=== STRUCTURE (max depth 5) ===
./
  .env.local
  .eslintrc.cjs
  .gitattributes
  .gitignore
  CLEANUP_LOG.md
  HomeFix.code-workspace
  build_trace.txt
  components.json
  deno.json
  deno.lock
  import_map.json
  jsconfig.json
  middleware.ts
  nem
  next-env.d.ts
  next.config.mjs
  package-lock.json
  package.json
  postcss.config.cjs
  repo-structure.txt
  repo-tree.ps1
  repo-tree.txt
  supabase-tests-direct.json
  tailwind.config.js
  test.css
  tsconfig.json
  .vscode/
    settings.json
  Scripts/
    HomeFix-Mail-Test.ps1
  agent/
    EDITH_NOTES.md
    README.md
    chatgpt-guide.md
    codex-guide.md
    design-laws.md
    shared-rules.md
  app/
    globals.css
    layout.tsx
    not-found.tsx
    page.tsx
    animations/
      3dKitchen.json
      civil.json
      diy.json
      electric.json
      fix.json
      interior.json
      map.json
      paint.json
    api/
      admin/
        bookings/
          list/
            route.js
          update/
            route.js
        reports/
          export/
            route.js
      auth/
        phone-otp/
          route.js
        send-email-otp/
          route.js
        upsert-user/
          route.js
        verify-email-otp/
          route.js
      bookings/
        route.js
        [id]/
          route.js
        cancel/
          route.js
        list/
          route.js
        reschedule/
          route.js
      bookings-ledger/
        [id]/
          route.ts
        cancel/
          route.ts
        create/
          route.ts
        list/
          route.ts
        refund/
          route.ts
        reschedule/
          route.ts
        return/
          route.ts
          approve/
            route.ts
          complete/
            route.ts
      clients/
        route.js
      edith/
        route.ts
      invoices/
        list/
          route.ts
      ledger/
        sync/
          route.ts
      profile/
        route.js
      services/
        route.js
    cart/
      page.tsx
    checkout/
      page.tsx
      page.tsx.bak
      success/
        page.tsx
    estimator/
      page.tsx
    login/
      page.tsx
    mockrazorpay/
      page.tsx
      page.tsx.bak
    my-orders/
      page.tsx
    my-space/
      page.tsx
      components/
        BookingCard.tsx
        BookingsView.tsx
        OrderCard.tsx
        OrdersView.tsx
        TabsBar.tsx
        ViewToggle.tsx
      orders/
        page.tsx
    profile/
      page.tsx
    services/
      page.tsx
      [slug]/
        page.js
    settings/
      page.tsx
    store/
      page.tsx
    studio/
      page.js
    unauthorized/
      page.js
  components/
    AuthCenterDrawer.tsx
    CartContext.js
    CartDrawer.tsx
    ClientDock.tsx
    HeroCinematicVideo.tsx
    HeroFX.js
    HeroParallax.tsx
    InstallFAB.js
    MapPicker.tsx
    OTPInput.tsx
    PWAInstallButton.js
    RateCard.js
    ServiceCard.tsx
    ServicesSection.jsx
    SessionHydrator.tsx
    SessionSync.tsx
    ThemeToggle.tsx
    checkout/
      CheckoutContainer.tsx
      CheckoutFooter.tsx
      CheckoutForm.tsx
      CheckoutOnlineStatus.tsx
      CheckoutToast.tsx
      EdithCard.tsx
    common/
      UniPreviewCanvas.tsx
      useAutoFitSvg.js
    edith/
      EdithLoader.tsx
      EdithToolsPanel.tsx
      EdithViewer.tsx
      EdithViewport.tsx
      index.ts
      useEdithStore.ts
    estimator/
      EstimatorForm.tsx
      EstimatorPageClient.tsx
      EstimatorShell.tsx
      KitchenRender.tsx
      KitchenScene3D.tsx
      KitchenSvg2D.jsx
      RateConfig.js
      SafeScene3D.tsx
      SummaryPanel.tsx
      WardrobeRender.tsx
      WardrobeScene3D.jsx
      WardrobeSvg2D.jsx
      modelPreload.js
      blueprintSchema/
        interpreter.js
        kitchenShapes.js
      store/
        estimatorStore.ts
    hooks/
    layout/
      LayoutContent.tsx
      NavBar.tsx
      RootShell.tsx
      SafeViewport.tsx
      Sidebar.tsx
      UniversalHeader.tsx
      index.ts
    ledgerx/
      LedgerXDock.tsx
      LedgerXDrawer.tsx
      LedgerXItemCard.tsx
      LedgerXProvider.tsx
      db.ts
      forceReset.ts
      useLedgerX.ts
    store/
      CategoryRail.tsx
      ProductCard.tsx
      ProductQuickView.tsx
      cartGuards.ts
      cartStore.ts
    studio/
      PriceHUD.jsx
      RoomPlanner2D_SVG.jsx
      RoomPlanner3D.jsx
      RoomShapeSelector.jsx
      RoomSummary.jsx
      store/
        plannerStore.js
    ui/
      Footer.tsx
      HomeFixLogo.tsx
      LiveClimateBar.tsx
      SearchFAB.tsx
      ServiceBookDrawer.tsx
      ServiceCartDrawer.tsx
      badge.js
      button-group-pro.tsx
      button-group.tsx
      button.tsx
      calendar.js
      card.tsx
      dialog.js
      drawer.tsx
      edith-tabs.tsx
      label.tsx
      progress.js
      switch.tsx
      tabs.js
      toaster.tsx
    utils/
      cadFitView.js
  contexts/
    SidebarContext.tsx
    StudioContext.tsx
    UserContext.tsx
  edith/
    components/
      useAssetSync.ts
  hooks/
    use-toast.tsx
    useCheckoutFlow.ts
    useDrawerSafeStyle.ts
    useGoogleMapsLoader.ts
    useMapPicker.ts
    useOtpManager.ts
    useRoleGuard.js
    useSupabaseUserSafe.ts
  lib/
    bookingUtils.js
    console.ts
    database.types.ts
    goods.js
    loadGoogleMaps.ts
    mockRazorpay.ts
    roles.ts
    supabaseClient.js
    supabaseServerClient.ts
    twilio.js
    useAuth.ts
    useServices.ts
    utils.ts
    assets/
      homefix-logo.ts
    supabaseQueries/
      admin.ts
      admin.types.ts
      bookings.ts
  packages/
    eslint-plugin-edith/
      index.js
      package.json
      lib/
        rules/
          no-hardcoded-colors.js
          no-inline-background-with-bg-class.js
  pages/
  public/
    logo-homefix.svg
    manifest.json
    offline.html
    sw.js
    workbox-4754cb34.js
    icons/
      HomeFix.png
      Logo.png
      icon.192x192.png.png
      icon.512x512.png.png
      vc.png
    images/
      HomeFix.png
    models/
      chair.glb
      interior_scene.glb
      kitchen.glb
      placeholder.glb
      sofa.glb
      wardrobe.glb
  return/
    estimator-theme.diff
    complete/
      route.ts
    reject/
      route.ts
  supabase/
    .gitignore
    config.toml
    .temp/
      cli-latest
      gotrue-version
      pooler-url
      postgres-version
      project-ref
      rest-version
      storage-migration
      storage-version
    functions/
      deno.json
      dispatch-booking-emails/
        index.ts
      email-queue-worker/
        index.ts
      functions/
        v1/
      link-otp-user/
        index.ts
      notify-booking-status/
        index.ts
      send-booking-email-core/
        index.ts
      verify-email-otp/
        index.ts
    migrations/
      20251013_reset_init.sql
      20251014_cleanup_profiles_table.sql
      20251026_fix_booking_fk_relations.sql
      20251026_triggers_cms_booking_sync.sql
      20251107_smartmail_v4.sql
  types/
    HomeFixUser.ts
    canvas-confetti.d.ts
    index.d.ts
    jsx.d.ts
    r3f.d.ts
    react-three.d.ts
=== TRACKED FILES (git ls-tree) ===
.eslintrc.cjs
.gitattributes
.gitignore
CLEANUP_LOG.md
HomeFix.code-workspace
Scripts/HomeFix-Mail-Test.ps1
agent/EDITH_NOTES.md
agent/README.md
agent/chatgpt-guide.md
agent/codex-guide.md
agent/design-laws.md
agent/shared-rules.md
app/animations/3dKitchen.json
app/animations/civil.json
app/animations/diy.json
app/animations/electric.json
app/animations/fix.json
app/animations/interior.json
app/animations/map.json
app/animations/paint.json
app/api/admin/bookings/list/route.js
app/api/admin/bookings/update/route.js
app/api/admin/reports/export/route.js
app/api/auth/phone-otp/route.js
app/api/auth/send-email-otp/route.js
app/api/auth/upsert-user/route.js
app/api/auth/verify-email-otp/route.js
app/api/bookings-ledger/[id]/route.ts
app/api/bookings-ledger/cancel/route.ts
app/api/bookings-ledger/create/route.ts
app/api/bookings-ledger/list/route.ts
app/api/bookings-ledger/refund/route.ts
app/api/bookings-ledger/reschedule/route.ts
app/api/bookings-ledger/return/approve/route.ts
app/api/bookings-ledger/return/complete/route.ts
app/api/bookings-ledger/return/route.ts
app/api/bookings/[id]/route.js
app/api/bookings/cancel/route.js
app/api/bookings/list/route.js
app/api/bookings/reschedule/route.js
app/api/bookings/route.js
app/api/clients/route.js
app/api/edith/route.ts
app/api/invoices/list/route.ts
app/api/ledger/sync/route.ts
app/api/profile/route.js
app/api/services/route.js
app/cart/page.tsx
app/checkout/page.tsx
app/checkout/success/page.tsx
app/estimator/page.tsx
app/globals.css
app/layout.tsx
app/login/page.tsx
app/mockrazorpay/page.tsx
app/my-orders/page.tsx
app/my-space/components/BookingCard.tsx
app/my-space/components/BookingsView.tsx
app/my-space/components/OrderCard.tsx
app/my-space/components/OrdersView.tsx
app/my-space/components/TabsBar.tsx
app/my-space/components/ViewToggle.tsx
app/my-space/orders/page.tsx
app/my-space/page.tsx
app/not-found.tsx
app/page.tsx
app/profile/page.tsx
app/services/[slug]/page.js
app/services/page.tsx
app/settings/page.tsx
app/store/page.tsx
app/studio/page.js
app/unauthorized/page.js
build_trace.txt
components.json
components/AuthCenterDrawer.tsx
components/CartContext.js
components/CartDrawer.tsx
components/ClientDock.tsx
components/HeroCinematicVideo.tsx
components/HeroFX.js
components/HeroParallax.tsx
components/InstallFAB.js
components/MapPicker.tsx
components/OTPInput.tsx
components/PWAInstallButton.js
components/RateCard.js
components/ServiceCard.tsx
components/ServicesSection.jsx
components/SessionHydrator.tsx
components/SessionSync.tsx
components/ThemeToggle.tsx
components/checkout/CheckoutContainer.tsx
components/checkout/CheckoutFooter.tsx
components/checkout/CheckoutForm.tsx
components/checkout/CheckoutOnlineStatus.tsx
components/checkout/CheckoutToast.tsx
components/checkout/EdithCard.tsx
components/common/UniPreviewCanvas.tsx
components/common/useAutoFitSvg.js
components/edith/EdithLoader.tsx
components/edith/EdithToolsPanel.tsx
components/edith/EdithViewer.tsx
components/edith/EdithViewport.tsx
components/edith/index.ts
components/edith/useEdithStore.ts
components/estimator/EstimatorForm.tsx
components/estimator/EstimatorPageClient.tsx
components/estimator/EstimatorShell.tsx
components/estimator/KitchenRender.tsx
components/estimator/KitchenScene3D.tsx
components/estimator/KitchenSvg2D.jsx
components/estimator/RateConfig.js
components/estimator/SafeScene3D.tsx
components/estimator/SummaryPanel.tsx
components/estimator/WardrobeRender.tsx
components/estimator/WardrobeScene3D.jsx
components/estimator/WardrobeSvg2D.jsx
components/estimator/blueprintSchema/interpreter.js
components/estimator/blueprintSchema/kitchenShapes.js
components/estimator/modelPreload.js
components/estimator/store/estimatorStore.ts
components/layout/LayoutContent.tsx
components/layout/NavBar.tsx
components/layout/RootShell.tsx
components/layout/SafeViewport.tsx
components/layout/Sidebar.tsx
components/layout/UniversalHeader.tsx
components/layout/index.ts
components/ledgerx/LedgerXDock.tsx
components/ledgerx/LedgerXDrawer.tsx
components/ledgerx/LedgerXItemCard.tsx
components/ledgerx/LedgerXProvider.tsx
components/ledgerx/db.ts
components/ledgerx/forceReset.ts
components/ledgerx/useLedgerX.ts
components/store/CategoryRail.tsx
components/store/ProductCard.tsx
components/store/ProductQuickView.tsx
components/store/cartGuards.ts
components/store/cartStore.ts
components/studio/PriceHUD.jsx
components/studio/RoomPlanner2D_SVG.jsx
components/studio/RoomPlanner3D.jsx
components/studio/RoomShapeSelector.jsx
components/studio/RoomSummary.jsx
components/studio/store/plannerStore.js
components/ui/Footer.tsx
components/ui/HomeFixLogo.tsx
components/ui/LiveClimateBar.tsx
components/ui/SearchFAB.tsx
components/ui/ServiceBookDrawer.tsx
components/ui/ServiceCartDrawer.tsx
components/ui/badge.js
components/ui/button-group-pro.tsx
components/ui/button-group.tsx
components/ui/button.tsx
components/ui/calendar.js
components/ui/card.tsx
components/ui/dialog.js
components/ui/drawer.tsx
components/ui/edith-tabs.tsx
components/ui/label.tsx
components/ui/progress.js
components/ui/switch.tsx
components/ui/tabs.js
components/ui/toaster.tsx
components/utils/cadFitView.js
contexts/SidebarContext.tsx
contexts/StudioContext.tsx
contexts/UserContext.tsx
deno.json
edith/components/useAssetSync.ts
hooks/use-toast.tsx
hooks/useCheckoutFlow.ts
hooks/useDrawerSafeStyle.ts
hooks/useGoogleMapsLoader.ts
hooks/useMapPicker.ts
hooks/useOtpManager.ts
hooks/useRoleGuard.js
hooks/useSupabaseUserSafe.ts
import_map.json
jsconfig.json
lib/assets/homefix-logo.ts
lib/bookingUtils.js
lib/console.ts
lib/database.types.ts
lib/goods.js
lib/loadGoogleMaps.ts
lib/mockRazorpay.ts
lib/roles.ts
lib/supabaseClient.js
lib/supabaseQueries/admin.ts
lib/supabaseQueries/admin.types.ts
lib/supabaseQueries/bookings.ts
lib/supabaseServerClient.ts
lib/twilio.js
lib/useAuth.ts
lib/useServices.ts
lib/utils.ts
middleware.ts
nem
next-env.d.ts
next.config.mjs
package-lock.json
package.json
packages/eslint-plugin-edith/index.js
packages/eslint-plugin-edith/lib/rules/no-hardcoded-colors.js
packages/eslint-plugin-edith/lib/rules/no-inline-background-with-bg-class.js
packages/eslint-plugin-edith/package.json
postcss.config.cjs
public/icons/HomeFix.png
public/icons/Logo.png
public/icons/icon.192x192.png.png
public/icons/icon.512x512.png.png
public/icons/vc.png
public/images/HomeFix.png
public/logo-homefix.svg
public/manifest.json
public/models/chair.glb
public/models/interior_scene.glb
public/models/kitchen.glb
public/models/placeholder.glb
public/models/sofa.glb
public/models/wardrobe.glb
public/offline.html
public/sw.js
public/workbox-4754cb34.js
repo-tree.ps1
repo-tree.txt
return/complete/route.ts
return/estimator-theme.diff
return/reject/route.ts
supabase-tests-direct.json
supabase/.gitignore
supabase/config.toml
supabase/functions/deno.json
supabase/functions/dispatch-booking-emails/index.ts
supabase/functions/email-queue-worker/index.ts
supabase/functions/link-otp-user/index.ts
supabase/functions/notify-booking-status/index.ts
supabase/functions/send-booking-email-core/index.ts
supabase/functions/verify-email-otp/index.ts
supabase/migrations/20251013_reset_init.sql
supabase/migrations/20251014_cleanup_profiles_table.sql
supabase/migrations/20251026_fix_booking_fk_relations.sql
supabase/migrations/20251026_triggers_cms_booking_sync.sql
supabase/migrations/20251107_smartmail_v4.sql
tailwind.config.js
test.css
tsconfig.json
types/HomeFixUser.ts
types/canvas-confetti.d.ts
types/index.d.ts
types/jsx.d.ts
types/r3f.d.ts
types/react-three.d.ts

=== package.json ===
{
  "name": "homefix-india",
  "version": "3.3.0",
  "private": true,
  "description": "HomeFix India ‚Äî Interior, Estimator, Studio & Edith Viewer Suite by Edith Technologies",
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "estimator": "next dev -p 4000",
    "studio": "next dev -p 4100",
    "edith": "next dev -p 4200"
  },
  "dependencies": {
    "@emotion/react": "11.14.0",
    "@emotion/styled": "11.14.1",
    "@mui/icons-material": "7.3.5",
    "@mui/material": "7.3.5",
    "@radix-ui/react-dialog": "1.1.15",
    "@radix-ui/react-label": "2.1.8",
    "@radix-ui/react-switch": "1.2.6",
    "@radix-ui/react-tabs": "1.1.13",
    "@radix-ui/react-toast": "1.2.15",
    "@react-spring/three": "9.6.1",
    "@react-three/postprocessing": "2.15.0",
    "@react-three/rapier": "1.5.0",
    "@supabase/auth-helpers-nextjs": "0.10.0",
    "@supabase/supabase-js": "2.77.0",
    "@use-gesture/react": "10.3.1",
    "canvas-confetti": "^1.9.4",
    "class-variance-authority": "0.7.1",
    "clsx": "^2.1.1",
    "date-fns": "4.1.0",
    "dexie": "^4.2.1",
    "eslint-plugin-edith": "file:../packages/eslint-plugin-edith",
    "framer-motion": "12.23.24",
    "idb-keyval": "6.2.1",
    "json2csv": "6.0.0-alpha.2",
    "lottie-react": "2.4.1",
    "lucide-react": "0.545.0",
    "maath": "^0.9.0",
    "next": "14.2.33",
    "next-pwa": "5.6.0",
    "next-themes": "0.4.6",
    "react": "18.2.0",
    "react-day-picker": "9.11.1",
    "react-dom": "18.2.0",
    "react-use-cart": "1.14.0",
    "recharts": "3.3.0",
    "sharp": "0.34.4",
    "sonner": "2.0.7",
    "suspend-react": "0.1.3",
    "tailwind-merge": "3.3.1",
    "tailwindcss-animate": "1.0.7",
    "three": "0.160.0",
    "three-stdlib": "2.30.4",
    "twilio": "4.21.0",
    "zustand": "5.0.8"
  },
  "devDependencies": {
    "@react-three/drei": "^9.88.3",
    "@react-three/fiber": "^8.15.12",
    "@tailwindcss/cli": "^4.1.17",
    "@tailwindcss/postcss": "^4.1.17",
    "@types/google.maps": "^3.58.1",
    "@types/node": "^24.9.1",
    "@types/react": "^19.2.2",
    "@types/react-dom": "^19.2.2",
    "@types/three": "^0.181.0",
    "autoprefixer": "^10.4.21",
    "eslint": "^8.57.1",
    "eslint-config-next": "^14.2.33",
    "postcss": "^8.5.6",
    "supabase": "^2.58.5",
    "tailwindcss": "^4.1.17",
    "typescript": "5.9.3"
  },
  "engines": {
    "node": ">=18.17.0"
  },
  "keywords": [
    "HomeFix",
    "Edith Technologies",
    "Next.js 14",
    "Estimator",
    "Studio",
    "3D Viewer",
    "Supabase",
    "Interior Design",
    "PWA",
    "AI"
  ],
  "author": "Edith Technologies ‚Äî Jagadish",
  "license": "UNLICENSED"
}

=== next.config.mjs ===
/**
 * ============================================================
 * üèóÔ∏è HomeFix India ‚Äî Edith Technologies v3.4 (ESM Safe)
 * ------------------------------------------------------------
 * ‚úÖ Ensures /api routes execute properly (standalone)
 * ‚úÖ PWA + Supabase Edge + LedgerX compatible
 * ‚úÖ TypedRoute ready for App Router
 * ============================================================
 */

import nextPWA from "next-pwa";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const withPWA = nextPWA({
  dest: "public",
  register: true,
  skipWaiting: true,
  disable: process.env.NODE_ENV === "development",
  cacheStartUrl: true,
  sw: "sw.js",
  scope: "/",
  buildExcludes: [/middleware-manifest\.json$/],
});

/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: process.env.NODE_ENV !== "production",
  output: "standalone", // ‚úÖ this enables API routes!
  productionBrowserSourceMaps: false,

  images: {
    remotePatterns: [
      { protocol: "https", hostname: "images.pexels.com" },
      { protocol: "https", hostname: "img.youtube.com" },
      { protocol: "https", hostname: "i.ytimg.com" },
      { protocol: "https", hostname: "res.cloudinary.com" },
      { protocol: "https", hostname: "lh3.googleusercontent.com" },
      { protocol: "https", hostname: "cdn.aesthetichomes.net" },
      { protocol: "https", hostname: "images.unsplash.com" },
      { protocol: "https", hostname: "plus.unsplash.com" },
      { protocol: "https", hostname: "*.supabase.co" },
    ],
    unoptimized: false,
    minimumCacheTTL: 3600,
  },

  eslint: { ignoreDuringBuilds: false },
  typescript: { ignoreBuildErrors: false },

  experimental: {
    serverActions: { bodySizeLimit: "2mb" },
    scrollRestoration: true,
    viewTransition: true,
    typedRoutes: true,
    webVitalsAttribution: ["CLS", "LCP", "FID"],
  },

  compiler: {
    removeConsole: process.env.NODE_ENV === "production",
    styledComponents: true,
  },

  poweredByHeader: false,
  compress: true,
  optimizeFonts: true,
  optimizeCss: true,

  webpack: (config) => {
    config.resolve.alias = {
      ...(config.resolve.alias || {}),
      "@/types": path.resolve(__dirname, "types"),
      "@/components": path.resolve(__dirname, "components"),
      "@/lib": path.resolve(__dirname, "lib"),
      "@/hooks": path.resolve(__dirname, "hooks"),
      "@/contexts": path.resolve(__dirname, "contexts"),
      "@/edith": path.resolve(__dirname, "edith"),
    };

    if (process.env.NODE_ENV === "production") {
      config.devtool = false;
    }

    config.plugins.push({
      apply: (compiler) => {
        compiler.hooks.done.tap("HomeFixBuildBanner", () => {
          console.log(
            "\x1b[36m%s\x1b[0m",
            "\nüåø HomeFix India v3.4 ‚Äî Edith Continuum Server Ready ‚ö°\n"
          );
        });
      },
    });

    return config;
  },
};

export default nextConfig;

=== .eslintrc.cjs ===
module.exports = {
  extends: ["next/core-web-vitals"],
};

=== tsconfig.json ===
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowJs": true,
    "resolveJsonModule": true,
    "noEmit": true,
    "incremental": true,

    "lib": ["DOM", "DOM.Iterable", "ESNext"],

    "types": [
      "react",
      "react-dom",
      "node",
      "@react-three/fiber",
      "google.maps"
    ],

    "jsx": "preserve",
    "isolatedModules": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true,
    "esModuleInterop": true,

    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"],
      "@/types/*": ["types/*"],
      "@/components/*": ["components/*"],
      "@/lib/*": ["lib/*"],
      "@/hooks/*": ["hooks/*"],
      "@/contexts/*": ["contexts/*"]
    },

    "plugins": [{ "name": "next" }],

    "typeRoots": ["./types", "./node_modules/@types"]
  },

  "typeRoots": ["./node_modules/@types"],

  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    "types",
    "types/**/*.d.ts",
    ".next/types/**/*.ts",
    "components/studio/RoomPlanner2DOLDS.jsx",
    "components/studio/RoomCanvas3d.jsx",
    "components/studio/EdithBot.tsx",
    "app/studio/oldpage.jsx",
    "app/studio/page.js",
    "hooks/use-toast.tsx",
    "app/api/ledger/sync/route.ts"
  ],

  "exclude": ["node_modules", "supabase", "dist", ".next"]
}

=== SOURCE FILES (.ts/.tsx in app, components, hooks, lib) ===

--- app/api/bookings-ledger/[id]/route.ts ---
// app/api/bookings-ledger/[id]/route.ts
export const runtime = "nodejs";

import { NextResponse } from "next/server";
import { supabaseService } from "@/lib/supabaseClient";

export async function GET(
  _req: Request,
  { params }: { params: { id: string } }
) {
  const supabase = supabaseService();
  const bookingId = params.id;

  if (!bookingId) {
    return NextResponse.json(
      { success: false, message: "booking ID is required" },
      { status: 400 }
    );
  }

  try {
    // Fetch booking
    const { data: booking, error: err1 } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("id", bookingId)
      .single();

    if (err1) {
      console.error("‚ùå booking fetch error:", err1);
      return NextResponse.json(
        { success: false, message: "Booking not found" },
        { status: 404 }
      );
    }

    // Fetch timeline events
    const { data: events, error: err2 } = await supabase
      .from("booking_events")
      .select("*")
      .eq("booking_id", bookingId)
      .order("created_at", { ascending: true });

    if (err2) {
      console.error("‚ö†Ô∏è event fetch error:", err2);
    }

    return NextResponse.json(
      {
        success: true,
        booking,
        events: events || [],
        last_event: events?.[events.length - 1] || null,
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• fatal detail error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Failed to fetch booking" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/cancel/route.ts ---
// app/api/bookings-ledger/cancel/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

interface CancelPayload {
  booking_id: string;
  user_id: string;
  reason?: string;
}

export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body = (await req.json()) as CancelPayload;

    if (!body?.booking_id) {
      return NextResponse.json(
        { success: false, message: "booking_id is required" },
        { status: 400 }
      );
    }

    if (!body?.user_id) {
      return NextResponse.json(
        { success: false, message: "user_id is required" },
        { status: 400 }
      );
    }

    // Fetch booking to ensure user owns it
    const { data: existing, error: fetchErr } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("id", body.booking_id)
      .single();

    if (fetchErr || !existing) {
      return NextResponse.json(
        { success: false, message: "Booking not found" },
        { status: 404 }
      );
    }

    if (existing.user_id !== body.user_id) {
      return NextResponse.json(
        { success: false, message: "Unauthorized booking access" },
        { status: 403 }
      );
    }

    // Prevent double cancellation
    if (existing.status === "cancelled") {
      return NextResponse.json(
        { success: true, message: "Already cancelled" },
        { status: 200 }
      );
    }

    // Update booking
    const { error: updErr } = await supabase
      .from("bookings_ledger")
      .update({
        status: "cancelled",
        event_count: (existing.event_count || 0) + 1,
        updated_at: new Date().toISOString(),
      })
      .eq("id", body.booking_id);

    if (updErr) {
      console.error("‚ùå cancel update error:", updErr);
      return NextResponse.json(
        { success: false, message: updErr.message },
        { status: 500 }
      );
    }

    // Log event
    await supabase.from("booking_events").insert([
      {
        booking_id: body.booking_id,
        user_id: body.user_id,
        event: "cancelled",
        status: "cancelled",
        meta: {
          reason: body.reason || "user_cancelled",
        },
      },
    ]);

    // Add to notification queue
    await supabase.from("notification_queue").insert([
      {
        kind: "email",
        to_email: null,
        subject: "Your booking was cancelled",
        html: `<p>Your booking was cancelled.</p>`,
        meta: { bookingId: body.booking_id },
        status: "pending",
        try_count: 0,
      },
    ]);

    return NextResponse.json(
      {
        success: true,
        message: "Booking cancelled successfully",
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• fatal cancel error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Cancellation failed" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/create/route.ts ---
// app/api/bookings-ledger/create/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

interface CreateBookingPayload {
  user_id: string;
  items: any[];
  total: number;

  address: string;
  landmark?: string;
  pincode?: string;

  latitude: number;
  longitude: number;

  receiver_name: string;
  receiver_phone: string;

  device_id?: string;
  source?: string;
  channel?: string;
  schema_version?: number;
}

function safe(v: any) {
  try {
    return JSON.parse(JSON.stringify(v));
  } catch {
    return v;
  }
}

export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body = (await req.json()) as CreateBookingPayload;

    if (!body?.user_id) {
      return NextResponse.json(
        { success: false, message: "user_id is required" },
        { status: 400 }
      );
    }

    if (!Array.isArray(body.items) || body.items.length === 0) {
      return NextResponse.json(
        { success: false, message: "items array empty" },
        { status: 400 }
      );
    }

    const bookingRow = {
      user_id: body.user_id,
      type: "booking",
      status: "pending",

      channel: body.channel || "pwa",
      source: body.source || "homefix",
      device_id: body.device_id || "unknown",
      checksum: crypto.randomUUID().slice(0, 8),

      schema_version: body.schema_version || 1,

      // Address fields
      address: body.address,
      landmark: body.landmark || null,
      pincode: body.pincode || null,

      latitude: body.latitude,
      longitude: body.longitude,

      receiver_name: body.receiver_name,
      receiver_phone: body.receiver_phone,

      items: safe(body.items),
      total: body.total,

      payload: safe(body),
      event_count: 1,
    };

    // Insert into bookings_ledger
    const { data: created, error: err1 } = await supabase
      .from("bookings_ledger")
      .insert([bookingRow])
      .select()
      .single();

    if (err1) {
      console.error("‚ùå Insert booking error:", err1);
      return NextResponse.json(
        { success: false, message: err1.message },
        { status: 500 }
      );
    }

    const bookingId = created.id;

    // Insert event
    await supabase.from("booking_events").insert([
      {
        booking_id: bookingId,
        user_id: body.user_id,
        event: "created",
        status: "pending",
        meta: {
          total: body.total,
          item_count: body.items.length,
          source: bookingRow.source,
          channel: bookingRow.channel,
        },
      },
    ]);

    // Notify queue (optional)
    await supabase.from("notification_queue").insert([
      {
        kind: "email",
        to_email: null,
        subject: "Booking Created",
        html: `<p>Your booking has been created.</p>`,
        meta: { bookingId, user_id: body.user_id },
        status: "pending",
        try_count: 0,
      },
    ]);

    return NextResponse.json(
      { success: true, booking: created },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• Fatal create booking error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Booking creation failed" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/list/route.ts ---
// app/api/bookings-ledger/list/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

export async function GET(req: Request) {
  const supabase = supabaseService();
  const { searchParams } = new URL(req.url);
  const user_id = searchParams.get("user_id");

  if (!user_id) {
    return NextResponse.json(
      { success: false, message: "user_id is required" },
      { status: 400 }
    );
  }

  try {
    // Fetch bookings for user
    const { data: bookings, error: err1 } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("user_id", user_id)
      .order("created_at", { ascending: false });

    if (err1) {
      console.error("‚ùå list bookings error:", err1);
      return NextResponse.json(
        { success: false, message: err1.message },
        { status: 500 }
      );
    }

    if (!bookings || bookings.length === 0) {
      return NextResponse.json({ success: true, data: [] }, { status: 200 });
    }

    // Fetch events for all bookings
    const bookingIds = bookings.map((b) => b.id);

    const { data: events, error: err2 } = await supabase
      .from("booking_events")
      .select("*")
      .in("booking_id", bookingIds)
      .order("created_at", { ascending: true });

    if (err2) {
      console.error("‚ö†Ô∏è list events error:", err2);
    }

    // Organize events per booking
    const eventsMap: Record<string, any[]> = {};
    for (const ev of events || []) {
      if (!eventsMap[ev.booking_id]) eventsMap[ev.booking_id] = [];
      eventsMap[ev.booking_id].push(ev);
    }

    // Merge bookings with their events
    const result = bookings.map((b) => ({
      ...b,
      events: eventsMap[b.id] || [],
      last_event: eventsMap[b.id]?.[eventsMap[b.id].length - 1] || null,
    }));

    return NextResponse.json({ success: true, data: result }, { status: 200 });
  } catch (err: any) {
    console.error("üí• fatal list error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Failed to list bookings" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/refund/route.ts ---
// app/api/bookings-ledger/refund/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

interface RefundPayload {
  booking_id: string;
  admin_id: string;
  amount: number;
  notes?: string;
}

export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body = (await req.json()) as RefundPayload;

    // Required fields
    if (!body.booking_id)
      return NextResponse.json(
        { success: false, message: "booking_id required" },
        { status: 400 }
      );

    if (!body.admin_id)
      return NextResponse.json(
        { success: false, message: "admin_id required" },
        { status: 400 }
      );

    if (!body.amount || body.amount <= 0)
      return NextResponse.json(
        { success: false, message: "Valid refund amount required" },
        { status: 400 }
      );

    // Fetch booking
    const { data: booking, error: fetchErr } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("id", body.booking_id)
      .single();

    if (fetchErr || !booking)
      return NextResponse.json(
        { success: false, message: "Booking not found" },
        { status: 404 }
      );

    // Validate status
    if (booking.status !== "returned") {
      return NextResponse.json(
        {
          success: false,
          message: `Refund cannot be processed unless booking is 'returned'. Current: ${booking.status}`,
        },
        { status: 400 }
      );
    }

    // Prevent double refunds
    if (booking.refund_amount && booking.refund_amount > 0) {
      return NextResponse.json(
        {
          success: false,
          message: "Refund already processed for this booking",
        },
        { status: 400 }
      );
    }

    // ------------------------------
    // üëá This is where payment gateway refund will happen later
    // Razorpay ‚Üí refund(payment_id, amount)
    // Stripe ‚Üí refund(charge_id, amount)
    // For now: Soft-confirmation only
    // ------------------------------

    // Update booking ledger
    const { error: updErr } = await supabase
      .from("bookings_ledger")
      .update({
        status: "refunded",
        refund_amount: body.amount,
        refund_processed_at: new Date().toISOString(),
        event_count: (booking.event_count || 0) + 1,
        updated_at: new Date().toISOString(),
        meta: {
          ...(booking.meta || {}),
          refund_notes: body.notes || null,
        },
      })
      .eq("id", booking.id);

    if (updErr) {
      console.error("‚ùå refund update error:", updErr);
      return NextResponse.json(
        { success: false, message: updErr.message },
        { status: 500 }
      );
    }

    // Log event
    await supabase.from("booking_events").insert([
      {
        booking_id: booking.id,
        user_id: booking.user_id,
        event: "refunded",
        status: "refunded",
        meta: {
          amount: body.amount,
          refund_by: body.admin_id,
          notes: body.notes || null,
        },
      },
    ]);

    // Queue user email
    await supabase.from("notification_queue").insert([
      {
        kind: "email",
        to_email: null,
        subject: "Refund Processed",
        html: `
          <p>Your refund for booking <b>${booking.id}</b> has been processed.</p>
          <p><b>Amount:</b> ‚Çπ${body.amount}</p>
        `,
        meta: {
          bookingId: booking.id,
          amount: body.amount,
          action: "refund",
        },
        status: "pending",
        try_count: 0,
      },
    ]);

    return NextResponse.json(
      {
        success: true,
        message: "Refund processed successfully",
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• refund fatal error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Refund process failed" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/reschedule/route.ts ---
// app/api/bookings-ledger/reschedule/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

interface ReschedulePayload {
  booking_id: string;
  user_id: string;
  preferred_date: string;
  preferred_slot: string;
}

export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body = (await req.json()) as ReschedulePayload;

    // Basic validation
    if (!body.booking_id)
      return NextResponse.json(
        { success: false, message: "booking_id is required" },
        { status: 400 }
      );

    if (!body.user_id)
      return NextResponse.json(
        { success: false, message: "user_id is required" },
        { status: 400 }
      );

    if (!body.preferred_date || !body.preferred_slot)
      return NextResponse.json(
        {
          success: false,
          message: "preferred_date and preferred_slot are required",
        },
        { status: 400 }
      );

    // Fetch booking to verify it exists & belongs to user
    const { data: existing, error: fetchErr } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("id", body.booking_id)
      .single();

    if (fetchErr || !existing) {
      return NextResponse.json(
        { success: false, message: "Booking not found" },
        { status: 404 }
      );
    }

    if (existing.user_id !== body.user_id) {
      return NextResponse.json(
        { success: false, message: "Unauthorized booking access" },
        { status: 403 }
      );
    }

    if (existing.status === "cancelled") {
      return NextResponse.json(
        { success: false, message: "Cancelled booking cannot be rescheduled" },
        { status: 400 }
      );
    }

    if (existing.status === "completed") {
      return NextResponse.json(
        { success: false, message: "Completed booking cannot be rescheduled" },
        { status: 400 }
      );
    }

    // Update ledger entry
    const { error: updErr } = await supabase
      .from("bookings_ledger")
      .update({
        preferred_date: body.preferred_date,
        preferred_slot: body.preferred_slot,
        status: "rescheduled",
        event_count: (existing.event_count || 0) + 1,
        updated_at: new Date().toISOString(),
      })
      .eq("id", body.booking_id);

    if (updErr) {
      console.error("‚ùå reschedule update error:", updErr);
      return NextResponse.json(
        { success: false, message: updErr.message },
        { status: 500 }
      );
    }

    // Log event
    await supabase.from("booking_events").insert([
      {
        booking_id: body.booking_id,
        user_id: body.user_id,
        event: "rescheduled",
        status: "rescheduled",
        meta: {
          new_date: body.preferred_date,
          new_slot: body.preferred_slot,
        },
      },
    ]);

    // Notification queue email
    await supabase.from("notification_queue").insert([
      {
        kind: "email",
        to_email: null,
        subject: "Your booking was rescheduled",
        html: `<p>Your booking has been rescheduled.</p>`,
        meta: {
          bookingId: body.booking_id,
          newDate: body.preferred_date,
          newSlot: body.preferred_slot,
        },
        status: "pending",
        try_count: 0,
      },
    ]);

    return NextResponse.json(
      {
        success: true,
        message: "Booking rescheduled successfully",
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• fatal reschedule error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Reschedule failed" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/return/approve/route.ts ---
// app/api/bookings-ledger/return/approve/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

interface ApproveReturnPayload {
  booking_id: string;
  admin_id: string;
  notes?: string;
}

export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body = (await req.json()) as ApproveReturnPayload;

    if (!body.booking_id)
      return NextResponse.json(
        { success: false, message: "booking_id required" },
        { status: 400 }
      );

    if (!body.admin_id)
      return NextResponse.json(
        { success: false, message: "admin_id required" },
        { status: 400 }
      );

    // Fetch booking
    const { data: booking, error: fetchErr } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("id", body.booking_id)
      .single();

    if (fetchErr || !booking)
      return NextResponse.json(
        { success: false, message: "Booking not found" },
        { status: 404 }
      );

    // Validate status
    if (booking.status !== "return_requested") {
      return NextResponse.json(
        {
          success: false,
          message: `Return cannot be approved when status is "${booking.status}"`,
        },
        { status: 400 }
      );
    }

    // Update booking ledger
    const { error: updErr } = await supabase
      .from("bookings_ledger")
      .update({
        status: "return_approved",
        event_count: (booking.event_count || 0) + 1,
        updated_at: new Date().toISOString(),
      })
      .eq("id", body.booking_id);

    if (updErr) {
      console.error("‚ùå return approve update error:", updErr);
      return NextResponse.json(
        { success: false, message: updErr.message },
        { status: 500 }
      );
    }

    // Log event
    await supabase.from("booking_events").insert([
      {
        booking_id: booking.id,
        user_id: booking.user_id,
        event: "return_approved",
        status: "return_approved",
        meta: {
          approved_by: body.admin_id,
          notes: body.notes || null,
        },
      },
    ]);

    // Notify user
    await supabase.from("notification_queue").insert([
      {
        kind: "email",
        to_email: null,
        subject: "Your Return Has Been Approved",
        html: `<p>Your return request for booking <b>${booking.id}</b> has been approved.</p>`,
        meta: {
          bookingId: booking.id,
          action: "return_approved",
        },
        status: "pending",
        try_count: 0,
      },
    ]);

    return NextResponse.json(
      {
        success: true,
        message: "Return approved successfully",
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• return approve fatal error:", err);
    return NextResponse.json(
      { success: false, message: err?.message || "Return approval failed" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/return/complete/route.ts ---
// app/api/bookings-ledger/return/complete/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

interface CompleteReturnPayload {
  booking_id: string;
  admin_id: string;
  notes?: string;
}

export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body = (await req.json()) as CompleteReturnPayload;

    // Validate
    if (!body.booking_id)
      return NextResponse.json(
        { success: false, message: "booking_id required" },
        { status: 400 }
      );

    if (!body.admin_id)
      return NextResponse.json(
        { success: false, message: "admin_id required" },
        { status: 400 }
      );

    // Fetch booking
    const { data: booking, error: fetchErr } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("id", body.booking_id)
      .single();

    if (fetchErr || !booking)
      return NextResponse.json(
        { success: false, message: "Booking not found" },
        { status: 404 }
      );

    // Validate status flow
    if (booking.status !== "return_approved") {
      return NextResponse.json(
        {
          success: false,
          message: `Return cannot be completed when status is "${booking.status}"`,
        },
        { status: 400 }
      );
    }

    // Update booking
    const { error: updErr } = await supabase
      .from("bookings_ledger")
      .update({
        status: "returned",
        event_count: (booking.event_count || 0) + 1,
        updated_at: new Date().toISOString(),
      })
      .eq("id", booking.id);

    if (updErr) {
      console.error("‚ùå return complete update error:", updErr);
      return NextResponse.json(
        { success: false, message: updErr.message },
        { status: 500 }
      );
    }

    // Log event
    await supabase.from("booking_events").insert([
      {
        booking_id: booking.id,
        user_id: booking.user_id,
        event: "returned",
        status: "returned",
        meta: {
          completed_by: body.admin_id,
          notes: body.notes || null,
        },
      },
    ]);

    // Queue user email
    await supabase.from("notification_queue").insert([
      {
        kind: "email",
        to_email: null,
        subject: "Return Completed",
        html: `
          <p>Your return for booking <b>${booking.id}</b> is completed.</p>
        `,
        meta: {
          bookingId: booking.id,
          action: "return_completed",
        },
        status: "pending",
        try_count: 0,
      },
    ]);

    return NextResponse.json(
      {
        success: true,
        message: "Return marked as completed",
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• return complete fatal error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Return completion failed" },
      { status: 500 }
    );
  }
}

--- app/api/bookings-ledger/return/route.ts ---
// app/api/bookings-ledger/return/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

interface ReturnRequestPayload {
  booking_id: string;
  user_id: string;
  reason: string;
}

export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body = (await req.json()) as ReturnRequestPayload;

    // Basic validations
    if (!body.booking_id)
      return NextResponse.json(
        { success: false, message: "booking_id is required" },
        { status: 400 }
      );

    if (!body.user_id)
      return NextResponse.json(
        { success: false, message: "user_id is required" },
        { status: 400 }
      );

    if (!body.reason)
      return NextResponse.json(
        { success: false, message: "reason is required for returns" },
        { status: 400 }
      );

    // Fetch booking & verify user
    const { data: booking, error: fetchErr } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("id", body.booking_id)
      .single();

    if (fetchErr || !booking)
      return NextResponse.json(
        { success: false, message: "Booking not found" },
        { status: 404 }
      );

    if (booking.user_id !== body.user_id)
      return NextResponse.json(
        { success: false, message: "Unauthorized booking access" },
        { status: 403 }
      );

    // Only allow return on "completed" status
    if (booking.status !== "completed") {
      return NextResponse.json(
        {
          success: false,
          message: "Return can be requested only for completed services/goods",
        },
        { status: 400 }
      );
    }

    // Prevent double return request
    if (booking.status === "return_requested") {
      return NextResponse.json(
        {
          success: true,
          message: "Return already requested",
        },
        { status: 200 }
      );
    }

    // Update booking ledger
    const { error: updErr } = await supabase
      .from("bookings_ledger")
      .update({
        status: "return_requested",
        event_count: (booking.event_count || 0) + 1,
        updated_at: new Date().toISOString(),
      })
      .eq("id", body.booking_id);

    if (updErr) {
      console.error("‚ùå return request update error:", updErr);
      return NextResponse.json(
        { success: false, message: updErr.message },
        { status: 500 }
      );
    }

    // Log event
    await supabase.from("booking_events").insert([
      {
        booking_id: body.booking_id,
        user_id: body.user_id,
        event: "return_requested",
        status: "return_requested",
        meta: {
          reason: body.reason,
        },
      },
    ]);

    // Queue email
    await supabase.from("notification_queue").insert([
      {
        kind: "email",
        to_email: null,
        subject: "Return Request Submitted",
        html: `<p>Your return request has been submitted.</p>`,
        meta: {
          bookingId: body.booking_id,
          reason: body.reason,
        },
        status: "pending",
        try_count: 0,
      },
    ]);

    return NextResponse.json(
      {
        success: true,
        message: "Return request submitted successfully",
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• fatal return request error:", err);
    return NextResponse.json(
      { success: false, message: err.message || "Return request failed" },
      { status: 500 }
    );
  }
}

--- app/api/edith/route.ts ---
// /app/api/edith/route.ts
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const { command, context } = await req.json();

    // Basic built-in commands
    if (command?.toLowerCase() === "ping") {
      return NextResponse.json({ status: "ok", message: "pong" });
    }

    // Safe fallback
    return NextResponse.json({
      status: "ok",
      message: `Edith received your message: "${command}"`,
      context,
    });
  } catch (err: any) {
    return NextResponse.json(
      { status: "error", message: err.message || "Unknown error" },
      { status: 500 }
    );
  }
}

--- app/api/invoices/list/route.ts ---
// app/api/invoices/list/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

const STORE_FLOW = [
  "Order Placed",
  "Order Received",
  "Order Confirmed",
  "Packed",
  "Shipped",
  "Delivered",
];

const SERVICE_FLOW = [
  "Service Booked",
  "Engineer Assigned",
  "Site Visit",
  "Quotation Sent",
  "Awaiting Approval",
  "Work Started",
  "In Progress",
  "Completion & Handover",
];

const STATUS_HINT: Record<string, number> = {
  pending: 1,
  synced: 6,
  completed: 6,
  failed: 2,
  cancelled: 2,
  rescheduled: 3,
  confirmed: 3,
};

function inferOrderType(row: any) {
  const declaredType =
    row?.type?.toLowerCase?.() ||
    row?.order_type?.toLowerCase?.() ||
    row?.payload?.order_type?.toLowerCase?.();

  if (declaredType === "service") return "service";
  if (declaredType === "product" || declaredType === "store") return "store";

  const payload = row?.payload ?? {};
  if (
    payload.channel === "store" ||
    payload.type === "store" ||
    (Array.isArray(payload.items) &&
      !Array.isArray(payload.services) &&
      !payload.visit_fee)
  ) {
    return "store";
  }
  return "service";
}

function buildItems(payload: any) {
  if (Array.isArray(payload?.items)) return payload.items;
  if (Array.isArray(payload?.cart)) return payload.cart;
  if (Array.isArray(payload?.services))
    return payload.services.map((svc: any) => ({
      name: svc?.name || svc?.title || "Service",
      quantity: svc?.quantity || 1,
      price: svc?.price || svc?.amount || 0,
    }));
  return [];
}

function deriveProgress(type: "store" | "service", status?: string | null) {
  const fallbackSteps = type === "store" ? STORE_FLOW : SERVICE_FLOW;
  const hintIndex = status ? STATUS_HINT[status] : undefined;
  if (hintIndex) return Math.min(hintIndex, fallbackSteps.length);
  return type === "store" ? 2 : 3;
}

/**
 * Invoices list endpoint for My Orders.
 *
 * For now, this reads from the `bookings_ledger` table and
 * shapes each row into a lightweight invoice object so the
 * My Orders UI can stay local-first but still backed by Supabase.
 */
export async function GET(req: Request) {
  try {
    const url = new URL(req.url);
    const userId = url.searchParams.get("user_id");

    if (!userId) {
      return NextResponse.json(
        { success: false, message: "Missing user_id" },
        { status: 400 }
      );
    }

    const supabase = supabaseService();

    const { data, error } = await supabase
      .from("bookings_ledger")
      .select("*")
      .eq("user_id", userId)
      .order("created_at", { ascending: false })
      .limit(100);

    if (error) {
      console.error("[api/invoices/list] Supabase error:", error);
      return NextResponse.json(
        { success: false, message: error.message },
        { status: 500 }
      );
    }

    const invoices =
      data?.map((row: any) => {
        const payload = row.payload || {};
        const orderType = inferOrderType(row);
        return {
          id: row.id,
          created_at: row.created_at,
          total:
            payload.total_price ??
            payload.total ??
            row.total ??
            0,
          invoice_url:
            payload.invoice_url ??
            payload.invoice_link ??
            null,
          reference: payload.checkout_id ?? payload.reference ?? row.id,
          invoice_id:
            payload.invoice_number ??
            payload.invoice_id ??
            payload.invoice ??
            row.id,
          order_type: orderType,
          visit_fee: payload.visit_fee ?? null,
          visit_fee_waived: Boolean(payload.visit_fee_waived),
          address:
            payload.address?.formatted ??
            payload.address?.label ??
            payload.site_location?.formatted ??
            payload.site_location?.address ??
            null,
          items: buildItems(payload),
          status: row.status ?? payload.status ?? "pending",
          tracking_steps: orderType === "store" ? STORE_FLOW : SERVICE_FLOW,
          progress: deriveProgress(orderType, row.status ?? payload.status),
          payload,
          raw: row,
        };
      }) ?? [];

    return NextResponse.json(
      {
        success: true,
        invoices,
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("[api/invoices/list] Fatal error:", err);
    return NextResponse.json(
      {
        success: false,
        message: err?.message ?? "Internal error",
      },
      { status: 500 }
    );
  }
}

--- app/api/ledger/sync/route.ts ---
// app/api/ledger/sync/route.ts
export const runtime = "nodejs";

import { supabaseService } from "@/lib/supabaseClient";
import { NextResponse } from "next/server";

/* -----------------------
   TYPES
------------------------- */
interface LedgerXIncomingEntry {
  id?: string;
  user_id?: string | null;
  type?: string;
  payload?: any;
  status?: string;
  device_id?: string;
  checksum?: string;
  created_at?: string;
  updated_at?: string;
}

interface LedgerXBody {
  _entries?: LedgerXIncomingEntry[];
}

/* -----------------------
   HELPERS
------------------------- */
const safeJson = (v: any) => {
  try {
    return JSON.parse(JSON.stringify(v ?? {}));
  } catch {
    return {};
  }
};

const safeUUID = (id?: string): string => {
  try {
    if (id && /^[0-9a-f-]{36}$/i.test(id)) return id;
    return crypto.randomUUID();
  } catch {
    return crypto.randomUUID();
  }
};

const isRealUser = (u?: string | null) =>
  !!u &&
  /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(
    u
  );

/* -----------------------
   POST HANDLER
------------------------- */
export async function POST(req: Request) {
  const supabase = supabaseService();

  try {
    const body: LedgerXBody = await req.json();

    if (!Array.isArray(body._entries) || body._entries.length === 0) {
      return NextResponse.json(
        { success: false, message: "Entries array missing or empty" },
        { status: 400 }
      );
    }

    /* -----------------------------
       Normalize incoming entries
    ------------------------------ */
    const normalized = body._entries
      .filter((e) => isRealUser(e.user_id)) // reject guest or null user_id
      .map((e) => {
        const p = safeJson(e.payload);
        const loc = p?.site_location ?? p?.address ?? {};

        return {
          /* ---- IDENTIFIERS ---- */
          id: safeUUID(e.id),
          user_id: e.user_id!,
          schema_version: 1,

          /* ---- META ---- */
          type: e.type || "booking",
          status: e.status || "pending",
          channel: p.channel || "pwa",
          source: "homefix",

          /* ---- DEVICE ---- */
          device_id: e.device_id || "unknown",
          checksum: e.checksum || "none",

          /* ---- PAYLOAD ---- */
          payload: p,

          /* ---- FLATTENED LOCATION ---- */
          address: loc.formatted ?? loc.address ?? null,
          landmark: loc.landmark ?? null,
          pincode: loc.pincode ?? null,
          latitude: loc.latitude ?? null,
          longitude: loc.longitude ?? null,
          receiver_name: loc.receiver_name ?? null,
          receiver_phone: loc.receiver_phone ?? null,

          /* ---- ITEMS & TOTAL ---- */
          items: p.services ?? p.items ?? [],
          total: Number(p.total_price ?? p.total ?? 0),

          /* ---- EVENTS ---- */
          event_count: p.event_count ?? 0,

          /* ---- TIMESTAMPS ---- */
          created_at: e.created_at ?? new Date().toISOString(),
          updated_at: new Date().toISOString(),
        };
      });

    if (normalized.length === 0) {
      return NextResponse.json(
        { success: false, message: "Rejected: guest or invalid user_id" },
        { status: 400 }
      );
    }

    console.log(
      `üì® [LedgerX Sync] Received entries: ${normalized.length}`,
      normalized
    );

    /* -----------------------------
       UPSERT into bookings_ledger
    ------------------------------ */
    const { data, error } = await supabase
      .from("bookings_ledger")
      .upsert(normalized, {
        onConflict: "id", // idempotent sync
        ignoreDuplicates: false,
      })
      .select("id");

    if (error) {
      console.error("‚ùå [LedgerX Upsert Error]", error);
      return NextResponse.json(
        { success: false, message: error.message },
        { status: 500 }
      );
    }

    console.log(
      `‚úÖ [LedgerX] Synced OK: ${normalized.length} sent ‚Üí ${
        data?.length || 0
      } affected`
    );

    return NextResponse.json(
      {
        success: true,
        sent: normalized.length,
        affected: data?.length || 0,
        message: "Ledger synced successfully",
      },
      { status: 200 }
    );
  } catch (err: any) {
    console.error("üí• [LedgerX API Fatal]", err);
    return NextResponse.json(
      { success: false, message: err?.message ?? "Internal error" },
      { status: 500 }
    );
  }
}

--- app/cart/page.tsx ---
"use client";
/**
 * ============================================================
 * Dual Cart View (Store + Services)
 * ------------------------------------------------------------
 * ? Toggle between product cart and service cart
 * ? Enforces separate checkout flows
 * ? Shares SafeViewport-aware layout
 * ============================================================
 */

import {
  useProductCartStore,
  useServiceCartStore,
} from "../../components/store/cartStore";
import { AnimatePresence, motion } from "framer-motion";
import {
  ArrowRight,
  Minus,
  Plus,
  ShoppingBag,
  Trash2,
} from "lucide-react";
import Image from "next/image";
import { useRouter, useSearchParams } from "next/navigation";
import { useEffect, useMemo, useState } from "react";

type CartView = "product" | "service";

const formatInr = (value: number) =>
  new Intl.NumberFormat("en-IN", {
    style: "currency",
    currency: "INR",
    minimumFractionDigits: 2,
  }).format(value);

export default function CartPage() {
  const router = useRouter();
  const params = useSearchParams();

  const storeItems = useProductCartStore((s) => s.items);
  const storeRemove = useProductCartStore((s) => s.removeItem);
  const storeIncrement = useProductCartStore((s) => s.increment);
  const storeDecrement = useProductCartStore((s) => s.decrement);
  const storeTotalItems = useProductCartStore((s) => s.totalItems);
  const storeTotalPrice = useProductCartStore((s) => s.totalPrice);

  const serviceItems = useServiceCartStore((s) => s.items);
  const serviceRemove = useServiceCartStore((s) => s.removeItem);
  const serviceIncrement = useServiceCartStore((s) => s.increment);
  const serviceDecrement = useServiceCartStore((s) => s.decrement);
  const serviceTotalItems = useServiceCartStore((s) => s.totalItems);
  const serviceTotalPrice = useServiceCartStore((s) => s.totalPrice);

  const typeParam = params?.get("type");
  const initialTab =
    (typeParam as CartView | null) ??
    (storeItems.length ? "product" : "service");
  const [view, setView] = useState<CartView>(initialTab);

  useEffect(() => {
    if (storeItems.length && view !== "product") setView("product");
    if (!storeItems.length && serviceItems.length && view !== "service")
      setView("service");
  }, [storeItems.length, serviceItems.length, view]);

  const { items, removeItem, increment, decrement, totalItems, totalPrice } =
    useMemo(() => {
      if (view === "service") {
        return {
          items: serviceItems,
          removeItem: serviceRemove,
          increment: serviceIncrement,
          decrement: serviceDecrement,
          totalItems: serviceTotalItems,
          totalPrice: serviceTotalPrice,
        };
      }
      return {
        items: storeItems,
        removeItem: storeRemove,
        increment: storeIncrement,
        decrement: storeDecrement,
        totalItems: storeTotalItems,
        totalPrice: storeTotalPrice,
      };
    }, [
      view,
      serviceItems,
      serviceRemove,
      serviceIncrement,
      serviceDecrement,
      serviceTotalItems,
      serviceTotalPrice,
      storeItems,
      storeRemove,
      storeIncrement,
      storeDecrement,
      storeTotalItems,
      storeTotalPrice,
    ]);

  const isEmpty = items.length === 0;

  useEffect(() => {
    if (typeof window !== "undefined") {
      document.title = `Cart (${totalItems}) ¬∑ HomeFix`;
    }
  }, [totalItems]);

  return (
    <section
      id="cart-safe-section"
      className="flex flex-col w-full max-w-3xl mx-auto px-4 sm:px-6 md:px-8
                 pt-safe-top pb-safe-bottom
                 text-[var(--text-primary)]
                 bg-[var(--surface-base)]
                 transition-colors duration-500"
      style={{
        paddingTop: "var(--header-h,72px)",
        paddingBottom:
          "calc(var(--mbnav-h,72px) + env(safe-area-inset-bottom))",
      }}
    >
      <div className="flex items-center justify-between gap-4 mb-6 mt-2">
        <h1 className="text-2xl font-bold">Your Cart</h1>

        <div className="flex rounded-full bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)] border border-[var(--edith-border)] text-sm">
          <button
            className={`px-4 py-1.5 rounded-full ${
              view === "product"
                ? "bg-[var(--accent-primary)] text-white"
                : "text-[var(--text-secondary)]"
            }`}
            onClick={() => setView("product")}
          >
            Store ({storeTotalItems})
          </button>
          <button
            className={`px-4 py-1.5 rounded-full ${
              view === "service"
                ? "bg-[var(--accent-primary)] text-white"
                : "text-[var(--text-secondary)]"
            }`}
            onClick={() => setView("service")}
          >
            Services ({serviceTotalItems})
          </button>
        </div>
      </div>

      {/* Empty State */}
      <AnimatePresence>
        {isEmpty ? (
          <motion.div
            key="empty"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 20 }}
            transition={{ duration: 0.4 }}
            className="flex flex-col items-center justify-center flex-1 text-[var(--text-secondary)] py-24"
          >
            <ShoppingBag className="w-12 h-12 mb-3 opacity-70" />
            <p className="text-lg font-medium mb-1">
              {view === "product"
                ? "Your store cart is empty"
                : "No service bookings yet"}
            </p>
            <button
              onClick={() =>
                router.push(view === "product" ? "/store" : "/services")
              }
              className="mt-4 px-5 py-2 bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]
                         hover:opacity-95 text-white font-semibold rounded-xl shadow-md transition active:scale-95"
            >
              {view === "product" ? "Shop Now" : "Browse Services"}
            </button>
          </motion.div>
        ) : (
          <div className="flex flex-col space-y-4 pb-32">
            {items.map((item) => (
              <motion.div
                key={`${view}-${item.id}`}
                layout
                className="flex items-center justify-between p-4 rounded-2xl border
                           bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                           border-[var(--border-soft)]
                           shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.25)]
                           hover:shadow-[0_8px_20px_rgba(0,0,0,0.08)] dark:hover:shadow-[0_8px_20px_rgba(0,0,0,0.35)]
                           transition-all duration-300"
              >
                <div className="flex items-center gap-3">
                  {item.image_url ? (
                    <Image
                      src={item.image_url}
                      alt={item.title}
                      width={64}
                      height={64}
                      className="w-16 h-16 rounded-xl object-cover border border-[var(--border-soft)]"
                    />
                  ) : (
                    <div className="w-16 h-16 rounded-xl flex items-center justify-center text-[var(--text-muted)]"
                      style={{ background: "var(--surface-overlay)" }}>
                      üß∞
                    </div>
                  )}
                  <div className="flex flex-col">
                    <span className="font-medium">{item.title}</span>
                    {item.category && (
                      <span className="text-xs opacity-70">
                        {item.category}
                      </span>
                    )}
                  </div>
                </div>

                <div className="flex flex-col items-end gap-2">
                  <div className="flex items-center border border-[var(--border-soft)] rounded-full overflow-hidden bg-[var(--surface-input)] dark:bg-[var(--surface-input-dark)] backdrop-blur">
                    <button
                      onClick={() => decrement(item.id)}
                      className="p-1.5 text-[var(--accent-primary)] hover:bg-[var(--surface-hover)] transition"
                      aria-label="Decrease quantity"
                    >
                      <Minus size={14} />
                    </button>
                    <span className="px-3 text-sm font-medium">
                      {item.quantity}
                    </span>
                    <button
                      onClick={() => increment(item.id)}
                      className="p-1.5 text-[var(--accent-primary)] hover:bg-[var(--surface-hover)] transition"
                      aria-label="Increase quantity"
                    >
                      <Plus size={14} />
                    </button>
                  </div>

                  <button
                    onClick={() => removeItem(item.id)}
                    className="text-xs text-[var(--accent-danger)] hover:opacity-80 flex items-center gap-1 transition"
                  >
                    <Trash2 size={12} /> Remove
                  </button>
                </div>
              </motion.div>
            ))}
          </div>
        )}
      </AnimatePresence>

      {/* Bottom Summary Bar */}
      {!isEmpty && (
        <motion.div
          initial={{ y: 80, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ duration: 0.4 }}
          className="sticky bottom-[calc(var(--mbnav-h,72px)+env(safe-area-inset-bottom))]
                     z-50 max-w-3xl mx-auto
                     rounded-t-3xl border-t
                     bg-[var(--surface-elevated)] dark:bg-[var(--surface-elevated-dark)]
                     border-[var(--border-muted)]
                     backdrop-blur-xl shadow-[0_-6px_20px_rgba(0,0,0,0.08)]
                     flex justify-between items-center gap-4 px-5 py-4
                     transition-all duration-500"
        >
          <div>
            <p className="text-sm opacity-70">
              {totalItems} item{totalItems !== 1 ? "s" : ""}
            </p>
            <p className="text-lg font-semibold text-[var(--accent-success)]">
              {formatInr(totalPrice)}
            </p>
          </div>

          <button
            onClick={() =>
              router.push(
                view === "product" ? "/checkout" : "/checkout?type=service"
              )
            }
            className="flex items-center gap-2 bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]
                       hover:opacity-90 text-white font-semibold px-6 py-2 rounded-xl shadow-md
                       active:scale-95 transition"
          >
            {view === "product"
              ? "Proceed to Checkout"
              : "Book Service Visit"}{" "}
            <ArrowRight size={18} />
          </button>
        </motion.div>
      )}
    </section>
  );
}


--- app/checkout/page.tsx ---
"use client";

/**
 * ============================================================
 * ü™∂ HomeFix Checkout ‚Äî Edith Continuum v12.3 (Refactored)
 * ------------------------------------------------------------
 * ‚úÖ Legacy MapPicker compatible (no apiKey prop)
 * ‚úÖ Fixed all template literals, JSX, imports
 * ‚úÖ 100% build-safe
 * ============================================================
 */

export const dynamic = "force-dynamic";
export const fetchCache = "force-no-store";

import SafeViewport from "@/components/layout/SafeViewport";
import { useLedgerX } from "@/components/ledgerx/useLedgerX";
import type { Coordinates } from "@/components/MapPicker";
import {
  type CartItem,
  useProductCartStore,
  useServiceCartStore,
} from "@/components/store/cartStore";
import { Button } from "@/components/ui/button";
import { useUser } from "@/contexts/UserContext";
import { AnimatePresence, motion } from "framer-motion";
import { CheckCircle, Loader2, MapPin, WifiOff, Wrench } from "lucide-react";
import { nanoid } from "nanoid";
import NextDynamic from "next/dynamic";
import { useRouter, useSearchParams } from "next/navigation";
import { ChangeEventHandler, useEffect, useMemo, useState } from "react";
type Item = CartItem;

const MapPicker = NextDynamic(() => import("@/components/MapPicker"), {
  ssr: false,
  loading: () => (
    <div className="w-full h-[320px] rounded-xl bg-[var(--edith-surface-hover)] animate-pulse" />
  ),
});

interface ToastMessage {
  text: string;
  type: "info" | "success" | "error";
}

interface InputProps {
  label: string;
  value: string;
  onChange: (value: string) => void;
  type?: "text" | "tel";
  disabled?: boolean;
}

interface CardProps {
  title: string;
  children: React.ReactNode;
}

/* =================================================================== */
/* MAIN CHECKOUT PAGE */
/* =================================================================== */

export default function CheckoutPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { user } = useUser();
  const { addEntry } = useLedgerX();

  const productItems = useProductCartStore((s) => s.items);
  const productTotalPrice = useProductCartStore((s) => s.totalPrice);

  const serviceItems = useServiceCartStore((s) => s.items);
  const serviceTotalPrice = useServiceCartStore((s) => s.totalPrice);

  const forcedServiceMode = searchParams?.get("type") === "service";
  const checkoutMode: "product" | "service" =
    forcedServiceMode || (serviceItems.length && !productItems.length)
      ? "service"
      : "product";

  const items = checkoutMode === "service" ? serviceItems : productItems;
  const cartTotalPrice =
    checkoutMode === "service" ? serviceTotalPrice : productTotalPrice;
  const hasProducts = checkoutMode === "product";
  const hasServices = checkoutMode === "service";
  const total = hasServices ? 0 : cartTotalPrice;
  const payableLabel = hasProducts
    ? "Total (Delivery)"
    : "Booking (no upfront charge)";
  const buttonLabel = hasProducts ? "Confirm & Pay" : "Confirm Visit";

  /* STATE */
  const [coords, setCoords] = useState<Coordinates>({
    lat: 13.0827,
    lng: 80.2707 /*  */,
  });

  const [liveAddress, setLiveAddress] = useState("");
  const [confirmedAddress, setConfirmedAddress] = useState("");
  const [landmark, setLandmark] = useState("");
  const [receiverName, setReceiverName] = useState("");
  const [receiverPhone, setReceiverPhone] = useState("");
  const [sameAsUser, setSameAsUser] = useState(false);
  const [serviceContactName, setServiceContactName] = useState("");
  const [serviceContactPhone, setServiceContactPhone] = useState("");
  const [preferredDate, setPreferredDate] = useState("");
  const [preferredSlot, setPreferredSlot] = useState("09:00 - 12:00");
  const [projectNotes, setProjectNotes] = useState("");

  const [online, setOnline] = useState(true);
  const [loading, setLoading] = useState(false);
  const [toastMsg, setToastMsg] = useState<ToastMessage | null>(null);
  const [uid, setUid] = useState<string | null>(null);

  const createToast = (text: string, type: ToastMessage["type"]) => {
    setToastMsg({ text, type });
    setTimeout(() => setToastMsg(null), 3000);
  };

  /* UID RESOLUTION */
  useEffect(() => {
    const determineUid = () => {
      const cachedUser = localStorage.getItem("user");
      let determinedUid: string | null = null;

      if (user?.id) {
        determinedUid = user.id;
      } else if (cachedUser) {
        try {
          const parsed = JSON.parse(cachedUser);
          determinedUid = parsed?.id || null;
        } catch {
          determinedUid = null;
        }
      }

      if (!determinedUid) {
        const guest =
          localStorage.getItem("hf_guest_id") || `guest-${nanoid(10)}`;
        localStorage.setItem("hf_guest_id", guest);
        determinedUid = guest;
      }

      setUid(determinedUid);
    };

    determineUid();
  }, [user]);

  /* Autofill */
  useEffect(() => {
    const u =
      user ||
      JSON.parse(localStorage.getItem("user") || "null") ||
      JSON.parse(sessionStorage.getItem("user") || "null");

    if (sameAsUser && u) {
      setReceiverName(u.name || "");
      setReceiverPhone(u.phone || "");
    }
  }, [sameAsUser, user]);

  useEffect(() => {
    if (user?.name && !serviceContactName) {
      setServiceContactName(user.name);
    }
    if (user?.phone && !serviceContactPhone) {
      setServiceContactPhone(user.phone);
    }
  }, [user?.name, user?.phone, serviceContactName, serviceContactPhone]);

  /* ONLINE WATCHER */
  useEffect(() => {
    const updateOnline = () => setOnline(navigator.onLine);
    updateOnline();
    window.addEventListener("online", updateOnline);
    window.addEventListener("offline", updateOnline);
    return () => {
      window.removeEventListener("online", updateOnline);
      window.removeEventListener("offline", updateOnline);
    };
  }, []);

  /* VALIDATION */
  const canSubmit = useMemo(() => {
    const addr = confirmedAddress || liveAddress;
    if (!addr) return false;
    if (!online) return false;
    if (hasProducts && !receiverPhone) return false;
    if (hasServices && (!serviceContactPhone || !preferredDate)) return false;

    return items.length > 0;
  }, [
    confirmedAddress,
    liveAddress,
    receiverPhone,
    serviceContactPhone,
    preferredDate,
    online,
    hasProducts,
    hasServices,
    items,
  ]);

  /* HANDLE CHECKOUT */
  async function handleCheckout() {
    if (!canSubmit) {
      return createToast(
        !online
          ? "‚ö†Ô∏è You are offline. Please reconnect."
          : "üìç Please confirm your location.",
        "error"
      );
    }

    setLoading(true);
    createToast(
      hasServices ? "Booking your service visit..." : "Redirecting to payment...",
      "info"
    );

    const basePayload: Record<string, any> = {
      user_id: uid,
      type: checkoutMode,
      items,
      total,
      address: confirmedAddress || liveAddress,
      landmark,
      latitude: coords.lat,
      longitude: coords.lng,
      status: "pending",
      created_at: new Date().toISOString(),
    };

    if (hasProducts) {
      basePayload.receiver_name = receiverName;
      basePayload.receiver_phone = receiverPhone;
      basePayload.store_fulfillment = {
        receiver_name: receiverName,
        receiver_phone: receiverPhone,
        same_as_user: sameAsUser,
        address: confirmedAddress || liveAddress,
        landmark,
      };
      basePayload.payment = {
        mode: "upi",
        gateway: "Razorpay",
        status: "initiated",
      };
    } else {
      basePayload.receiver_name = serviceContactName;
      basePayload.receiver_phone = serviceContactPhone;
      basePayload.visit_fee = 200;
      basePayload.visit_fee_waived = false;
      basePayload.service_preferences = {
        contact_name: serviceContactName,
        contact_phone: serviceContactPhone,
        preferred_date: preferredDate,
        preferred_slot: preferredSlot,
        notes: projectNotes,
      };
      basePayload.payment = {
        mode: "visit_fee",
        gateway: "BookNowPayLater",
        status: "pending",
      };
    }

    try {
      const result = await addEntry(
        uid ?? "guest",
        hasServices ? "service-booking" : "checkout-pending",
        basePayload
      );
      if (result?.id) {
        localStorage.setItem("hf_pending_order_id", result.id);
      }

      sessionStorage.setItem(
        "hf_checkout_payload",
        JSON.stringify({
          uid: uid ?? "guest",
          payload: basePayload,
          type: checkoutMode,
        })
      );

      if (hasProducts) {
        localStorage.setItem("last_checkout_total", String(total));
      }
    } catch (err) {
      console.error("Pending ledger entry failed", err);
      // continue anyway
    }

    await new Promise((r) => setTimeout(r, 900));
    sessionStorage.setItem("checkoutInitiated", "true");

    router.push(`/mockrazorpay?type=${checkoutMode}`);
  }

  /* EMPTY CART */
  if (!items.length)
    return (
      <SafeViewport>
        <div className="flex flex-col items-center justify-center h-[70vh] text-[var(--text-secondary)]">
          <Wrench className="w-8 h-8 mb-3 opacity-60" />
          <p>Your cart is empty. Add items to continue.</p>
          <Button
            onClick={() =>
              router.push(hasProducts ? "/store" : "/services")
            }
            className="mt-4"
          >
            {hasProducts ? "Shop Now" : "Browse Services"}
          </Button>
        </div>
      </SafeViewport>
    );

  /* RENDER */
  return (
    <SafeViewport>
      <main className="flex flex-col w-full sm:max-w-2xl mx-auto px-4 sm:px-6 pb-28 min-h-[calc(100vh-120px)]">
        {!online && (
          <motion.div
            initial={{ opacity: 0, y: -10 }}
            animate={{ opacity: 1, y: 0 }}
            className="flex items-center justify-center gap-2 py-2 mb-3 rounded-lg bg-red-500/10 border border-red-500/40 text-red-600 text-sm"
          >
            <WifiOff className="w-4 h-4" />
            You‚Äôre offline ‚Äî checkout disabled
          </motion.div>
        )}

        <motion.h2
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-2xl font-bold mb-4 text-center sm:text-left"
        >
          {hasServices && !hasProducts ? "Book Free Site Visit" : "Checkout"}
        </motion.h2>

        {/* CART ITEMS */}
        {hasServices && (
          <Card title={hasProducts ? "Service Bookings" : "Selected Services"}>
            {serviceItems.map((i) => (
              <div
                key={`svc-${i.id}`}
                className="flex justify-between items-center border-b border-[var(--edith-border)] last:border-none py-2 text-sm"
              >
                <div className="flex flex-col">
                  <span className="font-semibold">{i.title}</span>
                  <span className="text-xs text-[var(--text-secondary)]">
                    {i.quantity} slot{i.quantity > 1 ? "s" : ""} ¬∑ {i.unit || i.category || "On-site"}
                  </span>
                </div>
                <span className="font-medium text-[var(--accent-success)] text-right">
                  {i.price
                    ? `Est. ?${(i.price * i.quantity).toLocaleString()}`
                    : "To be quoted"}
                </span>
              </div>
            ))}
            <p className="text-xs text-amber-600 font-medium mt-3">
              Visit Charge: ?200 ‚Äî Free if you confirm the service. You only pay when you decline the job.
            </p>
            <p className="text-xs text-[var(--text-secondary)] mt-1">
              Service visits are scheduled after we confirm your preferred slot.
              Billing happens only after you approve the quotation.
            </p>
          </Card>
        )}
        {hasProducts && (
          <Card title={hasServices ? "Store Deliveries" : "Selected Products"}>
            {productItems.map((i) => {
              const lineTotal = (i.price || 0) * i.quantity;
              return (
                <div
                  key={`prod-${i.id}`}
                  className="flex justify-between items-center border-b border-[var(--edith-border)] last:border-none py-2 text-sm"
                >
                  <div className="flex flex-col">
                    <span className="font-semibold">{i.title}</span>
                    <span className="text-xs text-[var(--text-secondary)]">
                      {i.quantity} x ?{(i.price || 0).toLocaleString()}
                    </span>
                  </div>
                  <span className="font-medium text-[var(--accent-success)]">
                    ?{lineTotal.toLocaleString()}
                  </span>
                </div>
              );
            })}
            {!hasServices && <InstallationSuggestion />}
          </Card>
        )}
        {/* LOCATION PICKER */}
        <Card title={hasProducts ? "Delivery Details" : "Service Location"}>
          {hasServices && (
            <div className="mb-3 rounded-xl border border-amber-400/50 bg-amber-50 text-amber-700 text-xs px-4 py-3">
              Visit Charge: ?200 ‚Äî Free if you confirm the service. Charged only
              if you cancel after the site visit or decline the quotation.
            </div>
          )}
          <div className="relative h-[340px] mb-6 overflow-hidden rounded-xl border border-[var(--edith-border)]">
            <MapPicker
              initialLocation={coords}
              editable
              onLocationChange={(loc, addr, confirmed) => {
                if (loc) setCoords(loc);
                const safe = addr ?? "";
                if (!!confirmed) setConfirmedAddress(safe);
                else setLiveAddress(safe);
              }}
            />
          </div>

          {/* ADDRESS STRIP */}
          <div className="flex flex-col sm:flex-row gap-3 mb-6">
            <div
              className={`flex-1 px-4 py-3 rounded-xl text-sm font-medium truncate ${
                confirmedAddress
                  ? "bg-emerald-900/10 border border-emerald-600/50"
                  : "bg-[var(--edith-surface)] border border-[var(--edith-border)]"
              }`}
            >
              {confirmedAddress ||
                liveAddress ||
                "üìç Move map to select location"}
            </div>

            <button
              onClick={() => {
                if (liveAddress) {
                  setConfirmedAddress(liveAddress);
                  createToast("Location confirmed", "success");
                  navigator.vibrate?.([15, 30]);
                } else {
                  createToast("Move map to select address", "error");
                }
              }}
              className={`relative whitespace-nowrap px-6 py-2.5 rounded-xl font-semibold text-white transition-all duration-500 ${
                confirmedAddress
                  ? "bg-emerald-600 hover:bg-emerald-700"
                  : "bg-gradient-to-r from-fuchsia-500 via-indigo-500 to-cyan-400 hover:from-fuchsia-600 hover:to-indigo-600 shadow-[0_0_16px_rgba(147,51,234,0.5)]"
              }`}
            >
              {confirmedAddress ? "Confirmed ‚úì" : "Confirm Location"}
            </button>
          </div>

          {/* CONFIRMED ADDRESS DISPLAY */}
          {hasProducts && confirmedAddress && (
            <div className="mb-6 border border-emerald-600/40 bg-emerald-900/5 rounded-xl p-3 shadow-sm">
              <label className="block text-xs font-semibold text-emerald-700 mb-1">
                Confirmed Delivery Address
              </label>
              <div className="flex items-start text-sm text-[var(--text-primary)] font-medium leading-relaxed">
                <MapPin className="inline-block w-4 h-4 mr-2 mt-0.5 text-emerald-600 flex-shrink-0" />
                <span>{confirmedAddress}</span>
              </div>
              {landmark && (
                <p className="text-xs mt-1 text-[var(--text-secondary)] italic">
                  Landmark: {landmark}
                </p>
              )}
            </div>
          )}

          {/* RECEIVER INFO */}
          {hasProducts && (
            <div className="space-y-3 relative z-[2]">
              <Input
                label="Receiver Name"
                value={receiverName}
                onChange={setReceiverName}
                disabled={sameAsUser}
              />

              <Input
                label="Receiver Phone"
                value={receiverPhone}
                onChange={setReceiverPhone}
                type="tel"
                disabled={sameAsUser}
              />

              <Input
                label="Landmark / Flat No."
                value={landmark}
                onChange={setLandmark}
              />

              <label className="flex items-center gap-2 mt-2 text-sm text-[var(--text-secondary)]">
                <input
                  type="checkbox"
                  checked={sameAsUser}
                  onChange={(e) => setSameAsUser(e.target.checked)}
                />
                I will receive it myself {user?.name ? `(as ${user.name})` : ""}
              </label>
            </div>
          )}

          {hasServices && (
            <div className="mt-6 space-y-3">
              <p className="text-sm font-semibold text-[var(--text-primary)]">
                Visit Preferences
              </p>
              <Input
                label="On-site Contact Name"
                value={serviceContactName}
                onChange={setServiceContactName}
              />
              <Input
                label="On-site Contact Phone"
                value={serviceContactPhone}
                onChange={setServiceContactPhone}
                type="tel"
              />

              <div>
                <label className="block text-sm font-medium mb-2 text-[var(--text-secondary)]">
                  Preferred Visit Date
                </label>
                <input
                  type="date"
                  value={preferredDate}
                  onChange={(e) => setPreferredDate(e.target.value)}
                  className="w-full p-2 rounded-lg border border-[var(--edith-border)] bg-[var(--edith-surface)] text-sm focus:ring-2 focus:ring-[var(--edith-primary)]"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2 text-[var(--text-secondary)]">
                  Preferred Time Slot
                </label>
                <select
                  value={preferredSlot}
                  onChange={(e) => setPreferredSlot(e.target.value)}
                  className="w-full p-2 rounded-lg border border-[var(--edith-border)] bg-[var(--edith-surface)] text-sm focus:ring-2 focus:ring-[var(--edith-primary)]"
                >
                  <option value="09:00 - 12:00">Morning (9am - 12pm)</option>
                  <option value="12:00 - 15:00">Midday (12pm - 3pm)</option>
                  <option value="15:00 - 18:00">Evening (3pm - 6pm)</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2 text-[var(--text-secondary)]">
                  Project Notes / Access Info
                </label>
                <textarea
                  value={projectNotes}
                  onChange={(e) => setProjectNotes(e.target.value)}
                  rows={3}
                  placeholder="Share requirements, parking info, or gate access details"
                  className="w-full p-3 rounded-lg border border-[var(--edith-border)] bg-[var(--edith-surface)] text-sm focus:ring-2 focus:ring-[var(--edith-primary)] resize-none"
                />
              </div>
            </div>
          )}
        </Card>

        {/* FOOTER */}
        <footer className="fixed bottom-0 left-0 right-0 z-50 flex justify-between items-center px-5 py-4 w-full sm:max-w-2xl mx-auto rounded-t-2xl bg-[var(--edith-surface)] border-t border-[var(--edith-border)] backdrop-blur-md">
          <div>
            <p className="text-sm text-[var(--text-secondary)]">
              {payableLabel}
            </p>
            <p className="text-lg font-semibold text-[var(--accent-success)]">
              ?{(hasProducts ? total : 0).toLocaleString()}
            </p>
            {hasServices && (
              <p className="text-[11px] text-[var(--text-secondary)] mt-1">
                Services move ahead once you approve the quotation.
              </p>
            )}
          </div>

          <Button
            onClick={handleCheckout}
            disabled={loading || !canSubmit}
            className="font-semibold px-5 sm:px-6 py-2 rounded-xl"
          >
            {loading ? (
              <Loader2 className="animate-spin w-5 h-5" />
            ) : (
              buttonLabel
            )}
          </Button>
        </footer>

        {/* TOAST */}
        <AnimatePresence>
          {toastMsg && (
            <motion.div
              key={toastMsg.text}
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 10 }}
              className={`fixed bottom-28 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl shadow-lg text-sm ${
                toastMsg.type === "success"
                  ? "bg-green-600 text-white"
                  : toastMsg.type === "error"
                  ? "bg-red-600 text-white"
                  : "bg-gray-700 text-white"
              }`}
            >
              <div className="flex justify-center items-center gap-2">
                {toastMsg.type === "success" && (
                  <CheckCircle className="w-4 h-4" />
                )}
                {toastMsg.text}
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </main>
    </SafeViewport>
  );
}

/* =================================================================== */
/* SUBCOMPONENTS */
/* =================================================================== */

function Input({
  label,
  value,
  onChange,
  type = "text",
  disabled = false,
}: InputProps) {
  const handleChange: ChangeEventHandler<HTMLInputElement> = (e) => {
    onChange(e.target.value);
  };

  return (
    <div>
      <label className="block text-sm font-medium mb-2 text-[var(--text-secondary)]">
        {label}
      </label>

      <input
        type={type}
        value={value}
        onChange={handleChange}
        disabled={disabled}
        className={`w-full p-2 rounded-lg border border-[var(--edith-border)] bg-[var(--edith-surface)] text-sm focus:ring-2 focus:ring-[var(--edith-primary)] ${
          disabled ? "opacity-70 pointer-events-none" : ""
        }`}
      />
    </div>
  );
}

function Card({ title, children }: CardProps) {
  return (
    <section className="p-4 sm:p-5 rounded-xl border border-[var(--edith-border)] bg-[var(--edith-surface)] shadow-[0_4px_20px_rgba(0,0,0,0.05)] mb-4">
      <h3 className="font-semibold mb-3 text-base text-[var(--text-primary)]">
        {title}
      </h3>
      {children}
    </section>
  );
}

function InstallationSuggestion() {
  return (
    <div className="mt-4 rounded-xl border border-indigo-200/60 bg-indigo-50/60 dark:bg-indigo-900/30 p-4 text-sm text-indigo-900 dark:text-indigo-100">
      <p className="font-semibold mb-1">Need professional installation?</p>
      <p className="text-xs opacity-80">
        Our carpenters and installers can help assemble flooring, panels, and
        fittings you&apos;re buying. Add a service booking after checkout or{" "}
        <a
          href="/services?tab=carpentry"
          className="underline font-medium text-indigo-700 dark:text-indigo-200"
        >
          chat with a carpenter now
        </a>{" "}
        for recommendations.
      </p>
    </div>
  );
}






--- app/checkout/success/page.tsx ---
"use client";
/**
 * Checkout Success
 * - Supports product vs service flows (Book-now-pay-later)
 * - Confetti, CTA shortcuts, and safe copy for compliance
 */

import { Button } from "@/components/ui/button";
import confetti from "canvas-confetti";
import { AnimatePresence, motion } from "framer-motion";
import { CheckCircle, Home, Package } from "lucide-react";
import { useRouter, useSearchParams } from "next/navigation";
import { useEffect, useMemo, useState } from "react";

declare module "canvas-confetti" {
  interface ConfettiOptions {
    startVelocity?: number;
  }
}

const formatInr = (value: number) =>
  new Intl.NumberFormat("en-IN", {
    style: "currency",
    currency: "INR",
    minimumFractionDigits: 2,
  }).format(value);

export default function CheckoutSuccessPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [mounted, setMounted] = useState(false);

  const isServiceFlow = searchParams?.get("type") === "service";
  const total = useMemo(() => {
    if (isServiceFlow) return null;
    const raw = localStorage.getItem("last_checkout_total");
    return raw ? Number(raw) : null;
  }, [isServiceFlow]);

  useEffect(() => {
    setMounted(true);
    const colors = ["#10b981", "#34d399", "#6ee7b7"];
    const duration = 2000;
    const end = Date.now() + duration;

    (function frame() {
      (confetti as any)({
        particleCount: 4,
        startVelocity: 25,
        angle: 60,
        spread: 55,
        origin: { x: 0 },
        colors,
      });
      (confetti as any)({
        particleCount: 4,
        startVelocity: 25,
        angle: 120,
        spread: 55,
        origin: { x: 1 },
        colors,
      });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();

    navigator.vibrate?.([25, 50]);
  }, []);

  const ordersLink = isServiceFlow ? "/my-orders?tab=service" : "/my-orders";

  return (
    <main className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-[var(--edith-bg)] to-[var(--edith-surface)] px-6 text-center">
      <AnimatePresence>
        {mounted && (
          <motion.div
            key="success-card"
            initial={{ opacity: 0, y: 30 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            className="bg-[var(--edith-surface-hover)] rounded-2xl shadow-lg backdrop-blur-xl p-8 w-full sm:max-w-md border border-[var(--edith-border)]"
          >
            <CheckCircle className="w-16 h-16 mx-auto text-green-500 mb-3" />
            <h1 className="text-2xl font-semibold text-[var(--text-primary)]">
              {isServiceFlow ? "Service Visit Booked!" : "Order Confirmed!"}
            </h1>
            <p className="text-sm text-[var(--text-secondary)] mt-2">
              {isServiceFlow
                ? "Your technician will reach out shortly. Visit fee is charged only if you decline the quotation."
                : "Your payment was successful. Thank you for choosing HomeFix."}
            </p>

            {!isServiceFlow && total !== null && (
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.4 }}
                className="mt-6 bg-[var(--edith-surface)] rounded-xl p-4 text-left border border-[var(--edith-border)]"
              >
                <p className="text-xs text-[var(--text-secondary)] mb-1">
                  Transaction ID
                </p>
                <p className="font-mono text-[var(--text-primary)] text-sm">
                  MOCK-{new Date().getTime()}
                </p>
                <div className="flex justify-between items-center mt-3">
                  <p className="text-sm opacity-80">Total</p>
                  <p className="text-lg font-semibold text-green-500">
                    {formatInr(total)}
                  </p>
                </div>
                <p className="text-xs opacity-60 mt-3">
                  {new Date().toLocaleString()}
                </p>
              </motion.div>
            )}

            <div className="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
              <Button
                onClick={() => router.push(ordersLink)}
                className="flex items-center justify-center gap-2 bg-[var(--accent-success)] hover:bg-[var(--accent-success-hover)] text-white w-full sm:w-auto"
              >
                <Package className="w-4 h-4" />
                View My Orders
              </Button>

              <Button
                variant="outline"
                onClick={() => router.push("/")}
                className="flex items-center justify-center gap-2 border-[var(--accent-success)] text-[var(--accent-success)] hover:bg-emerald-50 w-full sm:w-auto"
              >
                <Home className="w-4 h-4" />
                Back Home
              </Button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </main>
  );
}


--- app/estimator/page.tsx ---
// üö® REQUIRED: stops Next from prerendering this route
import dynamicImport from "next/dynamic";

export const dynamic = "force-dynamic";
export const fetchCache = "force-no-store";

export const metadata = {
  title: "HomeFix Interior Estimator",
  description:
    "Kitchen & Wardrobe Estimator ‚Äî HomeFix India ¬∑ Edith Technologies",
};

const EstimatorPageClient = dynamicImport(
  () => import("@/components/estimator/EstimatorPageClient"),
  { ssr: false }
);

export default function EstimatorPage() {
  return <EstimatorPageClient />;
}

--- app/layout.tsx ---
import { RootShell } from "@/components/layout";
import type { Metadata, Viewport } from "next";
import { ThemeProvider } from "next-themes";
import "./globals.css";

/* ------------------------------------------------------------
   üß≠ Metadata + Viewport ‚Äî Edith SafeViewport v10.1
------------------------------------------------------------ */
export const metadata: Metadata = {
  title: "HomeFix India",
  description:
    "Smart home services & interior design platform by Aesthetic Homes.",
  manifest: "/manifest.json",
  icons: {
    icon: "/icons/icon-192x192.png",
    apple: "/icons/icon-512x512.png",
  },
  applicationName: "HomeFix India",
  appleWebApp: {
    capable: true,
    title: "HomeFix India",
    statusBarStyle: "black-translucent",
  },
  other: {
    "mobile-web-app-capable": "yes",
  },
};

export const viewport: Viewport = {
  themeColor: [
    { media: "(prefers-color-scheme: light)", color: "#5A5DF0" },
    { media: "(prefers-color-scheme: dark)", color: "#EC6ECF" },
  ],
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  viewportFit: "cover",
};

/* ------------------------------------------------------------
   üåó Root Layout (Server) ‚Äî SafeViewport host
   ------------------------------------------------------------
   ‚úÖ RootShell owns header/sidebar/nav/scroll
   ‚úÖ Body safe for PWA + iOS
   ‚úÖ No double padding or hidden overflow
------------------------------------------------------------ */
export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        {/* ‚úÖ PWA Essentials */}
        <link rel="manifest" href="/manifest.json" />
        <link rel="icon" href="/icons/icon-192x192.png" sizes="192x192" />
        <link rel="apple-touch-icon" href="/icons/icon-512x512.png" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="application-name" content="HomeFix India" />
        <meta
          name="apple-mobile-web-app-status-bar-style"
          content="black-translucent"
        />
      </head>

      <body
        suppressHydrationWarning
        className="antialiased
                   bg-[var(--surface-base)]
                   text-[var(--text-primary-light)] dark:text-[var(--text-primary-dark)]
                   selection:bg-[var(--edith-selection-bg-light)] selection:text-[var(--edith-selection-text-light)]
                   dark:selection:bg-[var(--edith-selection-bg-dark)] dark:selection:text-[var(--edith-selection-text-dark)]
                   transition-colors duration-500"
      >
        <ThemeProvider
          attribute="class"
          defaultTheme="system"
          enableSystem
          disableTransitionOnChange
        >
          {/* üß± RootShell provides SafeViewport + scroll + toasts */}
          <RootShell>{children}</RootShell>
        </ThemeProvider>
      </body>
    </html>
  );
}

--- app/login/page.tsx ---
"use client";

/**
 * ============================================================
 * ü™™ FILE: /app/login/page.tsx
 * FIXED VERSION v15.0 ‚Äî Supabase-session-safe login
 * ------------------------------------------------------------
 * ‚úÖ Creates REAL Supabase session after OTP verify
 * ‚úÖ Removes duplicate localStorage user writes
 * ‚úÖ Prevents UID=undefined issue (LedgerX + My Orders fix)
 * ============================================================
 */

import OTPInput from "@/components/OTPInput";
import { useUser } from "@/contexts/UserContext";
import { useToast } from "@/hooks/use-toast";
import { useOtpManager } from "@/hooks/useOtpManager";
import { supabase } from "@/lib/supabaseClient";
import { AnimatePresence, motion } from "framer-motion";
import { Check, Phone } from "lucide-react";
import { useRouter } from "next/navigation";
import { useCallback, useEffect, useRef, useState } from "react";

interface HomeFixUser {
  id?: string;
  phone: string;
  phone_verified: boolean;
  role: string;
  loggedIn: boolean;
  email?: string;
  name?: string;
  address?: string;
  latitude?: number;
  longitude?: number;
}

export default function LoginPage() {
  const { login } = useUser();
  const router = useRouter();
  const {
    sendOtp,
    verifyOtp,
    loading: otpLoading,
    verifying: otpVerifying,
  } = useOtpManager();
  const { success, error } = useToast();

  const [panel, setPanel] = useState<"form" | "otp" | "success">("form");
  const [phone, setPhone] = useState(
    typeof window !== "undefined"
      ? localStorage.getItem("hf_last_phone") || ""
      : ""
  );
  const [otp, setOtp] = useState("");
  const [loading, setLoading] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);

  const otpRefs = useRef<HTMLInputElement[]>([]);
  const phoneDigits = phone.replace(/\D/g, "");

  /* ------------------------------------------------------------
     üöÄ Redirect if already logged in
  ------------------------------------------------------------ */
  useEffect(() => {
    (async () => {
      const cached = JSON.parse(localStorage.getItem("user") || "null");
      if (cached?.loggedIn || cached?.phone_verified) {
        router.replace("/profile");
        return;
      }
      const { data } = await supabase.auth.getUser();
      if (data?.user) router.replace("/profile");
    })();
  }, [router]);

  /* ------------------------------------------------------------
     üì© Send OTP
  ------------------------------------------------------------ */
  const handleSendOtp = useCallback(async () => {
    if (isProcessing || otpLoading || loading) return;

    if (phoneDigits.length !== 10) {
      error("Please enter a valid 10-digit mobile number.");
      return;
    }

    setIsProcessing(true);
    setLoading(true);

    try {
      const sent = await sendOtp(phoneDigits, "phone");
      if (sent) {
        success(`OTP sent to +91 ${phoneDigits}`);
        navigator.vibrate?.(30);
        setPanel("otp");
        setTimeout(() => otpRefs.current[0]?.focus(), 300);
      } else {
        error("Failed to send OTP. Please try again.");
      }
    } catch (err) {
      console.error("[OTP Send]", err);
      error("Server error while sending OTP.");
    } finally {
      setLoading(false);
      setTimeout(() => setIsProcessing(false), 300);
    }
  }, [
    error,
    isProcessing,
    loading,
    otpLoading,
    phoneDigits,
    sendOtp,
    success,
  ]);

  /* ------------------------------------------------------------
     üîê Verify OTP + Create Supabase session
  ------------------------------------------------------------ */
  const handleVerifyOtp = useCallback(async () => {
    if (isProcessing || otpVerifying) return;
    if (otp.length !== 6) {
      error("Please enter the 6-digit OTP.");
      return;
    }

    setIsProcessing(true);

    try {
      const verified = await verifyOtp(otp, phoneDigits, "phone");
      if (!verified) {
        error("Invalid OTP.");
        navigator.vibrate?.([120]);
        return;
      }

      const phoneFull = `+91${phoneDigits}`;

      // üî• Your backend must return tokens
      const res = await fetch("/api/auth/upsert-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: phoneFull, verified: true }),
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.error);

      // ----------------------------------------------------------
      // üî• 1. Set REAL Supabase session (Fixes UID + LedgerX)
      // ----------------------------------------------------------
      if (data.access_token && data.refresh_token) {
        await supabase.auth.setSession({
          access_token: data.access_token,
          refresh_token: data.refresh_token,
        });
      }

      // ----------------------------------------------------------
      // üî• 2. Build user object
      // ----------------------------------------------------------
      const userData: HomeFixUser = {
        id: data.id,
        phone: phoneFull,
        phone_verified: true,
        role: "client",
        loggedIn: true,
        name: data.profile?.name ?? null,
        email: data.profile?.email ?? null,
        address: data.profile?.address ?? null,
      };

      // ----------------------------------------------------------
      // üî• 3. Login through UserContext
      //    (DO NOT write to localStorage manually)
      // ----------------------------------------------------------
      login(userData, true);

      // ----------------------------------------------------------
      // üî• 4. Set cookies
      // ----------------------------------------------------------
      document.cookie = `hf_user_phone=${phoneFull}; Path=/; Max-Age=604800`;
      document.cookie = `hf_user_id=${data.id}; Path=/; Max-Age=604800`;

      success("Welcome to HomeFix ‚Äî Login successful!");
      navigator.vibrate?.([60, 40, 120]);
      setPanel("success");

      setTimeout(() => router.replace("/profile"), 1600);
    } catch (err) {
      console.error("[Verify OTP]", err);
      error("Verification failed. Please try again.");
      navigator.vibrate?.([120]);
    } finally {
      setTimeout(() => setIsProcessing(false), 400);
    }
  }, [
    error,
    isProcessing,
    login,
    otp,
    otpVerifying,
    phoneDigits,
    router,
    success,
    verifyOtp,
  ]);

  /* ------------------------------------------------------------
     ‚å®Ô∏è Enter Key Handler
  ------------------------------------------------------------ */
  useEffect(() => {
    function handleKeyPress(e: KeyboardEvent) {
      if (e.key === "Enter") {
        e.preventDefault();
        if (panel === "form") handleSendOtp();
        if (panel === "otp") handleVerifyOtp();
      }
    }
    window.addEventListener("keydown", handleKeyPress);
    return () => window.removeEventListener("keydown", handleKeyPress);
  }, [panel, phone, otp, handleSendOtp, handleVerifyOtp]);

  /* Panels‚Ä¶ (unchanged UI code below)
  ------------------------------------------------------------ */

  const FormPanel = (
    <div className="p-6 sm:p-8 relative">
      <motion.div
        className="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-emerald-500 via-lime-400 to-green-600 rounded-t-3xl"
        layoutId="glow"
      />
      <h2 className="text-xl font-semibold text-emerald-700 dark:text-emerald-400 mb-4">
        Welcome to HomeFix
      </h2>

      <label className="text-sm text-gray-600 dark:text-gray-300">
        Mobile Number
      </label>
      <div className="flex items-center gap-2 border rounded-xl px-3 py-2 mb-3 bg-white dark:bg-slate-800 dark:border-slate-600">
        <Phone size={18} className="text-emerald-600 dark:text-emerald-400" />
        <input
          type="tel"
          inputMode="numeric"
          placeholder="10-digit mobile number"
          value={phone}
          onChange={(e) =>
            setPhone(e.target.value.replace(/\D/g, "").slice(0, 10))
          }
          className="flex-1 bg-transparent outline-none text-sm text-gray-900 dark:text-gray-100"
        />
      </div>

      <label className="flex items-center gap-2 mb-5 text-sm text-gray-600 dark:text-gray-300">
        <input
          type="checkbox"
          checked
          readOnly
          className="accent-emerald-600"
        />
        <span>Remember me</span>
      </label>

      <button
        onClick={handleSendOtp}
        disabled={loading || otpLoading || isProcessing}
        className="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition active:scale-[0.97]"
      >
        {loading || otpLoading ? "Sending..." : "Send OTP"}
      </button>
    </div>
  );

  const OtpPanel = (
    <div className="p-6 sm:p-8 text-center">
      <h2 className="text-lg font-semibold text-emerald-700 dark:text-emerald-400 mb-2">
        Verify OTP
      </h2>
      <p className="text-sm text-gray-600 dark:text-gray-300 mb-2">
        Enter OTP sent to +91 {phoneDigits}
      </p>
      <OTPInput otp={otp} setOtp={setOtp} refs={otpRefs} />
      <button
        onClick={handleVerifyOtp}
        disabled={otpVerifying || isProcessing}
        className="w-full mt-4 py-3 rounded-xl bg-orange-600 hover:bg-orange-700 text-white font-semibold transition active:scale-[0.97]"
      >
        {otpVerifying ? "Verifying..." : "Verify OTP"}
      </button>
    </div>
  );

  const SuccessPanel = (
    <div className="p-8 text-center">
      <motion.div
        initial={{ scale: 0.5 }}
        animate={{ scale: 1 }}
        transition={{ type: "spring", stiffness: 200, damping: 20 }}
        className="w-20 h-20 bg-green-600 text-white mx-auto rounded-full flex items-center justify-center shadow-xl"
      >
        <Check size={40} />
      </motion.div>
      <p className="mt-3 text-green-600 dark:text-green-400 font-semibold">
        Login Successful
      </p>
    </div>
  );

  return (
    <main className="min-h-screen flex items-end sm:items-center justify-center bg-[var(--surface-base)] relative">
      <motion.div
        initial={{ opacity: 0, y: 40 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
        className="w-full max-w-md bg-white dark:bg-slate-900 rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-[10000]"
      >
        <AnimatePresence mode="wait">
          {panel === "form" && <motion.div key="form">{FormPanel}</motion.div>}
          {panel === "otp" && <motion.div key="otp">{OtpPanel}</motion.div>}
          {panel === "success" && (
            <motion.div key="success">{SuccessPanel}</motion.div>
          )}
        </AnimatePresence>
      </motion.div>
    </main>
  );
}

--- app/mockrazorpay/page.tsx ---
"use client";
import { useLedgerX } from "@/components/ledgerx/useLedgerX";
import {
  useProductCartStore,
  useServiceCartStore,
} from "@/components/store/cartStore";
import { AnimatePresence, motion } from "framer-motion";
import { CheckCircle, Loader2, SmartphoneNfc } from "lucide-react";
import { useRouter, useSearchParams } from "next/navigation";
import { useEffect, useState } from "react";

export default function MockRazorpayPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const checkoutType =
    searchParams?.get("type") === "service" ? "service" : "product";
  const { addEntry } = useLedgerX();
  const clearProductCart = useProductCartStore((s) => s.clearCart);
  const clearServiceCart = useServiceCartStore((s) => s.clearCart);
  const clearCart =
    checkoutType === "service" ? clearServiceCart : clearProductCart;

  const [stage, setStage] = useState<"processing" | "authorizing" | "success">(
    "processing"
  );

  useEffect(() => {
    const t1 = setTimeout(() => setStage("authorizing"), 1800);
    const t2 = setTimeout(() => {
      setStage("success");
      sessionStorage.setItem("checkoutPaymentStatus", "success");
      localStorage.setItem("checkoutCompleted", "true");

      if (navigator.vibrate) navigator.vibrate([25, 90]);
    }, 3500);

    return () => {
      clearTimeout(t1);
      clearTimeout(t2);
    };
  }, [router]);

  useEffect(() => {
    if (stage !== "success") return;

    let cancelled = false;
    let redirectTimer: NodeJS.Timeout | null = null;

    const finalizePayment = async () => {
      try {
        const raw = sessionStorage.getItem("hf_checkout_payload");
        if (!raw) {
          redirectTimer = setTimeout(() => router.push("/my-orders"), 1800);
          return;
        }

        const parsed = JSON.parse(raw);
        const payload = {
          ...(parsed?.payload || {}),
          status: checkoutType === "service" ? "pending" : "paid",
          payment: {
            ...(parsed?.payload?.payment || {}),
            status:
              checkoutType === "service"
                ? "scheduled"
                : parsed?.payload?.payment?.status ?? "success",
            txn_id:
              checkoutType === "service"
                ? undefined
                : parsed?.payload?.payment?.txn_id || `MOCK-${Date.now()}`,
          },
        };

        if (cancelled) return;
        await addEntry(parsed?.uid ?? "guest", "checkout-paid", payload);
        clearCart();

        sessionStorage.removeItem("hf_checkout_payload");
        sessionStorage.removeItem("checkoutPaymentStatus");
        localStorage.removeItem("checkoutCompleted");
        localStorage.removeItem("hf_pending_order_id");
      } catch (err) {
        console.error("[MockRazorpay] finalize payment failed:", err);
      } finally {
        if (!cancelled) {
          redirectTimer = setTimeout(
            () => router.push(`/checkout/success?type=${checkoutType}`),
            1800
          );
        }
      }
    };

    finalizePayment();

    return () => {
      cancelled = true;
      if (redirectTimer) clearTimeout(redirectTimer);
    };
  }, [stage, addEntry, clearCart, router, checkoutType]);

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-[var(--edith-bg)] to-[var(--edith-surface)] text-center px-6 relative overflow-hidden">
      {/* Ambient Background Aura */}
      <motion.div
        className="absolute inset-0 opacity-[0.3] bg-[radial-gradient(circle_at_center,rgba(99,102,241,0.45),transparent_70%)]"
        animate={{
          backgroundPosition: ["0% 0%", "120% 120%", "0% 0%"],
        }}
        transition={{
          repeat: Infinity,
          duration: 12,
          ease: "linear",
        }}
      />

      <AnimatePresence mode="wait">
        {stage === "processing" && (
          <StageCard
            key="processing"
            icon={
              <Loader2 className="w-14 h-14 mx-auto mb-5 animate-spin text-indigo-500" />
            }
            title={
              checkoutType === "service"
                ? "Securing your booking."
                : "Processing payment."
            }
            subtitle={
              checkoutType === "service"
                ? "Reserving your service slot and technician."
                : "Connecting with your bank."
            }
          />
        )}

        {stage === "authorizing" && (
          <StageCard
            key="authorizing"
            icon={
              <SmartphoneNfc className="w-14 h-14 mx-auto mb-5 text-indigo-400" />
            }
            title={
              checkoutType === "service"
                ? "Coordinating visit details"
                : "Awaiting authorization"
            }
            subtitle={
              checkoutType === "service"
                ? "Confirming technician availability for your preferred slot."
                : "Approve payment on your UPI device."
            }
            pulse
          />
        )}

        {stage === "success" && (
          <motion.div
            key="success"
            initial={{ opacity: 0, scale: 0.7 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ type: "spring", stiffness: 90, damping: 12 }}
            className="relative z-10 bg-[var(--edith-surface-hover)] border border-emerald-500/40 rounded-3xl p-10 shadow-2xl backdrop-blur-xl max-w-sm w-full"
          >
            <motion.div
              initial={{ scale: 0 }}
              animate={{ scale: 1.2 }}
              transition={{ type: "spring", stiffness: 100, damping: 8 }}
              className="mb-4"
            >
              <CheckCircle className="w-16 h-16 mx-auto text-emerald-500 drop-shadow-[0_0_20px_rgba(16,185,129,0.5)]" />
            </motion.div>
            <h2 className="text-xl font-semibold mb-2 text-[var(--text-primary)]">
              {checkoutType === "service"
                ? "Visit Confirmed"
                : "Payment Successful"}
            </h2>
            <p className="text-sm text-[var(--text-secondary)]">
              {checkoutType === "service"
                ? "No charge yet ‚Äî visit fee applies only if you decline. Redirecting to My Orders."
                : "Redirecting to My Orders."}
            </p>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Footer */}
      <motion.p
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 0.85, y: 0 }}
        transition={{ delay: 1.2, duration: 0.6 }}
        className="absolute bottom-6 text-xs text-[var(--text-secondary)] tracking-wide"
      >
        Secured by{" "}
        <span className="text-indigo-400 font-medium">Edith MockPayT</span>
      </motion.p>
    </div>
  );
}

function StageCard({
  icon,
  title,
  subtitle,
  pulse = false,
}: {
  icon: React.ReactNode;
  title: string;
  subtitle: string;
  pulse?: boolean;
}) {
  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.9, y: 20 }}
      animate={{ opacity: 1, scale: 1, y: 0 }}
      exit={{ opacity: 0, scale: 0.8, y: -10 }}
      transition={{ duration: 0.55, ease: "easeOut" }}
      className={`relative z-10 ${
        pulse ? "animate-pulse" : ""
      } bg-[var(--edith-surface-hover)] border border-[var(--edith-border)] rounded-3xl p-10 shadow-2xl backdrop-blur-xl max-w-sm w-full`}
    >
      {icon}
      <h2 className="text-xl font-semibold mb-2 text-[var(--text-primary)]">
        {title}
      </h2>
      <p className="text-sm text-[var(--text-secondary)]">{subtitle}</p>
    </motion.div>
  );
}

--- app/my-orders/page.tsx ---
"use client";

/**
 * app/my-orders/page.tsx
 * Edith My Orders ‚Äì invoice list (replaces legacy my-space orders)
 */

import SafeViewport from "@/components/layout/SafeViewport";
import { useUser } from "@/contexts/UserContext";
import { format } from "date-fns";
import { AnimatePresence, motion } from "framer-motion";
import {
  ArrowUpRight,
  Calendar,
  FileText,
  MapPin,
  RefreshCw,
  ShoppingBag,
} from "lucide-react";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import { useEffect, useMemo, useState } from "react";

type OrderType = "store" | "service";

type OrderEntry = {
  id: string;
  reference: string;
  invoice_id: string;
  invoice_url?: string | null;
  total?: number;
  created_at?: string;
  order_type: OrderType;
  visit_fee?: number | null;
  visit_fee_waived?: boolean;
  items: any[];
  address?: string | null;
  status?: string;
  tracking_steps: string[];
  progress: number;
  payload?: any;
  raw?: any;
};

export default function MyOrdersPage() {
  const { user, isLoaded, isLoggedIn, setUser } = useUser();
  const searchParams = useSearchParams();
  const pathname = usePathname();
  const router = useRouter();
  const [orders, setOrders] = useState<OrderEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [refreshCount, setRefreshCount] = useState(0);
  const [expandedOrderId, setExpandedOrderId] = useState<string | null>(null);
  const tabParam = searchParams?.get("tab");
  const initialFilter =
    tabParam === "service" || tabParam === "store"
      ? (tabParam as OrderType)
      : "all";
  const [filterType, setFilterType] = useState<OrderType | "all">(
    initialFilter
  );

  const userId = user?.id;

  // Hydration bridge: recover user from localStorage if context hasn't populated yet.
  useEffect(() => {
    if (!isLoaded || isLoggedIn || user) return;
    try {
      const raw =
        typeof window !== "undefined" ? localStorage.getItem("user") : null;
      if (!raw) return;
      const cached = JSON.parse(raw);
      if (cached?.loggedIn) {
        setUser(cached);
      }
    } catch {
      // ignore parse errors
    }
  }, [user, isLoaded, isLoggedIn, setUser]);

  useEffect(() => {
    if (!isLoaded || !isLoggedIn || !userId) return;

    const controller = new AbortController();
    let isCurrent = true;

    (async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await fetch(`/api/invoices/list?user_id=${userId}`, {
          signal: controller.signal,
        });
        if (!res.ok) {
          throw new Error(`Request failed with status ${res.status}`);
        }
        const json = await res.json();
        if (!json?.success) {
          throw new Error(
            json?.message ?? "Unable to load your orders right now."
          );
        }
        const invoices: OrderEntry[] = Array.isArray(json.invoices)
          ? json.invoices
          : [];
        if (isCurrent) {
          setOrders(invoices);
          if (invoices.length === 0) setExpandedOrderId(null);
        }
      } catch (err) {
        if (controller.signal.aborted || !isCurrent) return;
        console.error("[my-orders] Failed to load invoices:", err);
        setOrders([]);
        setError(
          err instanceof Error
            ? err.message
            : "Something went wrong while loading your orders."
        );
      } finally {
        if (!controller.signal.aborted && isCurrent) {
          setLoading(false);
        }
      }
    })();

    return () => {
      isCurrent = false;
      controller.abort();
    };
  }, [userId, isLoaded, isLoggedIn, refreshCount]);

  const handleRefresh = () => setRefreshCount((prev) => prev + 1);

  const showLoginPrompt = !isLoggedIn && !loading && isLoaded;

  const sortedOrders = useMemo(
    () =>
      orders.slice().sort((a, b) => {
        const aDate = a.created_at ? new Date(a.created_at).getTime() : 0;
        const bDate = b.created_at ? new Date(b.created_at).getTime() : 0;
        return bDate - aDate;
      }),
    [orders]
  );
  const filteredOrders = useMemo(() => {
    if (filterType === "all") return sortedOrders;
    return sortedOrders.filter((o) => o.order_type === filterType);
  }, [sortedOrders, filterType]);

  return (
    <SafeViewport>
      <div className="min-h-[70vh] max-w-5xl mx-auto px-4 sm:px-6 py-6 space-y-5">
        <HeroCard loading={loading} onRefresh={handleRefresh} />

        {showLoginPrompt ? (
          <LoginPrompt />
        ) : (
          <motion.section
            initial={{ opacity: 0, y: 8 }}
            animate={{ opacity: 1, y: 0 }}
            className="bg-[var(--edith-surface)]/85 border border-[var(--edith-border)] rounded-2xl shadow-xl p-5 backdrop-blur"
          >
            <FilterTabs
              filterType={filterType}
              onChange={(next) => {
                setFilterType(next);
                if (!router || !pathname) return;
                const params = new URLSearchParams(
                  Array.from(searchParams?.entries() ?? [])
                );
                if (next === "all") params.delete("tab");
                else params.set("tab", next);
                const qs = params.toString();
                router.replace(`${pathname}${qs ? `?${qs}` : ""}`, {
                  scroll: false,
                });
              }}
            />
            {loading ? (
              <MutedState message="Loading orders..." />
            ) : error ? (
              <ErrorState message={error} onRetry={handleRefresh} />
            ) : filteredOrders.length === 0 ? (
              <EmptyState />
            ) : (
              <div className="flex flex-col gap-4">
                {filteredOrders.map((order) => (
                  <OrderCard
                    key={order.id}
                    order={order}
                    expanded={expandedOrderId === order.id}
                    onToggle={() =>
                      setExpandedOrderId((prev) =>
                        prev === order.id ? null : order.id
                      )
                    }
                  />
                ))}
              </div>
            )}
          </motion.section>
        )}
      </div>
    </SafeViewport>
  );
}

/* ---------- Helper Components ---------- */

function HeroCard({
  loading,
  onRefresh,
}: {
  loading: boolean;
  onRefresh: () => void;
}) {
  return (
    <div className="bg-[var(--edith-surface)]/90 border border-[var(--edith-border)] rounded-2xl shadow-xl p-5 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p className="text-xs uppercase tracking-[0.2em] text-[var(--text-secondary)]">
          Billing
        </p>
        <h1 className="text-2xl font-semibold text-[var(--text-primary-light)]">
          My Orders
        </h1>
        <p className="text-sm text-[var(--text-secondary)]">
          View your past orders and invoices.
        </p>
      </div>
      <div className="flex flex-wrap gap-2">
        <button
          onClick={onRefresh}
          disabled={loading}
          className="inline-flex items-center gap-2 rounded-full border border-[var(--edith-border)] bg-white/70 dark:bg-zinc-900/70 px-4 py-2 text-sm font-medium text-[var(--text-primary-light)] hover:bg-white disabled:opacity-50"
        >
          <RefreshCw size={16} />
          Refresh
        </button>
      </div>
    </div>
  );
}

function FilterTabs({
  filterType,
  onChange,
}: {
  filterType: OrderType | "all";
  onChange: (v: OrderType | "all") => void;
}) {
  const tabs: { id: OrderType | "all"; label: string }[] = [
    { id: "all", label: "All" },
    { id: "service", label: "Services" },
    { id: "store", label: "Store" },
  ];

  return (
    <div className="flex justify-center mb-4">
      <div className="flex rounded-full border border-[var(--edith-border)] bg-white/70 dark:bg-zinc-900/60 text-xs sm:text-sm">
        {tabs.map((tab) => {
          const active = filterType === tab.id;
          return (
            <button
              key={tab.id}
              onClick={() => onChange(tab.id)}
              className={`px-4 py-1.5 rounded-full font-semibold transition ${
                active
                  ? "bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white shadow"
                  : "text-[var(--text-secondary)] hover:text-[var(--text-primary-light)]"
              }`}
            >
              {tab.label}
            </button>
          );
        })}
      </div>
    </div>
  );
}

function MutedState({ message }: { message: string }) {
  return (
    <div className="flex items-center justify-center py-16 text-[var(--text-secondary)]">
      {message}
    </div>
  );
}

function ErrorState({
  message,
  onRetry,
}: {
  message: string;
  onRetry: () => void;
}) {
  return (
    <div className="flex flex-col items-center justify-center py-12 text-center space-y-3">
      <p className="text-sm text-red-500">
        We couldn&apos;t load your orders. {message}
      </p>
      <button
        onClick={onRetry}
        className="text-sm font-medium underline text-red-400"
      >
        Try again
      </button>
    </div>
  );
}

function EmptyState() {
  return (
    <div className="flex flex-col items-center justify-center py-16 text-[var(--text-secondary)] space-y-3">
      <ShoppingBag className="w-10 h-10 opacity-60" />
      <p>No orders found for this account yet.</p>
    </div>
  );
}

function LoginPrompt() {
  return (
    <div className="flex flex-col items-center justify-center py-24 text-center space-y-4 text-[var(--text-secondary)]">
      <FileText className="w-10 h-10 opacity-70 mx-auto" />
      <div>
        <p className="text-base font-medium text-[var(--text-primary-light)]">
          Sign in to view your orders
        </p>
        <p className="text-sm">
          Once you&apos;re signed in, your invoices will appear here.
        </p>
      </div>
    </div>
  );
}

function formatCurrency(value?: number) {
  return new Intl.NumberFormat("en-IN", {
    style: "currency",
    currency: "INR",
    minimumFractionDigits: 2,
  }).format(Number(value ?? 0));
}

function OrderCard({
  order,
  expanded,
  onToggle,
}: {
  order: OrderEntry;
  expanded: boolean;
  onToggle: () => void;
}) {
  const createdAtLabel = order.created_at
    ? format(new Date(order.created_at), "dd MMM yyyy, hh:mm a")
    : "Date unavailable";
  const rawIdentifier = String(order.reference || order.id || "")
    .replace(/[^a-zA-Z0-9]/g, "")
    .slice(0, 8)
    .toUpperCase();
  const orderLabel = `${order.order_type === "service" ? "SR" : "OR"}-${
    rawIdentifier || "000000"
  }`;
  const invoiceLabel = order.invoice_id
    ? `INV-${String(order.invoice_id).slice(0, 10)}`
    : null;
  const totalDisplay =
    order.order_type === "service"
      ? order.total && order.total > 0
        ? formatCurrency(order.total)
        : "To be quoted"
      : formatCurrency(order.total);

  return (
    <motion.div
      layout
      className="rounded-3xl border border-[var(--border-soft)] bg-[var(--surface-card)] dark:bg-[var(--surface-panel-dark)] shadow-[var(--shadow-elevation)] overflow-hidden transition-colors duration-500"
    >
      <div className="p-4 sm:p-6 flex flex-col gap-4">
        <div className="flex flex-wrap items-start justify-between gap-3">
          <div>
            <p className="text-xs uppercase tracking-[0.3em] text-[var(--accent-tertiary)]">
              {order.order_type === "store" ? "Products" : "Services"}
            </p>
            <h2 className="text-lg font-semibold text-[var(--text-primary)] dark:text-[var(--text-primary-dark)] flex items-center gap-2">
              <FileText className="w-5 h-5 text-[var(--accent-primary)]" />
              {orderLabel}
            </h2>
            {invoiceLabel && (
              <p className="text-xs text-[var(--text-muted)]">
                Invoice {invoiceLabel}
              </p>
            )}
          </div>
          <div className="text-right">
            <p className="text-xs text-[var(--text-muted)] flex items-center gap-1 justify-end">
              <Calendar className="w-4 h-4" />
              {createdAtLabel}
            </p>
            <p className="text-sm font-semibold text-[var(--text-primary)] dark:text-[var(--text-primary-dark)] whitespace-nowrap">
              Total: {totalDisplay}
            </p>
          </div>
        </div>

        {order.address && (
          <p className="text-xs text-[var(--text-muted)] flex items-center gap-1">
            <MapPin className="w-4 h-4" />
            {order.address}
          </p>
        )}

        {order.order_type === "service" && (
          <p className="text-xs font-medium text-[var(--accent-warning)]">
            Visit Charge: {formatCurrency(order.visit_fee ?? 200)}{" "}
            {order.visit_fee_waived
              ? "(waived after confirmation)"
              : "(payable only if you decline)"}
          </p>
        )}

        <OrderTimeline
          type={order.order_type}
          steps={order.tracking_steps}
          progress={order.progress}
        />

        <div className="flex flex-wrap items-center gap-3">
          <button
            onClick={onToggle}
            className="rounded-full border border-[var(--border-soft)] px-4 py-1.5 text-sm font-medium text-[var(--accent-primary)] hover:bg-[var(--surface-hover)] transition"
          >
            {expanded ? "Hide details" : "View details"}
          </button>
          {order.invoice_url && (
            <a
              href={order.invoice_url}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-flex items-center gap-1 text-sm text-[var(--accent-success)] hover:underline"
            >
              View invoice <ArrowUpRight className="w-3 h-3" />
            </a>
          )}
        </div>
      </div>

      <AnimatePresence initial={false}>
        {expanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: "auto", opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="border-t border-[var(--border-soft)] bg-[var(--surface-overlay)] dark:bg-[var(--surface-panel-dark)]/50 px-4 sm:px-6 py-4 space-y-4"
          >
            <div>
              <p className="text-xs uppercase tracking-[0.2em] text-indigo-500 mb-2">
                Items
              </p>
              {order.items && order.items.length > 0 ? (
                <ul className="space-y-2">
                  {order.items.map((item, idx) => (
                    <li
                      key={idx}
                      className="flex items-center justify-between text-sm text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]"
                    >
                      <span className="w-2/3">
                        {item?.name ?? item?.title ?? "Item"}
                      </span>
                      <span className="text-xs text-[var(--text-muted)]">
                        √ó{item?.quantity ?? item?.qty ?? 1}
                      </span>
                      <span className="font-medium">
                        {formatCurrency(item?.price ?? item?.amount ?? 0)}
                      </span>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-sm text-slate-500">
                  No line items captured on this order.
                </p>
              )}
            </div>

            {order.order_type === "service" && <ProgressNote order={order} />}
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
}

function ProgressNote({ order }: { order: OrderEntry }) {
  const milestone =
    order.tracking_steps[
      Math.min(order.progress - 1, order.tracking_steps.length - 1)
    ];
  return (
    <div className="rounded-2xl border border-[var(--border-soft)] bg-[var(--surface-card)] dark:bg-[var(--surface-panel-dark)]/60 p-4 text-sm text-[var(--text-secondary)] dark:text-[var(--text-primary-dark)]">
      <p className="font-semibold text-[var(--text-primary)] dark:text-[var(--text-primary-dark)] mb-1">
        {order.status ? order.status : "In Progress"}
      </p>
      <p>
        Latest milestone:{" "}
        <span className="text-[var(--accent-primary)] dark:text-[var(--accent-secondary)]">
          {milestone}
        </span>
      </p>
      <p className="text-xs text-[var(--text-muted)] mt-2">
        We&apos;ll notify you when the next step begins. You can refresh this
        page anytime to sync with the cosmic ledger.
      </p>
    </div>
  );
}

function OrderTimeline({
  type,
  steps,
  progress,
}: {
  type: OrderType;
  steps: string[];
  progress: number;
}) {
  const completed = Math.min(progress, steps.length);
  const percent = ((completed - 1) / (steps.length - 1 || 1)) * 100;

  return (
    <div className="space-y-3">
      <div className="relative h-2 rounded-full bg-[var(--surface-hover)] dark:bg-[var(--surface-panel-dark)]/60 overflow-hidden">
        <div
          className="absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-indigo-500 via-fuchsia-500 to-emerald-400 animate-pulse"
          style={{ width: `${Math.max(12, percent)}%` }}
        />
        <div className="absolute inset-y-0 left-0 w-full opacity-30 blur-xl bg-gradient-to-r from-blue-500 via-fuchsia-500 to-orange-400" />
      </div>
      <div className="flex justify-between text-[10px] uppercase tracking-wide text-[var(--text-muted)]">
        <span>{steps[0]}</span>
        <span>{steps[steps.length - 1]}</span>
      </div>
      <p className="text-xs text-[var(--text-muted)]">
        {type === "store"
          ? "Tracking cosmic parcels across HomeFix logistic ray."
          : "Service timeline entangled with your engineer's schedule."}
      </p>
    </div>
  );
}

--- app/my-space/components/BookingCard.tsx ---
"use client";
/**
 * BookingCard v1.2 ‚Äî Edith SafeViewport Style üåø
 * ------------------------------------------------------------
 * ‚úÖ Compact card design that stays within responsive grid
 * ‚úÖ Theme-aware shadows & surfaces
 * ‚úÖ Safe for both mobile & desktop widths
 * ============================================================
 */

import { format } from "date-fns";
import { motion } from "framer-motion";
import { Calendar, Clock, Package } from "lucide-react";

export default function BookingCard({ booking }: { booking: any }) {
  const services = Array.isArray(booking.services)
    ? booking.services
    : [booking.services];

  return (
    <motion.div
      layout
      whileHover={{ scale: 1.01 }}
      transition={{ type: "spring", stiffness: 180, damping: 20 }}
      className="p-4 rounded-2xl border border-black/10 dark:border-white/10
                 bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                 shadow-[0_2px_10px_rgba(0,0,0,0.05)] hover:shadow-[0_3px_14px_rgba(0,0,0,0.08)]
                 transition-all duration-400 flex flex-col justify-between"
    >
      {/* Header */}
      <div className="flex justify-between items-start mb-2">
        <h2 className="font-semibold text-base leading-snug line-clamp-2">
          {services[0]?.name || "Service Booking"}
        </h2>
        <span className="text-xs px-2 py-0.5 rounded-full bg-gray-200/70 dark:bg-slate-700/70 text-gray-700 dark:text-gray-300 capitalize">
          {booking.status}
        </span>
      </div>

      {/* Details */}
      <div className="text-sm space-y-1 opacity-80">
        <p className="flex items-center gap-1">
          <Calendar className="w-4 h-4" />
          {booking.preferred_date
            ? format(new Date(booking.preferred_date), "dd MMM yyyy")
            : "No date"}
        </p>
        {booking.preferred_slot && (
          <p className="flex items-center gap-1">
            <Clock className="w-4 h-4" /> {booking.preferred_slot}
          </p>
        )}
        <p className="flex items-center gap-1">
          <Package className="w-4 h-4" />{" "}
          {booking.type === "product"
            ? `Quantity: ${booking.quantity}`
            : "Scheduled service"}
        </p>
      </div>

      {/* Footer */}
      <div className="flex justify-between items-center mt-3 pt-2 border-t border-gray-100 dark:border-slate-800">
        <p className="font-semibold text-green-700 dark:text-green-400">
          ‚Çπ{Number(booking.total_price || 0).toLocaleString()}
        </p>
      </div>
    </motion.div>
  );
}

--- app/my-space/components/BookingsView.tsx ---
"use client";
/**
 * ============================================================
 * File: /app/my-space/components/BookingsView.tsx
 * Version: v10.2 ‚Äî HomeFix ‚ÄúGemini Harmony Polished‚Äù üåó
 * ------------------------------------------------------------
 * ‚úÖ Category bar pinned perfectly below UniversalHeader
 * ‚úÖ Auto-fit pills (no horizontal scrollbar)
 * ‚úÖ Restored booking actions: Reschedule / Cancel
 * ‚úÖ Theme-driven aura + elevation
 * ‚úÖ Fully fluid layout for all screen widths
 * ============================================================
 */

import { useUser } from "@/contexts/UserContext";
import clsx from "clsx";
import { format } from "date-fns";
import { motion } from "framer-motion";
import { Calendar, Clock, Loader2, Package } from "lucide-react";
import { useEffect, useMemo, useState } from "react";

const STATUS_TABS = [
  { key: "all", label: "All" },
  { key: "upcoming", label: "Upcoming" },
  { key: "in-progress", label: "In Progress" },
  { key: "rescheduled", label: "Rescheduled" },
  { key: "completed", label: "Completed" },
  { key: "cancelled", label: "Cancelled" },
];

export default function BookingsView() {
  const { user, isLoaded } = useUser();
  const [bookings, setBookings] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState("all");

  /* üî• Fetch Bookings */
  useEffect(() => {
    const cached =
      typeof window !== "undefined"
        ? JSON.parse(localStorage.getItem("user") || "null")
        : null;
    const userId = user?.id || cached?.id;
    if (!userId || !isLoaded) return;

    (async () => {
      setLoading(true);
      try {
        const res = await fetch(`/api/bookings/list?user_id=${userId}`);
        const json = await res.json();
        if (json.success) setBookings(json.bookings || []);
      } catch (err) {
        console.error("üí• Fetch error:", err);
      } finally {
        setLoading(false);
      }
    })();
  }, [user?.id, isLoaded]);

  /* üß© Filters */
  const normalize = (s = "") => s.toLowerCase().replace(/\s+/g, "-").trim();

  const filtered = useMemo(() => {
    if (activeTab === "all") return bookings;
    return bookings.filter((b) => normalize(b.status) === activeTab);
  }, [bookings, activeTab]);

  const statusCounts = useMemo(() => {
    const map: Record<string, number> = {};
    bookings.forEach((b) => {
      const key = normalize(b.status);
      map[key] = (map[key] || 0) + 1;
    });
    map["all"] = bookings.length;
    return map;
  }, [bookings]);

  if (loading)
    return <CenteredScreen message="Fetching your bookings..." spinner />;

  /* ------------------------------------------------------------
     üåó Unified Layout ‚Äî Perfectly aligned category bar
  ------------------------------------------------------------ */
  return (
    <div className="relative flex flex-col items-center w-full transition-colors duration-500">
      {/* ‚ú® Aura Background (auto-adaptive) */}
      <div className="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_50%_20%,var(--aura-light,rgba(56,189,248,0.1)),transparent_70%)] dark:bg-[radial-gradient(circle_at_50%_20%,var(--aura-dark,rgba(34,197,94,0.15)),transparent_70%)]" />

      {/* üß≠ Category Bar ‚Äî fits screen width, smaller pills */}
      <motion.div
        className="fixed left-0 right-0 z-[68] flex justify-center
                   backdrop-blur-xl bg-[var(--surface-elevated)]/80 dark:bg-[var(--surface-elevated-dark)]/80
                   border-b border-[var(--border-muted)]
                   shadow-[0_4px_14px_rgba(0,0,0,0.06)]
                   transition-all duration-300"
        style={{ top: "calc(var(--header-h) + 0.15rem)" }}
        initial={{ opacity: 0, y: -6 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.35 }}
      >
        <div className="flex flex-wrap justify-center gap-1.5 py-2 px-3 max-w-[640px]">
          {STATUS_TABS.map((t) => {
            const active = activeTab === t.key;
            return (
              <motion.button
                key={t.key}
                onClick={() => setActiveTab(t.key)}
                whileTap={{ scale: 0.95 }}
                className={clsx(
                  "px-3 py-1 rounded-full text-xs sm:text-sm font-medium border transition-all duration-300",
                  active
                    ? "bg-[var(--accent-primary)] text-white shadow-[0_0_6px_rgba(16,185,129,0.4)] border-transparent"
                    : "border-[var(--border-muted)] text-[var(--text-secondary)] hover:bg-[var(--surface-hover)]"
                )}
              >
                {t.label}
                {statusCounts[t.key] > 0 && (
                  <span className="ml-1 text-[10px] opacity-80">
                    {statusCounts[t.key]}
                  </span>
                )}
              </motion.button>
            );
          })}
        </div>
      </motion.div>

      {/* ü™∂ Booking Cards */}
      <motion.div
        key="grid"
        layout
        className="w-full max-w-[640px] px-3 sm:px-4 mt-[5rem] pb-28 grid gap-5"
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 0.35 }}
      >
        {filtered.length ? (
          filtered.map((b) => <BookingCard key={b.id} booking={b} />)
        ) : (
          <EmptyState />
        )}
      </motion.div>
    </div>
  );
}

/* ------------------------------------------------------------
   ü™û Subcomponents
------------------------------------------------------------ */
function BookingCard({ booking }: any) {
  const services = Array.isArray(booking.services)
    ? booking.services
    : [booking.services];
  const normalizedStatus = (booking.status || "").toLowerCase();
  const palette =
    normalizedStatus === "completed"
      ? {
          bar: "var(--accent-success)",
          text: "var(--accent-success)",
          chipBg:
            "color-mix(in srgb, var(--accent-success) 12%, transparent 88%)",
          chipBorder:
            "color-mix(in srgb, var(--accent-success) 40%, transparent 60%)",
        }
      : normalizedStatus === "cancelled"
      ? {
          bar: "var(--accent-danger)",
          text: "var(--accent-danger)",
          chipBg:
            "color-mix(in srgb, var(--accent-danger) 10%, transparent 90%)",
          chipBorder:
            "color-mix(in srgb, var(--accent-danger) 40%, transparent 60%)",
        }
      : {
          bar: "var(--accent-info)",
          text: "var(--accent-info)",
          chipBg:
            "color-mix(in srgb, var(--accent-info) 10%, transparent 90%)",
          chipBorder:
            "color-mix(in srgb, var(--accent-info) 40%, transparent 60%)",
        };

  return (
    <motion.div
      layout
      whileHover={{ y: -2, scale: 1.01 }}
      transition={{ type: "spring", stiffness: 250, damping: 20 }}
      className={clsx(
        "relative p-5 rounded-2xl overflow-hidden border border-[var(--border-subtle)] backdrop-blur-md shadow-[0_2px_12px_rgba(0,0,0,0.08)]",
        "bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]"
      )}
    >
      <span
        className="absolute left-0 top-0 h-full w-[4px] rounded-l-2xl"
        style={{ background: palette.bar }}
      />
      <div className="flex justify-between items-center mb-2 flex-wrap">
        <h2 className="font-semibold text-base truncate pr-3">
          {services[0]?.name || "Service Booking"}
        </h2>
        <span
          className="text-xs px-2 py-0.5 rounded-full border capitalize"
          style={{
            color: palette.text,
            borderColor: palette.chipBorder,
            background: palette.chipBg,
          }}
        >
          {booking.status}
        </span>
      </div>

      <p className="text-sm flex items-center gap-1 opacity-80">
        <Calendar className="w-4 h-4" />
        {booking.preferred_date
          ? format(new Date(booking.preferred_date), "dd MMM yyyy")
          : "No date"}
        {booking.preferred_slot && (
          <>
            <Clock className="w-4 h-4 ml-2" /> {booking.preferred_slot}
          </>
        )}
      </p>

      <p className="text-sm flex items-center gap-1 mt-1 opacity-80">
        <Package className="w-4 h-4" />
        {booking.type === "product"
          ? `Quantity: ${booking.quantity}`
          : "Scheduled service"}
      </p>

      {/* üîò Action Buttons */}
      {["upcoming", "rescheduled"].includes(
        booking.status?.toLowerCase?.() || ""
      ) && (
        <div className="flex gap-2 mt-4">
          <button
            className="flex-1 py-1.5 text-xs rounded-lg border border-[var(--border-muted)] hover:bg-[var(--surface-hover)] transition"
            onClick={() => console.log("üìÖ Reschedule", booking.id)}
          >
            Reschedule
          </button>
          <button
            className="flex-1 py-1.5 text-xs rounded-lg text-white transition hover:brightness-110"
            style={{ background: "var(--accent-danger)" }}
            onClick={() => console.log("‚ùå Cancel", booking.id)}
          >
            Cancel
          </button>
        </div>
      )}

      <div className="flex justify-between items-end mt-3">
        <p className="font-semibold text-[var(--accent-success)]">
          ‚Çπ{Number(booking.total_price).toLocaleString()}
        </p>
      </div>
    </motion.div>
  );
}

/* ------------------------------------------------------------
   ‚è≥ Loading / Empty States
------------------------------------------------------------ */
function CenteredScreen({ message, spinner }: any) {
  return (
    <div className="flex justify-center items-center h-[70vh] flex-col text-[var(--text-secondary)]">
      {spinner && <Loader2 className="animate-spin mb-3 w-5 h-5" />}
      <p>{message}</p>
    </div>
  );
}

function EmptyState() {
  return (
    <motion.div
      initial={{ opacity: 0, y: 8 }}
      animate={{ opacity: 1, y: 0 }}
      className="flex flex-col items-center justify-center h-[55vh] text-[var(--text-secondary)]"
    >
      <Package className="w-12 h-12 mb-3 opacity-70" />
      <p>No bookings yet</p>
      <p className="text-xs opacity-70 mt-1">
        Start by exploring our services to book your first one ‚ú®
      </p>
    </motion.div>
  );
}

--- app/my-space/components/OrderCard.tsx ---
"use client";
/**
 * OrderCard v1.1 ‚Äî Edith Unified Aesthetic üåó
 * ------------------------------------------------------------
 * ‚úÖ Fits same grid as BookingCard
 * ‚úÖ Shows date, amount, and invoice link
 * ‚úÖ Subtle hover elevation
 * ============================================================
 */

import { format } from "date-fns";
import { motion } from "framer-motion";
import { ArrowUpRight, Calendar, FileText } from "lucide-react";

export interface Invoice {
  id: string;
  invoice_url?: string;
  total?: number;
  created_at?: string;
  [key: string]: unknown;
}

interface OrderCardProps {
  order: Invoice;
}

export default function OrderCard({ order }: OrderCardProps) {
  return (
    <motion.div
      layout
      whileHover={{ scale: 1.01 }}
      transition={{ type: "spring", stiffness: 180, damping: 20 }}
      className="p-4 rounded-2xl border border-[var(--border-soft)]
                 bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                 shadow-[var(--shadow-elevation)] hover:shadow-[0_8px_24px_rgba(15,23,42,0.12)]
                 transition-all duration-400 flex flex-col justify-between"
    >
      <div className="flex justify-between items-start mb-2">
        <h2 className="font-semibold text-base flex items-center gap-1">
          <FileText className="w-4 h-4" />
          Invoice #{order.id?.slice(0, 6)}
        </h2>
        <a
          href={order.invoice_url}
          target="_blank"
          rel="noopener noreferrer"
          className="text-xs text-[var(--accent-success)] hover:underline flex items-center gap-1"
        >
          View <ArrowUpRight className="w-3 h-3" />
        </a>
      </div>

      <div className="text-sm opacity-80 space-y-1">
        <p className="flex items-center gap-1">
          <Calendar className="w-4 h-4" />
          {order.created_at
            ? format(new Date(order.created_at), "dd MMM yyyy")
            : "N/A"}
        </p>
        <p>Total: ‚Çπ{Number(order.total || 0).toLocaleString()}</p>
      </div>
    </motion.div>
  );
}

--- app/my-space/components/OrdersView.tsx ---
"use client";
import { useUser } from "@/contexts/UserContext";
import { useEffect, useState } from "react";
import OrderCard from "./OrderCard";

export default function OrdersView({ standalone = false }: any) {
  const { user, isLoaded } = useUser();
  const [orders, setOrders] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const userId = user?.id;
    if (!userId || !isLoaded) return;
    (async () => {
      setLoading(true);
      const res = await fetch(`/api/invoices/list?user_id=${userId}`);
      const json = await res.json();
      if (json.success) setOrders(json.invoices || []);
      setLoading(false);
    })();
  }, [user?.id, isLoaded]);

  if (loading)
    return (
      <div className="flex justify-center items-center h-[60vh] text-gray-500">
        Loading orders...
      </div>
    );

  return (
    <div className="flex flex-col gap-3 pb-24">
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {orders.length ? (
          orders.map((o) => <OrderCard key={o.id} order={o} />)
        ) : (
          <p className="text-center text-gray-400 py-16">No orders found.</p>
        )}
      </div>
    </div>
  );
}

--- app/my-space/components/TabsBar.tsx ---
"use client";
/**
 * TabsBar v1.0 ‚Äî Draggable Bookings Filter Tabs
 * ------------------------------------------------------------
 * ‚úÖ Drag-scrollable with mouse & touch
 * ‚úÖ Snaps smoothly and respects SafeViewport top
 * ‚úÖ Reusable across future lists (projects, invoices)
 * ============================================================
 */

import clsx from "clsx";
import { motion } from "framer-motion";
import { useEffect, useRef } from "react";

const STATUS_TABS = [
  { key: "all", label: "All" },
  { key: "upcoming", label: "Upcoming" },
  { key: "in-progress", label: "In Progress" },
  { key: "rescheduled", label: "Rescheduled" },
  { key: "completed", label: "Completed" },
  { key: "cancelled", label: "Cancelled" },
];

export default function TabsBar({
  activeTab,
  setActiveTab,
}: {
  activeTab: string;
  setActiveTab: (tab: string) => void;
}) {
  const tabRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const el = tabRef.current;
    if (!el) return;

    let isDown = false;
    let startX = 0,
      scrollLeft = 0;

    const start = (e: MouseEvent | TouchEvent) => {
      isDown = true;
      startX =
        (e instanceof MouseEvent ? e.pageX : e.touches[0].pageX) -
        el.offsetLeft;
      scrollLeft = el.scrollLeft;
    };
    const move = (e: MouseEvent | TouchEvent) => {
      if (!isDown) return;
      const x =
        (e instanceof MouseEvent ? e.pageX : e.touches[0].pageX) -
        el.offsetLeft;
      el.scrollLeft = scrollLeft - (x - startX) * 1.2;
    };
    const end = () => (isDown = false);

    el.addEventListener("mousedown", start);
    el.addEventListener("mousemove", move);
    el.addEventListener("mouseup", end);
    el.addEventListener("mouseleave", end);
    el.addEventListener("touchstart", start);
    el.addEventListener("touchmove", move);
    el.addEventListener("touchend", end);

    return () => {
      el.removeEventListener("mousedown", start);
      el.removeEventListener("mousemove", move);
      el.removeEventListener("mouseup", end);
      el.removeEventListener("mouseleave", end);
      el.removeEventListener("touchstart", start);
      el.removeEventListener("touchmove", move);
      el.removeEventListener("touchend", end);
    };
  }, []);

  return (
    <div
      ref={tabRef}
      className="flex gap-2 overflow-x-auto pb-2 pt-2 px-1
                 scrollbar-none scroll-smooth touch-pan-x snap-x snap-mandatory
                 border-b border-gray-200/30 dark:border-slate-800/30
                 backdrop-blur-md sticky top-[var(--header-h)] z-[60]
                 bg-[var(--surface-light)/70] dark:bg-[var(--surface-dark)/70]"
      style={{ WebkitOverflowScrolling: "touch", scrollbarWidth: "none" }}
    >
      {STATUS_TABS.map((t) => {
        const active = activeTab === t.key;
        return (
          <motion.button
            key={t.key}
            onClick={() => setActiveTab(t.key)}
            whileTap={{ scale: 0.95 }}
            className={clsx(
              "px-4 py-1.5 rounded-full text-sm font-medium snap-start whitespace-nowrap border transition-all",
              active
                ? "bg-gradient-to-r from-emerald-600 to-lime-500 text-white shadow-md border-transparent"
                : "border-gray-300 dark:border-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800"
            )}
          >
            {t.label}
          </motion.button>
        );
      })}
    </div>
  );
}

--- app/my-space/components/ViewToggle.tsx ---
"use client";
import clsx from "clsx";
import { motion } from "framer-motion";

export default function ViewToggle({
  view,
  setView,
}: {
  view: "bookings" | "orders";
  setView: (v: "bookings" | "orders") => void;
}) {
  return (
    <div
      className="flex justify-center sm:justify-end gap-3 mt-4 mb-4"
      style={{
        paddingInline:
          "max(env(safe-area-inset-left),1rem) max(env(safe-area-inset-right),1rem)",
      }}
    >
      {[
        { key: "bookings", label: "Service Bookings" },
        { key: "orders", label: "Product Orders" },
      ].map((opt) => {
        const active = view === opt.key;
        return (
          <motion.button
            key={opt.key}
            onClick={() => setView(opt.key as any)}
            whileTap={{ scale: 0.95 }}
            className={clsx(
              "px-4 py-2 rounded-full text-sm font-medium border transition-all select-none",
              active
                ? "bg-gradient-to-r from-emerald-500 to-lime-400 text-white shadow-md border-transparent"
                : "border-gray-300 dark:border-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800"
            )}
          >
            {opt.label}
          </motion.button>
        );
      })}
    </div>
  );
}

--- app/my-space/orders/page.tsx ---
"use client";
import OrdersView from "../components/OrdersView";

export default function MySpaceOrdersPage() {
  return <OrdersView standalone />;
}

--- app/my-space/page.tsx ---
"use client";
/**
 * ============================================================
 * File: /app/my-space/page.tsx
 * Version: v9.7 ‚Äî HomeFix ‚ÄúMySpace Continuum Final‚Äù üåó
 * ------------------------------------------------------------
 * ‚úÖ Controlled by UniversalHeader (compact toggle)
 * ‚úÖ No redundant toggles or nested SafeViewport conflicts
 * ‚úÖ Clean, minimal, and future-safe
 * ‚úÖ Auto-responds to ?view=bookings | ?view=orders
 * ============================================================
 */

import SafeViewport from "@/components/layout/SafeViewport";
import { motion } from "framer-motion";
import { useSearchParams } from "next/navigation";
import BookingsView from "./components/BookingsView";
import OrdersView from "./components/OrdersView";

export default function MySpacePage() {
  const params = useSearchParams();
  const view = (params?.get("view") as "bookings" | "orders") ?? "bookings";

  return (
    <SafeViewport>
      {/* ‚ú® Background Aura (for depth consistency with header) */}
      <div className="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_50%_15%,rgba(56,189,248,0.06),transparent_65%)] dark:bg-[radial-gradient(circle_at_50%_15%,rgba(34,197,94,0.12),transparent_70%)]" />

      {/* ü™∂ Content Zone */}
      <motion.div
        key={view}
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: 10 }}
        transition={{ duration: 0.35 }}
        className="flex-1 flex flex-col items-center justify-start w-full px-3 sm:px-4 pb-20"
      >
        <div className="w-full max-w-5xl">
          {view === "bookings" ? <BookingsView /> : <OrdersView />}
        </div>
      </motion.div>
    </SafeViewport>
  );
}

--- app/not-found.tsx ---
export const dynamic = "force-static";

export default function NotFound() {
  return (
    <html>
      <body>
        <div style={{ padding: "4rem", textAlign: "center" }}>
          <h1>404 ‚Äî Not Found</h1>
          <p>The page you are looking for does not exist.</p>
        </div>
      </body>
    </html>
  );
}

--- app/page.tsx ---
"use client";
/**
 * =============================================================
 * HomePage v4.2 ‚Äî Gemini Unified Theme üåó
 * -------------------------------------------------------------
 * ‚úÖ True theme sync (no hardcoded gray/surface colors)
 * ‚úÖ Brand gradients kept (#5A5DF0 ‚Üí #EC6ECF)
 * ‚úÖ Smooth transitions & shimmer maintained
 * ‚úÖ Works with global CSS variables (v6.1+)
 * =============================================================
 */

import InstallFAB from "@/components/InstallFAB";
import Footer from "@/components/ui/Footer";
import { motion, useScroll, useSpring, useTransform } from "framer-motion";
import dynamic from "next/dynamic";
import Image from "next/image";
import Link from "next/link";
import { useEffect, useRef, useState } from "react";
const Lottie = dynamic(() => import("lottie-react"), { ssr: false });

// üé¨ Local animations
import civilAnim from "./animations/civil.json";
import diyAnim from "./animations/diy.json";
import electricAnim from "./animations/electric.json";
import fixAnim from "./animations/fix.json";
import interiorAnim from "./animations/interior.json";
import paintAnim from "./animations/paint.json";

/* -------------------------------------------------------------------------- */
/* üåà SHIMMER                                                                 */
/* -------------------------------------------------------------------------- */
const Shimmer = ({ height = "100%" }: { height?: string }) => (
  <div
    className="relative overflow-hidden rounded-xl bg-[var(--surface-light)] dark:bg-[var(--surface-dark)]"
    style={{ height }}
  >
    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 dark:via-white/10 to-transparent animate-[shimmer_1.6s_infinite]" />
    <style jsx>{`
      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }
    `}</style>
  </div>
);

/* -------------------------------------------------------------------------- */
/* üéû HERO VIDEO ‚Äî Cinematic Woodworking + Smart Autoplay                     */
/* -------------------------------------------------------------------------- */
function HeroVideoSequence() {
  const videoRef = useRef<HTMLVideoElement>(null);
  const { scrollY } = useScroll();
  const [loaded, setLoaded] = useState(false);
  const startedRef = useRef(false);
  const promos = [
    {
      id: "summer-refresh",
      badge: "Offer",
      title: "Summer interior refresh",
      subtitle: "Save up to 20% on modular kitchens.",
    },
    {
      id: "visit-free",
      badge: "Free Visit",
      title: "No-cost site inspection",
      subtitle: "Pay only if you decline the quotation.",
    },
    {
      id: "studio-preview",
      badge: "Preview",
      title: "Studio sneak peek",
      subtitle: "Early access to upcoming design tools.",
    },
  ];
  const [promoIndex, setPromoIndex] = useState(0);

  useEffect(() => {
    const v = videoRef.current;
    if (!v) return;
    v.muted = true;
    v.playsInline = true;
    v.autoplay = true;
    const handleLoadedMetadata = () => {
      try {
        if (v.duration && v.duration > 35) {
          v.currentTime = 30;
        }
      } catch {
        // ignore
      }
    };
    v.addEventListener("loadedmetadata", handleLoadedMetadata);
    v.load();
    v.play()
      .then(() => {
        startedRef.current = true;
      })
      .catch(() => {
        // autoplay may be blocked; leave video paused without showing a button
      });
    return () => {
      v.removeEventListener("loadedmetadata", handleLoadedMetadata);
    };
  }, []);

  useEffect(() => {
    const timer = setTimeout(() => {
      const v = videoRef.current;
      if (v && !startedRef.current) {
        v.play().catch(() => {
          // ignore repeat autoplay errors
        });
        startedRef.current = true;
      }
    }, 20000);
    return () => clearTimeout(timer);
  }, []);

  useEffect(() => {
    const unsubscribe = scrollY.onChange((y: number) => {
      const v = videoRef.current;
      if (!v) return;
      if (y > 200 && !v.paused) v.pause();
      else if (y <= 200 && v.paused && startedRef.current)
        v.play().catch(() => {});
    });
    return () => unsubscribe();
  }, [scrollY]);

  useEffect(() => {
    if (promos.length <= 1) return;
    const id = setInterval(
      () =>
        setPromoIndex((prev) => {
          const next = prev + 1;
          return next >= promos.length ? 0 : next;
        }),
      8000
    );
    return () => clearInterval(id);
  }, [promos.length]);

  return (
    <section className="relative w-full h-[75vh] flex items-center justify-center overflow-hidden">
      {!loaded && (
        <motion.div
          initial={{ opacity: 1 }}
          animate={{ opacity: 0 }}
          transition={{ duration: 1.2 }}
          className="absolute inset-0 z-10"
        >
          <Shimmer />
        </motion.div>
      )}

      <video
        ref={videoRef}
        muted
        loop
        playsInline
        preload="auto"
        autoPlay
        onCanPlay={() => setLoaded(true)}
        poster="https://images.pexels.com/photos/3815582/pexels-photo-3815582.jpeg"
        className="absolute inset-0 w-full h-full object-cover"
      >
        <source
          src="https://videos.pexels.com/video-files/5471927/5471927-uhd_2560_1440_25fps.mp4"
          type="video/mp4"
        />
      </video>

      <motion.div
        className="absolute inset-0 pointer-events-none"
        style={{
          background:
            "linear-gradient(to top, color-mix(in srgb, var(--hero-overlay-top) 30%, transparent) 0%, color-mix(in srgb, var(--hero-overlay-mid) 20%, transparent) 55%, transparent 100%)",
        }}
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 1.4 }}
      />

      {/* Promo slider */}
      <div className="absolute top-6 inset-x-0 flex justify-center px-4 z-30">
        <motion.div
          key={promos[promoIndex].id}
          initial={{ opacity: 0, y: -8 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, ease: "easeOut" }}
          className="inline-flex items-center gap-3 rounded-2xl border border-[var(--border-soft)]
                     bg-[var(--surface-panel)]/95 dark:bg-[var(--surface-panel-dark)]/95
                     px-4 py-2 shadow-sm"
        >
          <span className="text-[11px] font-semibold uppercase tracking-[0.2em] text-[var(--text-muted)]">
            {promos[promoIndex].badge}
          </span>
          <div className="flex flex-col text-left">
            <span className="text-xs sm:text-sm font-medium text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]">
              {promos[promoIndex].title}
            </span>
            <span className="hidden sm:inline text-[11px] text-[var(--text-secondary)]">
              {promos[promoIndex].subtitle}
            </span>
          </div>
        </motion.div>
      </div>

      <div className="relative z-20 text-center px-4">
        <motion.h1
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
          className="text-4xl md:text-6xl font-bold
                     text-[var(--text-hero)]
                     drop-shadow-[0_10px_30px_rgba(0,0,0,0.75)]"
        >
          Crafted by Hand, Perfected by HomeFix
        </motion.h1>
        <motion.p
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.6 }}
          className="text-lg md:text-xl mt-4 text-[var(--text-hero)]/90"
        >
          Experience the art of modern woodworking and precision design.
        </motion.p>
      </div>
    </section>
  );
}

/* -------------------------------------------------------------------------- */
/* üß© LAZY YOUTUBE                                                            */
/* -------------------------------------------------------------------------- */
function LazyYouTube({ src, title }: { src: string; title: string }) {
  const ref = useRef<HTMLDivElement>(null);
  const [visible, setVisible] = useState(false);
  const [loaded, setLoaded] = useState(false);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;
    const obs = new IntersectionObserver(([e]) => {
      if (e.isIntersecting) {
        setVisible(true);
        obs.disconnect();
      }
    });
    obs.observe(el);
    return () => obs.disconnect();
  }, []);

  const videoId = src.split("/embed/")[1]?.split("?")[0];
  const thumb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
  const hasQuery = src.includes("?");
  const embedSrc = `${src}${
    hasQuery ? "&" : "?"
  }start=30&autoplay=1&mute=1&rel=0`;

  return (
    <div
      ref={ref}
      className="relative rounded-2xl overflow-hidden w-full md:w-[560px] aspect-video bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)] shadow-xl"
    >
      {!loaded && <Shimmer />}
      {visible ? (
        <iframe
          className="w-full h-full"
          src={embedSrc}
          title={title}
          loading="lazy"
          onLoad={() => setLoaded(true)}
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowFullScreen
        />
      ) : (
        <>
          <Image
            src={thumb}
            alt={title}
            fill
            className="object-cover opacity-80"
          />
          <div className="absolute inset-0 flex items-center justify-center">
            <button
              aria-label={`Play ${title}`}
              className="w-16 h-16 rounded-full bg-white/90 text-red-600 flex items-center justify-center shadow-lg"
            >
              ‚ñ∂
            </button>
          </div>
        </>
      )}
    </div>
  );
}

/* -------------------------------------------------------------------------- */
/* üè† HOMEPAGE MAIN                                                          */
/* -------------------------------------------------------------------------- */
export default function HomePage() {
  const { scrollY } = useScroll();
  const diyY = useSpring(useTransform(scrollY, [0, 800], [0, -60]), {
    stiffness: 60,
    damping: 15,
  });
  const ctaY = useSpring(useTransform(scrollY, [800, 1800], [0, -80]), {
    stiffness: 60,
    damping: 15,
  });

  return (
    <div
      className="relative flex flex-col items-stretch overflow-x-hidden w-full
                 bg-[var(--surface-base)]
                 text-[var(--text-primary-light)] dark:text-[var(--text-primary-dark)]
                 transition-colors duration-500 isolate"
    >
      <div
        aria-hidden="true"
        className="pointer-events-none absolute inset-0 -z-10 opacity-40 transition-colors duration-500"
        style={{
          background:
            "radial-gradient(circle at 18% 12%, var(--section-sheen) 0%, transparent 55%), radial-gradient(circle at 80% 0%, var(--section-veil) 0%, transparent 70%)",
        }}
      />
      {/* HERO */}
      <HeroVideoSequence />

      {/* SERVICES */}
      <section
        className="relative pt-16 md:pt-20 pb-24 px-4 w-full
                         bg-[var(--surface-base)] transition-colors duration-500"
      >
        <div
          aria-hidden="true"
          className="absolute inset-0 -z-10 pointer-events-none"
          style={{
            background:
              "linear-gradient(180deg, var(--section-sheen) 0%, transparent 65%)",
          }}
        />
        <div
          aria-hidden="true"
          className="absolute inset-x-0 bottom-0 h-32 -z-10 pointer-events-none"
          style={{
            background:
              "linear-gradient(0deg, var(--section-veil) 0%, transparent 100%)",
          }}
        />
        <div className="relative z-10 max-w-6xl mx-auto mb-10 text-center space-y-2">
          <p className="text-xs uppercase tracking-[0.3em] text-[var(--text-muted)]">
            Services
          </p>
          <h2 className="text-3xl font-semibold text-[var(--text-primary-light)] dark:text-[var(--text-primary-dark)]">
            Everything your home needs, in one orbit.
          </h2>
          <p className="text-sm text-[var(--text-subtle)] max-w-2xl mx-auto">
            From quick repairs to full interior makeovers, explore curated
            services powered by the Edith Universe.
          </p>
        </div>

        <div className="relative z-10 grid gap-8 md:grid-cols-3 w-full max-w-6xl mx-auto">
          {[
            {
              name: "Home Repairs",
              tagline: "Quick Fixes & Maintenance",
              anim: fixAnim,
            },
            {
              name: "Interior Design",
              tagline: "Modern Modular Spaces",
              anim: interiorAnim,
            },
            {
              name: "Painting & Finishes",
              tagline: "Vibrant Walls, Lasting Impressions",
              anim: paintAnim,
            },
            {
              name: "Electrical Works",
              tagline: "Safe & Smart Wiring",
              anim: electricAnim,
            },
            {
              name: "DIY Inspirations",
              tagline: "Learn, Build, Create",
              anim: diyAnim,
            },
            {
              name: "Civil & Renovation",
              tagline: "Foundations & Transformations",
              anim: civilAnim,
            },
          ].map((s, i) => (
            <motion.div
              key={s.name}
              initial={{ opacity: 0, y: 40 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: i * 0.15 }}
              whileHover={{ scale: 1.03, y: -4 }}
              className="relative group rounded-2xl overflow-hidden
                       bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                       shadow-lg hover:shadow-2xl border border-[var(--border-soft)]
                       hover:border-[var(--accent-tertiary)]/60
                       transition-all duration-500"
            >
              <motion.div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 bg-gradient-to-br from-[var(--accent-primary)]/10 to-[var(--accent-secondary)]/10 blur-2xl" />
              <div className="relative p-6 flex flex-col items-center text-center z-10">
                <div className="relative w-28 h-28 mb-2">
                  <Lottie
                    animationData={s.anim}
                    loop
                    autoplay
                    className="absolute inset-0"
                  />
                </div>
                <h3 className="text-xl font-semibold mt-2 text-[var(--accent-primary)] dark:text-[var(--accent-secondary)]">
                  {s.name}
                </h3>
                <p className="text-sm mt-1 text-[var(--text-secondary)]">
                  {s.tagline}
                </p>
              </div>
              <motion.div
                className="absolute inset-x-0 bottom-0 h-[2px] bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]"
                layoutId={`border-${i}`}
              />
            </motion.div>
          ))}
        </div>
      </section>

      {/* DIY SECTION */}
      <motion.section
        style={{ y: diyY }}
        className="relative py-24 w-full px-4 transition-colors duration-500
                   bg-[var(--surface-base)]"
      >
        <div
          aria-hidden="true"
          className="pointer-events-none absolute inset-0 -z-10"
          style={{
            background:
              "radial-gradient(circle at 15% 25%, var(--section-sheen) 0%, transparent 60%), radial-gradient(circle at 85% 30%, var(--section-veil) 0%, transparent 70%)",
          }}
        />
        <div className="relative z-10">
          <h2 className="text-3xl font-bold text-center mb-10 text-[var(--accent-primary)] dark:text-[var(--accent-secondary)]">
            DIY Inspirations
          </h2>
          <div className="flex flex-col md:flex-row gap-8 justify-center items-center">
            <LazyYouTube
              src="https://www.youtube.com/embed/DeSDjjicGWY"
              title="DIY Project Ideas"
            />
            <LazyYouTube
              src="https://www.youtube.com/embed/S9dvDU5RmQU"
              title="HomeFix Project Reel"
            />
          </div>
        </div>
      </motion.section>

      {/* CTA */}
      <motion.section
        style={{ y: ctaY }}
        className="relative w-full h-[45vh] flex flex-col items-center justify-center text-center bg-[url('https://images.pexels.com/photos/1571460/pexels-photo-1571460.jpeg')] bg-cover bg-center"
      >
        <div
          className="absolute inset-0"
          style={{
            background:
              "linear-gradient(180deg, color-mix(in srgb, var(--hero-overlay-top) 25%, transparent) 0%, color-mix(in srgb, var(--hero-overlay-mid) 20%, transparent) 45%, color-mix(in srgb, var(--overlay-cta) 80%, transparent) 100%)",
          }}
        />
        <div className="relative z-10 text-white px-4">
          <motion.h2
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8 }}
            className="text-3xl md:text-4xl font-bold mb-4"
          >
            Ready to Get Started?
          </motion.h2>
          <Link
            href="/checkout"
            className="px-6 py-3 rounded-xl text-white font-semibold shadow-lg
                       bg-[var(--accent-success)] hover:bg-[var(--accent-success-hover)]
                       transition-colors duration-200"
          >
            Book Your Service Now
          </Link>
        </div>
      </motion.section>

      <InstallFAB />
      <Footer />
    </div>
  );
}

--- app/profile/page.tsx ---
"use client";

/**
 * ============================================================
 * üß© FILE: /app/profile/page.tsx (FIXED v5.0)
 * ------------------------------------------------------------
 * ‚≠ê NO MORE direct localStorage writes
 * ‚≠ê Uses UserContext.setUser() instead
 * ‚≠ê Does NOT overwrite Supabase/Session user object
 * ‚≠ê My Orders + LedgerX finally get correct UID
 * ============================================================
 */

import AuthCenterDrawer from "@/components/AuthCenterDrawer";
import MapPicker from "@/components/MapPicker";
import SafeViewport from "@/components/layout/SafeViewport";
import { useUser } from "@/contexts/UserContext";
import { useToast } from "@/hooks/use-toast";
import { motion } from "framer-motion";
import { useRouter } from "next/navigation";
import { useCallback, useEffect, useRef, useState } from "react";

interface ProfileData {
  id?: string;
  name?: string;
  full_name?: string;
  phone?: string;
  email?: string;
  email_verified?: boolean;
  phone_verified?: boolean;
  address?: string;
  latitude?: number;
  longitude?: number;
  role?: string;
}

export default function ProfilePage() {
  const router = useRouter();
  const { user, setUser, logout, isLoaded } = useUser();
  const { success, error, info } = useToast();

  const [profile, setProfile] = useState<ProfileData | null>(null);
  const [loading, setLoading] = useState(true);
  const [coords, setCoords] = useState({ lat: 13.0827, lng: 80.2707 });
  const [address, setAddress] = useState("");
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [drawerMode, setDrawerMode] = useState<
    "form" | "phone-otp" | "email-otp"
  >("form");
  const [editingAddress, setEditingAddress] = useState(false);

  /* ------------------------------------------------------------
     üß† Safely hydrate WITHOUT overwriting auth/session state
  ------------------------------------------------------------ */
  const hydrate = useCallback(
    (fresh: any, base: any = user) => {
      const merged = {
        ...(base || {}),
        ...(fresh || {}),
      name: fresh?.name || fresh?.full_name || base?.name,
      email_verified: fresh?.email_verified ?? base?.email_verified ?? false,
      phone_verified: fresh?.phone_verified ?? base?.phone_verified ?? false,
    };

    setProfile(merged);
    setUser(merged); // <--- SAFE. Updates React + UserContext + storage.

      if (merged.address) setAddress(merged.address);

      if (merged.latitude && merged.longitude)
        setCoords({ lat: merged.latitude, lng: merged.longitude });
    },
    [setUser, user]
  );

  /* ------------------------------------------------------------
     üîÅ Fetch profile from backend
  ------------------------------------------------------------ */
  const prefetchProfile = useCallback(async () => {
    try {
      const phone = user?.phone;
      if (!phone) {
        if (user) hydrate(user, user);
        setLoading(false);
        return;
      }

      const resp = await fetch(`/api/profile?phone=${phone}`, {
        cache: "no-store",
      });

      const json = await resp.json();
      if (json?.user) hydrate(json.user, user);
      else hydrate(user, user);
    } catch (err) {
      console.error("Profile fetch failed:", err);
      hydrate(user, user);
    } finally {
      setLoading(false);
    }
  }, [hydrate, user]);

  const lastFetchedId = useRef<string | null>(null);

  useEffect(() => {
    if (!user) {
      if (!isLoaded) return;
      try {
        const cached = JSON.parse(localStorage.getItem("user") || "null");
        if (cached) {
          hydrate(cached, cached);
          lastFetchedId.current = cached.id ?? null;
        }
      } catch {
        // ignore parse errors
      } finally {
        setLoading(false);
      }
      return;
    }

    if (lastFetchedId.current === user.id) return;
    lastFetchedId.current = user.id ?? null;

    hydrate(user, user);
    prefetchProfile();
  }, [user, isLoaded, hydrate, prefetchProfile]);

  /* ------------------------------------------------------------
     üìç Save Location
  ------------------------------------------------------------ */
  async function saveLocation() {
    if (!profile?.phone) return;

    try {
      const updates = {
        phone: profile.phone,
        address,
        latitude: coords.lat,
        longitude: coords.lng,
      };

      const res = await fetch("/api/profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates),
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.message);

      hydrate(data.user);

      success("üìç Location saved.");
      navigator.vibrate?.(20);

      setEditingAddress(false);
      window.dispatchEvent(new Event("profile-updated"));
    } catch (e: any) {
      error("Failed to save location.");
      console.error(e);
      navigator.vibrate?.([120]);
    }
  }

  /* ------------------------------------------------------------
     üö™ Logout
  ------------------------------------------------------------ */
  async function handleLogout() {
    await logout().catch(() => {});
    success("Logged out.");
    navigator.vibrate?.([60, 40, 120]);
    router.replace("/login");
  }

  /* ------------------------------------------------------------
     üß± UI
  ------------------------------------------------------------ */
  if (loading) {
    return (
      <SafeViewport>
        <div className="max-w-5xl mx-auto p-6 text-center text-[var(--text-secondary)]">
          <p className="animate-pulse">Loading your profile...</p>
        </div>
      </SafeViewport>
    );
  }
  const fullyVerified = !!(profile?.email_verified && profile?.phone_verified);

  return (
    <SafeViewport>
      <div className="max-w-5xl mx-auto p-6 space-y-6 pb-[var(--mbnav-h-safe)]">
        {/* Banner */}
        <div
          onClick={() => {
            if (!fullyVerified) {
              setDrawerMode("form");
              setDrawerOpen(true);
            }
          }}
          className={`cursor-pointer rounded-xl px-4 py-3 shadow-sm border flex items-center justify-between ${
            fullyVerified
              ? "bg-[color-mix(in_srgb,var(--accent-success)10%,transparent)] border-[color-mix(in_srgb,var(--accent-success)35%,transparent)] text-[var(--accent-success)]"
              : "bg-[color-mix(in_srgb,var(--accent-danger)10%,transparent)] border-[color-mix(in_srgb,var(--accent-danger)35%,transparent)] text-[var(--accent-danger)]"
          }`}
        >
          <span className="font-medium">
            {fullyVerified ? "Verified Profile ‚úì" : "Unverified ‚Äî Verify Now"}
          </span>
          {!fullyVerified && <span className="text-sm underline">Open</span>}
        </div>

        <h1 className="text-2xl font-bold text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]">
          My Profile
        </h1>

        {/* Card */}
        <motion.div
          initial={{ opacity: 0, y: 15 }}
          animate={{ opacity: 1, y: 0 }}
          className="border border-[var(--border-soft)] p-5 rounded-2xl shadow-sm bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]"
        >
          <div className="grid gap-3">
            <Field label="Name" value={profile?.name} />
            <Field label="Phone" value={profile?.phone} />
            <Field label="Email" value={profile?.email} />
            <Field label="Address" value={address} />
          </div>

          <div className="flex flex-wrap gap-3 mt-5">
            <button
              onClick={() => setDrawerOpen(true)}
              className="text-white px-4 py-2 rounded-lg font-medium"
              style={{ background: "var(--accent-primary)" }}
            >
              Edit / Verify Account
            </button>

            <button
              onClick={() => setEditingAddress(true)}
              className="text-white px-4 py-2 rounded-lg font-medium"
              style={{ background: "var(--accent-warning)" }}
            >
              Edit Address
            </button>

            {editingAddress && (
              <button
                onClick={saveLocation}
                className="text-white px-4 py-2 rounded-lg font-medium"
                style={{ background: "var(--accent-success)" }}
              >
                Save Location
              </button>
            )}

            <button
              onClick={handleLogout}
              className="text-white px-4 py-2 rounded-lg font-medium ml-auto"
              style={{ background: "var(--accent-danger)" }}
            >
              Logout
            </button>
          </div>
        </motion.div>

        {/* Address Editor */}
        {editingAddress && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="border border-[var(--border-soft)] p-5 rounded-2xl shadow-sm bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]"
          >
            <h2 className="font-semibold text-lg mb-2">üìç Update Address</h2>
            <MapPicker
              initialLocation={coords}
              editable
              onLocationChange={(loc, addr) => {
                if (loc) setCoords(loc);
                setAddress(addr ?? "");
              }}
            />

            <p className="text-sm mt-2">
              <strong>Detected Address:</strong>{" "}
              {address || "Move the pin to detect address"}
            </p>
          </motion.div>
        )}

        <AuthCenterDrawer
          open={drawerOpen}
          onClose={() => setDrawerOpen(false)}
          initialMode={drawerMode}
        />
      </div>
    </SafeViewport>
  );
}

function Field({ label, value }: { label: string; value?: string }) {
  return (
    <div>
      <label className="text-sm text-[var(--text-muted)]">{label}</label>
      <div className="font-medium text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]">
        {value || "‚Äî"}
      </div>
    </div>
  );
}

--- app/services/page.tsx ---
"use client";
/**
 * =============================================================
 * File: /app/services/page.tsx
 * Module: HomeFix Services Explorer v4.0 ‚Äî Gemini Unified üåó
 * -------------------------------------------------------------
 * ‚úÖ True theme sync (no hardcoded bg/text)
 * ‚úÖ Smooth transitions preserved
 * ‚úÖ Hero + Cards auto-adapt to global theme
 * ‚úÖ Brand gradients intact
 * =============================================================
 */

import InstallFAB from "@/components/InstallFAB";
import ServiceCartDrawer from "@/components/ui/ServiceCartDrawer";
import supabase from "@/lib/supabaseClient";
import { AnimatePresence, motion } from "framer-motion";
import { ArrowUpRight } from "lucide-react";
import Image from "next/image";
import { useEffect, useState } from "react";

const FALLBACK_ICON_DATA =
  "data:image/svg+xml," +
  encodeURIComponent(
    `<svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
      <rect width="48" height="48" rx="14" fill="rgba(155,92,248,0.18)"/>
      <path d="M16 26l6-7 4 4 4-4 6 8" stroke="%239B5CF8" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`
  );

interface ServiceItem {
  id: number;
  title: string;
  description?: string;
  price?: number;
  unit?: string;
  icon?: string;
  image_url?: string;
  slug?: string;
  category?: string;
  type?: string;
}

export default function ServicesPage() {
  const [categories, setCategories] = useState<ServiceItem[]>([]);
  const [services, setServices] = useState<ServiceItem[]>([]);
  const [selected, setSelected] = useState<ServiceItem | null>(null);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [activeService, setActiveService] = useState<ServiceItem | null>(null);
  const [loading, setLoading] = useState(true);

  /* ------------------------------------------------------------ */
  useEffect(() => {
    async function fetchServices() {
      try {
        setLoading(true);
        const { data, error } = await supabase
          .from("services")
          .select("*")
          .eq("is_active", true)
          .order("id", { ascending: true });

        if (error) throw error;

        const cats = (data || []).filter((d) => d.type === "category");
        const servs = (data || []).filter((d) => d.type === "service");

        setCategories(cats);
        setServices(servs);
        if (cats.length > 0) setSelected(cats[0]);
      } catch (err) {
        console.error("‚ùå [Services] Fetch failed:", err);
      } finally {
        setLoading(false);
      }
    }
    fetchServices();
  }, []);

  const filteredServices = services.filter(
    (s) =>
      s.category?.toLowerCase().trim() === selected?.title?.toLowerCase().trim()
  );

  const openDrawer = (service: ServiceItem) => {
    setActiveService(service);
    setDrawerOpen(true);
  };
  const closeDrawer = () => {
    setDrawerOpen(false);
    setTimeout(() => setActiveService(null), 250);
  };

  /* ------------------------------------------------------------ */
  return (
    <main
      className="relative flex flex-col items-center justify-start min-h-[calc(100vh-72px)]
                 bg-[var(--surface-base)]
                 text-[var(--text-primary-light)] dark:text-[var(--text-primary-dark)]
                 pt-20 px-4 md:px-8 transition-colors duration-500 overflow-hidden"
    >
      {/* ‚ú® Loading State */}
      {loading && (
        <div className="flex flex-col items-center justify-center h-[50vh] text-center">
          <div className="animate-spin rounded-full h-10 w-10 border-2 border-[var(--accent-tertiary)] border-t-transparent mb-4"></div>
          <p className="text-sm opacity-70">Fetching HomeFix services‚Ä¶</p>
        </div>
      )}

      {/* üåà Loaded State */}
      {!loading && selected && (
        <>
          {/* üñºÔ∏è Hero Section */}
          <motion.section
            key={selected.id}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            className="relative w-full max-w-6xl rounded-3xl overflow-hidden shadow-xl
                       bg-[var(--surface-light)] dark:bg-[var(--surface-dark)] mb-10
                       transition-colors duration-500"
          >
            <div className="relative w-full h-[300px] md:h-[420px] overflow-hidden">
              <Image
                src={selected.image_url || "/placeholder.png"}
                alt={selected.title || "Service"}
                fill
                priority
                sizes="(max-width: 768px) 100vw, 1200px"
                className="object-cover transition-transform duration-700 hover:scale-105"
              />
              <div
                className="absolute inset-0"
                style={{
                  background:
                    "linear-gradient(to top, color-mix(in srgb, var(--surface-dark) 92%, transparent 8%), color-mix(in srgb, var(--surface-dark) 55%, transparent 45%), transparent)",
                }}
              />
              <div className="absolute bottom-6 left-6 text-white z-10">
                <motion.h1
                  className="text-3xl md:text-5xl font-bold mb-2"
                  initial={{ opacity: 0, y: 15 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.2 }}
                >
                  {selected.title}
                </motion.h1>
                <motion.p
                  className="max-w-lg text-sm md:text-base text-gray-200"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  transition={{ delay: 0.4 }}
                >
                  {selected.description ||
                    "Professional home and commercial services by HomeFix India."}
                </motion.p>
              </div>
            </div>
          </motion.section>

          {/* üß© Category Tabs */}
          <motion.section
            layout
            className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 w-full max-w-6xl mb-10"
          >
            {categories.map((cat) => (
              <motion.button
                key={cat.id}
                layout
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.97 }}
                onClick={() => setSelected(cat)}
                className={`relative flex flex-col items-center justify-center p-4 rounded-2xl shadow-md
                            bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                            border transition-all duration-300
                            ${
                              selected.id === cat.id
                                ? "border-[var(--accent-tertiary)]/60 shadow-lg"
                                : "border-[var(--border-soft)]/40"
                            }`}
              >
                <CategoryIcon src={cat.icon} alt={cat.title} />
                <span className="font-medium text-center text-sm">
                  {cat.title}
                </span>
              </motion.button>
            ))}
          </motion.section>

          {/* üíº Services Grid */}
          <AnimatePresence mode="wait">
            <motion.section
              key={selected.title}
              initial={{ opacity: 0, y: 15 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.4 }}
              className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-6xl pb-24"
            >
              {filteredServices.length > 0 ? (
                filteredServices.map((srv) => (
                  <motion.div
                    key={srv.id}
                    whileHover={{ scale: 1.02 }}
                    transition={{ type: "spring", stiffness: 200, damping: 20 }}
                    className="group relative rounded-2xl shadow-md overflow-hidden border
                               bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                               border-[var(--border-soft)]/60 transition-all duration-300"
                  >
                    <div className="relative h-48 w-full">
                      <Image
                        src={srv.image_url || "/placeholder.png"}
                        alt={srv.title}
                        fill
                        sizes="(max-width: 768px) 100vw, 1200px"
                        className="object-cover group-hover:scale-105 transition-transform duration-500"
                      />
                      <div
                        className="absolute inset-0"
                        style={{
                          background:
                            "linear-gradient(to top, color-mix(in srgb, var(--surface-dark) 86%, transparent 14%), transparent)",
                        }}
                      />
                      <div className="absolute bottom-3 left-4 text-white">
                        <h3 className="font-semibold text-lg">{srv.title}</h3>
                        {srv.price && (
                          <p className="text-sm opacity-80">
                            ‚Çπ{srv.price} / {srv.unit || "unit"}
                          </p>
                        )}
                      </div>
                    </div>
                    <div className="p-4">
                      <p className="text-sm opacity-80 mb-2 line-clamp-2">
                        {srv.description}
                      </p>
                      <button
                        onClick={() => openDrawer(srv)}
                        className="mt-2 inline-flex items-center justify-center w-full py-2 rounded-lg
                                   bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]
                                   text-white text-sm font-medium hover:opacity-90 transition"
                      >
                        Book Now
                        <ArrowUpRight className="ml-2 w-4 h-4" />
                      </button>
                    </div>
                  </motion.div>
                ))
              ) : (
                <p className="col-span-full text-center opacity-70 text-sm">
                  No active services found under {selected.title}.
                </p>
              )}
            </motion.section>
          </AnimatePresence>
        </>
      )}

      {/* ü™∂ Drawer & FAB */}
      <ServiceCartDrawer
        service={activeService}
        open={drawerOpen}
        onClose={closeDrawer}
        onAdd={() => {}}
      />
      <InstallFAB />
    </main>
  );
}

function CategoryIcon({
  src,
  alt,
}: {
  src?: string | null;
  alt?: string | null;
}) {
  const [errored, setErrored] = useState(false);
  const resolvedSrc = !errored && src ? src : FALLBACK_ICON_DATA;
  return (
    <Image
      src={resolvedSrc}
      alt={alt || "Service category"}
      width={40}
      height={40}
      className="mb-2"
      unoptimized
      onError={() => setErrored(true)}
    />
  );
}

--- app/settings/page.tsx ---
"use client";

import { motion } from "framer-motion";
import dynamic from "next/dynamic";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";

// ‚ùó FIXED ‚Äî correct supabase import
import { supabase } from "@/lib/supabaseClient";

import PWAInstallButton from "@/components/PWAInstallButton";
import { useAuth } from "@/lib/useAuth";
import {
  Briefcase,
  ChevronRight,
  Hammer,
  LogOut,
  Shield,
  User,
} from "lucide-react";

const ThemeToggle = dynamic(() => import("@/components/ThemeToggle"), {
  ssr: false,
});

export default function SettingsPage() {
  const { user, setUser, loading } = useAuth();
  const router = useRouter();

  const [role, setRole] = useState("user");
  const [loadingRole, setLoadingRole] = useState(true);

  /* ------------------------------------------------------------
     üß† Role Detection
  ------------------------------------------------------------ */
  useEffect(() => {
    if (!user) {
      setRole("guest");
      setLoadingRole(false);
      return;
    }

    const checkRole = async () => {
      setLoadingRole(true);
      try {
        const metaRole =
          user.role || user?.user_metadata?.role || user?.app_metadata?.role;

        if (metaRole) {
          setRole(metaRole);
          return;
        }

        const { data, error } = await supabase
          .from("user_profiles")
          .select("role")
          .eq("id", user.id)
          .maybeSingle();

        if (error) console.warn("[SETTINGS] Role fetch error:", error.message);

        setRole(data?.role || "user");
      } catch (err) {
        console.error("[SETTINGS] Role check failed:", err);
        setRole("user");
      } finally {
        setLoadingRole(false);
      }
    };

    checkRole();
  }, [user]);

  if (loading || loadingRole) return null;

  /* ------------------------------------------------------------
     üö™ Logout Handler
  ------------------------------------------------------------ */
  const handleLogout = async () => {
    try {
      await supabase.auth.signOut(); // ‚ùó Now it works because import is correct
    } catch (e) {
      console.warn("Logout failed", e);
    }

    localStorage.removeItem("user");
    setUser(null);
    router.push("/login");
  };

  // Derived flags
  const isAdmin = role === "admin";
  const isManager = role === "manager";
  const isTechnician = role === "technician";

  return (
    <div className="min-h-[100dvh] bg-[var(--surface-base)] pt-6 pb-28 px-4 md:pb-12 transition-colors duration-500">
      <motion.h1
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.3 }}
        className="text-xl font-semibold mb-4 text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]"
      >
        Settings
      </motion.h1>

      {!user ? (
        <Link
          href="/login"
          className="block text-center py-4 rounded-xl bg-[var(--accent-success)] hover:bg-[var(--accent-success-hover)] text-white font-medium transition"
        >
          Log in / Sign up
        </Link>
      ) : (
        <>
          {/* User Card */}
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.4 }}
            className="bg-[var(--surface-card)]/90 dark:bg-[var(--surface-card-dark)]/85 backdrop-blur-lg rounded-2xl p-4 shadow-sm border border-[var(--border-soft)] flex items-center justify-between"
          >
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-full bg-[var(--accent-success)]/12 dark:bg-[var(--accent-success)]/25 flex items-center justify-center">
                <User className="w-6 h-6 text-[var(--accent-success)]" />
              </div>
              <div>
                <p className="font-medium text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]">
                  {user?.name || "Aesthetic Home"}
                </p>
                <p className="text-xs text-[var(--text-muted)]">
                  {user?.phone || "720009XXXX"}
                </p>
                {role !== "user" && (
                  <span className="inline-block mt-1 text-[10px] px-2 py-[2px] rounded-full bg-[var(--badge-live-bg)] text-[var(--badge-live-text)] uppercase">
                    {role}
                  </span>
                )}
              </div>
            </div>
            <ThemeToggle />
          </motion.div>

          {/* Settings Actions */}
          <section className="mt-6 space-y-3">
            <Link
              href="/profile"
              className="flex items-center justify-between bg-[var(--surface-card)]/90 dark:bg-[var(--surface-card-dark)]/85 backdrop-blur-md border border-[var(--border-soft)] rounded-xl p-3 hover:bg-[var(--surface-hover)]/80 dark:hover:bg-[var(--surface-hover)]/60 transition"
            >
              <div className="flex items-center gap-3">
                <User className="w-5 h-5 text-[var(--accent-primary)]" />
                <span className="text-sm text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]">
                  Manage Profile
                </span>
              </div>
              <ChevronRight className="w-4 h-4 text-gray-400" />
            </Link>

            {/* Admin */}
            {isAdmin && (
              <motion.button
                onClick={() => router.push("/admin")}
                whileTap={{ scale: 0.97 }}
                className="w-full flex items-center justify-between bg-[var(--accent-success)] text-white rounded-xl p-3 shadow-md hover:bg-[var(--accent-success-hover)] transition"
              >
                <div className="flex items-center gap-3">
                  <Shield className="w-5 h-5" />
                  <span className="text-sm font-medium">Admin Dashboard</span>
                </div>
                <ChevronRight className="w-4 h-4 opacity-80" />
              </motion.button>
            )}

            {/* Manager */}
            {isManager && (
              <motion.button
                onClick={() => router.push("/manager")}
                whileTap={{ scale: 0.97 }}
                className="w-full flex items-center justify-between bg-[var(--accent-info)] text-white rounded-xl p-3 shadow-md hover:brightness-110 transition"
              >
                <div className="flex items-center gap-3">
                  <Briefcase className="w-5 h-5" />
                  <span className="text-sm font-medium">Manager Panel</span>
                </div>
                <ChevronRight className="w-4 h-4 opacity-80" />
              </motion.button>
            )}

            {/* Technician */}
            {isTechnician && (
              <motion.button
                onClick={() => router.push("/technician")}
                whileTap={{ scale: 0.97 }}
                className="w-full flex items-center justify-between bg-[var(--accent-warning)] text-white rounded-xl p-3 shadow-md hover:brightness-110 transition"
              >
                <div className="flex items-center gap-3">
                  <Hammer className="w-5 h-5" />
                  <span className="text-sm font-medium">Technician Tools</span>
                </div>
                <ChevronRight className="w-4 h-4 opacity-80" />
              </motion.button>
            )}

            <PWAInstallButton />
          </section>

          {/* Logout */}
          <motion.button
            onClick={handleLogout}
            whileTap={{ scale: 0.97 }}
            className="w-full flex items-center justify-center gap-2 mt-8 py-3 text-sm font-medium text-white rounded-xl shadow-md transition"
            style={{ background: "var(--accent-danger)" }}
          >
            <LogOut className="w-4 h-4" />
            Logout
          </motion.button>
        </>
      )}
    </div>
  );
}

--- app/store/page.tsx ---
"use client";
/**
 * ============================================================
 * üè¨ HomeFix Store ‚Äî Edith Continuum v11.0 üåø Checkout-Aware
 * ------------------------------------------------------------
 * ‚úÖ Floating "Proceed to Checkout" bar (cart > 0)
 * ‚úÖ Smooth appear/disappear animation
 * ‚úÖ Works on mobile + desktop
 * ‚úÖ Edith gradient button style
 * ============================================================
 */

import { useProductCartStore } from "@/components/store/cartStore";
import ProductCard, { Product } from "@/components/store/ProductCard";
import { useSidebar } from "@/contexts/SidebarContext";
import supabase from "@/lib/supabaseClient";
import { AnimatePresence, motion } from "framer-motion";
import { PackageOpen, Search, Tag } from "lucide-react";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";

export default function StorePage() {
  const router = useRouter();
  const { collapsed } = useSidebar();
  const { items, totalPrice } = useProductCartStore();
  const cartCount = items.length;

  const [products, setProducts] = useState<Product[]>([]);
  const [filtered, setFiltered] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [category, setCategory] = useState("all");
  const [isDesktop, setIsDesktop] = useState(false);

  const categories = [
    { name: "all", icon: <Tag size={20} /> },
    { name: "Doors", icon: <Tag size={20} /> },
    { name: "CNC Elements", icon: <Tag size={20} /> },
    { name: "Wooden Panels", icon: <Tag size={20} /> },
    { name: "Paint Finishes", icon: <Tag size={20} /> },
    { name: "Hardware", icon: <Tag size={20} /> },
    { name: "Lighting", icon: <Tag size={20} /> },
    { name: "Bathroom", icon: <Tag size={20} /> },
  ];

  /* üî• Fetch from Supabase */
  useEffect(() => {
    let active = true;
    const fetchProducts = async () => {
      setLoading(true);
      const { data, error } = await supabase
        .from("goods")
        .select("*")
        .returns<Product[]>();
      if (active) {
        if (!error) setProducts(data || []);
        setLoading(false);
      }
    };
    fetchProducts();
    return () => {
      active = false;
    };
  }, []);

  /* üéØ Search + Filter */
  useEffect(() => {
    const timer = setTimeout(() => {
      let list = [...products];
      if (category !== "all") {
        list = list.filter(
          (p) => p.category?.toLowerCase() === category.toLowerCase()
        );
      }
      if (search.trim()) {
        const q = search.toLowerCase();
        list = list.filter((p) => p.title?.toLowerCase().includes(q));
      }
      setFiltered(list);
    }, 120);
    return () => clearTimeout(timer);
  }, [search, category, products]);

  /* üñ•Ô∏è Detect desktop for rail positioning */
  useEffect(() => {
    const handleResize = () => setIsDesktop(window.innerWidth >= 768);
    handleResize();
    window.addEventListener("resize", handleResize);
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  /* üíé UI */
  return (
    <section
      id="store-safe-zone"
      className="relative flex flex-col w-full mx-auto
                 overflow-hidden
                 bg-[var(--surface-base)]
                 transition-colors duration-500"
      style={{
        minHeight: "calc(100vh - var(--header-h) - var(--mbnav-h,72px))",
      }}
    >
      {/* üîç Search */}
      <div className="relative flex w-full sm:max-w-md mx-auto mt-4 mb-3 px-4">
        <Search className="absolute left-6 top-2.5 w-4 h-4 text-[var(--text-muted)]" />
        <input
          id="store-search"
          type="text"
          placeholder="Search products..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="w-full pl-10 pr-3 py-2 rounded-xl border border-[var(--border-soft)]
                     bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                     text-sm text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]
                     focus:ring-2 focus:ring-[var(--accent-primary)] outline-none transition"
        />
      </div>

      <div className="relative flex-1 flex flex-row">
        {/* üìÅ Category Rail */}
        <motion.aside
          animate={{
            left: isDesktop ? (collapsed ? 80 : 256) : 0,
          }}
          transition={{ type: "spring", stiffness: 180, damping: 22 }}
          className="fixed z-[60]
                     border-r border-[var(--edith-border)]
                     bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                     flex flex-col items-center overflow-y-auto scroll-smooth
                     touch-pan-y backdrop-blur-md"
          style={{
            top: "var(--header-h)",
            bottom: "var(--mbnav-h,72px)",
            width: isDesktop ? "96px" : "80px",
            WebkitOverflowScrolling: "touch",
            scrollbarWidth: "none",
          }}
        >
          <div className="flex flex-col py-3 gap-3 items-center w-full">
            {categories.map((cat) => {
              const isActive = cat.name === category;
              return (
                <motion.button
                  key={cat.name}
                  onClick={() => setCategory(cat.name)}
                  whileTap={{ scale: 0.94 }}
                  className={`relative w-[72px] h-[72px] rounded-2xl flex flex-col items-center justify-center text-[11px] font-medium
                    overflow-hidden transition-all duration-300 text-center
                    ${
                      isActive
                        ? "bg-gradient-to-b from-[var(--accent-success)] to-[var(--accent-success-hover)] text-white shadow-[0_0_10px_rgba(16,185,129,0.6)]"
                        : "bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)] text-[var(--text-secondary)] hover:bg-[var(--surface-hover)]"
                    }`}
                >
                  <div className="mb-1">{cat.icon}</div>
                  <span className="leading-tight px-1 whitespace-normal break-words text-[10px] font-medium">
                    {cat.name}
                  </span>
                </motion.button>
              );
            })}
          </div>
        </motion.aside>

        {/* üß© Product Grid */}
        <section
          className="flex-1 overflow-y-auto px-4 sm:px-8 pb-32 pt-4 transition-all duration-700 ease-in-out
                     bg-[var(--surface-base)]"
          style={{
            marginLeft: isDesktop
              ? `calc(${collapsed ? 80 : 256}px + 96px)`
              : "80px",
          }}
        >
          <AnimatePresence mode="popLayout">
            {loading ? (
              <motion.div
                key="loading"
                className="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3 px-1 justify-items-center"
              >
                {Array.from({ length: 12 }).map((_, i) => (
                  <div
                    key={i}
                    className="aspect-[4/5.5] rounded-xl bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)] animate-pulse w-full"
                  />
                ))}
              </motion.div>
            ) : filtered.length > 0 ? (
              <motion.div
                key="grid"
                layout
                className="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-3 px-1 justify-items-center"
              >
                {filtered.map(
                  (p) => p?.id && <ProductCard key={p.id} product={p} />
                )}
              </motion.div>
            ) : (
              <motion.div
                key="empty"
                className="flex flex-col items-center justify-center h-[50vh] text-[var(--text-secondary)]"
              >
                <PackageOpen className="w-10 h-10 mb-2 text-[var(--text-muted)]" />
                <p>No products found.</p>
              </motion.div>
            )}
          </AnimatePresence>
        </section>
      </div>

      {/* üõí Floating Checkout Bar */}
      <AnimatePresence>
        {cartCount > 0 && (
          <motion.footer
            key="checkout-footer"
            initial={{ y: 80, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ y: 80, opacity: 0 }}
            transition={{ type: "spring", stiffness: 200, damping: 20 }}
            className="fixed bottom-0 left-0 right-0 z-[70] 
                       flex items-center justify-between gap-4 px-5 py-4 
                       bg-[var(--edith-surface)] border-t border-[var(--edith-border)] 
                       backdrop-blur-lg rounded-t-2xl shadow-[0_-4px_20px_rgba(0,0,0,0.1)]"
          >
            <div className="flex flex-col">
              <span className="text-xs text-[var(--text-secondary)]">
                {cartCount} {cartCount === 1 ? "item" : "items"} in cart
              </span>
              <span className="font-semibold text-[var(--accent-success)] text-lg">
                ‚Çπ{totalPrice.toLocaleString()}
              </span>
            </div>

            <button
              onClick={() => router.push("/checkout")}
              className="relative px-6 py-2.5 rounded-xl font-semibold text-white overflow-hidden group
                         bg-gradient-to-r from-fuchsia-500 via-indigo-500 to-cyan-400 hover:from-fuchsia-600 hover:to-indigo-600 
                         shadow-[0_0_16px_rgba(147,51,234,0.5)] transition-all"
            >
              <span className="relative z-10">Proceed to Checkout</span>
              <span className="absolute -inset-[2px] rounded-xl bg-gradient-to-r from-fuchsia-500 via-indigo-500 to-cyan-400 blur-md opacity-60 animate-pulse" />
            </button>
          </motion.footer>
        )}
      </AnimatePresence>
    </section>
  );
}

--- components/AuthCenterDrawer.tsx ---
"use client";
/**
 * ============================================================
 * File: /components/AuthCenterDrawer.tsx
 * Version: v13.0 ‚Äî LiveSync Verified Edition üåø
 * ------------------------------------------------------------
 * ‚úÖ Triggers `profile-updated` event after any change (name/email/verify)
 * ‚úÖ Auto-normalizes phone number before save
 * ‚úÖ Merges API response into cache + context
 * ‚úÖ Ensures real-time profile reload on /profile
 * ‚úÖ Toast-safe + haptic feedback retained
 * ============================================================
 */

import OTPInput from "@/components/OTPInput";
import {
  Drawer,
  DrawerContent,
  DrawerDescription,
  DrawerHeader,
  DrawerTitle,
} from "@/components/ui/drawer";
import { useUser } from "@/contexts/UserContext";
import { useToast } from "@/hooks/use-toast";
import { useOtpManager } from "@/hooks/useOtpManager";
import { AnimatePresence, motion } from "framer-motion";
import { Check, Mail, Phone, UserRound } from "lucide-react";
import { useEffect, useMemo, useRef, useState } from "react";

type Panel = "form" | "phone-otp" | "email-otp" | "success";

/* üîß Helper: Normalize phone */
function normalizePhone(raw: string): string {
  if (!raw) return "";
  let p = raw.replace(/\D/g, "");
  if (p.startsWith("91") && p.length === 12) return "+" + p;
  if (p.length === 10) return "+91" + p;
  if (p.startsWith("+91")) return p;
  return "+91" + p.slice(-10);
}

export default function AuthCenterDrawer({
  open,
  onClose,
  standalone = false,
  initialMode = "form",
}: {
  open: boolean;
  onClose?: () => void;
  standalone?: boolean;
  initialMode?: Panel | "form";
}) {
  const { success, error } = useToast();
  const { user, login } = useUser();
  const { sendOtp, verifyOtp, loading, verifying } = useOtpManager();

  const [panel, setPanel] = useState<Panel>("form");
  const [saving, setSaving] = useState(false);

  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [emailVerified, setEmailVerified] = useState(false);
  const [phone, setPhone] = useState("");
  const [origPhone, setOrigPhone] = useState("");
  const [phoneVerified, setPhoneVerified] = useState(false);
  const [otp, setOtp] = useState("");
  const otpRefs = useRef<HTMLInputElement[]>([]);

  const phoneDigits = phone.replace(/\D/g, "");
  const isPhoneChanged = useMemo(() => {
    const normalizedOrig = origPhone.replace(/\D/g, "").replace(/^91/, "");
    return phoneDigits.length === 10 && phoneDigits !== normalizedOrig;
  }, [phoneDigits, origPhone]);

  /* ------------------------------------------------------------
     Prefill cached data
  ------------------------------------------------------------ */
  useEffect(() => {
    if (!open) return;
    const cached = JSON.parse(localStorage.getItem("user") || "null");
    const pre = cached || user || {};
    setName(pre.name || pre.full_name || "");
    const p = (pre.phone || "")
      .toString()
      .replace(/\D/g, "")
      .replace(/^91/, "");
    setPhone(p || "");
    setOrigPhone(pre.phone || p || "");
    setPhoneVerified(!!pre.phone_verified || pre.loggedOut === false);
    setEmail(pre.email || "");
    setEmailVerified(!!pre.email_verified);
    setPanel(initialMode === "form" ? "form" : (initialMode as Panel));
    setOtp("");
  }, [open, user, initialMode]);

  /* ------------------------------------------------------------
     Save Name + Email (with LiveSync dispatch)
  ------------------------------------------------------------ */
  async function saveNameEmail() {
    setSaving(true);
    try {
      const cached = JSON.parse(localStorage.getItem("user") || "{}");
      const phoneSafe = normalizePhone(
        cached?.phone || (phoneDigits ? `+91${phoneDigits}` : "")
      );

      if (!phoneSafe) {
        error("Verify your phone before saving.");
        setSaving(false);
        return;
      }

      const payload = {
        name: name.trim(),
        email: email.trim(),
        phone: phoneSafe,
      };

      const res = await fetch("/api/profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        cache: "no-store",
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Save failed");

      const updatedUser = { ...cached, ...data.user };
      localStorage.setItem("user", JSON.stringify(updatedUser));
      login(updatedUser, true);

      // ‚úÖ LiveSync trigger ‚Äî ProfilePage listens to this event
      window.dispatchEvent(new Event("profile-updated"));

      success("Profile updated successfully!");
      navigator.vibrate?.(20);
      setPanel("success");

      setTimeout(() => {
        setPanel("form");
        onClose?.();
      }, 1200);
    } catch (err: any) {
      console.error("üí• [saveNameEmail]", err.message);
      error("Failed to save changes.");
    } finally {
      setSaving(false);
    }
  }

  /* ------------------------------------------------------------
     OTP Flow (LiveSync integrated)
  ------------------------------------------------------------ */
  const handlePhoneOtpSend = async () => {
    const ok = await sendOtp(phoneDigits, "phone");
    if (ok) setPanel("phone-otp");
  };

  const handlePhoneOtpVerify = async () => {
    const verified = await verifyOtp(otp, phoneDigits, "phone");
    if (verified) {
      setPhoneVerified(true);
      setOrigPhone(`+91${phoneDigits}`);
      window.dispatchEvent(new Event("profile-updated")); // ‚úÖ LiveSync
      setPanel("success");
      setTimeout(() => setPanel("form"), 1500);
    }
  };

  const handleEmailOtpSend = async () => {
    const ok = await sendOtp(email, "email");
    if (ok) setPanel("email-otp");
  };

  const handleEmailOtpVerify = async () => {
    const verified = await verifyOtp(otp, email, "email");
    if (verified) {
      setEmailVerified(true);
      window.dispatchEvent(new Event("profile-updated")); // ‚úÖ LiveSync
      setPanel("success");
      setTimeout(() => setPanel("form"), 1500);
    }
  };

  /* ------------------------------------------------------------
     Verify Pills
  ------------------------------------------------------------ */
  const EmailVerifyPill = emailVerified ? (
    <span className="ml-2 text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 flex items-center gap-1">
      <Check size={14} /> Verified
    </span>
  ) : (
    <button
      onClick={handleEmailOtpSend}
      disabled={loading}
      className="ml-2 text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition"
    >
      Unverified ‚Äî Verify
    </button>
  );

  const PhoneInlineAction = isPhoneChanged ? (
    <button
      onClick={handlePhoneOtpSend}
      disabled={loading}
      className="ml-2 text-xs px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200 transition"
    >
      Verify new number
    </button>
  ) : phoneVerified ? (
    <span className="ml-2 text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 flex items-center gap-1">
      <Check size={14} /> Verified
    </span>
  ) : (
    <button
      onClick={handlePhoneOtpSend}
      disabled={loading}
      className="ml-2 text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition"
    >
      Verify
    </button>
  );

  /* ------------------------------------------------------------
     UI Panels
  ------------------------------------------------------------ */
  const PanelContent = (
    <AnimatePresence mode="wait">
      {panel === "form" && (
        <motion.div key="form" className="p-6 sm:p-8">
          <h2 className="text-lg font-semibold mb-4">Account Center</h2>

          {/* Name */}
          <label className="text-sm text-gray-500">Name</label>
          <div className="flex items-center gap-2 border rounded-xl px-3 py-2 mb-3 dark:border-slate-700">
            <UserRound size={18} className="text-emerald-600" />
            <input
              type="text"
              placeholder="Your Name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="flex-1 bg-transparent outline-none text-sm"
            />
          </div>

          {/* Phone */}
          <label className="text-sm text-gray-500">Phone</label>
          <div className="flex items-center border rounded-xl px-3 py-2 mb-3 dark:border-slate-700">
            <Phone size={18} className="text-emerald-600 mr-2" />
            <input
              type="tel"
              inputMode="numeric"
              placeholder="10-digit mobile number"
              value={phone}
              onChange={(e) =>
                setPhone(e.target.value.replace(/\D/g, "").slice(0, 10))
              }
              className="flex-1 bg-transparent outline-none text-sm"
            />
            {PhoneInlineAction}
          </div>

          {/* Email */}
          <label className="text-sm text-gray-500">Email</label>
          <div className="flex items-center border rounded-xl px-3 py-2 dark:border-slate-700">
            <Mail size={18} className="text-emerald-600 mr-2" />
            <input
              type="email"
              placeholder="you@example.com"
              value={email}
              onChange={(e) => {
                const newEmail = e.target.value.trim();
                setEmail(newEmail);

                // ‚úÖ Keep verified if user re-enters same verified email
                const cached = JSON.parse(localStorage.getItem("user") || "{}");
                const cachedEmail = cached?.email?.trim()?.toLowerCase();

                if (cachedEmail && newEmail.toLowerCase() === cachedEmail) {
                  setEmailVerified(true);
                } else {
                  setEmailVerified(false);
                }
              }}
              className="flex-1 bg-transparent outline-none text-sm"
            />
            {EmailVerifyPill}
          </div>

          <button
            onClick={saveNameEmail}
            disabled={saving}
            className="w-full py-3 mt-4 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold active:scale-[0.98]"
          >
            {saving ? "Saving..." : "Save Changes"}
          </button>
        </motion.div>
      )}

      {/* Phone OTP */}
      {panel === "phone-otp" && (
        <motion.div key="phone" className="p-6">
          <h3 className="font-semibold mb-2">Verify Phone</h3>
          <p className="text-sm text-gray-600 mb-2">
            Enter the OTP sent to +91 {phoneDigits}
          </p>
          <OTPInput otp={otp} setOtp={setOtp} refs={otpRefs} />
          <button
            onClick={handlePhoneOtpVerify}
            disabled={verifying}
            className="w-full mt-3 py-3 rounded-xl bg-orange-600 hover:bg-orange-700 text-white font-semibold"
          >
            {verifying ? "Verifying..." : "Verify OTP"}
          </button>
        </motion.div>
      )}

      {/* Email OTP */}
      {panel === "email-otp" && (
        <motion.div key="email" className="p-6">
          <h3 className="font-semibold mb-2">Verify Email</h3>
          <p className="text-sm text-gray-600 mb-2">
            Enter the OTP sent to {email}
          </p>
          <OTPInput otp={otp} setOtp={setOtp} refs={otpRefs} />
          <button
            onClick={handleEmailOtpVerify}
            disabled={verifying}
            className="w-full mt-3 py-3 rounded-xl bg-orange-600 hover:bg-orange-700 text-white font-semibold"
          >
            {verifying ? "Verifying..." : "Verify OTP"}
          </button>
        </motion.div>
      )}

      {/* Success */}
      {panel === "success" && (
        <motion.div key="success" className="p-8 text-center">
          <motion.div
            initial={{ scale: 0.5 }}
            animate={{ scale: 1 }}
            className="w-20 h-20 bg-green-600 text-white mx-auto rounded-full flex items-center justify-center shadow-xl"
          >
            <Check size={40} />
          </motion.div>
          <p className="mt-3 text-green-600 font-semibold">
            Verified Successfully
          </p>
        </motion.div>
      )}
    </AnimatePresence>
  );

  /* ------------------------------------------------------------
     Drawer Layout
  ------------------------------------------------------------ */
  if (standalone) {
    return (
      <motion.div className="min-h-screen flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm">
        <div className="w-full max-w-md bg-white dark:bg-slate-900 rounded-t-3xl sm:rounded-3xl shadow-2xl">
          {PanelContent}
        </div>
      </motion.div>
    );
  }

  return (
    <Drawer open={open} onOpenChange={onClose}>
      <DrawerContent className="bg-white dark:bg-slate-900 rounded-t-3xl">
        <DrawerHeader>
          <DrawerTitle className="text-center">Account Center</DrawerTitle>
          <DrawerDescription className="text-center text-xs">
            Manage your profile and verification
          </DrawerDescription>
        </DrawerHeader>
        {PanelContent}
      </DrawerContent>
    </Drawer>
  );
}

--- components/CartDrawer.tsx ---
"use client";
/**
 * CartDrawer v4.0 ‚Äî Smart Responsive Edition üåø
 * ------------------------------------------------------------
 * ‚úÖ Uses shadcn/ui Drawer (BaseDrawer fully removed)
 * ‚úÖ Auto-switch: Bottom drawer on mobile, right drawer on desktop
 * ‚úÖ Clean animated FAB
 * ‚úÖ Works with CartContext / Zustand
 * ‚úÖ Dark-mode & accessibility ready
 */

import { useEffect, useState } from "react";
import { motion } from "framer-motion";
import { ShoppingCart, X } from "lucide-react";
import Link from "next/link";
import Image from "next/image";
import { useCart } from "@/components/CartContext";
import { Button } from "@/components/ui/button";
import {
  Drawer,
  DrawerContent,
  DrawerHeader,
  DrawerTitle,
  DrawerDescription,
} from "@/components/ui/drawer";

/* --- Shared cart item type --- */
interface CartItem {
  id: string;
  title: string;
  price: number;
  quantity: number;
  type: "product" | "service";
  image_url?: string | null;
  date?: string | null;
  slot?: string | null;
}

/* --- Hook: Detect mobile layout --- */
function useIsMobile(threshold = 768) {
  const [isMobile, setIsMobile] = useState(false);
  useEffect(() => {
    const check = () => setIsMobile(window.innerWidth < threshold);
    check();
    window.addEventListener("resize", check);
    return () => window.removeEventListener("resize", check);
  }, [threshold]);
  return isMobile;
}

export default function CartDrawer() {
  const { cart, removeFromCart, total } = useCart() as {
    cart: CartItem[];
    removeFromCart: (id: string) => void;
    total: number;
  };

  const [open, setOpen] = useState(false);
  const isMobile = useIsMobile();

  return (
    <>
      {/* üõí Floating Cart FAB */}
      <motion.button
        whileHover={{
          scale: 1.1,
          boxShadow: "0 0 20px rgba(91,146,255,0.4)",
        }}
        whileTap={{ scale: 0.95 }}
        onClick={() => setOpen(true)}
        className="fixed right-6 bg-emerald-600 text-white p-3 rounded-full shadow-lg z-[60]"
        style={{
          bottom: "calc(var(--mbnav-h-safe) + 1rem)",
        }}
        aria-label="Open cart"
      >
        <ShoppingCart className="w-6 h-6" />
        {cart.length > 0 && (
          <span className="absolute -top-1 -right-1 bg-red-600 text-xs text-white px-1 rounded-full">
            {cart.length}
          </span>
        )}
      </motion.button>

      {/* üß∫ Drawer */}
      <Drawer open={open} onOpenChange={setOpen}>
        <DrawerContent
          className={`bg-white dark:bg-slate-900 ${
            isMobile
              ? "rounded-t-3xl h-[85vh]" // bottom drawer for mobile
              : "rounded-l-3xl fixed right-0 top-0 h-full w-[400px]" // side drawer for desktop
          } transition-all`}
        >
          <DrawerHeader className="border-b border-slate-200 dark:border-slate-700 pb-3 px-5 pt-4 flex justify-between items-center">
            <div>
              <DrawerTitle>Your Cart</DrawerTitle>
              <DrawerDescription>Review and checkout</DrawerDescription>
            </div>
            <button
              onClick={() => setOpen(false)}
              className="text-slate-500 hover:text-slate-900 dark:hover:text-white"
            >
              <X className="w-5 h-5" />
            </button>
          </DrawerHeader>

          <div className="p-5 flex flex-col h-full">
            {/* Items */}
            <div className="flex-1 overflow-y-auto scrollbar-thin">
              {cart.length === 0 ? (
                <p className="text-center text-gray-500 mt-6">No items yet.</p>
              ) : (
                cart.map((item: CartItem) => (
                  <div
                    key={item.id}
                    className="flex items-center justify-between mb-3 border-b border-gray-200 dark:border-slate-700 pb-3"
                  >
                    {/* Thumbnail */}
                    <div className="w-16 h-16 rounded overflow-hidden flex-shrink-0">
                      {item.image_url ? (
                        <Image
                          src={item.image_url}
                          alt={item.title}
                          width={64}
                          height={64}
                          className="object-cover w-full h-full"
                        />
                      ) : (
                        <div className="bg-gray-100 dark:bg-slate-800 w-full h-full flex items-center justify-center text-gray-400 text-xs">
                          No Img
                        </div>
                      )}
                    </div>

                    {/* Info */}
                    <div className="flex-1 px-3 min-w-0">
                      <p className="font-medium text-sm truncate">
                        {item.title}
                      </p>
                      <p className="text-xs text-gray-500 dark:text-gray-400">
                        {item.type === "product"
                          ? `Qty: ${item.quantity}`
                          : `${item.date || ""} ${item.slot || ""}`}
                      </p>
                    </div>

                    {/* Price + Remove */}
                    <div className="text-right">
                      <p className="font-semibold text-sm">
                        ‚Çπ{(item.price * item.quantity).toLocaleString()}
                      </p>
                      <button
                        className="text-xs text-red-500 mt-1 hover:text-red-700 dark:hover:text-red-400"
                        onClick={() => removeFromCart(item.id)}
                      >
                        Remove
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>

            {/* Footer */}
            <div className="border-t border-gray-200 dark:border-slate-700 pt-3 mt-2 space-y-2">
              <p className="text-sm font-medium">
                Total: ‚Çπ{total.toLocaleString()}
              </p>
              <Link href="/checkout" onClick={() => setOpen(false)}>
                <Button
                  className="w-full bg-emerald-600 hover:bg-emerald-700"
                  disabled={cart.length === 0}
                >
                  Go to Checkout
                </Button>
              </Link>
            </div>
          </div>
        </DrawerContent>
      </Drawer>
    </>
  );
}

--- components/ClientDock.tsx ---
import { ClipboardList } from "lucide-react";
import Link from "next/link";

<Link
  href="/my-orders"
  className="flex flex-col items-center text-xs opacity-80 hover:opacity-100 transition"
>
  <ClipboardList className="w-5 h-5 mb-1" />
  Orders
</Link>;

--- components/HeroCinematicVideo.tsx ---
/* -------------------------------------------------------------------------- */
/* üé• CINEMATIC HERO ‚Äî delayed autoplay + scroll pause                        */
/* -------------------------------------------------------------------------- */
import { useEffect, useRef } from "react";
import { useScroll, motion, useMotionValueEvent } from "framer-motion";

export function HeroCinematicVideo() {
  const videoRef = useRef<HTMLVideoElement>(null);
  const { scrollY } = useScroll();
  const startedRef = useRef(false);

  // üéû autoplay after 20 s
  useEffect(() => {
    const timer = setTimeout(() => {
      const v = videoRef.current;
      if (v && !startedRef.current) {
        v.play().catch(() => {});
        startedRef.current = true;
      }
    }, 20000);
    return () => clearTimeout(timer);
  }, []);

  // ‚è∏ pause/resume on scroll
  useMotionValueEvent(scrollY, "change", (y) => {
    const v = videoRef.current;
    if (!v) return;
    if (y > 200 && !v.paused) v.pause();
    else if (y <= 200 && v.paused && startedRef.current) v.play().catch(() => {});
  });

  return (
    <section className="relative w-full h-[75vh] overflow-hidden flex items-center justify-center">
      <video
        ref={videoRef}
        muted
        loop
        playsInline
        preload="auto"
        className="absolute inset-0 w-full h-full object-cover"
        poster="https://images.pexels.com/photos/3815582/pexels-photo-3815582.jpeg"
      >
        <source
          src="https://videos.pexels.com/video-files/5471927/5471927-uhd_2560_1440_25fps.mp4"
          type="video/mp4"
        />
      </video>

      {/* gradient overlays */}
      <motion.div
        className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/50 pointer-events-none"
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 1.5 }}
      />

      {/* headline */}
      <div className="relative z-10 text-center text-white px-4">
        <motion.h1
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
          className="text-4xl md:text-6xl font-bold drop-shadow-lg"
        >
          Crafted by Hand, Perfected by HomeFix
        </motion.h1>
        <motion.p
          initial={{ opacity: 0, y: 30 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.6 }}
          className="text-lg md:text-xl mt-4 text-gray-200"
        >
          Experience the art of modern woodworking and precision design.
        </motion.p>
      </div>
    </section>
  );
}

--- components/HeroParallax.tsx ---
/**
 * File: /components/HeroParallax.tsx
 * Purpose: Animated parallax hero with depth using Framer Motion scroll.
 */

"use client";
import { motion, useScroll, useTransform } from "framer-motion";

export default function HeroParallax() {
  const { scrollY } = useScroll();
  const y1 = useTransform(scrollY, [0, 500], [0, 80]);
  const y2 = useTransform(scrollY, [0, 500], [0, -40]);

  return (
    <section className="relative h-[70vh] overflow-hidden bg-gradient-to-b from-slate-900 to-slate-700">
      <motion.img
        src="/images/bg-layer1.png"
        className="absolute top-0 w-full h-full object-cover opacity-60"
        style={{ y: y1 }}
      />
      <motion.img
        src="/images/bg-layer2.png"
        className="absolute top-0 w-full h-full object-cover opacity-80"
        style={{ y: y2 }}
      />
      <div className="relative z-10 flex flex-col items-center justify-center h-full text-white">
        <h1 className="text-4xl md:text-5xl font-bold">HomeFix India</h1>
        <p className="text-lg mt-3 opacity-80">
          Tech-Enabled DIY & Workforce Cloud
        </p>
      </div>
    </section>
  );
}

--- components/MapPicker.tsx ---
"use client";

import { motion } from "framer-motion";
import { useTheme } from "next-themes";
import { useEffect, useRef, useState } from "react";
import { useMapPicker } from "@/hooks/useMapPicker";

export interface Coordinates {
  lat: number;
  lng: number;
}

export interface MapPickerProps {
  initialLocation?: Coordinates;
  onLocationChange?: (
    loc: Coordinates | null,
    address: string,
    confirmed?: boolean
  ) => void;
  editable?: boolean;
  /** Optional: force manual mode even if Maps works */
  forceManualMode?: boolean;
}

export default function MapPicker({
  initialLocation = { lat: 13.0827, lng: 80.2707 },
  onLocationChange,
  editable = true,
  forceManualMode = false,
}: MapPickerProps) {
  const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;
  const missingApiKey = !apiKey;

  const autocompleteElRef = useRef<HTMLElement | null>(null);
  const [confirmed, setConfirmed] = useState(false);
  const { theme } = useTheme();

  const handleHookChange = (
    loc: Coordinates | null,
    addr: string,
    confirmed?: boolean
  ) => {
    onLocationChange?.(loc, addr, confirmed);
  };

  const {
    mapRootRef,
    mapRef,
    address,
    locating,
    autocompleteReady,
    mapsLoaded,
    mapsDead,
    locateMe,
    confirmLocation,
  } = useMapPicker({
    initialLocation,
    editable,
    onLocationChange: handleHookChange,
    autocompleteElRef,
  });

  const manualOnly = forceManualMode || missingApiKey || mapsDead;

  useEffect(() => {
    if (manualOnly) return;
    if (!mapRef.current || !(window as any).google?.maps) return;

    const darkStyles: google.maps.MapTypeStyle[] = [
      { elementType: "geometry", stylers: [{ color: "#0b0a1a" }] },
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "road", stylers: [{ color: "#202124" }] },
    ];

    const lightStyles: google.maps.MapTypeStyle[] = [
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "transit", stylers: [{ visibility: "off" }] },
    ];

    mapRef.current.setOptions({
      styles: theme === "dark" ? darkStyles : lightStyles,
    });
  }, [theme, mapRef, manualOnly]);

  useEffect(() => {
    setConfirmed(false);
  }, [address]);

  const handleLocate = () => {
    if (manualOnly) return;
    locateMe();
    setConfirmed(false);
  };

  const handleConfirm = async () => {
    if (!address) return;
    if (!manualOnly) {
      await confirmLocation();
    }
    setConfirmed(true);
  };

  if (manualOnly) {
    return (
      <div className="flex flex-col gap-4 w-full">
        <div className="w-full rounded-xl border border-[var(--edith-border)] bg-[var(--surface-card)] p-4 text-sm text-[var(--text-secondary)]">
          <p className="font-medium mb-1">üìç Map unavailable</p>
          {missingApiKey ? (
            <p className="text-xs opacity-70">
              Google Maps is not configured. Add{" "}
              <code className="px-1 py-0.5 rounded bg-black/10 text-[10px]">
                NEXT_PUBLIC_GOOGLE_MAPS_API_KEY
              </code>{" "}
              to enable live map selection.
            </p>
          ) : (
            <p className="text-xs opacity-70">
              Maps services are temporarily unavailable (quota / billing
              verification). You can still enter your address manually.
            </p>
          )}
        </div>

        <div className="flex flex-col sm:flex-row gap-3">
          <input
            type="text"
            placeholder="Enter your full address, landmark, city‚Ä¶"
            onChange={(e) =>
              onLocationChange?.(null, e.target.value, false)
            }
            className="flex-1 bg-[var(--edith-surface)] text-sm px-3 py-2 rounded-xl
              border border-[var(--edith-border)]"
          />

          {editable && (
            <motion.button
              whileTap={{ scale: 0.97 }}
              onClick={handleConfirm}
              className="relative sm:w-auto w-full min-h-[44px] px-6 py-2.5 rounded-xl text-sm font-semibold
                text-white shadow-lg transition-all
                bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]"
            >
              {confirmed ? "‚úì Address Saved" : "Save Address"}
            </motion.button>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4 w-full relative">
      {editable && (
        <div className="space-y-2">
          <gmpx-place-autocomplete
            ref={autocompleteElRef}
            placeholder="Search location or area‚Ä¶"
            className={`w-full bg-[var(--surface-card)] text-[var(--text-primary)]
              border border-[var(--edith-border)] rounded-xl px-4 py-2 text-sm
              shadow-sm focus-within:ring-2 focus-within:ring-[var(--accent-primary)]
              outline-none transition-all`}
          />
          {!autocompleteReady && (
            <p className="text-xs text-[var(--text-muted)]">
              Loading Google Place Autocomplete‚Ä¶
            </p>
          )}
        </div>
      )}

      <div className="relative w-full h-[340px] rounded-2xl overflow-hidden border border-[var(--edith-border)] shadow-md">
        {!mapsLoaded ? (
          <div className="flex items-center justify-center w-full h-full text-[var(--text-secondary)]">
            üó∫Ô∏è Loading map‚Ä¶
          </div>
        ) : (
          <>
            <div ref={mapRootRef} className="absolute inset-0" />

            <motion.div
              className="absolute left-1/2 top-1/2 
                -translate-x-1/2 -translate-y-[70%] 
                pointer-events-none"
              animate={{ y: [0, -4, 0] }}
              transition={{ repeat: Infinity, duration: 1.5 }}
            >
              <div className="w-3.5 h-3.5 rounded-full bg-[var(--accent-primary)]" />
            </motion.div>

            {editable && (
              <motion.button
                whileTap={{ scale: 0.9 }}
                onClick={handleLocate}
                className={`absolute bottom-5 right-5 w-10 h-10 flex items-center justify-center
                  rounded-full border border-[var(--edith-border)]
                  bg-[var(--surface-card)] hover:bg-[var(--accent-primary)]
                  hover:text-white transition-all shadow-md
                  ${
                    locating
                      ? "animate-pulse text-[var(--accent-primary)]"
                      : ""
                  }`}
              >
                üì°
              </motion.button>
            )}
          </>
        )}
      </div>

      <div className="flex flex-col sm:flex-row gap-3">
        <input
          readOnly
          type="text"
          value={
            address || "Move the map or search to select your location‚Ä¶"
          }
          className="flex-1 bg-[var(--edith-surface)] text-sm px-3 py-2 rounded-xl
            border border-[var(--edith-border)]"
        />

        {editable && (
          <motion.button
            whileTap={{ scale: 0.97 }}
            onClick={handleConfirm}
            disabled={!address}
            className={`relative sm:w-auto w-full min-h-[44px] px-6 py-2.5 rounded-xl text-sm font-semibold
              text-white shadow-lg transition-all
              bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]
              disabled:opacity-50`}
          >
            {confirmed ? "‚úì Confirm Location" : "Confirm Location"}
          </motion.button>
        )}
      </div>
    </div>
  );
}

--- components/OTPInput.tsx ---
"use client";
/**
 * OTPInput v3.5 ‚Äî Smart Paste + Haptic Feedback üåø
 * ------------------------------------------------------------
 * ‚úÖ Accepts otp / setOtp / refs (fully controlled)
 * ‚úÖ Auto-advance and backspace navigation
 * ‚úÖ Paste entire 6-digit OTP at once
 * ‚úÖ Optional onComplete callback
 * ‚úÖ Works seamlessly in dark/light themes
 */

import React, { useEffect } from "react";

interface OTPInputProps {
  otp: string;
  setOtp: (v: string) => void;
  refs: React.MutableRefObject<HTMLInputElement[]>;
  length?: number;
  onComplete?: (otp: string) => void;
}

export default function OTPInput({
  otp,
  setOtp,
  refs,
  length = 6,
  onComplete,
}: OTPInputProps): React.ReactElement {
  /* üì≥ Haptic feedback helper */
  const buzz = (ok = true) => {
    if (typeof window !== "undefined" && "vibrate" in navigator) {
      navigator.vibrate(ok ? 20 : [60, 40, 60]);
    }
  };

  /* üß† Input handlers */
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>, i: number) => {
    const val = e.target.value.replace(/\D/g, "").slice(0, 1);
    const newOtp = otp.substring(0, i) + val + otp.substring(i + 1);
    setOtp(newOtp);
    if (val && i < length - 1) refs.current[i + 1]?.focus();
  };

  const handleKeyDown = (
    e: React.KeyboardEvent<HTMLInputElement>,
    i: number,
  ) => {
    if (e.key === "Backspace" && !otp[i] && i > 0) {
      refs.current[i - 1]?.focus();
    }
  };

  const handlePaste = (e: React.ClipboardEvent<HTMLInputElement>) => {
    e.preventDefault();
    const paste = e.clipboardData.getData("text").replace(/\D/g, "").slice(
      0,
      length,
    );
    if (!paste) return;
    setOtp(paste);
    paste.split("").forEach((val, idx) => {
      if (refs.current[idx]) refs.current[idx].value = val;
    });
    buzz(true);
    refs.current[length - 1]?.focus();
    if (onComplete && paste.length === length) onComplete(paste);
  };

  useEffect(() => {
    if (otp.length === length && onComplete) onComplete(otp);
  }, [otp, length, onComplete]);

  /* üé® Render */
  return (
    <div className="flex justify-center gap-2 my-3" onPaste={handlePaste}>
      {Array.from({ length }).map((_, i) => (
        <input
          key={i}
          ref={(el) => {
            if (el) refs.current[i] = el;
          }}
          type="tel"
          inputMode="numeric"
          maxLength={1}
          value={otp[i] || ""}
          onChange={(e) => handleChange(e, i)}
          onKeyDown={(e) => handleKeyDown(e, i)}
          className="w-10 h-12 text-center text-lg font-semibold border rounded-xl border-gray-300 dark:border-slate-600 
                     focus:ring-2 focus:ring-orange-300 outline-none transition bg-white dark:bg-slate-700 
                     text-gray-800 dark:text-gray-100"
        />
      ))}
    </div>
  );
}

--- components/ServiceCard.tsx ---
/**
 * File: /components/ServiceCard.tsx
 * Purpose: Displays service info with hover motion and cart actions.
 * Removes: "Send Booking Email (Test)" button.
 */

"use client";
import { motion } from "framer-motion";

export default function ServiceCard({
  service,
  inCart,
  toggleCart,
}: {
  service: { title: string; description: string; price: number };
  inCart: boolean;
  toggleCart: () => void;
}) {
  return (
    <motion.div
      whileHover={{
        scale: 1.03,
        boxShadow: "0 8px 20px rgba(0,0,0,0.12)",
      }}
      transition={{ type: "spring", stiffness: 300, damping: 20 }}
      className="rounded-xl border p-4 bg-white dark:bg-slate-800 flex flex-col justify-between"
    >
      <div>
        <h3 className="text-lg font-semibold">{service.title}</h3>
        <p className="text-sm text-slate-600 dark:text-slate-300 mt-1">
          {service.description}
        </p>
        <p className="text-green-600 dark:text-green-400 font-semibold mt-2">
          ‚Çπ{service.price}
        </p>
      </div>
      <button
        onClick={toggleCart}
        className={`mt-4 px-4 py-2 rounded text-white ${
          inCart ? "bg-red-600" : "bg-green-600"
        }`}
      >
        {inCart ? "Remove from Cart" : "Add to Cart"}
      </button>
    </motion.div>
  );
}

--- components/SessionHydrator.tsx ---
"use client";
import { useEffect } from "react";
import { useUser } from "@/contexts/UserContext";

export default function SessionHydrator() {
  const { user, refreshUser, isLoaded } = useUser();

  useEffect(() => {
    if (!isLoaded || !user?.loggedIn) return;
    const interval = setInterval(() => refreshUser().catch(() => {}), 60_000);
    return () => clearInterval(interval);
  }, [isLoaded, user?.loggedIn, refreshUser]);

  useEffect(() => {
    if (!isLoaded || !user?.loggedIn) return;
    const keepCookiesAlive = () => {
      try {
        const u = user ?? JSON.parse(localStorage.getItem("user") || "null");
        if (!u?.loggedIn) return;
        const maxAge = 7 * 24 * 60 * 60;
        const base = `Path=/; Max-Age=${maxAge}; SameSite=Lax`;
        document.cookie = [
          `hf_user_id=${encodeURIComponent(u.id || "")}; ${base}`,
          `hf_user_phone=${encodeURIComponent(u.phone || "")}; ${base}`,
          `hf_user_email=${encodeURIComponent(u.email || "")}; ${base}`,
          `hf_user_verified=${u.email_verified ? "true" : "false"}; ${base}`,
        ].join(", ");
      } catch {}
    };
    keepCookiesAlive();
    const interval = setInterval(keepCookiesAlive, 24 * 60 * 60 * 1000);
    return () => clearInterval(interval);
  }, [isLoaded, user?.loggedIn, user]);

  return null;
}

--- components/SessionSync.tsx ---
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";

/**
 * SessionSync v2.3 ‚Äî Safe Cross-Tab Sync üåø
 * ------------------------------------------------------------
 * ‚úÖ Handles login/logout sync across tabs + PWA
 * ‚úÖ Works with Supabase + localStorage
 * ‚úÖ Fully typed, avoids TS 2367
 * ‚úÖ Proper event cleanup
 */
export default function SessionSync() {
  const router = useRouter();

  useEffect(() => {
    // ‚úÖ Explicit CustomEvent<string> typing
    function onSync(e: Event) {
      const customEvent = e as CustomEvent<string>;
      const detail = customEvent.detail || "";

      if (detail === "logged_out") {
        console.log("üö™ [SessionSync] Detected logout ‚Äî refreshing state");
        try {
          localStorage.removeItem("user");
          sessionStorage.removeItem("user");
        } catch {}
        globalThis.location?.assign("/login");
      }

      if (detail === "logged_in") {
        console.log("üîê [SessionSync] Detected login ‚Äî syncing session");
        router.refresh(); // revalidate data
      }
    }

    // ‚úÖ Storage event handler for multi-tab logout
    function onStorage(event: StorageEvent) {
      if (event.key === "hf_logged_out") {
        console.log("üö™ [SessionSync] Storage logout detected");
        globalThis.location?.assign("/login");
      }
    }

    // Attach listeners
    globalThis.addEventListener("hf:session-sync", onSync as EventListener);
    globalThis.addEventListener("storage", onStorage);

    // Cleanup listeners on unmount
    return () => {
      globalThis.removeEventListener("hf:session-sync", onSync as EventListener);
      globalThis.removeEventListener("storage", onStorage);
    };
  }, [router]);

  return null; // üöÄ No UI, purely behavioral
}

--- components/ThemeToggle.tsx ---
"use client";
import { useTheme } from "next-themes";
import { Moon, Sun } from "lucide-react";
import { useEffect, useState } from "react";

export default function ThemeToggle() {
  const { theme, setTheme, systemTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  // Avoid hydration mismatch: render only after mount
  useEffect(() => setMounted(true), []);

  if (!mounted) {
    return (
      <button
        className="p-2 rounded-full opacity-50"
        aria-label="Toggle Theme"
        disabled
      >
        <Moon size={18} />
      </button>
    );
  }

  const currentTheme = theme === "system" ? systemTheme : theme;

  return (
    <button
      onClick={() =>
        setTheme(currentTheme === "dark" ? "light" : "dark")
      }
      className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition"
      aria-label="Toggle Theme"
    >
      {currentTheme === "dark" ? <Sun size={18} /> : <Moon size={18} />}
    </button>
  );
}

--- components/checkout/CheckoutContainer.tsx ---

--- components/checkout/CheckoutFooter.tsx ---

--- components/checkout/CheckoutForm.tsx ---

--- components/checkout/CheckoutOnlineStatus.tsx ---

--- components/checkout/CheckoutToast.tsx ---

--- components/checkout/EdithCard.tsx ---

--- components/common/UniPreviewCanvas.tsx ---
"use client";

import React, {
  useRef,
  useState,
  useEffect,
  useMemo,
  type ReactNode,
} from "react";
import { Canvas } from "@react-three/fiber";
import { OrbitControls, Stage, Environment } from "@react-three/drei";
import { motion } from "framer-motion";
import useEstimator from "@/components/estimator/store/estimatorStore";

type ResolveModelURL = (path: string) => Promise<string>;

export type PreviewModelProps = {
  resolveModelURL?: ResolveModelURL;
};

type PreviewProps = {
  SvgComponent?: React.ComponentType<Record<string, never>>;
  ModelComponent?: React.ComponentType<PreviewModelProps>;
  title?: string;
  showTitle?: boolean;
};

const SUPABASE_BASE =
  "https://<YOUR-PROJECT-ID>.supabase.co/storage/v1/object/public/models";

const resolveModelURL: ResolveModelURL = async (path) => {
  try {
    const res = await fetch(path, { method: "HEAD" });
    if (res.ok) return path;
  } catch {
    /* noop ‚Äî fallback below */
  }
  return `${SUPABASE_BASE}${path}`;
};

const PANEL_SURFACE =
  "color-mix(in srgb, var(--surface-panel) 95%, transparent)";

const WATERMARK_COLOR =
  "color-mix(in srgb, var(--accent-primary) 80%, transparent)";

function EntangledDualityToggle() {
  const mode = useEstimator((s) => s.mode);
  const setMode = useEstimator((s) => s.setMode);
  const is3d = mode === "3d";

  return (
    <div className="absolute top-3 right-3 z-20">
      <motion.button
        whileTap={{ scale: 0.96 }}
        onClick={() => setMode(is3d ? "2d" : "3d")}
        aria-label={is3d ? "Switch to 2D Plan" : "Switch to 3D View"}
        className="relative h-8 w-[118px] rounded-full border border-[var(--border-soft)] bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)] backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.12)] flex items-center justify-between px-4 overflow-hidden transition-colors duration-300"
      >
        <div
          className={`absolute inset-0 rounded-full transition-colors duration-500 ${
            is3d
              ? "bg-[color-mix(in_srgb,var(--accent-secondary)15%,transparent)]"
              : "bg-[color-mix(in_srgb,var(--accent-primary)15%,transparent)]"
          }`}
        />
        <div className="absolute inset-0 rounded-full ring-1 ring-[var(--border-subtle)]" />

        <span
          className="z-10 text-[11px] font-semibold transition-opacity"
          style={{ color: "var(--text-primary)", opacity: is3d ? 0.5 : 1 }}
        >
          2D
        </span>
        <span
          className="z-10 text-[11px] font-semibold transition-opacity"
          style={{ color: "var(--text-primary)", opacity: is3d ? 1 : 0.5 }}
        >
          3D
        </span>

        <motion.div
          className="absolute inset-y-[2px] left-[5px] flex items-center justify-start"
          animate={{ x: is3d ? 52 : 0 }}
          transition={{ type: "spring", stiffness: 260, damping: 22 }}
          style={{
            width: "52px",
            height: "calc(100% - 4px)",
            borderRadius: "9999px",
            pointerEvents: "none",
          }}
        >
          <motion.div
            className="mx-auto flex items-center justify-center"
            animate={{
              width: 14,
              height: 14,
              borderRadius: "9999px",
              background: is3d
                ? "linear-gradient(135deg,var(--accent-secondary),var(--accent-tertiary))"
                : "linear-gradient(135deg,var(--accent-primary),var(--accent-tertiary))",
              boxShadow: is3d
                ? "0 0 12px color-mix(in srgb,var(--accent-secondary)80%,transparent), 0 0 2px color-mix(in srgb,var(--accent-secondary)85%,transparent) inset"
                : "0 0 12px color-mix(in srgb,var(--accent-primary)80%,transparent), 0 0 2px color-mix(in srgb,var(--accent-primary)85%,transparent) inset",
            }}
            transition={{
              duration: 1.4,
              repeat: Infinity,
              repeatType: "mirror",
            }}
          />
        </motion.div>

        <motion.div
          key={is3d ? "to3d" : "to2d"}
          className="absolute left-1/2 top-1/2 rounded-full"
          initial={{ opacity: 0, scale: 0 }}
          animate={{ opacity: [0, 1, 0], scale: [0, 1.2, 0] }}
          transition={{ duration: 0.45, ease: "easeOut", delay: 0.05 }}
          style={{
            background: "var(--accent-primary)",
            width: 18,
            height: 18,
            filter: "blur(3px)",
            pointerEvents: "none",
            transform: "translate(-50%, -50%)",
          }}
        />
      </motion.button>
    </div>
  );
}

type Transform = { x: number; y: number; z: number };

function PanZoomWrapper({
  children,
}: {
  children: (transform: Transform) => ReactNode;
}) {
  const ref = useRef<HTMLDivElement | null>(null);
  const [transform, setTransform] = useState<Transform>({
    x: 600,
    y: 300,
    z: 1,
  });
  const fitRef = useRef({ fit: 1, min: 0.05, max: 50 });
  const dragging = useRef(false);
  const last = useRef({ x: 0, y: 0 });

  useEffect(() => {
    const el = ref.current;
    if (!el) return;
    const rect = el.getBoundingClientRect();
    const fit = Math.min(rect.width / 1200, rect.height / 600);
    const initial = fit * 0.92;
    fitRef.current = { fit: initial, min: initial * 0.05, max: initial * 50 };
    setTransform({ x: rect.width / 2, y: rect.height / 2, z: initial });
  }, []);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;

    const onWheel = (e: WheelEvent) => {
      e.preventDefault();
      const rect = el.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const speed = 0.0012;
      const k = Math.exp(-e.deltaY * speed);
      setTransform((prev) => {
        const nextZ = Math.min(
          fitRef.current.max,
          Math.max(fitRef.current.min, prev.z * k)
        );
        const kz = nextZ / prev.z;
        return {
          x: mx - (mx - prev.x) * kz,
          y: my - (my - prev.y) * kz,
          z: nextZ,
        };
      });
    };

    const onDown = (e: PointerEvent) => {
      dragging.current = true;
      last.current = { x: e.clientX, y: e.clientY };
      el.setPointerCapture?.(e.pointerId);
    };

    const onMove = (e: PointerEvent) => {
      if (!dragging.current) return;
      const dx = e.clientX - last.current.x;
      const dy = e.clientY - last.current.y;
      last.current = { x: e.clientX, y: e.clientY };
      setTransform((prev) => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
    };

    const stop = (e: PointerEvent) => {
      dragging.current = false;
      el.releasePointerCapture?.(e.pointerId);
    };

    el.addEventListener("wheel", onWheel, { passive: false });
    el.addEventListener("pointerdown", onDown);
    el.addEventListener("pointermove", onMove);
    el.addEventListener("pointerup", stop);
    el.addEventListener("pointerleave", stop);

    return () => {
      el.removeEventListener("wheel", onWheel);
      el.removeEventListener("pointerdown", onDown);
      el.removeEventListener("pointermove", onMove);
      el.removeEventListener("pointerup", stop);
      el.removeEventListener("pointerleave", stop);
    };
  }, []);

  return (
    <div
      ref={ref}
      className="absolute inset-0 overflow-hidden cursor-grab active:cursor-grabbing bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)]"
    >
      {children(transform)}
    </div>
  );
}

export default function UniPreviewCanvas({
  SvgComponent,
  ModelComponent,
  title,
  showTitle = false,
}: PreviewProps) {
  const mode = useEstimator((s) => s.mode);
  const is3d = mode === "3d";

  const watermarkTone = useMemo(
    () =>
      is3d
        ? "text-[color-mix(in_srgb,var(--accent-secondary)80%,transparent)]"
        : "text-[color-mix(in_srgb,var(--accent-primary)80%,transparent)]",
    [is3d]
  );

  return (
    <div
      className="relative w-full h-[420px] rounded-2xl overflow-hidden border border-[var(--border-muted)] bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)]"
      style={{
        background: PANEL_SURFACE,
        boxShadow:
          "0 28px 90px color-mix(in srgb, var(--text-primary) 9%, transparent)",
      }}
    >
      <div
        className="absolute inset-0 pointer-events-none -z-10 opacity-20 dark:opacity-55"
        style={{
          background:
            "radial-gradient(circle at 20% 20%, color-mix(in srgb, var(--aura-light) 60%, transparent), transparent 65%), radial-gradient(circle at 80% 0%, color-mix(in srgb, var(--aura-dark) 45%, transparent), transparent 70%)",
        }}
      />

      {showTitle && (
        <div className="absolute top-3 left-3 text-xs font-semibold text-[var(--accent-tertiary)]">
          {title} ¬∑ {mode.toUpperCase()} Mode
        </div>
      )}

      <EntangledDualityToggle />

      {is3d ? (
        <div className="relative w-full h-full">
          <Canvas
            shadows
            camera={{ position: [4, 3, 6], fov: 45 }}
            style={{ background: PANEL_SURFACE }}
          >
            <ambientLight intensity={0.7} />
            <directionalLight position={[5, 10, 5]} intensity={1.2} castShadow />
            <Environment preset="warehouse" background={false} />
            <Stage
              environment="city"
              intensity={0.5}
              shadows="contact"
              adjustCamera
            >
              {ModelComponent ? (
                <ModelComponent resolveModelURL={resolveModelURL} />
              ) : (
                <mesh position={[0, 0.5, 0]}>
                  <boxGeometry args={[2, 1, 1]} />
                  <meshStandardMaterial
                    color="#B9B9B9"
                    metalness={0.3}
                    roughness={0.6}
                  />
                </mesh>
              )}
            </Stage>
            <OrbitControls
              enableZoom
              enablePan
              enableRotate
              zoomSpeed={0.9}
              panSpeed={1.2}
              rotateSpeed={0.95}
            />
          </Canvas>
          <div
            className="pointer-events-none absolute right-3 bottom-2 text-[11px] font-medium"
            style={{ color: WATERMARK_COLOR }}
          >
            HomeFix Studio ‚Ä¢ 3D View
          </div>
        </div>
      ) : (
        <PanZoomWrapper>
          {(transform) => (
            <svg
              viewBox="0 0 1200 600"
              className="absolute inset-0 w-full h-full bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)]"
            >
              <g
                transform={`translate(${transform.x}, ${transform.y}) scale(${transform.z})`}
              >
                {SvgComponent ? (
                  <SvgComponent />
                ) : (
                  <text x="0" y="0" fontSize="12">
                    No 2D View
                  </text>
                )}
              </g>
            </svg>
          )}
        </PanZoomWrapper>
      )}

      <div
        className={`pointer-events-none absolute right-3 bottom-2 text-[11px] font-medium select-none ${watermarkTone}`}
      >
        HomeFix Studio
      </div>
    </div>
  );
}

--- components/edith/EdithLoader.tsx ---
// EdithLoader.tsx
// Placeholder for Edith Viewer component
--- components/edith/EdithToolsPanel.tsx ---
// EdithToolsPanel.tsx
// Placeholder for Edith Viewer component
--- components/edith/EdithViewer.tsx ---
// EdithViewer.tsx
// Placeholder for Edith Viewer component
--- components/edith/EdithViewport.tsx ---
// EdithViewport.tsx
// Placeholder for Edith Viewer component
--- components/edith/index.ts ---
// index.ts
// Placeholder for Edith Viewer component
--- components/edith/useEdithStore.ts ---
// useEdithStore.ts
// Placeholder for Edith Viewer component
--- components/estimator/EstimatorForm.tsx ---
"use client";
import React from "react";
import type {
  Finish,
  KitchenData,
  WardrobeData,
} from "@/components/estimator/store/estimatorStore";

const FIELD_LABEL =
  "text-sm font-semibold text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]";
const CONTROL_BASE =
  "w-full rounded-2xl border border-[var(--border-soft)] bg-[color-mix(in_srgb,var(--surface-panel)94%,transparent)] dark:bg-[var(--surface-panel-dark)]/90 px-4 py-2.5 text-sm text-[var(--text-primary)] dark:text-[var(--text-primary-dark)] placeholder:text-[var(--text-muted)] shadow-[0_18px_40px_rgba(15,23,42,0.08)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]/25 focus:border-[var(--accent-primary)] transition";
const SUPPORT_TEXT = "text-[11px] text-[var(--text-muted)]";

type KitchenFormProps = {
  kitchen: KitchenData;
  setKitchenShape: (shape: string) => void;
  setKitchenFinish: (finish: Finish) => void;
  setKitchenLength: (wall: string, value: number) => void;
};

type WardrobeFormProps = {
  wardrobe: WardrobeData;
  setWardrobeWidth: (value: number | string) => void;
  setWardrobeFinish: (finish: Finish) => void;
};

const SectionHint = ({
  title,
  description,
}: {
  title: string;
  description: string;
}) => (
  <div className="rounded-2xl border border-[var(--border-subtle)] bg-[color-mix(in_srgb,var(--surface-panel)92%,transparent)] dark:bg-[var(--surface-panel-dark)]/70 px-4 py-3 text-xs text-[var(--text-secondary)] shadow-sm">
    <p className="font-semibold text-[var(--accent-primary)] dark:text-[var(--accent-secondary)]">
      {title}
    </p>
    <p>{description}</p>
  </div>
);

export function KitchenForm({
  kitchen,
  setKitchenShape,
  setKitchenFinish,
  setKitchenLength,
}: KitchenFormProps) {
  const max = kitchen.perWallMax || 20;
  const minByShape = kitchen.shape === "linear" ? 10 : 8;

  const Input = (key: string, label: string, min = minByShape) => (
    <div className="space-y-1.5" key={key}>
      <label className={FIELD_LABEL}>{label} (ft)</label>
      <input
        type="number"
        min={min}
        max={max}
        step={0.1}
        value={kitchen.lengths[key] ?? min}
        onChange={(e) => {
          const value = Math.max(min, parseFloat(e.target.value) || 0);
          setKitchenLength(key, value);
        }}
        className={CONTROL_BASE}
      />
      <p className={SUPPORT_TEXT}>
        Min {min} ft ¬∑ Max {max} ft
      </p>
    </div>
  );

  return (
    <div className="space-y-4">
      <div>
        <label className={FIELD_LABEL}>Shape</label>
        <select
          value={kitchen.shape}
          onChange={(e) => setKitchenShape(e.target.value)}
          className={`${CONTROL_BASE} mt-1`}
        >
          <option value="linear">Single Wall (Linear)</option>
          <option value="parallel">Galley (Parallel)</option>
          <option value="lshape">L Shape</option>
          <option value="u">U Shape</option>
        </select>
      </div>

      {kitchen.shape === "u" ? (
        <div className="grid grid-cols-3 gap-3">
          {["A", "B", "C"].map((key) => Input(key, `Wall ${key}`))}
        </div>
      ) : kitchen.shape === "parallel" || kitchen.shape === "lshape" ? (
        <div className="grid grid-cols-2 gap-3">
          {["A", "B"].map((key) => Input(key, `Wall ${key}`))}
        </div>
      ) : (
        Input("A", "Wall A", 10)
      )}

      <div>
        <label className={FIELD_LABEL}>Finish</label>
        <select
          value={kitchen.finish}
          onChange={(e) => setKitchenFinish(e.target.value as Finish)}
          className={`${CONTROL_BASE} mt-1`}
        >
          <option value="essential">Essential</option>
          <option value="premium">Premium</option>
          <option value="luxury">Luxury</option>
        </select>
      </div>

      <SectionHint
        title="Design Note"
        description="Wall lengths assume a continuous counter with 2 ft depth. Adjust each span to mirror your kitchen layout."
      />
    </div>
  );
}

export function WardrobeForm({
  wardrobe,
  setWardrobeWidth,
  setWardrobeFinish,
}: WardrobeFormProps) {
  const max = wardrobe.maxFt || 20;

  return (
    <div className="space-y-4">
      <div>
        <label className={FIELD_LABEL}>Width (ft)</label>
        <input
          type="number"
          min={4}
          max={max}
          step={0.1}
          value={wardrobe.widthFt}
          onChange={(e) => setWardrobeWidth(e.target.value)}
          className={`${CONTROL_BASE} mt-1`}
        />
        <p className={SUPPORT_TEXT}>Max width: {max} ft</p>
      </div>

      <div>
        <label className={FIELD_LABEL}>Finish</label>
        <select
          value={wardrobe.finish}
          onChange={(e) => setWardrobeFinish(e.target.value as Finish)}
          className={`${CONTROL_BASE} mt-1`}
        >
          <option value="essential">Essential</option>
          <option value="premium">Premium</option>
          <option value="luxury">Luxury</option>
        </select>
      </div>

      <SectionHint
        title="Loft Reminder"
        description="All wardrobes include a default 3 ft loft module. Modify widths to match each wall bay."
      />
    </div>
  );
}

export default KitchenForm;

--- components/estimator/EstimatorPageClient.tsx ---
"use client";

import type { ReactElement } from "react";
import SafeViewport from "@/components/layout/SafeViewport";
import EstimatorShell from "@/components/estimator/EstimatorShell";

export default function EstimatorPageClient(): ReactElement {
  return (
    <SafeViewport align="left">
      <EstimatorShell />
    </SafeViewport>
  );
}

--- components/estimator/EstimatorShell.tsx ---
"use client";
/**
 * File: components/estimator/EstimatorShell.tsx
 * Version: v4.0 ‚Äî Edith Stable Build üåó
 */

import React from "react";
import dynamic from "next/dynamic";
import useEstimator, {
  type EstimatorStep,
} from "@/components/estimator/store/estimatorStore";
import KitchenRender from "@/components/estimator/KitchenRender";
import WardrobeRender from "@/components/estimator/WardrobeRender";
import {
  KitchenForm,
  WardrobeForm,
} from "@/components/estimator/EstimatorForm";

const SummaryPanel = dynamic(
  () => import("@/components/estimator/SummaryPanel"),
  {
    ssr: false,
    loading: () => (
      <div className="rounded-3xl border border-dashed border-[var(--border-soft)] px-6 py-16 text-center text-sm text-[var(--text-secondary)]">
        Generating estimate‚Ä¶
      </div>
    ),
  }
);

const CARD_CLASS =
  "rounded-3xl border border-[var(--border-soft)] bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)] backdrop-blur-xl transition-colors duration-500 text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]";
const CARD_ELEVATION = {
  boxShadow:
    "0 25px 80px color-mix(in srgb, var(--text-primary) 8%, transparent)",
  background: "color-mix(in srgb, var(--surface-panel) 96%, transparent)",
};

interface PanelProps {
  children: React.ReactNode;
  className?: string;
}

const Panel = ({ children, className = "" }: PanelProps) => (
  <div className={`${CARD_CLASS} ${className}`} style={CARD_ELEVATION}>
    {children}
  </div>
);

const STAGE_DESCRIPTION: Record<EstimatorStep, string> = {
  kitchen: "Define the kitchen layout, finishes, and wall runs.",
  wardrobe: "Size your wardrobes and loft extensions to continue.",
  summary: "Review the combined estimate and export a shareable snapshot.",
};

export default function EstimatorShell(): React.ReactElement {
  const {
    step,
    kitchen,
    wardrobe,
    setStep,
    setKitchenShape,
    setKitchenFinish,
    setKitchenLength,
    setWardrobeWidth,
    setWardrobeFinish,
  } = useEstimator();

  const stageBadge =
    step === "kitchen"
      ? "STEP 1 ¬∑ KITCHEN"
      : step === "wardrobe"
      ? "STEP 2 ¬∑ WARDROBE"
      : "STEP 3 ¬∑ SUMMARY";

  const hero = (
    <header className="max-w-4xl mx-auto text-center space-y-3">
      <p className="text-xs uppercase tracking-[0.3em] text-[var(--text-muted)]">
        {stageBadge}
      </p>
      <h1 className="text-3xl font-semibold text-[var(--text-primary-light)] dark:text-[var(--text-primary-dark)]">
        Interior Budget Estimator
      </h1>
      <p className="text-sm text-[var(--text-secondary)]">
        {STAGE_DESCRIPTION[step]}
      </p>
    </header>
  );

  /* üü£ Summary Mode */
  if (step === "summary") {
    return (
      <section className="w-full space-y-8">
        {hero}
        <div className="w-full max-w-5xl mx-auto">
          <SummaryPanel />
        </div>
        <div className="flex justify-end gap-3 max-w-5xl mx-auto">
          <button
            onClick={() => setStep("wardrobe")}
            className="px-4 py-2 rounded-xl border border-[var(--border-soft)] text-sm font-medium text-[var(--accent-primary)] hover:bg-[var(--surface-hover)] transition"
          >
            ‚Üê Back to wardrobe specs
          </button>
        </div>
      </section>
    );
  }

  /* üü¶ Normal Flow (Kitchen / Wardrobe) */
  return (
    <section className="relative w-full space-y-8">
      <div
        aria-hidden="true"
        className="pointer-events-none absolute inset-0 -z-10 opacity-40"
        style={{
          background:
            "radial-gradient(circle at 10% 5%, rgba(90,93,240,0.1), transparent 60%), radial-gradient(circle at 90% 0%, rgba(236,110,207,0.08), transparent 70%)",
        }}
      />
      {hero}
      <div className="w-full max-w-6xl mx-auto space-y-6">
        <div className="grid md:grid-cols-2 gap-6">
          <Panel className="space-y-5">
            {step === "kitchen" ? (
              <>
                <KitchenForm
                  kitchen={kitchen}
                  setKitchenShape={setKitchenShape}
                  setKitchenFinish={setKitchenFinish}
                  setKitchenLength={setKitchenLength}
                />
                <div className="rounded-2xl border border-[var(--border-subtle)] bg-[var(--surface-chip)] dark:bg-[var(--surface-chip-dark)] px-4 py-3 text-xs text-[var(--text-secondary)] flex flex-wrap gap-3">
                  <span className="inline-flex items-center gap-1 rounded-full border border-[var(--border-soft)] px-3 py-1 text-[var(--text-primary)]">
                    Shape ¬∑ {kitchen.shape.toUpperCase()}
                  </span>
                  <span className="inline-flex items-center gap-1 rounded-full border border-[var(--border-soft)] px-3 py-1 capitalize">
                    Finish ¬∑ {kitchen.finish}
                  </span>
                  <span className="inline-flex items-center gap-1 rounded-full border border-[var(--border-soft)] px-3 py-1">
                    Per-wall max ¬∑ {kitchen.perWallMax} ft
                  </span>
                </div>
              </>
            ) : (
              <>
                <WardrobeForm
                  wardrobe={wardrobe}
                  setWardrobeWidth={setWardrobeWidth}
                  setWardrobeFinish={setWardrobeFinish}
                />
                <div className="rounded-2xl border border-[var(--border-subtle)] bg-[var(--surface-chip)] dark:bg-[var(--surface-chip-dark)] px-4 py-3 text-xs text-[var(--text-secondary)] flex flex-wrap gap-3">
                  <span className="inline-flex items-center gap-1 rounded-full border border-[var(--border-soft)] px-3 py-1">
                    Width ¬∑ {wardrobe.widthFt.toFixed(1)} ft
                  </span>
                  <span className="inline-flex items-center gap-1 rounded-full border border-[var(--border-soft)] px-3 py-1">
                    Loft ¬∑ 3 ft default
                  </span>
                  <span className="inline-flex items-center gap-1 rounded-full border border-[var(--border-soft)] px-3 py-1 capitalize">
                    Finish ¬∑ {wardrobe.finish}
                  </span>
                </div>
              </>
            )}
          </Panel>

          <Panel className="relative min-h-[360px] overflow-hidden px-0 py-0">
            <div
              className="absolute top-4 left-4 z-10 inline-flex items-center gap-2 rounded-full border border-[var(--border-soft)] px-3 py-1 text-xs font-semibold text-[var(--accent-primary)]"
              style={{
                background:
                  "color-mix(in srgb, var(--surface-light) 80%, transparent)",
              }}
            >
              {step === "kitchen"
                ? `Shape ¬∑ ${kitchen.shape.toUpperCase()}`
                : `Finish ¬∑ ${wardrobe.finish}`}
            </div>
            <div className="rounded-3xl overflow-hidden">
              {step === "kitchen" ? <KitchenRender /> : <WardrobeRender />}
            </div>
          </Panel>
        </div>

        <div className="flex justify-end gap-3">
          {step !== "kitchen" && (
            <button
              onClick={() => setStep("kitchen")}
              className="px-4 py-2 rounded-xl border border-[var(--border-soft)] text-sm font-medium text-[var(--accent-primary)] hover:bg-[var(--surface-hover)] transition"
            >
              ‚Üê Back to kitchen
            </button>
          )}
          {step === "kitchen" && (
            <button
              onClick={() => setStep("wardrobe")}
              className="px-5 py-2 rounded-xl bg-[var(--accent-primary)] text-white text-sm font-semibold shadow-sm hover:opacity-90 transition"
            >
              Next ¬∑ Wardrobe
            </button>
          )}
          {step === "wardrobe" && (
            <button
              onClick={() => setStep("summary")}
              className="px-5 py-2 rounded-xl bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)] text-white text-sm font-semibold shadow-sm hover:opacity-95 transition"
            >
              Generate summary ‚Üí
            </button>
          )}
        </div>
      </div>
    </section>
  );
}

--- components/estimator/KitchenRender.tsx ---
"use client";
import React from "react";
import { motion } from "framer-motion";
import { Environment } from "@react-three/drei";
import useEstimator, { type ViewMode } from "@/components/estimator/store/estimatorStore";
import UniPreviewCanvas, {
  type PreviewModelProps,
} from "@/components/common/UniPreviewCanvas";
import KitchenSvg2D from "@/components/estimator/KitchenSvg2D";

/* =========================================================
   üîπ Minimal 3D Placeholder Model (fine-line edition)
   ========================================================= */
function KitchenModel3D(_: PreviewModelProps): React.ReactElement {
  return (
    <group>
      {/* Base counter block */}
      <mesh position={[0, 0.4, 0]}>
        <boxGeometry args={[2.4, 0.8, 0.6]} />
        <meshStandardMaterial color="#C7C3FF" metalness={0.25} roughness={0.55} />
      </mesh>

      {/* Wall backsplash */}
      <mesh position={[0, 1.0, -0.25]}>
        <boxGeometry args={[2.4, 0.4, 0.05]} />
        <meshStandardMaterial color="#DAD8FF" metalness={0.2} roughness={0.6} />
      </mesh>

      <Environment preset="studio" />
    </group>
  );
}

/* =========================================================
   üî∏ MAIN KITCHEN RENDER WRAPPER
   ========================================================= */
export default function KitchenRender(): React.ReactElement {
  const mode = useEstimator((s) => s.mode as ViewMode);

  return (
    <div className="relative w-full h-full flex items-center justify-center">
      <UniPreviewCanvas
        SvgComponent={KitchenSvg2D}
        ModelComponent={KitchenModel3D}
      />

      {/* overlay label */}
      <motion.div
        className="absolute bottom-3 right-4 px-3 py-1.5 text-xs rounded-full backdrop-blur-sm shadow-sm"
        style={{
          background:
            "color-mix(in srgb, var(--surface-light) 90%, transparent)",
          color: "var(--text-primary)",
        }}
        initial={{ opacity: 0 }}
        animate={{ opacity: 0.9 }}
        transition={{ duration: 0.6 }}
      >
        {mode === "3d" ? "3D View ‚Äî Kitchen" : "2D CAD Plan ‚Äî Kitchen"}
      </motion.div>
    </div>
  );
}

--- components/estimator/KitchenScene3D.tsx ---
"use client";
// [edith-bridge3D][fallback-cube][lightweight-safe]
import React, { Suspense, useMemo } from "react";
import { Canvas } from "@react-three/fiber";
import { OrbitControls, Environment, Html, useGLTF } from "@react-three/drei";
import { Box3, Vector3 } from "three";

function SafeModel({ url = "/models/kitchen.glb" }) {
  const gltf = useGLTF(url);
  const scene = useMemo(() => {
    if (!gltf?.scene) return null;
    const clone = gltf.scene.clone();
    const box = new Box3().setFromObject(clone);
    const center = new Vector3();
    box.getCenter(center);
    clone.position.sub(center);
    return clone;
  }, [gltf]);

  if (!scene) {
    return (
      <mesh>
        <boxGeometry args={[1, 0.3, 1]} />
        <meshStandardMaterial color="#A0A0FF" roughness={0.4} metalness={0.2} />
      </mesh>
    );
  }

  return <primitive object={scene} scale={0.9} />;
}

export default function KitchenScene3D() {
  return (
    <div className="w-full h-[420px] bg-transparent">
      <Canvas
        camera={{ position: [2.5, 2.5, 2.5], fov: 45 }}
        shadows
      >
        <ambientLight intensity={0.6} />
        <directionalLight position={[3, 5, 2]} intensity={0.9} castShadow />
        <Suspense fallback={<Html center><span>Loading 3D...</span></Html>}>
          <SafeModel url="/models/kitchen.glb" />
        </Suspense>
        <OrbitControls enablePan={false} enableZoom={true} maxPolarAngle={Math.PI / 2.2} />
        <Environment preset="apartment" />
      </Canvas>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ú® Edith Patch v2025.11 ‚Äî Lightweight fallback 3D connector
// Falls back to cube when /public/models/kitchen.glb missing (404 safe)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

--- components/estimator/SafeScene3D.tsx ---
"use client";
// [edith-safe3D][fallback][unified-loader]
import React, { Suspense, useMemo } from "react";
import { Canvas } from "@react-three/fiber";
import { OrbitControls, Environment, Html, useGLTF } from "@react-three/drei";
import { Box3, Vector3 } from "three";

type SafeModelProps = {
  url: string;
};

function SafeModel({ url }: SafeModelProps) {
  const gltf = useGLTF(url);
  const scene = useMemo(() => {
    if (!gltf?.scene) return null;
    const clone = gltf.scene.clone();
    const box = new Box3().setFromObject(clone);
    const center = new Vector3();
    box.getCenter(center);
    clone.position.sub(center);
    return clone;
  }, [gltf]);

  if (!scene) {
    console.warn(`[SafeScene3D] Model not found ‚Üí fallback cube (${url})`);
    return (
      <mesh>
        <boxGeometry args={[1, 0.3, 1]} />
        <meshStandardMaterial color="#A0A0FF" roughness={0.4} metalness={0.25} />
      </mesh>
    );
  }

  return <primitive object={scene} scale={0.9} />;
}

type SafeScene3DProps = {
  modelUrl?: string;
  cameraPos?: [number, number, number];
  bg?: string;
};

export default function SafeScene3D({
  modelUrl = "/models/fallback.glb",
  cameraPos = [2.5, 2.5, 2.5],
  bg = "transparent",
}: SafeScene3DProps) {
  return (
    <div className="w-full h-[420px]" style={{ background: bg }}>
      <Canvas camera={{ position: cameraPos, fov: 45 }} shadows>
        <ambientLight intensity={0.6} />
        <directionalLight position={[3, 5, 2]} intensity={0.9} castShadow />
        <Suspense fallback={<Html center><span>Loading 3D...</span></Html>}>
          <SafeModel url={modelUrl} />
        </Suspense>
        <OrbitControls
          enablePan={false}
          enableZoom={true}
          maxPolarAngle={Math.PI / 2.2}
        />
        <Environment preset="apartment" />
      </Canvas>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ú® Edith Shared 3D Bridge ‚Äî Fallback cube if GLB missing (404-safe)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

--- components/estimator/SummaryPanel.tsx ---
"use client";
import React from "react";
import useEstimator from "@/components/estimator/store/estimatorStore";
import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  PieChart,
  Pie,
  Cell,
  Tooltip,
  type PieLabelRenderProps,
} from "recharts";

/* üí∞ Currency Helper */
const Money = ({ v = 0 }: { v?: number }) => (
  <>‚Çπ{Math.round(v).toLocaleString()}</>
);

/* üé® Colors */
const COLORS = [
  "var(--accent-primary)",
  "var(--accent-secondary)",
  "var(--accent-tertiary)",
  "var(--accent-warning)",
];

export default function SummaryPanel() {
  const setStep = useEstimator((s) => s.setStep);
  const k = useEstimator((s) => s.kitchen);
  const w = useEstimator((s) => s.wardrobe);
  const getComputed = useEstimator((s) => s.getComputed);
  const comp = getComputed();

  const parts = [
    { label: "Kitchen Base Units", value: comp.kBaseCost || 0 },
    { label: "Kitchen Wall Units", value: comp.kWallCost || 0 },
    { label: "Wardrobe (Bottom)", value: comp.wBaseCost || 0 },
    { label: "Wardrobe (Loft)", value: comp.wLoftCost || 0 },
  ];

  const total = comp.total || 0;
  const max = Math.max(...parts.map((p) => p.value), 1);

  const pieData = [
    { name: "Kitchen", value: (comp.kBaseCost || 0) + (comp.kWallCost || 0) },
    { name: "Wardrobe", value: (comp.wBaseCost || 0) + (comp.wLoftCost || 0) },
  ];

  return (
    <div className="space-y-6 pb-16">
      <div
        className="rounded-3xl border border-[var(--border-soft)] bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)] backdrop-blur-xl p-6 transition-colors duration-500"
        style={{
          boxShadow:
            "0 32px 120px color-mix(in srgb, var(--text-primary) 10%, transparent)",
          background: "color-mix(in srgb, var(--surface-panel) 96%, transparent)",
        }}
      >
        <div className="grid lg:grid-cols-2 gap-6">
          {/* üîπ Left ‚Äî Text Summary */}
          <div className="space-y-3">
            <h2 className="font-semibold text-[var(--accent-primary)] dark:text-[var(--accent-secondary)] text-lg">
              Estimate Summary
            </h2>

            <div className="text-sm text-[var(--text-secondary)] space-y-1">
              <div>
                Kitchen: <b>{k.shape}</b> ¬∑ Finish: <b>{k.finish}</b> ¬∑ Total run:{" "}
                <b>{comp.totalRun?.toFixed(2)} ft</b>
              </div>
              <div>
                Wardrobe: width <b>{comp.width?.toFixed(1)} ft</b> ¬∑ Finish:{" "}
                <b>{w.finish}</b>
              </div>
            </div>

            <div className="mt-4 space-y-2">
              {parts.map((p, i) => (
                <div key={i} className="flex items-center gap-2">
                  <div className="w-44 text-sm text-[var(--text-secondary)]">
                    {p.label}
                  </div>
                  <div className="flex-1 h-2 rounded-full overflow-hidden bg-[var(--surface-chip)] dark:bg-[var(--surface-chip-dark)]">
                    <div
                      className="h-2 rounded-full"
                      style={{
                        width: `${(p.value / max) * 100}%`,
                        background: COLORS[i % COLORS.length],
                      }}
                    />
                  </div>
                  <div className="w-28 text-right text-sm text-[var(--text-primary)] dark:text-[var(--text-primary-dark)]">
                    <Money v={p.value} />
                  </div>
                </div>
              ))}
            </div>

            {/* ‚ú® Total Card */}
            <div className="mt-5 p-4 rounded-2xl text-center font-bold text-lg text-white shadow-md bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]">
              Grand Total: <Money v={total} />
            </div>
          </div>

          {/* üî∏ Right ‚Äî Charts */}
          <div className="space-y-4">
            <div className="font-medium text-[var(--accent-primary)] dark:text-[var(--accent-secondary)] text-sm">
              Cost Breakdown (‚Çπ)
            </div>
            <div className="rounded-2xl border border-[var(--border-subtle)] bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)]/85 p-3 shadow-sm">
              <ResponsiveContainer width="100%" height={180}>
                <BarChart data={parts}>
                  <XAxis
                    dataKey="label"
                    tick={{ fontSize: 10, fill: "var(--text-muted)" }}
                    interval={0}
                  />
                  <Tooltip
                    formatter={(value: number | string) =>
                      `‚Çπ${Math.round(Number(value) || 0).toLocaleString()}`
                    }
                  />
                  <Bar dataKey="value" radius={[6, 6, 0, 0]}>
                    {parts.map((_, i) => (
                      <Cell key={i} fill={COLORS[i % COLORS.length]} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>

            <div className="font-medium text-[var(--accent-primary)] dark:text-[var(--accent-secondary)] text-sm">
              Kitchen vs Wardrobe
            </div>
            <div className="rounded-2xl border border-[var(--border-subtle)] bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)]/85 p-3 shadow-sm">
              <ResponsiveContainer width="100%" height={180}>
                <PieChart>
                  <Pie
                    data={pieData}
                    cx="50%"
                    cy="50%"
                    outerRadius={70}
                    dataKey="value"
                    labelLine={false}
                    label={({ name, percent }: PieLabelRenderProps) => {
                      const ratio =
                        typeof percent === "number"
                          ? percent
                          : Number(percent ?? 0);
                      return `${name ?? ""} ${(ratio * 100).toFixed(0)}%`;
                    }}
                  >
                    {pieData.map((_, i) => (
                      <Cell key={i} fill={COLORS[i % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip
                    formatter={(value: number | string) =>
                      `‚Çπ${Math.round(Number(value) || 0).toLocaleString()}`
                    }
                  />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>

        {/* üîπ Assumptions */}
        <div className="mt-6 text-sm text-[var(--text-secondary)]">
          <div className="font-medium text-[var(--accent-primary)] dark:text-[var(--accent-secondary)] mb-2">
            Assumptions
          </div>
          <ul className="list-disc pl-5 space-y-1">
            <li>Per-wall cap for kitchen runs: 20 ft</li>
            <li>Counter depth assumed: 2 ft (visual only)</li>
            <li>Base unit height: 2.46 ft ¬∑ Wall unit height: 2.0 ft</li>
            <li>Wardrobe heights: 7 ft (bottom) + 3 ft (loft)</li>
            <li>Finishes apply multipliers to area rates</li>
          </ul>
        </div>
      </div>

      {/* üì± Sticky Footer Actions */}
      <div
        className="fixed bottom-0 left-0 right-0 z-50 p-3 bg-[var(--surface-panel)] dark:bg-[var(--surface-panel-dark)] backdrop-blur-lg border-t border-[var(--border-soft)] flex items-center justify-between"
        style={{
          boxShadow:
            "0 -18px 40px color-mix(in srgb, var(--text-primary) 8%, transparent)",
          background: "color-mix(in srgb, var(--surface-panel) 95%, transparent)",
        }}
      >
        <span className="text-sm font-medium text-[var(--accent-primary)] dark:text-[var(--accent-secondary)]">
          Total: <Money v={total} />
        </span>
        <div className="flex gap-2">
          <button
            onClick={() => setStep("wardrobe")}
            className="px-3 py-1.5 rounded-lg border border-[var(--border-soft)] text-sm text-[var(--accent-primary)] hover:bg-[var(--surface-hover)] transition"
          >
            ‚Üê Back
          </button>
          <button
            onClick={() => window.print()}
            className="px-4 py-1.5 rounded-lg bg-[var(--accent-primary)] text-white text-sm font-medium shadow hover:opacity-90 transition"
          >
            Print / Save PDF
          </button>
        </div>
      </div>
    </div>
  );
}

--- components/estimator/WardrobeRender.tsx ---
"use client";
import React from "react";
import { Environment } from "@react-three/drei";
import { motion } from "framer-motion";
import useEstimator, { type ViewMode } from "@/components/estimator/store/estimatorStore";
import UniPreviewCanvas, {
  type PreviewModelProps,
} from "@/components/common/UniPreviewCanvas";
import WardrobeSvg2D from "@/components/estimator/WardrobeSvg2D";

/* =========================================================
   üîπ 3D PLACEHOLDER MODEL
   ========================================================= */
function WardrobeModel3D(_: PreviewModelProps): React.ReactElement {
  return (
    <group>
      {/* Base wardrobe block */}
      <mesh position={[0, 1.25, 0]}>
        <boxGeometry args={[2.4, 2.6, 0.6]} />
        <meshStandardMaterial
          color="#C9BCFF"
          metalness={0.2}
          roughness={0.5}
        />
      </mesh>

      {/* Loft block */}
      <mesh position={[0, 2.9, 0]}>
        <boxGeometry args={[2.4, 0.8, 0.6]} />
        <meshStandardMaterial
          color="#BDAAFF"
          metalness={0.25}
          roughness={0.45}
        />
      </mesh>

      {/* Subtle light glow */}
      <pointLight position={[0, 3.5, 1]} intensity={0.8} color="#D3B8FF" />
      <Environment preset="studio" />
    </group>
  );
}

/* =========================================================
   üî∏ MAIN WARDROBE RENDER WRAPPER
   ========================================================= */
export default function WardrobeRender(): React.ReactElement {
  const mode = useEstimator((s) => s.mode as ViewMode);

  return (
    <div className="relative w-full h-full flex items-center justify-center">
      <UniPreviewCanvas
        SvgComponent={WardrobeSvg2D}
        ModelComponent={WardrobeModel3D}
      />

      {/* Optional overlay: label or mode indicator */}
      <motion.div
        className="absolute bottom-3 right-4 px-3 py-1.5 text-xs rounded-full backdrop-blur-sm shadow-sm"
        style={{
          background:
            "color-mix(in srgb, var(--surface-light) 90%, transparent)",
          color: "var(--text-primary)",
        }}
        initial={{ opacity: 0 }}
        animate={{ opacity: 0.9 }}
        transition={{ duration: 0.6 }}
      >
        {mode === "3d" ? "3D View ‚Äî Wardrobe" : "2D Elevation ‚Äî Wardrobe"}
      </motion.div>
    </div>
  );
}

--- components/estimator/store/estimatorStore.ts ---
"use client";

import { create } from "zustand";

export type EstimatorStep = "kitchen" | "wardrobe" | "summary";
export type ViewMode = "2d" | "3d";
export type Shape = "linear" | "parallel" | "lshape" | "u";
export type Finish = "essential" | "premium" | "luxury";

type KitchenLengths = Record<string, number>;

export interface KitchenData {
  shape: Shape;
  finish: Finish;
  perWallMax: number;
  lengths: KitchenLengths;
}

export interface WardrobeData {
  widthFt: number;
  finish: Finish;
  maxFt: number;
  baseH: number;
  loftH: number;
}

interface Rates {
  kitchen: { base: number; wall: number };
  wardrobe: { base: number; loft: number };
}

interface ComputedEstimate {
  kBaseSqft: number;
  kWallSqft: number;
  kBaseCost: number;
  kWallCost: number;
  wBaseCost: number;
  wLoftCost: number;
  total: number;
  totalRun?: number;
  width?: number;
}

interface EstimatorState {
  step: EstimatorStep;
  mode: ViewMode;
  rates: Rates;
  finishMult: Record<Finish, number>;
  kitchen: KitchenData;
  wardrobe: WardrobeData;
  setStep: (step: EstimatorStep) => void;
  setMode: (mode: ViewMode) => void;
  setKitchenShape: (shape: string) => void;
  setKitchenFinish: (finish: Finish) => void;
  setKitchenLength: (key: string, value: number) => void;
  setWardrobeWidth: (value: number | string) => void;
  setWardrobeFinish: (finish: Finish) => void;
  getComputed: () => ComputedEstimate;
}

const MIN_WALLS: Record<Shape, number> = {
  linear: 10,
  parallel: 8,
  lshape: 8,
  u: 8,
};

const VALID_SHAPES: Shape[] = ["linear", "parallel", "lshape", "u"];

const useEstimator = create<EstimatorState>((set, get) => ({
  step: "kitchen",
  mode: "2d",
  rates: {
    kitchen: { base: 2000, wall: 1500 },
    wardrobe: { base: 1800, loft: 1000 },
  },
  finishMult: { essential: 1.0, premium: 1.25, luxury: 1.5 },
  kitchen: {
    shape: "linear",
    finish: "essential",
    perWallMax: 20,
    lengths: { A: 10, B: 10, C: 10 },
  },
  wardrobe: {
    widthFt: 10,
    finish: "essential",
    maxFt: 20,
    baseH: 7,
    loftH: 3,
  },
  setStep: (step) => set({ step }),
  setMode: (mode) => set({ mode }),
  setKitchenShape: (shape) =>
    set((state) => {
      const raw =
        typeof shape === "string"
          ? shape.toLowerCase().trim()
          : "linear";
      const safe = VALID_SHAPES.includes(raw as Shape)
        ? (raw as Shape)
        : "linear";
      return { kitchen: { ...state.kitchen, shape: safe } };
    }),
  setKitchenFinish: (finish) =>
    set((state) => ({ kitchen: { ...state.kitchen, finish } })),
  setKitchenLength: (key, value) =>
    set((state) => {
      const { shape, perWallMax, lengths } = state.kitchen;
      const num = Number(value) || 0;
      const min = MIN_WALLS[shape];
      const clamped = Math.min(Math.max(num, min), perWallMax);
      return {
        kitchen: {
          ...state.kitchen,
          lengths: { ...lengths, [key]: clamped },
        },
      };
    }),
  setWardrobeWidth: (ft) =>
    set((state) => {
      const num = Number(ft) || 0;
      return {
        wardrobe: {
          ...state.wardrobe,
          widthFt: Math.min(num, state.wardrobe.maxFt),
        },
      };
    }),
  setWardrobeFinish: (finish) =>
    set((state) => ({ wardrobe: { ...state.wardrobe, finish } })),
  getComputed: () => {
    const { kitchen, wardrobe, rates, finishMult } = get();
    const totalRun = Object.values(kitchen.lengths).reduce(
      (acc, ft) => acc + (Number(ft) || 0),
      0
    );

    const kBaseSqft = totalRun * 2.46;
    const kWallSqft = totalRun * 2.0;
    const kitchenMultiplier = finishMult[kitchen.finish];
    const wardrobeMultiplier = finishMult[wardrobe.finish];

    const kBaseCost = kBaseSqft * rates.kitchen.base * kitchenMultiplier;
    const kWallCost = kWallSqft * rates.kitchen.wall * kitchenMultiplier;
    const wBaseSqft = wardrobe.widthFt * wardrobe.baseH;
    const wLoftSqft = wardrobe.widthFt * wardrobe.loftH;
    const wBaseCost = wBaseSqft * rates.wardrobe.base * wardrobeMultiplier;
    const wLoftCost = wLoftSqft * rates.wardrobe.loft * wardrobeMultiplier;

    return {
      kBaseSqft,
      kWallSqft,
      kBaseCost,
      kWallCost,
      wBaseCost,
      wLoftCost,
      total: kBaseCost + kWallCost + wBaseCost + wLoftCost,
      totalRun,
      width: wardrobe.widthFt,
    };
  },
}));

export default useEstimator;

--- components/layout/LayoutContent.tsx ---
"use client";
/**
 * ============================================================
 * LayoutContent v11.0 ‚Äî Edith Gemini SafeViewport Build üåó
 * ------------------------------------------------------------
 * ‚úÖ Single global header (no duplication)
 * ‚úÖ RootShell controls the viewport + scroll
 * ‚úÖ Sidebar + main inside safe viewport
 * ‚úÖ No double padding or nested scroll
 * ‚úÖ Smooth layout transitions, theme-aware
 * ============================================================
 */

import { NavBar, Sidebar } from "@/components/layout";
import { useSidebar } from "@/contexts/SidebarContext";
import { motion } from "framer-motion";
import { useEffect, useState } from "react";

export default function LayoutContent({
  children,
}: {
  children: React.ReactNode;
}) {
  const { collapsed } = useSidebar();
  const [hydrated, setHydrated] = useState(false);
  const [isMobile, setIsMobile] = useState(false);

  /* ------------------------------------------------------------
     üíß Hydration + responsive detection
  ------------------------------------------------------------ */
  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    handleResize();
    window.addEventListener("resize", handleResize);
    setHydrated(true);
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  if (!hydrated) return null;

  return (
    <div
      className="relative flex flex-col min-h-full overflow-hidden
                 bg-[var(--surface-base)]
                 text-[var(--sidebar-text)] transition-colors duration-500"
    >
      {/* üß≠ Sidebar + Main Section */}
      <div className="flex flex-row w-full min-h-full overflow-hidden">
        {/* üß© Sidebar (desktop only) */}
        <motion.aside
          id="universal-sidebar"
          animate={{ width: collapsed ? 80 : 256 }}
          transition={{ type: "spring", stiffness: 180, damping: 22 }}
          className="hidden md:flex flex-shrink-0 fixed left-0 z-[60]
                     overflow-y-auto overflow-x-hidden"
          style={{
            top: "var(--header-h, 72px)",
            height: "calc(100vh - var(--header-h, 72px))",
            background: "var(--sidebar-surface)",
            color: "var(--sidebar-text)",
          }}
        >
          <Sidebar />
        </motion.aside>

        {/* üß± Main Content (inside RootShell‚Äôs scroll zone) */}
        <main
          id="safe-main-content"
          className="flex-1 transition-all duration-700 ease-in-out
                     text-[var(--sidebar-text)]"
          style={{
            marginLeft: isMobile ? "0px" : collapsed ? "80px" : "256px",
            transition: "margin-left 0.4s ease",
          }}
        >
          <div
            className="w-full ml-0 mr-0
                       pl-4 sm:pl-6 md:pl-8
                       pr-2 sm:pr-3 md:pr-4
                       pt-4 md:pt-6 pb-8"
          >
            {children}
          </div>
        </main>
      </div>

      {/* üì± Mobile Navbar (fixed bottom) */}
      <footer
        id="hf-mobile-navbar"
        className="md:hidden fixed bottom-0 left-0 right-0 z-[80]
                   border-t border-gray-200/40 dark:border-slate-800/50
                   backdrop-blur-xl transition-all duration-500"
        style={{
          background: "var(--sidebar-surface)",
          color: "var(--sidebar-text)",
          height: "var(--mbnav-h,72px)",
          paddingBottom: "env(safe-area-inset-bottom)",
        }}
      >
        <NavBar />
      </footer>
    </div>
  );
}

--- components/layout/NavBar.tsx ---
"use client";
/**
 * ============================================================
 * File: /components/ui/NavBar.tsx
 * Version: v7.5 ‚Äî HomeFix Aurora Dock (SafeViewport Sync) üåà
 * ------------------------------------------------------------
 * ‚úÖ Registers --mbnav-h dynamically via ResizeObserver
 * ‚úÖ Scroll-safe & header-aware viewport integration
 * ‚úÖ Uses same surface + gradient tone as Header
 * ‚úÖ Works in PWA fullscreen + notch safe areas
 * ============================================================
 */

import { useProductCartStore } from "@/components/store/cartStore";
import { AnimatePresence, motion, useReducedMotion } from "framer-motion";
import {
  CalendarDays,
  Home,
  Layers3,
  Settings,
  Store,
  User,
} from "lucide-react";
import dynamic from "next/dynamic";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { useEffect, useRef } from "react";

const ThemeToggle = dynamic(() => import("@/components/ThemeToggle"), {
  ssr: false,
});

export default function NavBar() {
  const pathname = usePathname();
  const prefersReducedMotion = useReducedMotion();
  const vibrate = () => globalThis.navigator?.vibrate?.(20);
  const { totalItems } = useProductCartStore();
  const navRef = useRef<HTMLDivElement>(null);

  const tabs = [
    { name: "Home", href: "/", icon: Home },
    { name: "Services", href: "/services", icon: Layers3 },
    { name: "Store", href: "/store", icon: Store },
    { name: "Bookings", href: "/my-space", icon: CalendarDays },
    { name: "Profile", href: "/profile", icon: User },
    { name: "Settings", href: "/settings", icon: Settings },
  ];

  /* üß≠ Register nav height for safe viewport sync */
  useEffect(() => {
    const el = navRef.current;
    if (!el) return;

    const update = () => {
      const h = el.getBoundingClientRect().height;
      document.documentElement.style.setProperty("--mbnav-h", `${h}px`);
    };

    const resizeObs = new ResizeObserver(update);
    resizeObs.observe(el);
    update();

    return () => resizeObs.disconnect();
  }, []);

  return (
    <nav
      ref={navRef}
      className="fixed bottom-0 left-0 right-0 z-navbar md:hidden
                 border-t border-gray-200 dark:border-slate-800
                 backdrop-blur-2xl transition-all duration-500
                 safe-area-inset-bottom"
      style={{
        background: "var(--nav-surface)",
        color: "var(--nav-text)",
        WebkitBackdropFilter: "blur(16px)",
        paddingBottom: "env(safe-area-inset-bottom)",
      }}
    >
      <div className="max-w-3xl mx-auto flex justify-around items-center h-full px-3">
        {tabs.map(({ name, href, icon: Icon }) => {
          const active = pathname === href;
          return (
            <Link
              key={href}
              href={href}
              onClick={vibrate}
              aria-current={active ? "page" : undefined}
              className="relative flex flex-col items-center justify-center gap-0.5 w-[60px]"
            >
              {/* üîÜ Active Background Glow */}
              <AnimatePresence>
                {active && (
                  <motion.span
                    layoutId="nav-active-glow"
                    className="absolute inset-0 rounded-xl bg-gradient-to-r from-[#5A5DF0]/25 to-[#EC6ECF]/25 blur-md"
                    transition={{ type: "spring", stiffness: 240, damping: 20 }}
                  />
                )}
              </AnimatePresence>

              {/* üåü Icon */}
              <motion.div
                whileTap={{ scale: prefersReducedMotion ? 1 : 0.9 }}
                whileHover={{ scale: prefersReducedMotion ? 1 : 1.1 }}
                transition={{ type: "spring", stiffness: 300, damping: 18 }}
                className={`text-[11px] font-medium ${
                  active
                    ? "text-green-600 dark:text-emerald-400"
                    : "text-[var(--nav-label-color)]"
                }`}
              >
                <Icon size={20} />

                {/* üõí Cart badge */}
                {name === "Store" && totalItems > 0 && (
                  <motion.span
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    className="absolute -top-1 -right-1 text-[10px] font-semibold
                               bg-green-600 text-white rounded-full w-4 h-4
                               flex items-center justify-center"
                  >
                    {totalItems}
                  </motion.span>
                )}
              </motion.div>

              {/* üìõ Label */}
              <span
                className={`text-[11px] font-medium ${
                  active
                    ? "text-green-600 dark:text-emerald-400"
                    : "text-gray-600 dark:text-gray-400"
                }`}
              >
                {name}
              </span>
            </Link>
          );
        })}
      </div>
    </nav>
  );
}

--- components/layout/RootShell.tsx ---
"use client";
import { LayoutContent, UniversalHeader } from "@/components/layout";
import SessionSync from "@/components/SessionSync";
import { EdithToaster } from "@/components/ui/toaster";
import { SidebarProvider } from "@/contexts/SidebarContext";
import { UserProvider } from "@/contexts/UserContext";
import { usePathname, useRouter } from "next/navigation";
import { useEffect } from "react";

export default function RootShell({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const router = useRouter();
  const isAdmin = pathname?.startsWith("/admin");
  const isAuth =
    pathname?.startsWith("/login") || pathname?.startsWith("/signup");

  /* ------------------------------------------------------------
     üö´ Post-checkout redirect safeguard
     Prevent /profile reroute immediately after payment success
  ------------------------------------------------------------ */
  useEffect(() => {
    if (typeof window === "undefined") return;
    const skip = sessionStorage.getItem("skipProfileRedirect");

    if (skip) {
      console.log("üß≠ [RootShell] skipProfileRedirect detected.");
      sessionStorage.removeItem("skipProfileRedirect");

      // If the user somehow gets pushed toward /profile,
      // bring them back to /my-orders immediately.
      if (pathname === "/profile") {
        console.warn("üîÅ [RootShell] Canceling profile redirect ‚Üí /my-orders");
        router.replace("/my-orders");
      }
    }
  }, [pathname, router]);

  if (isAdmin) {
    return (
      <>
        <SessionSync />
        {children}
      </>
    );
  }

  return (
    <SidebarProvider>
      <UserProvider>
        <SessionSync />

        {!isAuth && <UniversalHeader />}

        <div
          id="root-safe-viewport"
          className="relative flex flex-col w-full min-h-[100dvh]
                     bg-[var(--surface-base)]
                     text-[var(--text-primary-light)] dark:text-[var(--text-primary-dark)]
                     transition-colors duration-500"
        >
          <main
            id="safe-scroll-zone"
            className="flex-1 overflow-y-auto overflow-x-hidden scroll-smooth"
            style={{
              paddingTop: "var(--header-h,72px)",
              paddingBottom:
                "calc(var(--mbnav-h,72px) + env(safe-area-inset-bottom))",
              WebkitOverflowScrolling: "touch",
            }}
          >
            <LayoutContent>{children}</LayoutContent>
          </main>

          <div
            id="edith-toast-safe"
            className="fixed left-0 right-0 z-[120] flex justify-center
                       bottom-[calc(var(--mbnav-h,72px)+env(safe-area-inset-bottom))] 
                       pointer-events-none pb-4 px-3"
          >
            <div className="w-full max-w-sm">
              <EdithToaster />
            </div>
          </div>
        </div>
      </UserProvider>
    </SidebarProvider>
  );
}

--- components/layout/SafeViewport.tsx ---
"use client";
/**
 * ============================================================
 * SafeViewport v8.8 ‚Äî Gemini Alignment Edition üåó
 * ------------------------------------------------------------
 * ‚úÖ Dynamically syncs header / navbar / sidebar offsets
 * ‚úÖ Centers content within max-safe width (no right drift)
 * ‚úÖ Applies fluid clamp width for desktop + mobile
 * ‚úÖ Prevents scroll bleed inside SafeViewport
 * ‚úÖ Fully theme-aware and RootShell-compatible
 * ============================================================
 */

import { useEffect, useState } from "react";

export default function SafeViewport({
  children,
  headerId = "universal-header",
  navbarId = "hf-mobile-navbar",
  sidebarId = "universal-sidebar",
  align = "center",
}: {
  children: React.ReactNode;
  headerId?: string;
  navbarId?: string;
  sidebarId?: string;
  align?: "center" | "left";
}) {
  const [offsets, setOffsets] = useState({
    top: 72,
    bottom: 72,
    left: 0,
  });

  /* ------------------------------------------------------------
     üß© Dynamically measure layout elements
  ------------------------------------------------------------ */
  useEffect(() => {
    const updateOffsets = () => {
      const header = document.getElementById(headerId);
      const navbar = document.getElementById(navbarId);
      const sidebar = document.getElementById(sidebarId);

      requestAnimationFrame(() => {
        setOffsets({
          top: header?.offsetHeight || 72,
          bottom: navbar?.offsetHeight || 72,
          left: sidebar?.offsetWidth || 0,
        });
      });
    };

    updateOffsets();
    window.addEventListener("resize", updateOffsets);
    return () => window.removeEventListener("resize", updateOffsets);
  }, [headerId, navbarId, sidebarId]);

  /* ------------------------------------------------------------
     üåó SafeViewport Container
  ------------------------------------------------------------ */
  return (
    <main
      id="dynamic-safe-viewport"
      className="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto
                 transition-colors duration-500 ease-out"
      style={{
        paddingTop: offsets.top,
        paddingBottom: offsets.bottom,
        paddingLeft: offsets.left,
        minHeight: "100vh",
        background: "var(--surface-base)",
        color: "var(--text-primary)",
      }}
    >
      {/* üß≠ Centered Content Wrapper */}
      <div
        className="relative w-full flex flex-col items-center justify-start
                   px-4 sm:px-6 md:px-8"
        style={{
          width: align === "left" ? "100%" : "clamp(340px, 95vw, 1280px)",
          marginInline: align === "left" ? "0" : "auto",
          maxWidth: align === "left"
            ? "none"
            : "var(--safe-max-width, 1280px)",
        }}
      >
        {children}
      </div>

      {/* üîí Subtle background gradient for safe visual anchoring */}
      <div
        className="pointer-events-none absolute inset-0 z-[-1]
                   bg-[radial-gradient(circle_at_center,rgba(16,185,129,0.05),transparent_65%)]
                   dark:bg-[radial-gradient(circle_at_center,rgba(52,211,153,0.08),transparent_70%)]"
      />
    </main>
  );
}

--- components/layout/Sidebar.tsx ---
"use client";
/**
 * Sidebar v10.5 ‚Äî HomeFix Gemini Continuum Unified üåó
 * ------------------------------------------------------------
 * ‚úÖ Full integration with globals.css v6.1+ palette
 * ‚úÖ True-light / Gemini-dark base with readable text
 * ‚úÖ Smooth spring animation & no overflow flicker
 * ‚úÖ Hover glow retains Edith gradient energy
 */

import { useSidebar } from "@/contexts/SidebarContext";
import { useUser } from "@/contexts/UserContext";
import { supabase } from "@/lib/supabaseClient";
import { HomeFixUser } from "@/types/HomeFixUser";
import { motion } from "framer-motion";
import {
  Box,
  Calculator,
  CalendarDays,
  ChevronLeft,
  ChevronRight,
  ClipboardList,
  Home,
  LogIn,
  LogOut,
  Settings,
  ShoppingCart,
  Store,
} from "lucide-react";
import dynamic from "next/dynamic";
import Link from "next/link";
import { useCallback, useEffect, useState } from "react";

const ThemeToggle = dynamic(() => import("@/components/ThemeToggle"), {
  ssr: false,
});

const NAV = [
  { href: "/", label: "Home", Icon: Home },
  { href: "/services", label: "Services", Icon: ClipboardList },
  { href: "/my-space", label: "Bookings", Icon: CalendarDays },
  {
    href: "/estimator",
    label: "Online Estimator",
    Icon: Calculator,
    badge: "Live",
  },
  { href: "/studio", label: "Studio", Icon: Box, badge: "Coming Soon" },
  { href: "/store", label: "Store", Icon: Store },
  { href: "/cart", label: "Cart", Icon: ShoppingCart },
  { href: "/settings", label: "Settings", Icon: Settings },
];

export default function Sidebar() {
  const { collapsed, setCollapsed } = useSidebar();
  const { user: contextUser } = useUser();

  const [user, setUser] = useState<HomeFixUser | null>(null);
  const [pinned, setPinned] = useState<boolean>(false);

  const widthPx = collapsed ? 80 : 256;

  /* üß† Hydrate user */
  useEffect(() => {
    if (contextUser && contextUser.loggedIn) {
      setUser(contextUser);
      return;
    }

    // fallback only if no real context user
    const cached = localStorage.getItem("user");
    if (cached) {
      try {
        setUser(JSON.parse(cached));
      } catch {
        localStorage.removeItem("user");
      }
    }
  }, [contextUser]);

  /* üö™ Logout */
  const handleLogout = useCallback(async () => {
    try {
      await supabase.auth.signOut();
      localStorage.removeItem("user");
      setUser(null);
      window.dispatchEvent(new CustomEvent("profile-updated"));
      setTimeout(() => (window.location.href = "/login"), 300);
    } catch (err) {
      console.error("üí• [Sidebar Logout Error]:", err);
      window.location.href = "/login";
    }
  }, []);

  const avatarLetter = user?.name?.[0]?.toUpperCase() || "G";

  return (
    <motion.aside
      data-theme-transition
      role="complementary"
      layout
      animate={{ width: widthPx }}
      transition={{
        type: "spring",
        stiffness: 150,
        damping: 22,
        mass: 0.8,
      }}
      onMouseEnter={() => {
        if (!pinned) setCollapsed(false);
      }}
      onMouseLeave={() => {
        if (!pinned) setCollapsed(true);
      }}
      style={{
        background: "var(--sidebar-surface)",
        color: "var(--sidebar-text)",
        transition: "background 0.4s ease, color 0.4s ease",
        borderRight: "1px solid var(--border-soft)",
      }}
      className={`
    relative flex flex-col h-[calc(100vh-64px)]
    overflow-y-hidden overflow-x-hidden
    backdrop-blur-xl transition-all duration-500
  `}
    >
      {/* üåà Edith Aura Band */}
      <motion.div
        className="absolute inset-y-0 left-0 w-[4px] rounded-r-full pointer-events-none"
        animate={{
          background: [
            "linear-gradient(to bottom, var(--accent-tertiary), var(--accent-primary), var(--accent-secondary))",
            "linear-gradient(to bottom, var(--accent-secondary), var(--accent-primary), var(--accent-tertiary))",
          ],
          boxShadow: [
            "0 0 16px rgba(155,92,248,0.55)",
            "0 0 26px rgba(236,110,207,0.6)",
          ],
          scaleY: [1, 1.04, 1],
        }}
        transition={{ repeat: Infinity, duration: 4, ease: "easeInOut" }}
      />

      {/* ‚ú® Header */}
      <div
        className="relative flex items-center justify-center px-4 py-4 border-b border-[var(--border-soft)]
                   bg-[var(--sidebar-surface)] backdrop-blur-xl"
      >
        <motion.button
          aria-label="Toggle sidebar"
          aria-pressed={pinned}
          onClick={() =>
            setPinned((prev) => {
              const next = !prev;
              setCollapsed(!next);
              return next;
            })
          }
          whileHover={{ scale: 1.1 }}
          whileTap={{ scale: 0.9 }}
          transition={{ type: "spring", stiffness: 240, damping: 18 }}
          className="absolute -right-3 top-5 z-50 rounded-full 
                     bg-[var(--sidebar-surface)]
                     border border-[var(--border-soft)]
                     shadow-md p-1 hover:border-[var(--accent-tertiary)]/40
                     hover:bg-[var(--edith-surface-hover)]/90 dark:hover:bg-[var(--surface-hover)]
                     transition-all duration-300"
        >
          {collapsed ? (
            <ChevronRight
              size={18}
              className="text-[var(--sidebar-text)]/70"
            />
          ) : (
            <ChevronLeft
              size={18}
              className="text-[var(--sidebar-text)]/70"
            />
          )}
        </motion.button>
      </div>

      {/* üß≠ Navigation */}
      <div className="flex-1 px-2 py-4 space-y-1 relative select-none">
        {NAV.map(({ href, label, Icon, badge }) => (
          <motion.div
            key={href}
            whileHover={{ scale: 1.03, x: 3 }}
            transition={{ type: "spring", stiffness: 220, damping: 18 }}
          >
            <Link
              href={href}
              className="group flex items-center gap-3 px-3 py-2 rounded-xl
                         text-[var(--sidebar-text)]
                         hover:bg-gradient-to-r hover:from-[var(--accent-primary)]/10 hover:to-[var(--accent-secondary)]/10
                         hover:shadow-[0_0_10px_rgba(155,92,248,0.25)]
                         transition-all duration-300 ease-out"
            >
              <motion.div
                whileHover={{ y: -1 }}
                className="relative flex items-center"
              >
                <Icon size={18} />
                <span className="absolute inset-0 rounded-full bg-gradient-to-r from-[var(--accent-primary)]/20 to-[var(--accent-secondary)]/20 blur-md opacity-0 group-hover:opacity-60 transition-opacity" />
              </motion.div>

              {!collapsed && (
                <div className="flex items-center justify-between w-full">
                  <span className="text-[15px] font-medium tracking-wide">
                    {label}
                  </span>
                  {badge && (
                    <span
                      className={`text-[10px] px-1.5 py-0.5 rounded-md ml-2 ${
                        badge === "Live"
                          ? "bg-[var(--badge-live-bg)] text-[var(--badge-live-text)]"
                          : "bg-[var(--badge-soon-bg)] text-[var(--badge-soon-text)]"
                      }`}
                    >
                      {badge}
                    </span>
                  )}
                </div>
              )}
            </Link>
          </motion.div>
        ))}
      </div>

      {/* üë§ Footer */}
      <div className="border-t border-[var(--border-soft)] bg-[var(--sidebar-surface)] backdrop-blur-lg p-4">
        <div className="flex items-center justify-between mb-2">
          <motion.div
            whileHover={{ scale: 1.08 }}
            whileTap={{ scale: 0.94 }}
            onClick={() => (window.location.href = "/profile")}
            className="relative cursor-pointer group"
          >
            <motion.div
              initial={{ opacity: 0.5 }}
              animate={{ opacity: [0.4, 0.1, 0.4], scale: [1, 1.15, 1] }}
              transition={{ duration: 2, repeat: Infinity, ease: "easeInOut" }}
              className="absolute inset-0 rounded-full bg-gradient-to-r from-[var(--accent-primary)]/40 to-[var(--accent-secondary)]/40 blur-lg"
            />
            <div
              className="relative w-9 h-9 rounded-full bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]
                         flex items-center justify-center text-sm font-bold text-white
                         shadow-[0_0_10px_rgba(155,92,248,0.5)] ring-1 ring-white/10"
            >
              {avatarLetter}
            </div>
          </motion.div>

          {!collapsed && (
            <div className="flex items-center justify-between flex-1 ml-3">
              <div className="flex flex-col leading-tight">
                <span className="text-[15px] font-medium">
                  {user?.name || "Guest"}
                </span>
                <span className="text-xs text-[var(--text-muted)]">
                  Member
                </span>
              </div>
              <ThemeToggle />
            </div>
          )}
        </div>

        {user ? (
          <motion.button
            whileTap={{ scale: 0.96 }}
            onClick={handleLogout}
            className="w-full mt-2 flex items-center gap-2 px-3 py-2 rounded-lg 
                       text-[var(--accent-secondary)] hover:bg-[var(--accent-secondary)]/10 transition-all"
          >
            <LogOut size={16} />
            {!collapsed && <span className="text-sm">Logout</span>}
          </motion.button>
        ) : (
          <Link
            href="/login"
            className="w-full mt-2 flex items-center gap-2 px-3 py-2 rounded-lg
                       text-[var(--accent-primary)] hover:bg-[var(--accent-tertiary)]/10 transition-all"
          >
            <LogIn size={16} />
            {!collapsed && <span className="text-sm">Login</span>}
          </Link>
        )}
      </div>
    </motion.aside>
  );
}

--- components/layout/UniversalHeader.tsx ---
"use client";
/**
 * ============================================================
 * UniversalHeader v7.0 ‚Äî Gemini Continuum Edition üåó
 * ------------------------------------------------------------
 * ‚úÖ Theme-safe hydration (no mismatch)
 * ‚úÖ Fully tokenized colors (no raw hex)
 * ‚úÖ Smooth aura transitions + elevation depth
 * ‚úÖ Enhanced MySpace toggle animation
 * ‚úÖ Production-grade accessibility + UX polish
 * ============================================================
 */

import useEstimator, {
  type EstimatorStep,
} from "@/components/estimator/store/estimatorStore";
import { useProductCartStore } from "@/components/store/cartStore";
import HomeFixLogo from "@/components/ui/HomeFixLogo";
import clsx from "clsx";
import { motion } from "framer-motion";
import {
  CalendarDays,
  Moon,
  Package,
  RefreshCw,
  ShoppingCart,
  Sun,
} from "lucide-react";
import { useTheme } from "next-themes";
import { usePathname, useRouter } from "next/navigation";
import React, { useEffect, useRef, useState } from "react";

export default function UniversalHeader(): React.ReactElement {
  const headerRef = useRef<HTMLElement | null>(null);
  const pathname = usePathname();
  const router = useRouter();
  const { theme, setTheme, systemTheme } = useTheme();

  const [mounted, setMounted] = useState(false);
  const [isSyncing, setSyncing] = useState(false);

  const totalItems = useProductCartStore((s) => s.totalItems);
  const estimatorState = useEstimator.getState?.() || {};
  const step = (estimatorState.step || "kitchen") as EstimatorStep;
  const fallbackSetStep: (s: EstimatorStep) => void = () => {};
  const setStep: (s: EstimatorStep) => void =
    estimatorState.setStep ?? fallbackSetStep;

  const isEstimator = pathname?.startsWith("/estimator");
  const isViewer = pathname?.startsWith("/edith");
  const isMySpace = pathname?.startsWith("/my-space");

  useEffect(() => setMounted(true), []);

  // dynamically set CSS var for layout alignment
  useEffect(() => {
    const el = headerRef.current;
    if (!el) return;
    const updateHeight = () =>
      document.documentElement.style.setProperty(
        "--header-h",
        `${el.getBoundingClientRect().height}px`
      );
    const ro = new ResizeObserver(updateHeight);
    ro.observe(el);
    updateHeight();
    return () => ro.disconnect();
  }, []);

  const currentTheme = theme === "system" ? systemTheme : theme;
  const toggleTheme = () =>
    setTheme(currentTheme === "light" ? "dark" : "light");

  async function handleSync() {
    try {
      setSyncing(true);
      const { syncEdithAssets } = await import(
        "@/edith/components/useAssetSync"
      );
      await syncEdithAssets((p: number) =>
        console.log("Sync progress:", Math.round(p * 100) + "%")
      );
    } catch (err) {
      console.error("Sync failed:", err);
    } finally {
      setSyncing(false);
    }
  }

  const pageTitle = pathname?.startsWith("/studio")
    ? "HomeFix Studio"
    : pathname?.startsWith("/store")
    ? "HomeFix Store"
    : pathname?.startsWith("/my-space")
    ? "My Space"
    : pathname?.startsWith("/services")
    ? "Our Services"
    : pathname?.startsWith("/profile")
    ? "Profile Center"
    : isViewer
    ? "Edith Viewer"
    : isEstimator
    ? "HomeFix Estimator"
    : "";

  return (
    <motion.header
      ref={headerRef}
      className="fixed top-0 left-0 right-0 z-[70] flex flex-col select-none
                 border-b border-[var(--border-soft)] backdrop-blur-xl
                 bg-[var(--surface-header)]/95 transition-all duration-500"
      initial={{ opacity: 0, y: -15 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.6, ease: "easeOut" }}
    >
      {/* üåà Primary Header Bar */}
      <div className="flex flex-wrap items-center justify-between px-4 sm:px-6 py-3.5 gap-3">
        <div className="flex items-center gap-3.5">
          <HomeFixLogo size="md" />
          {mounted && (
            <motion.span
              className="hidden sm:inline text-sm text-[var(--text-secondary)] italic"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.3 }}
            >
              Build what you wish existed.
            </motion.span>
          )}
        </div>

        {/* üõí Cart */}
        <button
          onClick={() => router.push("/cart")}
          className="relative flex items-center justify-center w-8 h-8 rounded-lg
                     border border-[var(--border-soft)] hover:border-[var(--accent-primary)]
                     bg-[var(--surface-card)] transition-colors"
          aria-label="Open Cart"
        >
          <ShoppingCart className="text-[var(--text-primary)]" size={16} />
          {totalItems > 0 && (
            <span
              className="absolute -top-1 -right-1 bg-[var(--accent-primary)]
                             text-white text-[10px] font-semibold w-4 h-4
                             rounded-full flex items-center justify-center"
            >
              {totalItems}
            </span>
          )}
        </button>

        {/* üß≠ Page Title */}
        <motion.h1
          key={pathname}
          className="text-base sm:text-lg font-semibold text-[var(--accent-primary)]
                     dark:text-[var(--accent-secondary)] flex-1 text-center sm:text-left truncate"
          initial={{ opacity: 0, y: -6 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.4 }}
        >
          {pageTitle}
        </motion.h1>

        {/* ‚òÄÔ∏è Actions */}
        <div className="flex items-center gap-3 sm:gap-4">
          {isViewer && (
            <button
              onClick={handleSync}
              disabled={isSyncing}
              className="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs md:text-sm
                         bg-[var(--accent-primary)] text-white hover:opacity-90 shadow-md"
            >
              <RefreshCw
                size={14}
                className={isSyncing ? "animate-spin" : ""}
              />
              {isSyncing ? "Syncing" : "Sync"}
            </button>
          )}
          {mounted && (
            <button
              onClick={toggleTheme}
              className="flex items-center justify-center w-8 h-8 rounded-lg
                         border border-[var(--border-soft)]
                         bg-[var(--surface-card)] transition"
              aria-label="Toggle Theme"
            >
              {currentTheme === "light" ? (
                <Moon className="text-[var(--accent-primary)]" size={16} />
              ) : (
                <Sun className="text-[var(--accent-secondary)]" size={16} />
              )}
            </button>
          )}
        </div>
      </div>

      {/* üî∏ Estimator Tabs */}
      {isEstimator && (
        <motion.nav
          className="flex flex-wrap items-center justify-center gap-2 py-2 border-t border-[var(--border-soft)]
                     bg-[var(--surface-header)]"
          initial={{ opacity: 0, y: -8 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.3 }}
        >
          {(
            ["kitchen", "wardrobe", "summary"] as ReadonlyArray<EstimatorStep>
          ).map((key, i) => {
            const label = `${i + 1}. ${
              key.charAt(0).toUpperCase() + key.slice(1)
            }`;
            const active = step === key;
            return (
              <button
                key={key}
                onClick={() => setStep(key)}
                className={clsx(
                  "relative px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-200",
                  active
                    ? "bg-[var(--accent-primary)] text-white shadow-md"
                    : "bg-[var(--surface-card)] text-[var(--text-primary)] border border-[var(--border-soft)] hover:border-[var(--accent-primary)]"
                )}
              >
                {label}
              </button>
            );
          })}
        </motion.nav>
      )}

      {/* üî∏ MySpace Compact Toggle Bar ‚Äî Gemini Glow Enhanced */}
      {isMySpace && (
        <motion.div
          className="flex justify-center items-center py-2 border-t border-[var(--border-soft)]
                     bg-[var(--surface-header)]/80 backdrop-blur-xl
                     sticky top-[calc(var(--header-h))] z-[67]
                     shadow-[0_2px_8px_rgba(0,0,0,0.04)]"
          initial={{ opacity: 0, y: -8 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.35, ease: "easeOut" }}
        >
          <motion.div
            layout
            className="relative inline-flex items-center gap-1 p-1 rounded-full border border-[var(--border-soft)]
                       bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                       shadow-[inset_0_0_4px_rgba(255,255,255,0.25),0_0_6px_rgba(155,92,248,0.3)]
                       transition-all duration-300"
          >
            {[
              { id: "bookings", label: "Bookings", icon: CalendarDays },
              { id: "orders", label: "Orders", icon: Package },
            ].map((item) => {
              const active = pathname?.includes(item.id) ?? false;
              const Icon = item.icon;
              return (
                <motion.button
                  key={item.id}
                  onClick={() => router.replace(`/my-space?view=${item.id}`)}
                  data-active={active}
                  whileTap={{ scale: 0.97 }}
                  className={clsx(
                    "flex items-center gap-1 px-3 sm:px-4 py-1.5 rounded-full text-xs sm:text-sm font-medium relative select-none focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]/40 transition-all duration-300",
                    active
                      ? "text-white bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)] shadow-[0_0_8px_rgba(155,92,248,0.4)]"
                      : "text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:bg-[var(--surface-hover)]"
                  )}
                >
                  <Icon size={14} />
                  {item.label}
                  {active && (
                    <motion.div
                      layoutId="active-glow"
                      className="absolute inset-0 rounded-full bg-gradient-to-r from-[var(--accent-primary)]/40 to-[var(--accent-secondary)]/40 blur-md -z-10"
                      transition={{
                        type: "spring",
                        stiffness: 120,
                        damping: 20,
                      }}
                    />
                  )}
                </motion.button>
              );
            })}
          </motion.div>
        </motion.div>
      )}
    </motion.header>
  );
}

--- components/layout/index.ts ---


export { default as RootShell } from "./RootShell";
export { default as LayoutContent } from "./LayoutContent";
export { default as UniversalHeader } from "./UniversalHeader";
export { default as NavBar } from "./NavBar";
export { default as Sidebar } from "./Sidebar";

--- components/ledgerx/LedgerXDock.tsx ---
// components/ledgerx/LedgerXDock.tsx
"use client";
import { useState } from "react";
import { useLedgerX } from "./useLedgerX";
import { Dock, Circle } from "lucide-react"; // replace with your favorite icon

export default function LedgerXDock({ onOpen }: { onOpen: () => void }) {
  const { pendingCount, isSyncing } = useLedgerX();
  return (
    <button
      onClick={onOpen}
      className="fixed bottom-5 right-5 z-40 rounded-full shadow-lg px-4 py-3 bg-[var(--edith-surface)] hover:opacity-90"
      aria-label="Open ledger"
    >
      <span className="inline-flex items-center gap-2">
        <Dock className="w-5 h-5" />
        <span>Ledger</span>
        {isSyncing ? (
          <span className="animate-pulse text-xs">syncing‚Ä¶</span>
        ) : (
          <span className="text-xs opacity-70">{pendingCount} pending</span>
        )}
        {pendingCount > 0 && <Circle className="w-2 h-2" />}
      </span>
    </button>
  );
}

--- components/ledgerx/LedgerXDrawer.tsx ---
/**
 * LedgerX Local DB ‚Äî v2.0
 * Unified Type + IndexedDB Helpers
 * Fully compatible with:
 * - useLedgerX.ts
 * - LedgerXItemCard
 * - LedgerXDrawer
 * - Checkout + My Orders
 */

export type LedgerXStatus = "pending" | "synced" | "failed" | "cancelled";

export interface LedgerXEntry {
  id: string;
  type: string;
  status: LedgerXStatus;
  createdAt: number | string;

  payload: {
    cart?: any[];
    total?: number;
    address?: {
      label?: string;
      formatted?: string;
    };
    [key: string]: any;
  };

  [key: string]: any;
}

/* ------------------------------------------------------------
   IndexedDB minimal wrapper (used by useLedgerX.ts)
------------------------------------------------------------- */

// Use one database name consistently
const DB_NAME = "ledgerx_db";
const STORE_NAME = "entries";

export function getLedgerDB(): Promise<IDBDatabase> {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);

    req.onerror = () => reject(req.error);
    req.onsuccess = () => resolve(req.result);

    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "id" });
      }
    };
  });
}

export async function addLedgerEntry(entry: LedgerXEntry) {
  const db = await getLedgerDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).put(entry);
  return new Promise((resolve) => {
    tx.oncomplete = resolve;
  });
}

export async function getAllLedgerEntries(): Promise<LedgerXEntry[]> {
  const db = await getLedgerDB();
  const tx = db.transaction(STORE_NAME, "readonly");
  const store = tx.objectStore(STORE_NAME);

  return new Promise((resolve) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result as LedgerXEntry[]);
  });
}

export async function deleteLedgerEntry(id: string) {
  const db = await getLedgerDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).delete(id);
  return new Promise((resolve) => {
    tx.oncomplete = resolve;
  });
}

--- components/ledgerx/LedgerXItemCard.tsx ---
"use client";
import { useProductCartStore } from "@/components/store/cartStore";
import { resolveCartConflict } from "@/components/store/cartGuards";
import { Button } from "@/components/ui/button";
import { useRouter } from "next/navigation";
import type { LedgerXEntry } from "./useLedgerX";

interface LedgerXItemCardProps {
  entry: LedgerXEntry;
}

export default function LedgerXItemCard({ entry }: LedgerXItemCardProps) {
  const router = useRouter();
  const addItem = useProductCartStore((s) => s.addItem);

  const items = Array.isArray(entry.payload?.cart) ? entry.payload.cart : [];
  const total = entry.payload?.total ?? 0;
  const address =
    entry.payload?.address?.label ??
    entry.payload?.address?.formatted ??
    "Address not set";

  const statusColor =
    entry.status === "pending"
      ? "bg-amber-500"
      : entry.status === "synced"
      ? "bg-emerald-600"
      : "bg-slate-500";

  return (
    <div className="rounded-xl p-3 border border-[var(--edith-border)] bg-[var(--edith-surface-hover)]">
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <span className={`w-2 h-2 rounded-full ${statusColor}`} />
          <span className="text-sm font-medium">{entry.type}</span>
        </div>
        <span className="text-xs opacity-70">
          {new Date(entry.createdAt).toLocaleString()}
        </span>
      </div>

      <div className="text-sm opacity-80 line-clamp-2">{address}</div>

      <div className="flex items-center justify-between mt-2">
        <div className="flex items-center gap-2">
          <span className="px-2 py-1 rounded-md bg-[var(--edith-surface-hover)] text-xs opacity-80">
            {items.length} items
          </span>
          <span className="px-2 py-1 rounded-md border text-xs opacity-80">
            ‚Çπ {total}
          </span>
        </div>
        <div className="flex items-center gap-2">
          <Button
            size="sm"
            onClick={() => {
              if (!resolveCartConflict("product")) return;
              if (items.length)
                items.forEach((it: any) =>
                  addItem({ ...it, type: "product" })
                );
            }}
          >
            Reorder
          </Button>

          <Button
            size="sm"
            onClick={() => {
              if (!resolveCartConflict("product")) return;
              if (items.length)
                items.forEach((it: any) =>
                  addItem({ ...it, type: "product" })
                );
            }}
          >
            Reorder
          </Button>
        </div>
      </div>
    </div>
  );
}

--- components/ledgerx/LedgerXProvider.tsx ---
"use client";

import { useLedgerX } from "@/components/ledgerx/useLedgerX";
import { useUser } from "@/contexts/UserContext";
import { useEffect } from "react";

export default function LedgerXProvider({ children }: any) {
  const { user, isLoaded } = useUser();
  const { load } = useLedgerX();

  useEffect(() => {
    if (!isLoaded || !user?.id) return;

    // Load Dexie immediately after user loads
    load(user.id);
  }, [isLoaded, user?.id, load]);

  return <>{children}</>;
}

--- components/ledgerx/db.ts ---
// File: components/ledgerx/db.ts
// Clean IndexedDB wrapper for LedgerX (enhanced)

export interface LedgerXDBEntry {
  id: string;
  userId: string;
  type: string;
  payload: any;
  status: string;
  deviceId?: string | null;
  checksum?: string | null;
  createdAt: number;
  updatedAt: number;
}

const DB_NAME = "ledgerx-db";
const STORE_NAME = "entries";
const DB_VERSION = 1;
const LEGACY_DB_NAMES = ["homefix-ledgerx", "ledgerx_db"];

(function cleanupLegacyLedgerDbs() {
  if (typeof window === "undefined") return;
  const flag = "__ledgerx_legacy_cleanup__";
  if ((window as any)[flag]) return;
  (window as any)[flag] = true;

  for (const name of LEGACY_DB_NAMES) {
    if (name === DB_NAME) continue;
    try {
      indexedDB.deleteDatabase(name);
    } catch (err) {
      console.warn("[LedgerX] legacy DB cleanup failed:", name, err);
    }
  }
})();

let dbPromise: Promise<IDBDatabase> | null = null;

function openDB(): Promise<IDBDatabase> {
  if (dbPromise) return dbPromise;

  dbPromise = new Promise((resolve, reject) => {
    if (typeof window === "undefined") return reject(new Error("No window"));

    const req = indexedDB.open(DB_NAME, DB_VERSION);

    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: "id" });
        store.createIndex("userId", "userId", { unique: false });
        store.createIndex("createdAt", "createdAt", { unique: false });
      }
    };

    req.onerror = () => reject(req.error);
    req.onsuccess = () => resolve(req.result);
  });

  return dbPromise;
}

/* ---------------------- Transaction helpers ---------------------- */

async function withTx<T>(
  mode: IDBTransactionMode,
  fn: (store: IDBObjectStore) => Promise<T>
): Promise<T> {
  const db = await openDB();
  const tx = db.transaction(STORE_NAME, mode);
  const store = tx.objectStore(STORE_NAME);
  try {
    const res = await fn(store);
    return await new Promise<T>((resolve, reject) => {
      tx.oncomplete = () => resolve(res);
      tx.onabort = () => reject(tx.error);
      tx.onerror = () => reject(tx.error);
    });
  } catch (err) {
    tx.abort();
    throw err;
  }
}

/* ---------------------- EXPORTED API ---------------------- */

export async function getLedgerDB(): Promise<IDBDatabase> {
  return openDB();
}

export async function addLedgerEntry(entry: LedgerXDBEntry): Promise<void> {
  await withTx("readwrite", async (store) => {
    store.put(entry);
  });
}

export async function getAllLedgerEntries(): Promise<LedgerXDBEntry[]> {
  return withTx("readonly", async (store) => {
    return await new Promise<LedgerXDBEntry[]>((resolve, reject) => {
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result as LedgerXDBEntry[]);
      request.onerror = () => reject(request.error);
    });
  });
}

--- components/ledgerx/forceReset.ts ---
// Run only in browser
export function forceResetLedgerX() {
  if (typeof window === "undefined") return;

  const FLAG = "ledgerx-force-reset-v1";

  // Already reset before ‚Üí skip
  if (localStorage.getItem(FLAG)) return;

  console.warn("üßπ Running LedgerX one-time hard reset‚Ä¶");

  // delete DB
  indexedDB.deleteDatabase("homefix-ledgerx");

  // mark as cleaned
  localStorage.setItem(FLAG, "1");

  // reload once
  setTimeout(() => location.reload(), 200);
}

--- components/ledgerx/useLedgerX.ts ---
"use client";

import { supabase } from "@/lib/supabaseClient";
import { nanoid } from "nanoid";
import { create } from "zustand";
import { addLedgerEntry, getAllLedgerEntries, LedgerXDBEntry } from "./db";

const DEBUG =
  (typeof window !== "undefined" &&
    (window as any).__DEBUG_LEDGERX__ === true) ||
  process.env.NEXT_PUBLIC_DEBUG_LEDGERX === "true" ||
  process.env.DEBUG_MODE === "true";

const TIMEOUT_MS = Number(process.env.NEXT_PUBLIC_LEDGERX_TIMEOUT_MS || 20000);
const SYNC_BATCH_SIZE = Number(
  process.env.NEXT_PUBLIC_LEDGERX_BATCH_SIZE || 40
);
const SYNC_MAX_RETRIES = Number(
  process.env.NEXT_PUBLIC_LEDGERX_SYNC_RETRIES || 3
);

export type LedgerXStatusType =
  | "pending"
  | "synced"
  | "failed"
  | "cancelled"
  | "completed"
  | "rescheduled"
  | "return_requested"
  | "return_approved"
  | "return_rejected"
  | "returned"
  | "refunded";

export interface LedgerXEntry {
  id: string;
  userId: string;
  type: string;
  payload: any;
  status: LedgerXStatusType;
  deviceId?: string | null;
  checksum?: string | null;
  createdAt: number;
  updatedAt: number;
}

function safeJson<T = any>(v: any): T {
  try {
    return JSON.parse(JSON.stringify(v ?? {}));
  } catch {
    return {} as T;
  }
}

function uuidv4(): string {
  try {
    if ((crypto as any)?.randomUUID) return (crypto as any).randomUUID();
  } catch {}
  const a = new Uint8Array(16);
  if ((crypto as any)?.getRandomValues) (crypto as any).getRandomValues(a);
  else for (let i = 0; i < 16; i++) a[i] = Math.floor(Math.random() * 256);
  a[6] = (a[6] & 0x0f) | 0x40;
  a[8] = (a[8] & 0x3f) | 0x80;
  return Array.from(a)
    .map((b) => b.toString(16).padStart(2, "0"))
    .join("")
    .replace(
      /([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,
      "$1-$2-$3-$4-$5"
    );
}

function withTimeout<T>(p: Promise<T>, ms = TIMEOUT_MS): Promise<T> {
  let id: any;
  const timeout = new Promise<T>((_, rej) => {
    id = setTimeout(
      () => rej(new Error(`operation timed out after ${ms}ms`)),
      ms
    );
  });
  return Promise.race([p.finally(() => clearTimeout(id)), timeout]);
}

function isUuidLike(id?: string | null): boolean {
  if (!id || typeof id !== "string") return false;
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(
    id
  );
}

function normalizeLocalRow(r: LedgerXDBEntry | any): LedgerXEntry {
  return {
    id: String(r.id),
    userId: String(r.userId ?? ""),
    type: r.type ?? "unknown",
    payload: safeJson(r.payload),
    status: (r.status as LedgerXStatusType) ?? "pending",
    deviceId: r.deviceId ?? null,
    checksum: r.checksum ?? null,
    createdAt: typeof r.createdAt === "number" ? r.createdAt : Date.now(),
    updatedAt: typeof r.updatedAt === "number" ? r.updatedAt : Date.now(),
  };
}

function normalizeCloudRow(r: any): LedgerXEntry {
  const createdAt = r.created_at
    ? new Date(r.created_at).getTime()
    : Date.now();
  const updatedAt = r.updated_at ? new Date(r.updated_at).getTime() : createdAt;

  return {
    id: r.id ?? uuidv4(),
    userId: r.user_id ?? "",
    type: r.type ?? "booking",
    payload: safeJson(r.payload),
    status: (r.status as LedgerXStatusType) ?? "synced",
    deviceId: r.device_id ?? "remote",
    checksum: r.checksum ?? nanoid(6),
    createdAt,
    updatedAt,
  };
}

export type LedgerStore = {
  entries: LedgerXEntry[];
  pendingCount: number;
  isSyncing: boolean;
  lastSyncAt?: number;
  load: (uid?: string) => Promise<void>;
  addEntry: (uid: string, type: string, payload: any) => Promise<LedgerXEntry>;
  markStatus: (id: string, status: LedgerXStatusType) => Promise<void>;
  syncNow: (uid: string) => Promise<number>;
  syncPending: (uid: string) => Promise<number>;
  hydrateFromCloud: (uid?: string) => Promise<void>;
  fetchCloudOrders: (uid: string) => Promise<LedgerXEntry[]>;
  mergeOrders: (
    localEntries: LedgerXEntry[],
    cloudOrders: LedgerXEntry[]
  ) => LedgerXEntry[];
};

export const useLedgerX = create<LedgerStore>((set, get) => {
  let lastUidSeen: string | undefined = undefined;

  async function _refreshStateFromDB(uid?: string) {
    try {
      if (typeof window === "undefined") return;

      if (!uid) {
        if (DEBUG && lastUidSeen !== uid) {
          console.log("[LedgerX] _refreshStateFromDB: waiting for uid...");
        }
        lastUidSeen = uid;
        return;
      }

      lastUidSeen = uid;

      const rows = (await getAllLedgerEntries()) || [];
      const filtered: LedgerXEntry[] = rows
        .filter((r: LedgerXDBEntry) => String(r.userId) === String(uid))
        .map(normalizeLocalRow)
        .sort((a: LedgerXEntry, b: LedgerXEntry) => b.createdAt - a.createdAt);

      set({
        entries: filtered,
        pendingCount: filtered.filter((i) => i.status === "pending").length,
      });

      DEBUG &&
        console.log("[LedgerX] Refreshed from IndexedDB:", filtered.length);
    } catch (err) {
      console.warn("[LedgerX] _refreshStateFromDB failed:", err);
      set({ entries: [], pendingCount: 0 });
    }
  }

  async function _fetchCloudOrders(uid?: string): Promise<LedgerXEntry[]> {
    try {
      if (!uid) return [];
      if (!isUuidLike(uid)) {
        DEBUG && console.log("[LedgerX] _fetchCloudOrders: guest uid -> skip");
        return [];
      }

      const { data, error } = await supabase
        .from("bookings_ledger")
        .select("*")
        .eq("user_id", uid)
        .order("created_at", { ascending: false });

      if (error) {
        console.warn("[LedgerX] _fetchCloudOrders supabase error:", error);
        return [];
      }
      if (!Array.isArray(data)) return [];

      return data.map(normalizeCloudRow);
    } catch (err) {
      console.error("[LedgerX] _fetchCloudOrders failed:", err);
      return [];
    }
  }

  function _mergeOrders(
    localEntries: LedgerXEntry[],
    cloudOrders: LedgerXEntry[]
  ) {
    const map = new Map<string, LedgerXEntry>();

    for (const c of cloudOrders || []) map.set(c.id, c);

    for (const l of localEntries || []) {
      const existing = map.get(l.id);
      if (!existing) map.set(l.id, l);
      else if (l.status === "pending" && existing.status !== "pending") {
        map.set(l.id, {
          ...existing,
          status: l.status,
          updatedAt: Math.max(existing.updatedAt || 0, l.updatedAt || 0),
        });
      }
    }

    const arr = Array.from(map.values());
    arr.sort((a, b) => b.createdAt - a.createdAt);
    return arr;
  }

  return {
    entries: [],
    pendingCount: 0,
    isSyncing: false,
    lastSyncAt: undefined,

    load: async (uid?: string) => {
      if (!uid) {
        DEBUG && console.log("[LedgerX] load(): uid missing -> waiting");
        await _refreshStateFromDB(uid);
        return;
      }
      await _refreshStateFromDB(uid);
    },

    addEntry: async (uid: string, type: string, payload: any) => {
      const now = Date.now();
      const id = uuidv4() || nanoid();
      const entry: LedgerXEntry = {
        id,
        userId: uid,
        type,
        payload: safeJson(payload),
        status: "pending",
        deviceId:
          typeof navigator !== "undefined"
            ? `device:web:${navigator?.userAgent?.slice?.(0, 80) ?? "unknown"}`
            : "device:web:unknown",
        checksum: nanoid(8),
        createdAt: now,
        updatedAt: now,
      };

      try {
        await addLedgerEntry(entry as LedgerXDBEntry);

        const current = get().entries || [];
        set({
          entries: [entry, ...current],
          pendingCount:
            current.filter((e) => e.status === "pending").length + 1,
        });

        if (isUuidLike(uid)) {
          setTimeout(() => {
            if (
              typeof navigator !== "undefined" &&
              (navigator as any)?.onLine
            ) {
              get()
                .syncPending(uid)
                .catch(
                  (e) => DEBUG && console.warn("[LedgerX] bg sync failed", e)
                );
            }
          }, 300);
        }

        return entry;
      } catch (err) {
        console.error("[LedgerX] addEntry fatal:", err);
        throw err;
      }
    },

    markStatus: async (id: string, status: LedgerXStatusType) => {
      if (!id) return;
      try {
        const rows = (await getAllLedgerEntries()) || [];
        const target = rows.find((r) => r.id === id);
        if (target) {
          target.status = status;
          target.updatedAt = Date.now();
          await addLedgerEntry(target as LedgerXDBEntry);
        }

        const updated = get().entries.map((e) =>
          e.id === id ? { ...e, status, updatedAt: Date.now() } : e
        );
        set({
          entries: updated,
          pendingCount: updated.filter((i) => i.status === "pending").length,
        });
      } catch (err) {
        console.warn("[LedgerX] markStatus failed:", err);
      }
    },

    syncNow: async (uid: string) => {
      if (!uid) return 0;
      if (!isUuidLike(uid)) {
        DEBUG && console.log("[LedgerX] syncNow skipped: guest uid");
        return 0;
      }

      if (get().isSyncing) {
        DEBUG && console.log("[LedgerX] syncNow skipped: already syncing");
        return 0;
      }

      set({ isSyncing: true });

      try {
        const all = (await getAllLedgerEntries()) || [];
        const pendingAll = all.filter(
          (r) => String(r.userId) === String(uid) && r.status === "pending"
        );

        if (!pendingAll || pendingAll.length === 0) {
          set({ isSyncing: false, lastSyncAt: Date.now() });
          return 0;
        }

        let syncedCount = 0;

        for (let i = 0; i < pendingAll.length; i += SYNC_BATCH_SIZE) {
          const batch = pendingAll.slice(i, i + SYNC_BATCH_SIZE);
          const payloadEntries = batch.map((p) => ({
            id: p.id,
            user_id: p.userId,
            type: p.type,
            payload: safeJson(p.payload),
            status: p.status || "pending",
            device_id: p.deviceId ?? "unknown",
            checksum: p.checksum ?? "none",
            created_at: new Date(p.createdAt).toISOString(),
            updated_at: new Date(p.updatedAt || Date.now()).toISOString(),
          }));

          const body = JSON.stringify({ _entries: payloadEntries });

          let attempt = 0;
          let success = false;
          let lastErr: any = null;

          while (attempt <= SYNC_MAX_RETRIES && !success) {
            try {
              attempt++;
              DEBUG &&
                console.log(
                  `[LedgerX] sync batch ${
                    i / SYNC_BATCH_SIZE + 1
                  } attempt ${attempt}`,
                  payloadEntries.map((p) => p.id)
                );

              const res = await withTimeout(
                fetch(
                  `${
                    typeof window !== "undefined" ? window.location.origin : ""
                  }/api/ledger/sync`,
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body,
                  }
                )
              );

              if (!res.ok) {
                const d = await res.json().catch(() => ({}));
                throw new Error(d?.message || `HTTP ${res.status}`);
              }

              const now = Date.now();
              for (const p of batch) {
                try {
                  const updated = { ...p, status: "synced", updatedAt: now };
                  await addLedgerEntry(updated as LedgerXDBEntry);
                } catch (err) {
                  console.warn("[LedgerX] marking entry synced failed:", err);
                }
              }

              syncedCount += batch.length;
              success = true;
            } catch (err) {
              lastErr = err;
              console.warn(
                `[LedgerX] batch sync attempt ${attempt} failed:`,
                err
              );
              const backoffMs = Math.min(1000 * Math.pow(2, attempt), 30000);
              await new Promise((r) => setTimeout(r, backoffMs));
            }
          }

          if (!success) {
            console.error("[LedgerX] batch permanently failed:", lastErr);
          } else {
            try {
              await get().hydrateFromCloud(uid);
            } catch (e) {
              DEBUG &&
                console.warn(
                  "[LedgerX] hydrateFromCloud after batch failed:",
                  e
                );
            }
          }
        }

        await _refreshStateFromDB(uid);
        set({ lastSyncAt: Date.now() });

        return syncedCount;
      } catch (err) {
        console.error("[LedgerX] Sync Error:", err);
        return 0;
      } finally {
        set({ isSyncing: false });
      }
    },

    syncPending: async (uid: string) => {
      if (typeof window === "undefined") return 0;
      if (!(navigator as any)?.onLine) return 0;
      return get().syncNow(uid);
    },

    hydrateFromCloud: async (uid?: string) => {
      try {
        if (!uid) return;
        if (!isUuidLike(uid)) {
          DEBUG && console.log("[LedgerX] hydrateFromCloud skipped: guest uid");
          return;
        }

        const cloud = await _fetchCloudOrders(uid);
        if (!cloud || cloud.length === 0) {
          DEBUG && console.log("[LedgerX] hydrateFromCloud: no remote rows");
          return;
        }

        for (const row of cloud) {
          const item: LedgerXDBEntry = {
            id: row.id,
            userId: row.userId,
            type: row.type,
            payload: safeJson(row.payload),
            status: (row.status as LedgerXStatusType) ?? "synced",
            deviceId: row.deviceId ?? "remote",
            checksum: row.checksum ?? nanoid(6),
            createdAt: row.createdAt,
            updatedAt: row.updatedAt,
          };

          try {
            await addLedgerEntry(item);
          } catch (err) {
            console.warn("[LedgerX] hydrate put failed (nonfatal):", err);
          }
        }

        await _refreshStateFromDB(uid);
      } catch (err) {
        console.warn("[LedgerX] hydrateFromCloud failed:", err);
      }
    },

    fetchCloudOrders: async (uid: string) => {
      return _fetchCloudOrders(uid);
    },

    mergeOrders: (localEntries: LedgerXEntry[], cloudOrders: LedgerXEntry[]) =>
      _mergeOrders(localEntries, cloudOrders),
  };
});

--- components/store/CategoryRail.tsx ---
"use client";
/**
 * ============================================================
 * CategoryRail v1.1 ‚Äî Edith Blinkit Rail üåø
 * ------------------------------------------------------------
 * ‚úÖ TypeScript safe (explicit props)
 * ‚úÖ Vertical swipeable sidebar (mobile)
 * ‚úÖ 15mm pinned design (‚âà 60px)
 * ============================================================
 */

import { motion } from "framer-motion";
import React from "react";

interface CategoryRailProps {
  categories: string[];
  active: string;
  onSelect: (cat: string) => void;
}

const CategoryRail: React.FC<CategoryRailProps> = ({
  categories,
  active,
  onSelect,
}) => {
  return (
    <aside
      className="fixed left-0 top-[var(--header-h)]
                 bottom-[var(--mbnav-h,72px)] z-[70]
                 w-[60px] flex flex-col items-center
                 border-r border-[var(--edith-border)]
                 bg-[var(--surface-light)] dark:bg-[var(--surface-dark)]
                 md:hidden overflow-y-auto overscroll-contain
                 scrollbar-none touch-pan-y snap-y snap-mandatory
                 backdrop-blur-md transition-all duration-500"
      style={{
        WebkitOverflowScrolling: "touch",
        scrollbarWidth: "none",
      }}
    >
      <div className="flex flex-col py-3 gap-2 items-center w-full">
        {categories.map((cat: string) => {
          const isActive = cat === active;
          return (
            <motion.button
              key={cat}
              onClick={() => onSelect(cat)}
              whileTap={{ scale: 0.92 }}
              className={`relative w-[48px] h-[48px] rounded-full flex items-center justify-center text-[11px] font-medium
                overflow-hidden transition-all duration-300 snap-start
                ${
                  isActive
                    ? "bg-gradient-to-b from-emerald-500 to-lime-400 text-white shadow-[0_0_8px_rgba(16,185,129,0.6)]"
                    : "bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)] text-[var(--text-secondary)] hover:bg-[var(--surface-hover)]"
                }`}
            >
              <span className="truncate max-w-[42px] text-center leading-tight px-1">
                {cat.replace(/\s+/g, "\n")}
              </span>
            </motion.button>
          );
        })}
      </div>
    </aside>
  );
};

export default CategoryRail;

--- components/store/ProductCard.tsx ---
"use client";
/**
 * ============================================================
 * File: /components/store/ProductCard.tsx
 * Version: v6.2 ‚Äî Blinkit Micro Compact üåø
 * ------------------------------------------------------------
 * ‚úÖ Compact 1.2-inch cards (~85px)
 * ‚úÖ Smooth hover scale + green aura
 * ‚úÖ Edith theme surface variables
 * ‚úÖ Touch-friendly buttons
 * ============================================================
 */

import { useProductCartStore } from "@/components/store/cartStore";
import { resolveCartConflict } from "@/components/store/cartGuards";
import { motion } from "framer-motion";
import { Minus, Plus } from "lucide-react";
import Image from "next/image";
import { useState } from "react";

export interface Product {
  id: number | string;
  title: string;
  price: number;
  description?: string;
  category?: string | null;
  stock?: number;
  unit?: string;
  type?: "product" | "service";
  image_url?: string;
  images?: { url: string }[];
}

export default function ProductCard({ product }: { product: Product }) {
  const { items, addItem, removeItem } = useProductCartStore();
  const [adding, setAdding] = useState(false);

  const productId = Number(product.id);
  const inCart = items.find((i) => Number(i.id) === productId);
  const quantity = inCart?.quantity || 0;
  const isOutOfStock = product.stock !== undefined && product.stock <= 0;
  const imageSrc =
    product.images?.[0]?.url || product.image_url || "/placeholder.png";

  const handleAdd = () => {
    if (adding || isOutOfStock) return;
    if (!resolveCartConflict("product")) return;
    setAdding(true);
    addItem({
      id: productId,
      title: product.title,
      price: product.price,
      image_url: imageSrc,
      quantity: 1,
      type: "product",
    });
    navigator.vibrate?.(25);
    setTimeout(() => setAdding(false), 200);
  };

  const handleRemove = () => {
    if (quantity > 0) removeItem(productId);
    navigator.vibrate?.(15);
  };

  return (
    <motion.div
      layout
      whileHover={{ scale: 1.03 }}
      whileTap={{ scale: 0.96 }}
      className="relative flex flex-col rounded-xl overflow-hidden
                 bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]
                 border border-[var(--edith-border)]
                 shadow-sm hover:shadow-[0_0_10px_rgba(0,255,150,0.25)]
                 transition-all duration-300 cursor-pointer select-none"
      style={{
        width: "90px",
        height: "125px", // ‚úÖ slightly taller ‚Äì vertical photo-frame feel
      }}
    >
      {/* üñºÔ∏è Image */}
      <div
        className="relative w-full aspect-square overflow-hidden
                   bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)]"
        onClick={handleAdd}
        role="button"
        aria-label={`Add ${product.title}`}
      >
        <Image
          src={imageSrc}
          alt={product.title || "Product"}
          fill
          sizes="(max-width:768px) 33vw, 15vw"
          className="object-cover transition-transform duration-400 hover:scale-110"
        />
        {isOutOfStock && (
          <span className="absolute top-1 left-1 bg-red-600 text-white text-[10px] px-1 py-[1px] rounded">
            Out
          </span>
        )}
      </div>

      {/* üßæ Info */}
      <div className="flex flex-col justify-between flex-1 p-1.5 leading-tight">
        <p
          className="font-medium text-[11px] text-[var(--text-primary)]
                     line-clamp-2 h-[28px]"
        >
          {product.title}
        </p>

        <div className="flex items-center justify-between mt-1">
          <span className="font-semibold text-[var(--accent-success)] text-[11px]">
            ‚Çπ{Number(product.price).toLocaleString()}
          </span>

          {quantity > 0 ? (
            <div className="flex items-center rounded-full border overflow-hidden"
                 style={{ borderColor: "var(--accent-success)" }}>
              <button
                onClick={handleRemove}
                className="px-1 hover:bg-[color-mix(in_srgb,var(--accent-success)10%,transparent)] dark:hover:bg-[color-mix(in_srgb,var(--accent-success)18%,transparent)]"
                style={{ color: "var(--accent-success)" }}
              >
                <Minus size={12} />
              </button>
              <span className="px-1 text-[10px] font-medium">{quantity}</span>
              <button
                onClick={handleAdd}
                disabled={isOutOfStock}
                className="px-1 hover:bg-[color-mix(in_srgb,var(--accent-success)10%,transparent)] dark:hover:bg-[color-mix(in_srgb,var(--accent-success)18%,transparent)] disabled:opacity-50"
                style={{ color: "var(--accent-success)" }}
              >
                <Plus size={12} />
              </button>
            </div>
          ) : (
            <motion.button
              disabled={isOutOfStock}
              onClick={handleAdd}
              whileTap={{ scale: 0.93 }}
              className="px-2 py-[2px] rounded-full text-[10px] font-semibold text-white shadow-sm"
              style={{
                background:
                  "linear-gradient(90deg,var(--accent-success),var(--accent-success-hover))",
              }}
            >
              Add
            </motion.button>
          )}
        </div>
      </div>
    </motion.div>
  );
}

--- components/store/ProductQuickView.tsx ---
"use client";
/**
 * ============================================================
 * File: /components/store/ProductQuickView.tsx
 * Version: v1.1 ‚Äî Gemini Contrast-Safe Edition ‚ú®
 * ------------------------------------------------------------
 * ‚úÖ Exports prop types (fixes TS2322 in ProductCard)
 * ‚úÖ Enforces contrast-safe background on all themes
 * ‚úÖ Glass-blur consistency with global v5.9 CSS
 * ‚úÖ Adds focus trap + Escape key close
 * ‚úÖ Smooth motion & haptic-safe tap feedback
 * ============================================================
 */

import { useProductCartStore } from "@/components/store/cartStore";
import { resolveCartConflict } from "@/components/store/cartGuards";
import { AnimatePresence, motion } from "framer-motion";
import { Minus, Plus, ShoppingBag, X } from "lucide-react";
import Image from "next/image";
import { useCallback, useEffect, useState } from "react";

export interface ProductQuickViewProps {
  product: {
    id: number;
    title: string;
    price: number;
    description?: string;
    category?: string;
    stock?: number;
    image_url?: string;
    unit?: string;
  } | null;
  isOpen: boolean;
  onClose: () => void;
}

export default function ProductQuickView({
  product,
  isOpen,
  onClose,
}: ProductQuickViewProps) {
  const { items, addItem } = useProductCartStore();
  const [localQty, setLocalQty] = useState(1);
  const inCart = product ? items.find((i) => i.id === product.id) : null;

  // ‚ôªÔ∏è Reset qty when product changes
  useEffect(() => {
    if (product) setLocalQty(1);
  }, [product]);

  // ‚å®Ô∏è Close on Escape key
  const handleKey = useCallback(
    (e: KeyboardEvent) => {
      if (e.key === "Escape") onClose();
    },
    [onClose]
  );

  useEffect(() => {
    if (isOpen) {
      document.addEventListener("keydown", handleKey);
      return () => document.removeEventListener("keydown", handleKey);
    }
  }, [isOpen, handleKey]);

  if (!product) return null;

  return (
    <AnimatePresence>
      {isOpen && (
        <motion.div
          key="overlay"
          className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-md"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
        >
          <motion.div
            key="card"
            layout
            initial={{ scale: 0.92, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0.95, opacity: 0 }}
            transition={{ type: "spring", stiffness: 180, damping: 20 }}
            className="relative w-[90%] max-w-md rounded-2xl border overflow-hidden shadow-2xl
                       bg-gradient-to-br from-white/95 via-white/90 to-[#f4f4ff]/90
                       dark:from-[#14132b]/98 dark:via-[#1c1a3a]/96 dark:to-[#1f1c46]/95
                       border-gray-200 dark:border-[#2a2749] backdrop-saturate-150 backdrop-blur-xl"
          >
            {/* ‚úñÔ∏è Close */}
            <button
              onClick={onClose}
              className="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors"
              aria-label="Close"
            >
              <X size={20} />
            </button>

            {/* üñºÔ∏è Image */}
            <div className="relative w-full h-56 bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)] overflow-hidden">
              {product.image_url ? (
                <Image
                  src={product.image_url}
                  alt={product.title}
                  fill
                  className="object-cover brightness-[1.05] contrast-[1.1]"
                />
              ) : (
                <div className="flex items-center justify-center h-full text-gray-400 dark:text-gray-500">
                  <ShoppingBag size={32} />
                </div>
              )}
            </div>

            {/* üßæ Details */}
            <div className="p-5 space-y-3 relative z-[1] text-gray-900 dark:text-gray-100">
              <div className="flex justify-between items-start">
                <div>
                  <h3 className="text-lg font-semibold">{product.title}</h3>
                  {product.category && (
                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                      {product.category}
                    </p>
                  )}
                </div>
                <p className="text-green-600 dark:text-green-400 font-semibold text-lg">
                  ‚Çπ{product.price.toLocaleString()}
                  {product.unit && (
                    <span className="text-xs text-gray-500 ml-1">
                      / {product.unit}
                    </span>
                  )}
                </p>
              </div>

              {product.description && (
                <p className="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                  {product.description}
                </p>
              )}

              {/* üßÆ Actions */}
              <div className="flex items-center justify-between mt-4">
                {/* Quantity Control */}
                <div className="flex items-center border border-green-500 rounded-full overflow-hidden bg-white/80 dark:bg-emerald-900/30 backdrop-blur-sm">
                  <button
                    onClick={() => setLocalQty((q) => Math.max(1, q - 1))}
                    className="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 transition"
                  >
                    <Minus size={14} />
                  </button>
                  <span className="px-3 text-sm font-medium">{localQty}</span>
                  <button
                    onClick={() => setLocalQty((q) => q + 1)}
                    className="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 transition"
                  >
                    <Plus size={14} />
                  </button>
                </div>

                {/* Add to Cart */}
                <motion.button
                  whileTap={{ scale: 0.95 }}
                  onClick={() => {
                    if (!resolveCartConflict("product")) return;
                    addItem({
                      id: product.id,
                      title: product.title,
                      price: product.price,
                      image_url: product.image_url,
                      quantity: localQty,
                      type: "product",
                      category: product.category,
                    });
                    navigator.vibrate?.(30);
                    onClose();
                  }}
                  className="flex items-center gap-2 bg-gradient-to-r from-emerald-600 to-lime-500 hover:from-emerald-700 hover:to-lime-600 text-white font-semibold px-4 py-2 rounded-xl shadow-md transition-colors"
                >
                  <ShoppingBag size={16} />
                  {inCart ? "Update Cart" : "Add to Cart"}
                </motion.button>
              </div>
            </div>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

--- components/store/cartGuards.ts ---
"use client";

import {
  useProductCartStore,
  useServiceCartStore,
} from "@/components/store/cartStore";

type CartRealm = "product" | "service";

export function checkCartConflict(target: CartRealm): string | null {
  const otherItems =
    target === "product"
      ? useServiceCartStore.getState().items.length
      : useProductCartStore.getState().items.length;

  if (otherItems === 0) return null;

  return target === "product"
    ? "You have service bookings pending checkout. Please finish or clear them before adding store items."
    : "You have products pending checkout. Please finish or clear them before booking a service.";
}

export function resolveCartConflict(target: CartRealm) {
  const conflict = checkCartConflict(target);
  if (conflict) {
    alert(conflict);
  }
  return !conflict;
}

--- components/store/cartStore.ts ---
"use client";
/**
 * ============================================================
 * Dual Cart Stores - Store vs Service (Zustand + persist)
 * ------------------------------------------------------------
 * ? useProductCartStore  -> materials / goods checkout
 * ? useServiceCartStore  -> service bookings (visit-fee model)
 * ? Identical APIs: addItem / increment / decrement / totals
 * ? Independent persistence + cross-tab sync
 * ============================================================
 */

import { create } from "zustand";
import { createJSONStorage, persist, StateStorage } from "zustand/middleware";

export type CartItemType = "product" | "service";

export interface CartItem {
  id: number;
  title: string;
  price: number;
  quantity: number;
  unit?: string;
  image_url?: string;
  slug?: string;
  category?: string;
  billing_type?: "sqft" | "job" | "unit";
  type?: CartItemType;
}

interface CartState {
  items: CartItem[];
  addItem: (item: Omit<CartItem, "type" | "quantity"> & {
    quantity?: number;
    type?: CartItemType;
  }) => void;
  increment: (id: number) => void;
  decrement: (id: number) => void;
  removeItem: (id: number) => void;
  clearCart: () => void;
  reset: () => void;
  totalItems: number;
  totalPrice: number;
  recalcTotals: () => void;
  getTotalItems: () => number;
  getTotalPrice: () => number;
}

const safeStorage: StateStorage = {
  getItem: (name: string): string | null => {
    if (typeof window === "undefined") return null;
    return localStorage.getItem(name);
  },
  setItem: (name: string, value: string): void => {
    if (typeof window === "undefined") return;
    localStorage.setItem(name, value);
  },
  removeItem: (name: string): void => {
    if (typeof window === "undefined") return;
    localStorage.removeItem(name);
  },
};

function createCartStore(storageKey: string, defaultType: CartItemType) {
  return create<CartState>()(
    persist(
      (set, get) => ({
        items: [],
        totalItems: 0,
        totalPrice: 0,

        addItem: (item) => {
          const id = Number(item.id);
          const existing = get().items.find((i) => i.id === id);
          const quantityToAdd = Math.max(item.quantity ?? 1, 1);
          const normalizedType = item.type || defaultType;

          const updated = existing
            ? get().items.map((i) =>
                i.id === id
                  ? { ...i, quantity: i.quantity + quantityToAdd }
                  : i
              )
            : [
                ...get().items,
                {
                  ...item,
                  id,
                  quantity: quantityToAdd,
                  type: normalizedType,
                },
              ];

          set({ items: updated });
          get().recalcTotals();
          navigator.vibrate?.(20);
        },

        increment: (id) => {
          const updated = get().items.map((i) =>
            i.id === id ? { ...i, quantity: i.quantity + 1 } : i
          );
          set({ items: updated });
          get().recalcTotals();
        },

        decrement: (id) => {
          const current = get().items.find((i) => i.id === id);
          if (!current) return;
          if (current.quantity <= 1) return get().removeItem(id);

          const updated = get().items.map((i) =>
            i.id === id ? { ...i, quantity: i.quantity - 1 } : i
          );
          set({ items: updated });
          get().recalcTotals();
        },

        removeItem: (id) => {
          const updated = get().items.filter((i) => i.id !== id);
          set({ items: updated });
          get().recalcTotals();
          navigator.vibrate?.(10);
        },

        clearCart: () => {
          set({ items: [], totalItems: 0, totalPrice: 0 });
          if (typeof window !== "undefined") {
            localStorage.removeItem(storageKey);
          }
        },

        reset: () => {
          if (typeof window !== "undefined") {
            localStorage.removeItem(storageKey);
          }
          set({ items: [], totalItems: 0, totalPrice: 0 });
        },

        recalcTotals: () => {
          const valid = get().items.filter((i) => i.quantity > 0);
          const totalItems = valid.reduce((sum, i) => sum + i.quantity, 0);
          const totalPrice = valid.reduce(
            (sum, i) => sum + i.price * i.quantity,
            0
          );
          set({ items: valid, totalItems, totalPrice });
        },

        getTotalItems: () => get().totalItems,
        getTotalPrice: () => get().totalPrice,
      }),
      {
        name: storageKey,
        version: 1,
        storage: createJSONStorage(() => safeStorage),
        skipHydration: false,
        onRehydrateStorage: () => (state) => {
          if (state) {
            requestAnimationFrame(() => {
              state.recalcTotals?.();
              console.log(
                `üõí [CartStore:${storageKey}] Rehydrated from storage`
              );
            });
          }
        },
      }
    )
  );
}

export const useProductCartStore = createCartStore(
  "homefix-store-cart",
  "product"
);
export const useServiceCartStore = createCartStore(
  "homefix-service-cart",
  "service"
);

function syncFromStorage(event: StorageEvent, storeKey: string) {
  if (event.key !== storeKey || !event.newValue) return;
  try {
    const payload = JSON.parse(event.newValue);
    if (!payload?.state) return;
    if (storeKey === "homefix-store-cart") {
      useProductCartStore.setState(payload.state);
    } else if (storeKey === "homefix-service-cart") {
      useServiceCartStore.setState(payload.state);
    }
  } catch (err) {
    console.warn("üõí [CartStore] Cross-tab sync failed:", err);
  }
}

if (typeof window !== "undefined") {
  window.addEventListener("storage", (e) =>
    ["homefix-store-cart", "homefix-service-cart"].forEach((key) =>
      syncFromStorage(e, key)
    )
  );
}

--- components/ui/Footer.tsx ---
"use client";

/**
 * Footer v4.0 ‚Äî HomeFix Gemini Glass Continuum üåå
 * ------------------------------------------------------------
 * ‚úÖ Theme-responsive (light/dark surfaces)
 * ‚úÖ Subtle glass blur & gradient tint
 * ‚úÖ Smooth color transitions
 * ‚úÖ Matches UniversalHeader & Sidebar styles
 */

export default function Footer() {
  return (
    <footer
      className="relative w-full py-8 text-center text-sm backdrop-blur-xl
                 border-t border-gray-200/30 dark:border-slate-700/50
                 bg-[color-mix(in srgb, var(--surface-light) 85%, #f5f0ff 15%)]
                 dark:bg-[color-mix(in srgb, var(--surface-dark) 85%, #1a1845 15%)]
                 text-[color-mix(in srgb, var(--text-primary-light) 90%, #2a2a66 10%)]
                 dark:text-[color-mix(in srgb, var(--text-primary-dark) 90%, #e0d6ff 10%)]
                 shadow-[0_-1px_8px_rgba(155,92,248,0.08)]
                 dark:shadow-[0_-1px_12px_rgba(155,92,248,0.18)]
                 transition-all duration-700 ease-out"
    >
      <div className="relative z-10 px-4">
        ¬© {new Date().getFullYear()}{" "}
        <span className="font-semibold text-transparent bg-clip-text edith-logo-gradient">
          HomeFix India
        </span>{" "}
        ¬∑ Built with ‚ù§Ô∏è in Chennai
      </div>

      {/* üåà Subtle Glow Bar (bottom aura) */}
      <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-[80%] h-[2px] rounded-full bg-gradient-to-r from-[var(--accent-primary)]/40 via-[var(--accent-secondary)]/40 to-[var(--accent-primary)]/40 blur-[2px] opacity-80" />
    </footer>
  );
}

--- components/ui/HomeFixLogo.tsx ---
"use client";

/**
 * HomeFixLogo v3.0 ‚Äî Static Gemini Core üíé
 * ----------------------------------------
 * ‚úÖ Sharp, gradient text (no blur)
 * ‚úÖ Used in UniversalHeader & branding exports
 */

import { motion } from "framer-motion";

export default function HomeFixLogo({
  size = "md",
}: {
  size?: "sm" | "md" | "lg";
}) {
  const fontSize = {
    sm: "text-xl",
    md: "text-2xl",
    lg: "text-4xl",
  }[size];

  return (
    <motion.span
      className={`relative inline-flex items-center ${fontSize} select-none`}
      initial={{ opacity: 0, y: -4 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.6, ease: "easeOut" }}
    >
      {/* Edith Aura behind the logo */}
      <span
        aria-hidden="true"
        className="absolute -inset-1 rounded-full blur-md opacity-45"
        style={{
          background:
            "linear-gradient(120deg, color-mix(in srgb, var(--accent-tertiary) 55%, transparent 45%), color-mix(in srgb, var(--accent-primary) 45%, transparent 55%), color-mix(in srgb, var(--accent-secondary) 35%, transparent 65%))",
        }}
      />

      {/* Gradient wordmark ‚Äî animated Edith aura */}
      <span
        className="relative font-extrabold tracking-tight bg-clip-text text-transparent edith-logo-gradient"
      >
        HomeFix
      </span>
    </motion.span>
  );
}

--- components/ui/LiveClimateBar.tsx ---
"use client";
/**
 * LiveClimateBar v1.0 ‚Äî HomeFix ‚ÄúEdith Climate Pulse‚Äù üå¶Ô∏è
 * -------------------------------------------------------
 * ‚úÖ Auto-fetches city + temperature
 * ‚úÖ Refreshes every 15 minutes
 * ‚úÖ Lightweight Open-Meteo + Reverse Geocoding
 * ‚úÖ Graceful fallback if GPS denied
 * ‚úÖ PWA-friendly and animated
 */

import { useCallback, useEffect, useState } from "react";
import { MapPin, Thermometer, CloudSun, Loader2 } from "lucide-react";
import { motion } from "framer-motion";

interface ClimateData {
  temp: number | null;
  city: string | null;
  condition: string | null;
}

export default function LiveClimateBar() {
  const [data, setData] = useState<ClimateData>({ temp: null, city: null, condition: null });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  /* üåç Fetch Weather + Location */
  const fetchWeather = useCallback(async (lat: number, lon: number) => {
    try {
      // Get weather from Open-Meteo
      const weatherRes = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
      );
      const weatherData = await weatherRes.json();

      // Reverse geocode
      const geoRes = await fetch(
        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
      );
      const geoData = await geoRes.json();

      setData({
        temp: weatherData?.current_weather?.temperature ?? null,
        city: geoData?.address?.suburb || geoData?.address?.city || geoData?.address?.town || "Your Area",
        condition: weatherData?.current_weather?.weathercode ? decodeWeather(weatherData.current_weather.weathercode) : null,
      });
      setLoading(false);
      setError(null);
    } catch (err) {
      console.error("üåßÔ∏è [ClimateBar] Fetch failed:", err);
      setError("Weather unavailable");
      setLoading(false);
    }
  }, []);

  /* ‚òÅÔ∏è Decode Open-Meteo codes */
  function decodeWeather(code: number): string {
    const map: Record<number, string> = {
      0: "Clear Sky",
      1: "Mainly Clear",
      2: "Partly Cloudy",
      3: "Overcast",
      45: "Foggy",
      48: "Icy Fog",
      51: "Light Drizzle",
      61: "Rainy",
      71: "Snow",
      95: "Thunderstorm",
    };
    return map[code] || "Cloudy";
  }

  /* üõ∞Ô∏è Get location */
  useEffect(() => {
    if (!navigator.geolocation) {
      setError("Location unavailable");
      setLoading(false);
      return;
    }

    const fetchLocation = () => {
      navigator.geolocation.getCurrentPosition(
        (pos) => fetchWeather(pos.coords.latitude, pos.coords.longitude),
        () => {
          setError("Location access denied");
          setLoading(false);
        }
      );
    };

    fetchLocation();
    const interval = setInterval(fetchLocation, 15 * 60 * 1000); // refresh every 15 min
    return () => clearInterval(interval);
  }, [fetchWeather]);

  /* üåà Render */
  return (
    <motion.div
      initial={{ opacity: 0, y: -8 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.6 }}
      className="w-full border-b border-[#9B5CF8]/30 bg-gradient-to-r 
        from-[#F8F7FF]/70 via-[#F2F0FF]/50 to-[#EAE8FF]/60 
        dark:from-[#0D0B2B]/60 dark:via-[#1B1545]/50 dark:to-[#241A55]/60
        backdrop-blur-xl shadow-sm py-2 px-4 flex items-center justify-between
        text-sm sm:text-base font-medium"
    >
      {/* Left: Location */}
      <div className="flex items-center gap-2 text-[#5A5DF0] dark:text-[#CBA0FF]">
        <MapPin className="w-4 h-4" />
        {loading ? (
          <span className="flex items-center gap-1 text-gray-500 dark:text-gray-400">
            <Loader2 className="animate-spin w-3 h-3" /> Locating...
          </span>
        ) : error ? (
          <span className="text-gray-400">{error}</span>
        ) : (
          <span>{data.city}</span>
        )}
      </div>

      {/* Right: Weather */}
      <div className="flex items-center gap-2 text-green-600 dark:text-green-400">
        {data.temp !== null ? (
          <>
            <Thermometer className="w-4 h-4" />
            <span>{data.temp}¬∞C</span>
            {data.condition && (
              <span className="hidden sm:inline text-xs text-gray-500 dark:text-gray-400">
                {data.condition}
              </span>
            )}
          </>
        ) : (
          <CloudSun className="w-4 h-4 text-gray-400" />
        )}
      </div>
    </motion.div>
  );
}

--- components/ui/SearchFAB.tsx ---
"use client";
import { motion } from "framer-motion";
import { Search } from "lucide-react";
import { usePathname } from "next/navigation";
import { useState } from "react";

export default function SearchFAB() {
  const pathname = usePathname();
  const [open, setOpen] = useState(false);
  if (pathname !== "/store") return null;

  return (
    <>
      <motion.button
        onClick={() => setOpen(true)}
        whileTap={{ scale: 0.9 }}
        className="fixed bottom-24 right-5 z-fab w-14 h-14 rounded-full
                   bg-gradient-to-r from-accent-mid to-accent-end text-white
                   shadow-gemini flex items-center justify-center"
      >
        <Search className="w-5 h-5" />
      </motion.button>

      {open && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="fixed inset-0 z-modal bg-black/40 backdrop-blur-sm flex items-start justify-center pt-28"
          onClick={() => setOpen(false)}
        >
          <motion.div
            onClick={(e: React.MouseEvent<HTMLDivElement>) =>
              e.stopPropagation()
            }
            className="w-11/12 sm:w-[420px] bg-white dark:bg-slate-900 rounded-2xl shadow-xl p-4"
          >
            <input
              autoFocus
              placeholder="Search hardware, doors, CNC panels..."
              className="w-full text-sm p-3 rounded-xl border border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-accent-mid"
            />
          </motion.div>
        </motion.div>
      )}
    </>
  );
}

--- components/ui/ServiceBookDrawer.tsx ---
"use client";
//components/ui/ServiceBookDrawer.tsx
import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { CalendarDays, Clock, X, ArrowRight } from "lucide-react";
import { format } from "date-fns";
import { useRouter } from "next/navigation";

/* -------------------------------------------------------------------------- */
/* üì¶ TYPE DEFINITIONS                                                        */
/* -------------------------------------------------------------------------- */
interface ServiceItem {
  id: number;
  title: string;
  description: string;
  price: number;
  unit: string;
  slug: string;
}

interface ServiceBookDrawerProps {
  service: ServiceItem | null;
  open: boolean;
  onClose: () => void;
}

/* -------------------------------------------------------------------------- */
/* üß± COMPONENT                                                               */
/* -------------------------------------------------------------------------- */
export default function ServiceBookDrawer({
  service,
  open,
  onClose,
}: ServiceBookDrawerProps) {
  const router = useRouter();
  const [date, setDate] = useState<string>("");
  const [slot, setSlot] = useState<string>("");

  const today = new Date();
  const slots = [
    "10:00 AM - 12:00 PM",
    "12:00 PM - 2:00 PM",
    "3:00 PM - 5:00 PM",
    "5:00 PM - 7:00 PM",
  ];

  useEffect(() => {
    if (!open) {
      setDate("");
      setSlot("");
    }
  }, [open]);

  if (!service) return null;

  return (
    <AnimatePresence>
      {open && (
        <motion.div
          initial={{ y: "100%" }}
          animate={{ y: 0 }}
          exit={{ y: "100%" }}
          transition={{ type: "spring", stiffness: 100, damping: 22 }}
          className="fixed bottom-0 left-0 right-0 z-[90] bg-white dark:bg-slate-900 
                     shadow-[0_-4px_30px_rgba(0,0,0,0.1)] rounded-t-3xl overflow-hidden"
        >
          {/* Header */}
          <div className="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700">
            <h3 className="text-lg font-semibold text-[#5A5DF0] dark:text-[#EC6ECF]">
              Book {service.title}
            </h3>
            <button onClick={onClose}>
              <X size={18} className="text-slate-600 dark:text-slate-300" />
            </button>
          </div>

          {/* Content */}
          <div className="p-5 space-y-5 max-h-[70vh] overflow-y-auto">
            {/* Price */}
            <div>
              <p className="text-sm text-slate-500">Service Price</p>
              <p className="text-2xl font-semibold text-[#5A5DF0] dark:text-[#EC6ECF]">
                ‚Çπ{service.price}
                <span className="text-sm text-slate-500 ml-1">
                  / {service.unit}
                </span>
              </p>
            </div>

            {/* Date Picker */}
            <div>
              <label className="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-300">
                <CalendarDays className="inline-block w-4 h-4 mr-1 text-[#5A5DF0]" />
                Choose a date
              </label>
              <input
                type="date"
                min={format(today, "yyyy-MM-dd")}
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full rounded-xl border border-slate-300 dark:border-slate-700 p-2 text-sm bg-white dark:bg-slate-800"
              />
            </div>

            {/* Time Slot Picker */}
            <div>
              <label className="block text-sm font-medium mb-1 text-slate-600 dark:text-slate-300">
                <Clock className="inline-block w-4 h-4 mr-1 text-[#5A5DF0]" />
                Choose a time slot
              </label>
              <div className="grid grid-cols-2 gap-2">
                {slots.map((s) => (
                  <button
                    key={s}
                    onClick={() => setSlot(s)}
                    className={`px-3 py-2 rounded-lg text-sm border transition-all ${
                      slot === s
                        ? "bg-gradient-to-r from-[#5A5DF0] to-[#EC6ECF] text-white border-transparent"
                        : "bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-600 dark:text-slate-300"
                    }`}
                  >
                    {s}
                  </button>
                ))}
              </div>
            </div>

            {/* Description */}
            <div>
              <p className="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                {service.description}
              </p>
            </div>
          </div>

          {/* Footer CTA */}
          <div className="p-4 border-t border-slate-200 dark:border-slate-700 bg-gradient-to-r from-[#F8F7FF] to-[#EAE8FF] dark:from-[#0D0B2B] dark:to-[#1B1545]">
            <button
              disabled={!date || !slot}
              onClick={() => {
                router.push(
                  `/checkout?service=${service.slug}&date=${encodeURIComponent(
                    date
                  )}&slot=${encodeURIComponent(slot)}`
                );
              }}
              className="w-full py-3 rounded-xl font-semibold text-white bg-gradient-to-r 
                         from-[#5A5DF0] to-[#EC6ECF] hover:opacity-90 disabled:opacity-50 
                         flex items-center justify-center gap-2 transition"
            >
              Proceed to Checkout <ArrowRight size={18} />
            </button>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

--- components/ui/ServiceCartDrawer.tsx ---
"use client";
/**
 * =============================================================
 * File: components/ui/ServiceCartDrawer.tsx
 * Module: üõí HomeFix Service Cart Drawer v3.5 (Aurora+)
 * -------------------------------------------------------------
 * ‚úÖ Integrated with Zustand cartStore (persistent cart)
 * ‚úÖ Safe geolocation + reverse lookup (OpenStreetMap)
 * ‚úÖ Animated feedback (added ‚úì confirmation)
 * ‚úÖ Includes ‚ÄúProceed to Checkout‚Äù shortcut post-add
 * ‚úÖ Compatible with both mobile & desktop drawers
 * =============================================================
 */

import { UniversalHeader } from "@/components/layout";
import { useServiceCartStore } from "@/components/store/cartStore";
import { resolveCartConflict } from "@/components/store/cartGuards";
import {
  Drawer,
  DrawerContent,
  DrawerFooter,
  DrawerHeader,
  DrawerTitle,
} from "@/components/ui/drawer";
import { AnimatePresence, motion } from "framer-motion";
import { CheckCircle2 } from "lucide-react";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";

/* ------------------------------------------------------------
   üì¶ Types
------------------------------------------------------------ */
interface Service {
  id: number;
  title: string;
  description?: string;
  price?: number;
  unit?: string;
  category?: string;
  image_url?: string;
  slug?: string;
}

interface ServiceCartDrawerProps {
  service: Service | null;
  open: boolean;
  onClose: (open: boolean) => void;
  onAdd: (service: Service) => void;
}

/* ------------------------------------------------------------
   üß± Component
------------------------------------------------------------ */
export default function ServiceCartDrawer({
  service,
  open,
  onClose,
  onAdd,
}: ServiceCartDrawerProps) {
  const router = useRouter();
  const { addItem } = useServiceCartStore();
  const [location, setLocation] = useState<string>("Fetching location‚Ä¶");
  const [added, setAdded] = useState(false);

  /* ------------------------------------------------------------
     üß≠ Auto-detect user‚Äôs city (OpenStreetMap)
  ------------------------------------------------------------ */
  useEffect(() => {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const { latitude, longitude } = pos.coords;
          try {
            const res = await fetch(
              `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
            );
            const data = await res.json();
            setLocation(data.address?.city || "Your Area");
          } catch {
            setLocation("Location unavailable");
          }
        },
        () => setLocation("Location access denied")
      );
    }
  }, []);

  if (!service) return null;

  /* ------------------------------------------------------------
     üõí Add item handler
  ------------------------------------------------------------ */
  const handleAddToCart = () => {
    if (!resolveCartConflict("service")) return;
    addItem({
      id: service.id,
      title: service.title,
      price: Number(service.price) || 0,
      unit: service.unit,
      image_url: service.image_url,
      slug: service.slug,
      quantity: 1,
    });
    onAdd(service);
    setAdded(true);
    setTimeout(() => setAdded(false), 2200);
  };

  /* ------------------------------------------------------------
     üß© Drawer Layout
  ------------------------------------------------------------ */
  return (
    <>
      <UniversalHeader />

      <Drawer open={open} onOpenChange={onClose}>
        <DrawerContent className="bg-white dark:bg-slate-900 rounded-t-3xl overflow-hidden shadow-xl">
          {/* Header */}
          <DrawerHeader className="flex flex-col gap-1">
            <div className="flex items-center justify-between">
              <DrawerTitle className="text-lg font-semibold text-[#5A5DF0] dark:text-[#EC6ECF]">
                {service.title}
              </DrawerTitle>
              <span className="text-xs text-slate-500 dark:text-slate-400">
                üìç {location}
              </span>
            </div>
            <p className="text-sm text-slate-500 dark:text-slate-400">
              {service.description ||
                "Professional service handled by verified HomeFix experts."}
            </p>
          </DrawerHeader>

          {/* Details */}
          <motion.div
            className="py-4 border-t border-slate-200 dark:border-slate-700 mt-2 px-4"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
          >
            <ul className="text-sm text-slate-600 dark:text-slate-300 space-y-1 mb-4">
              <li>‚úÖ Labor included</li>
              <li>‚ùå Materials not included</li>
              <li>üïê Avg duration: 1‚Äì2 hrs</li>
              <li>üë∑ Certified HomeFix Professionals</li>
            </ul>
            <p className="font-semibold text-slate-800 dark:text-white">
              ‚Çπ{service.price} / {service.unit || "unit"}
            </p>
          </motion.div>

          {/* Footer Buttons */}
          <DrawerFooter>
            <AnimatePresence>
              {!added ? (
                <motion.button
                  key="add"
                  onClick={handleAddToCart}
                  whileTap={{ scale: 0.96 }}
                  className="w-full bg-gradient-to-r from-[#5A5DF0] to-[#EC6ECF] 
                             text-white py-2 rounded-lg font-medium shadow hover:opacity-90 transition"
                >
                  Add to Cart
                </motion.button>
              ) : (
                <motion.div
                  key="added"
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: 10 }}
                  transition={{ duration: 0.3 }}
                  className="flex flex-col items-center justify-center space-y-2"
                >
                  <div className="flex items-center gap-2 text-green-600 font-semibold">
                    <CheckCircle2 className="w-5 h-5" /> Added to Cart
                  </div>
                  <button
                    onClick={() => router.push("/checkout?type=service")}
                    className="px-4 py-2 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 transition"
                  >
                    Proceed to Checkout
                  </button>
                </motion.div>
              )}
            </AnimatePresence>
          </DrawerFooter>
        </DrawerContent>
      </Drawer>
    </>
  );
}

--- components/ui/button-group-pro.tsx ---
"use client";
/**
 * ============================================================
 * üéõÔ∏è EdithButtonGroupPro ‚Äî v7.6
 * ------------------------------------------------------------
 * ‚úÖ Persistent selection (localStorage)
 * ‚úÖ Optional URL query sync
 * ‚úÖ Keyboard navigation (‚Üê ‚Üí or ‚Üë ‚Üì)
 * ‚úÖ Framer Motion highlight
 * ‚úÖ Light/Dark adaptive (Edith theme)
 * ============================================================
 */

import clsx from "clsx";
import { motion } from "framer-motion";
import { useRouter, useSearchParams } from "next/navigation";
import * as React from "react";
import { useCallback, useEffect, useRef, useState } from "react";

export interface ButtonGroupProProps {
  groupKey: string; // unique key for persistence (e.g., "ledger-filter")
  options: { id: string; label: string; icon?: React.ElementType }[];
  defaultId?: string;
  syncURL?: boolean;
  className?: string;
  orientation?: "horizontal" | "vertical";
  rounded?: boolean;
  onChange?: (id: string) => void;
}

/**
 * Example:
 *  <ButtonGroupPro
 *     groupKey="ledger-filter"
 *     options={[
 *        { id: "all", label: "All" },
 *        { id: "paid", label: "Paid", icon: CheckCircle2 },
 *        { id: "failed", label: "Failed", icon: XCircle },
 *     ]}
 *     defaultId="all"
 *     syncURL
 *     onChange={setFilter}
 *  />
 */
export function ButtonGroupPro({
  groupKey,
  options,
  defaultId = options[0]?.id,
  syncURL = false,
  onChange,
  className,
  orientation = "horizontal",
  rounded = true,
}: ButtonGroupProProps) {
  const isVertical = orientation === "vertical";
  const router = useRouter();
  const params = useSearchParams();
  const containerRef = useRef<HTMLDivElement>(null);

  // üß† Active ID
  const [activeId, setActiveId] = useState<string>(defaultId);

  /* ------------------------------------------------------------
     üß© Load persisted state or URL param
  ------------------------------------------------------------ */
  useEffect(() => {
    const stored = localStorage.getItem(`edith-group-${groupKey}`);
    const urlValue = syncURL ? params?.get(groupKey) ?? null : null;
    setActiveId(urlValue || stored || defaultId);
  }, [groupKey, defaultId, params, syncURL]);

  /* ------------------------------------------------------------
     üíæ Persist + Optional URL Sync
  ------------------------------------------------------------ */
  const handleChange = useCallback(
    (id: string) => {
      setActiveId(id);
      localStorage.setItem(`edith-group-${groupKey}`, id);
      if (syncURL) {
        const search = new URLSearchParams(
          params ? Array.from(params.entries()) : []
        );
        search.set(groupKey, id);
        router.replace(`?${search.toString()}`);
      }

      onChange?.(id);
    },
    [groupKey, syncURL, params, router, onChange]
  );

  /* ------------------------------------------------------------
     üéπ Keyboard Navigation (‚Üê ‚Üí or ‚Üë ‚Üì)
  ------------------------------------------------------------ */
  const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
    const idx = options.findIndex((o) => o.id === activeId);
    if (idx === -1) return;
    if (
      (isVertical && e.key === "ArrowDown") ||
      (!isVertical && e.key === "ArrowRight")
    ) {
      e.preventDefault();
      const next = options[(idx + 1) % options.length];
      handleChange(next.id);
    } else if (
      (isVertical && e.key === "ArrowUp") ||
      (!isVertical && e.key === "ArrowLeft")
    ) {
      e.preventDefault();
      const prev = options[(idx - 1 + options.length) % options.length];
      handleChange(prev.id);
    }
  };

  /* ------------------------------------------------------------
     üé® Render
  ------------------------------------------------------------ */
  return (
    <div
      ref={containerRef}
      tabIndex={0}
      onKeyDown={handleKeyDown}
      className={clsx(
        "relative inline-flex isolate overflow-hidden outline-none",
        isVertical ? "flex-col" : "flex-row",
        "border border-[var(--edith-border)] bg-[var(--edith-surface)] dark:bg-[var(--edith-surface)] shadow-sm",
        rounded && "rounded-xl",
        className
      )}
    >
      {options.map((opt) => {
        const isActive = activeId === opt.id;
        const Icon = opt.icon;

        return (
          <button
            key={opt.id}
            onClick={() => handleChange(opt.id)}
            className={clsx(
              "relative z-10 flex-1 px-4 py-2 text-sm font-medium transition-all duration-150",
              "flex items-center justify-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--edith-accent)]",
              isActive
                ? "text-[var(--edith-on-primary)]"
                : "text-[var(--edith-text)] hover:bg-[var(--edith-surface-hover)]"
            )}
          >
            {Icon && <Icon className="w-4 h-4" />}
            {opt.label}
          </button>
        );
      })}

      {/* ü™∂ Animated highlight */}
      <motion.div
        key={activeId}
        layoutId={`edith-highlight-${groupKey}`}
        className="absolute bg-[var(--edith-primary)] z-0 rounded-xl"
        style={{
          [isVertical ? "height" : "width"]: `${100 / options.length}%`,
          [isVertical ? "top" : "left"]: `${
            options.findIndex((o) => o.id === activeId) * (100 / options.length)
          }%`,
          [isVertical ? "width" : "height"]: "100%",
        }}
        transition={{ type: "spring", stiffness: 260, damping: 30 }}
      />
    </div>
  );
}

export default ButtonGroupPro;

--- components/ui/button-group.tsx ---
"use client";
/**
 * ============================================================
 * üéõÔ∏è EdithButtonGroup ‚Äî v7.5 (Toggle-Enabled)
 * ------------------------------------------------------------
 * ‚úÖ Horizontal/Vertical group
 * ‚úÖ Segmented toggle with Framer Motion highlight
 * ‚úÖ Light/Dark adaptive
 * ‚úÖ Works with <Button> seamlessly
 * ============================================================
 */

import clsx from "clsx";
import { motion } from "framer-motion";
import * as React from "react";

export interface ButtonGroupProps {
  options: { id: string; label: string; icon?: React.ElementType }[];
  activeId?: string;
  onChange?: (id: string) => void;
  className?: string;
  orientation?: "horizontal" | "vertical";
  rounded?: boolean;
}

/**
 * Usage Example:
 * <ButtonGroup
 *    options={[
 *      { id: "all", label: "All" },
 *      { id: "paid", label: "Paid" },
 *      { id: "failed", label: "Failed" },
 *    ]}
 *    activeId={filter}
 *    onChange={setFilter}
 * />
 */
export function ButtonGroup({
  options,
  activeId,
  onChange,
  className,
  orientation = "horizontal",
  rounded = true,
}: ButtonGroupProps) {
  const isVertical = orientation === "vertical";

  return (
    <div
      className={clsx(
        "relative inline-flex isolate overflow-hidden",
        isVertical ? "flex-col" : "flex-row",
        "border border-[var(--edith-border)] bg-[var(--edith-surface)] dark:bg-[var(--edith-surface)] shadow-sm",
        rounded && "rounded-xl",
        className
      )}
    >
      {options.map((opt) => {
        const isActive = activeId === opt.id;
        const Icon = opt.icon;

        return (
          <button
            key={opt.id}
            onClick={() => onChange?.(opt.id)}
            className={clsx(
              "relative z-10 flex-1 px-4 py-2 text-sm font-medium transition-all duration-150",
              "flex items-center justify-center gap-2",
              "focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--edith-accent)]",
              isActive
                ? "text-[var(--edith-on-primary)]"
                : "text-[var(--edith-text)] hover:bg-[var(--edith-surface-hover)]"
            )}
          >
            {Icon && <Icon className="w-4 h-4" />}
            {opt.label}
          </button>
        );
      })}

      {/* ü™∂ Animated highlight background */}
      <motion.div
        key={activeId}
        layoutId="edith-button-group-highlight"
        className={clsx(
          "absolute bg-[var(--edith-primary)] inset-0 z-0",
          isVertical
            ? "top-[calc(var(--index)*100%)] left-0 w-full h-[33%]"
            : "top-0 left-[calc(var(--index)*100%)] h-full",
          "rounded-xl"
        )}
        style={{
          // Calculate highlight position dynamically
          [isVertical ? "height" : "width"]: `${100 / options.length}%`,
          [isVertical ? "top" : "left"]: `${
            options.findIndex((o) => o.id === activeId) * (100 / options.length)
          }%`,
        }}
        transition={{ type: "spring", stiffness: 250, damping: 30 }}
      />
    </div>
  );
}

export default ButtonGroup;

--- components/ui/button.tsx ---
"use client";
/**
 * ============================================================
 * üé® EdithButton ‚Äî HomeFix UI Core v7.4
 * ------------------------------------------------------------
 * ‚úÖ Type-safe (React + Framer Motion)
 * ‚úÖ Light & Dark adaptive theme
 * ‚úÖ Edith glow + depth transitions
 * ‚úÖ Icon / loading support
 * ============================================================
 */

import clsx from "clsx";
import { motion, type HTMLMotionProps } from "framer-motion";
import { Loader2 } from "lucide-react";
import * as React from "react";

/* ------------------------------------------------------------
   üîß Types
------------------------------------------------------------ */
type MergedButtonProps = HTMLMotionProps<"button"> &
  React.ButtonHTMLAttributes<HTMLButtonElement> & {
    icon?: React.ElementType;
    isLoading?: boolean;
    variant?:
      | "primary"
      | "secondary"
      | "outline"
      | "ghost"
      | "danger"
      | "destructive";
    size?: "sm" | "md" | "lg" | "icon";
    children?: React.ReactNode;
  };

/* ------------------------------------------------------------
   üé® Edith Button
------------------------------------------------------------ */
export const Button = React.forwardRef<HTMLButtonElement, MergedButtonProps>(
  (
    {
      children,
      onClick,
      variant = "primary",
      size = "md",
      disabled = false,
      isLoading = false,
      icon: Icon,
      className = "",
      type = "button",
      ...props
    },
    ref
  ) => {
    /* ------------------------------------------------------------
       üåó Theme Styles (Edith-aware)
       Uses custom CSS variables:
       --edith-primary, --edith-surface, --edith-text
       These can be defined in globals.css or Tailwind config.
    ------------------------------------------------------------ */

    const baseStyles = clsx(
      "inline-flex items-center justify-center font-medium rounded-2xl select-none relative",
      "focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--edith-accent)] focus-visible:ring-offset-2",
      "transition-all duration-200 active:scale-[0.98]",
      disabled && "opacity-60 cursor-not-allowed"
    );

    const variants: Record<string, string> = {
      primary:
        "bg-[var(--edith-primary)] text-[var(--edith-on-primary)] shadow-[0_2px_10px_rgba(90,93,240,0.35)] hover:shadow-[0_3px_14px_rgba(90,93,240,0.45)] dark:shadow-[0_2px_10px_rgba(236,110,207,0.3)] hover:dark:shadow-[0_3px_14px_rgba(236,110,207,0.45)]",
      secondary:
        "bg-[var(--edith-surface)] text-[var(--edith-text)] border border-[var(--edith-border)] hover:bg-[var(--edith-surface-hover)]",
      outline:
        "border border-[var(--edith-border)] text-[var(--edith-text)] hover:bg-[var(--edith-surface-hover)] dark:hover:bg-[var(--edith-surface-dark-hover)]",
      ghost:
        "bg-transparent text-[var(--edith-text)] hover:bg-[var(--edith-surface-hover)] dark:hover:bg-[var(--edith-surface-dark-hover)]",
      danger:
        "bg-red-600 text-white hover:bg-red-700 shadow-[0_2px_8px_rgba(220,38,38,0.35)]",
      destructive:
        "bg-gradient-to-r from-red-500 to-rose-600 text-white hover:from-red-600 hover:to-rose-700 shadow-[0_2px_8px_rgba(220,38,38,0.35)]",
    };

    const sizes: Record<string, string> = {
      sm: "px-3 py-1.5 text-sm",
      md: "px-4 py-2 text-base",
      lg: "px-6 py-3 text-lg",
      icon: "p-2 w-10 h-10 justify-center",
    };

    const showIcon = isLoading || Icon;

    return (
      <motion.button
        ref={ref}
        type={type}
        whileTap={{ scale: disabled ? 1 : 0.96 }}
        whileHover={{
          scale: disabled ? 1 : 1.02,
          y: disabled ? 0 : -1,
          boxShadow: disabled ? undefined : "0 6px 12px rgba(90,93,240,0.25)",
        }}
        disabled={disabled || isLoading}
        onClick={onClick}
        className={clsx(
          baseStyles,
          variants[variant],
          sizes[size],
          "transition-shadow ease-out",
          className
        )}
        {...props}
      >
        {/* Left Icon / Loader */}
        {showIcon && (
          <span
            className={clsx(
              "inline-flex items-center justify-center",
              children ? "mr-2" : ""
            )}
          >
            {isLoading ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              Icon && <Icon className="w-4 h-4" />
            )}
          </span>
        )}

        {/* Label */}
        {children && <span className="whitespace-nowrap">{children}</span>}
      </motion.button>
    );
  }
);

Button.displayName = "Button";

export default Button;

--- components/ui/card.tsx ---
import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn(
        "rounded-xl border border-[var(--border-soft)] bg-[var(--surface-card)] dark:bg-[var(--surface-card-dark)] text-[var(--text-primary)] dark:text-[var(--text-primary-dark)] shadow",
        className
      )}
      {...props}
    />
  )
)
Card.displayName = "Card"

const CardHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
)
CardHeader.displayName = "CardHeader"

const CardTitle = ({ className, ...props }: React.HTMLAttributes<HTMLHeadingElement>) => (
  <h3 className={cn("text-lg font-semibold leading-none tracking-tight", className)} {...props} />
)
CardTitle.displayName = "CardTitle"

const CardContent = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn("p-6 pt-0", className)} {...props} />
)
CardContent.displayName = "CardContent"

export { Card, CardHeader, CardTitle, CardContent }

--- components/ui/drawer.tsx ---
"use client";

import * as React from "react";
import * as DrawerPrimitive from "@radix-ui/react-dialog";
import { cn } from "@/lib/utils";

export const Drawer = DrawerPrimitive.Root;
export const DrawerTrigger = DrawerPrimitive.Trigger;
export const DrawerClose = DrawerPrimitive.Close;

export function DrawerContent({
  className,
  children,
  ...props
}: React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>) {
  return (
    <DrawerPrimitive.Portal>
      <DrawerPrimitive.Overlay className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[80]" />
      <DrawerPrimitive.Content
        {...props}
        className={cn(
          "fixed bottom-0 left-0 right-0 z-[90] rounded-t-3xl bg-white dark:bg-slate-900 shadow-lg border-t border-slate-200 dark:border-slate-800",
          className
        )}
      >
        {children}
      </DrawerPrimitive.Content>
    </DrawerPrimitive.Portal>
  );
}

export const DrawerHeader = ({
  className,
  children,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "px-4 py-3 border-b border-slate-200 dark:border-slate-800",
      className
    )}
    {...props}
  >
    {children}
  </div>
);

export const DrawerFooter = ({
  className,
  children,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "px-4 py-3 border-t border-slate-200 dark:border-slate-800",
      className
    )}
    {...props}
  >
    {children}
  </div>
);

export const DrawerTitle = DrawerPrimitive.Title;
export const DrawerDescription = DrawerPrimitive.Description;

--- components/ui/edith-tabs.tsx ---
"use client";
/**
 * ============================================================
 * üß≠ EdithTabs ‚Äî v7.7 (Built on ButtonGroupPro)
 * ------------------------------------------------------------
 * ‚úÖ Smart tab system for Next.js App Router
 * ‚úÖ Uses ButtonGroupPro for top bar
 * ‚úÖ Persists active tab (localStorage + URL)
 * ‚úÖ Motion fade between tab panels
 * ‚úÖ Light/Dark adaptive (Edith theme)
 * ============================================================
 */

import { ButtonGroupPro } from "@/components/ui/button-group-pro";
import clsx from "clsx";
import { AnimatePresence, motion } from "framer-motion";
import * as React from "react";

export interface EdithTabsProps {
  groupKey: string;
  tabs: {
    id: string;
    label: string;
    icon?: React.ElementType;
    content: React.ReactNode;
  }[];
  defaultId?: string;
  syncURL?: boolean;
  className?: string;
  rounded?: boolean;
  fullWidth?: boolean;
}

/**
 * Usage:
 *  <EdithTabs
 *    groupKey="admin-panel"
 *    tabs={[
 *      { id: "orders", label: "Orders", icon: Package2, content: <OrdersTab /> },
 *      { id: "ledger", label: "Ledger", icon: Receipt, content: <LedgerTab /> },
 *      { id: "users", label: "Users", icon: Users, content: <UsersTab /> },
 *    ]}
 *  />
 */
export function EdithTabs({
  groupKey,
  tabs,
  defaultId = tabs[0]?.id,
  syncURL = true,
  className,
  rounded = true,
  fullWidth = true,
}: EdithTabsProps) {
  const [activeId, setActiveId] = React.useState(defaultId);

  const activeTab = tabs.find((t) => t.id === activeId) || tabs[0];

  return (
    <div
      className={clsx(
        "flex flex-col w-full",
        "bg-[var(--edith-surface)] dark:bg-[var(--edith-surface)] rounded-2xl border border-[var(--edith-border)] shadow-sm",
        className
      )}
    >
      {/* üåó Tab Header */}
      <div
        className={clsx(
          "p-3 border-b border-[var(--edith-border)] flex justify-center",
          fullWidth ? "w-full" : "w-auto mx-auto"
        )}
      >
        <ButtonGroupPro
          groupKey={groupKey}
          options={tabs.map((t) => ({
            id: t.id,
            label: t.label,
            icon: t.icon,
          }))}
          defaultId={defaultId}
          onChange={setActiveId}
          syncURL={syncURL}
          rounded={rounded}
        />
      </div>

      {/* ü™∂ Animated Content */}
      <div className="relative flex-1 min-h-[200px] p-4 sm:p-6">
        <AnimatePresence mode="wait">
          <motion.div
            key={activeId}
            initial={{ opacity: 0, y: 8 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -8 }}
            transition={{ duration: 0.25, ease: "easeOut" }}
            className="relative"
          >
            {activeTab?.content || (
              <p className="text-center text-[var(--text-secondary)]">
                No content for this tab.
              </p>
            )}
          </motion.div>
        </AnimatePresence>
      </div>
    </div>
  );
}

export default EdithTabs;

--- components/ui/label.tsx ---
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cn } from "@/lib/utils";

export interface LabelProps
  extends React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> {}

export const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  LabelProps
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(
      "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",
      className
    )}
    {...props}
  />
));
Label.displayName = "Label";

--- components/ui/switch.tsx ---
"use client";

import * as React from "react";
import * as SwitchPrimitives from "@radix-ui/react-switch";
import { cn } from "@/lib/utils";

export interface SwitchProps
  extends React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root> {}

export const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  SwitchProps
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    ref={ref}
    className={cn(
      "peer inline-flex h-[20px] w-[36px] shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-green-600 data-[state=unchecked]:bg-gray-300",
      className
    )}
    {...props}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-white shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
));
Switch.displayName = "Switch";

--- components/ui/toaster.tsx ---
"use client";
/**
 * components/ui/toaster.tsx
 * ------------------------------------------------------------
 * Renders Edith toast stack with support for success/destructive/default
 */

import { Toaster } from "sonner";

export function EdithToaster() {
  return <Toaster position="top-center" richColors closeButton />;
}

--- hooks/use-toast.tsx ---
"use client";
/**
 * ============================================================
 * ü™∂ FILE: /hooks/use-toast.tsx
 * VERSION: v5.0 ‚Äî Edith SafeViewport Toast Engine üåó
 * ------------------------------------------------------------
 * ‚úÖ Always within header/navbar safe region
 * ‚úÖ Auto theme-adaptive (dark/light)
 * ‚úÖ Dynamic top offset = var(--header-h)
 * ‚úÖ Dynamic bottom guard = var(--mbnav-h)
 * ‚úÖ Smooth fade/slide animation
 * ============================================================
 */

import { useCallback, useEffect, useRef } from "react";
import { toast as sonner, Toaster } from "sonner";

export function ToastProvider() {
  // üîÑ Keep top offset synced with CSS vars
  useEffect(() => {
    const updateOffset = () => {
      const headerH =
        parseFloat(
          getComputedStyle(document.documentElement).getPropertyValue(
            "--header-h"
          )
        ) || 64;
      const topOffset = headerH + 12; // little breathing room
      document.documentElement.style.setProperty(
        "--toast-safe-top",
        `${topOffset}px`
      );
    };
    updateOffset();
    window.addEventListener("resize", updateOffset);
    return () => window.removeEventListener("resize", updateOffset);
  }, []);

  return (
    <Toaster
      position="top-center"
      offset="var(--toast-safe-top, 76px)"
      toastOptions={{
        style: {
          borderRadius: "12px",
          padding: "14px 18px",
          fontSize: "0.95rem",
          fontWeight: 500,
          zIndex: 90, // stays below header z[70]+10 safety margin
          transition: "all 0.3s ease",
          margin: "6px 0",
          maxWidth: "min(92vw, 400px)",
        },
        className:
          "shadow-xl backdrop-blur-xl bg-white/80 dark:bg-zinc-900/80 text-zinc-900 dark:text-zinc-100 border border-black/5 dark:border-white/5",
      }}
      closeButton
      richColors
      expand
      duration={2600}
      visibleToasts={3}
    />
  );
}

export function useToast() {
  const lastToastRef = useRef<string | null>(null);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const showToast = useCallback(
    (message: string, type: "success" | "error" | "info" = "info") => {
      if (!message) return;
      if (lastToastRef.current === message) return;

      lastToastRef.current = message;
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      timeoutRef.current = setTimeout(
        () => (lastToastRef.current = null),
        2000
      );

      const theme = document.documentElement.classList.contains("dark")
        ? "dark"
        : "light";

      const baseStyle = {
        background:
          theme === "dark" ? "rgba(24,24,27,0.9)" : "rgba(255,255,255,0.95)",
        color: theme === "dark" ? "#fafafa" : "#111827",
        border:
          theme === "dark"
            ? "1px solid rgba(255,255,255,0.08)"
            : "1px solid rgba(0,0,0,0.08)",
        backdropFilter: "blur(8px)",
      };

      switch (type) {
        case "success":
          sonner.success(message, { style: baseStyle });
          break;
        case "error":
          sonner.error(message, { style: baseStyle });
          break;
        default:
          sonner(message, { style: baseStyle });
      }
    },
    []
  );

  return {
    success: (msg: string) => showToast(msg, "success"),
    error: (msg: string) => showToast(msg, "error"),
    info: (msg: string) => showToast(msg, "info"),
  };
}

--- hooks/useCheckoutFlow.ts ---
import { useLedgerX } from "@/components/ledgerx/useLedgerX";
import { useProductCartStore } from "@/components/store/cartStore";
import { useUser } from "@/contexts/UserContext";
import { useEffect, useMemo, useState } from "react";

export function useCheckoutFlow() {
  const { user, isLoaded } = useUser();
  const { items, totalPrice, clearCart } = useProductCartStore();
  const { addEntry } = useLedgerX();

  const [state, setState] = useState({
    ready: false,
    loading: false,
    msg: "",
    msgType: "info" as "info" | "success" | "error",
  });

  useEffect(() => {
    if (isLoaded) setState((s) => ({ ...s, ready: true }));
  }, [isLoaded]);

  const hasProducts = items.some((i) => i.type === "product");
  const hasServices = items.some((i) => i.type === "service");
  const total = hasServices && !hasProducts ? 0 : totalPrice;

  const canSubmit = useMemo(() => {
    // simple example
    return !!items.length;
  }, [items.length]);

  async function handleCheckout(payload: any) {
    if (!user?.id) {
      setState({ ...state, msg: "‚ùå Please log in first.", msgType: "error" });
      return;
    }
    const entry = await addEntry(user.id, "checkout-confirm", payload);
    console.log("LedgerX entry:", entry);
    // ‚Ä¶ do payment flow
  }

  return {
    user,
    items,
    total,
    hasProducts,
    hasServices,
    canSubmit,
    handleCheckout,
    state,
    setState,
    clearCart,
  };
}

--- hooks/useDrawerSafeStyle.ts ---
"use client";
/**
 * useDrawerSafeStyle v2.5 ‚Äî Keyboard-Aware + Debug Overlay üåø
 * -----------------------------------------------------------
 * ‚úÖ Drawer-safe across iOS PWAs, Android Chrome, Desktop
 * ‚úÖ Auto-adjusts height when keyboard opens/closes
 * ‚úÖ Detects nav + safe insets + keyboard height
 * ‚úÖ Alt+Shift+D (desktop) or long-press top (mobile) toggles live overlay
 * ‚úÖ Smooth transitions + console metrics
 *
 * Author: Edith ü™∂ for Jagadish (HomeFix India)
 */

import { useEffect, useState } from "react";

export function useDrawerSafeStyle(extraOffset: number = 0) {
  const [style, setStyle] = useState<React.CSSProperties>(() => ({
    height: "auto",
    maxHeight: "calc(100dvh - 72px)",
    paddingBottom:
      "calc(var(--mbnav-h-safe, 72px) + env(safe-area-inset-bottom, 0px))",
  }));

  const [keyboardHeight, setKeyboardHeight] = useState(0);
  const [debug, setDebug] = useState(false);
  const [metrics, setMetrics] = useState({
    visual: 0,
    inner: 0,
    nav: "72px",
    safe: "0px",
    keyboard: 0,
  });

  /* -----------------------------------------------------------
     üß≠ Dynamic viewport / keyboard tracking
  ----------------------------------------------------------- */
  useEffect(() => {
    let prevViewport = window.visualViewport?.height ?? window.innerHeight;

    const update = () => {
      const root = document.documentElement;
      const computed = getComputedStyle(root);

      const safe = computed.getPropertyValue("--safe-bottom")?.trim() ||
        "env(safe-area-inset-bottom, 0px)";
      const nav = computed.getPropertyValue("--mbnav-h-safe")?.trim() || "72px";

      const visual = window.visualViewport?.height ?? window.innerHeight;
      const inner = window.innerHeight;

      // detect keyboard height
      const kb = Math.max(0, inner - visual);
      if (Math.abs(kb - keyboardHeight) > 10) {
        setKeyboardHeight(kb);
        if (kb > 0) navigator.vibrate?.(10);
      }

      setMetrics({ visual, inner, nav, safe, keyboard: kb });

      setStyle({
        height: "auto",
        maxHeight: `calc(${visual}px - ${nav})`,
        paddingBottom: `calc(${nav} + ${safe} + ${extraOffset}px)`,
        transition: "max-height 0.25s ease, padding-bottom 0.25s ease",
        WebkitOverflowScrolling: "touch",
        overscrollBehavior: "contain",
      });

      prevViewport = visual;
    };

    update();
    window.addEventListener("resize", update);
    window.addEventListener("orientationchange", update);
    window.visualViewport?.addEventListener("resize", update);

    const toggle = (e: KeyboardEvent) => {
      if (e.altKey && e.shiftKey && e.key.toLowerCase() === "d") {
        setDebug((v) => !v);
      }
    };
    window.addEventListener("keydown", toggle);

    return () => {
      window.removeEventListener("resize", update);
      window.removeEventListener("orientationchange", update);
      window.visualViewport?.removeEventListener("resize", update);
      window.removeEventListener("keydown", toggle);
    };
  }, [extraOffset, keyboardHeight]);

  /* -----------------------------------------------------------
     üß© Floating overlay (optional)
  ----------------------------------------------------------- */
  useEffect(() => {
    const id = "drawer-safe-debug";
    const existing = document.getElementById(id);
    if (existing) existing.remove();

    if (!debug) return;

    const el = document.createElement("div");
    el.id = id;
    Object.assign(el.style, {
      position: "fixed",
      bottom: "110px",
      right: "12px",
      background: "rgba(16,185,129,0.9)",
      color: "#fff",
      fontSize: "12px",
      fontFamily: "monospace",
      padding: "6px 10px",
      borderRadius: "8px",
      boxShadow: "0 4px 12px rgba(0,0,0,0.25)",
      zIndex: 99999,
      whiteSpace: "pre",
    });
    el.textContent = `Viewport: ${
      metrics.visual.toFixed(
        0,
      )
    }\nKeyboard: ${
      metrics.keyboard.toFixed(0)
    }\nNav: ${metrics.nav}\nSafe: ${metrics.safe}`;
    document.body.appendChild(el);

    return () => el.remove();
  }, [debug, metrics]);

  return style;
}

--- hooks/useGoogleMapsLoader.ts ---
// components/ledgerx/useGoogleMapsLoader.ts
import { useEffect, useState } from "react";

/**
 * Ensures the Google Maps JS API script is loaded exactly once
 * using a global callback to manage the loading state.
 */
export function useGoogleMapsLoader() {
  const [mapsLoaded, setMapsLoaded] = useState(false);

  useEffect(() => {
    if (typeof window === "undefined") return;

    const g = (window as any).google;

    // 1. Exit if the script has already been loaded
    if (g?.maps) {
      setMapsLoaded(true);
      return;
    }

    // 2. Define a global callback function (will be called by Google Maps script when loaded)
    const callbackName = "__googleMapsApiLoaded";
    (window as any)[callbackName] = () => {
      setMapsLoaded(true);
    };

    const script = document.createElement("script");

    // Append the 'callback' parameter to notify us when loading is complete
    const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=${callbackName}`;

    script.async = true;
    script.defer = true;
    script.onerror = () => console.error("Google Maps script failed to load.");

    // 3. Add script only if it doesn't exist yet (prevents Fast Refresh duplication)
    if (!document.querySelector(`script[src*="maps.googleapis.com"]`)) {
      document.head.appendChild(script);
    }

    // 4. Cleanup function
    return () => {
      delete (window as any)[callbackName];
    };
  }, []); // Dependencies are empty, as intended for a script loader

  return mapsLoaded;
}

--- hooks/useMapPicker.ts ---
"use client";
// hooks/useMapPicker.ts

import {
  MutableRefObject,
  useCallback,
  useEffect,
  useRef,
  useState,
} from "react";

interface GmpxPlaceAutocompleteElement extends HTMLElement {
  getPlace?: () => any;
}

export interface Coordinates {
  lat: number;
  lng: number;
}

export interface UseMapPickerOptions {
  initialLocation?: Coordinates;
  editable?: boolean;
  onLocationChange?: (
    loc: Coordinates | null,
    address: string,
    confirmed?: boolean
  ) => void;
  autocompleteElRef?: MutableRefObject<any>;
}

export function useMapPicker({
  initialLocation = { lat: 13.0827, lng: 80.2707 },
  editable = true,
  onLocationChange,
  autocompleteElRef,
}: UseMapPickerOptions) {
  const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;

  const mapRootRef = useRef<HTMLDivElement | null>(null);
  const mapRef = useRef<google.maps.Map | null>(null);
  const markerRef = useRef<google.maps.Marker | null>(null);

  const [mapsLoaded, setMapsLoaded] = useState(false);
  const [autocompleteReady, setAutocompleteReady] = useState(false);
  const [address, setAddress] = useState("");
  const [satellite, setSatellite] = useState(false);
  const [locating, setLocating] = useState(false);

  const autocompleteErrorLoggedRef = useRef(false);

  /* ------------------------------------------------------------------ */
  /*  LOAD GOOGLE MAPS SCRIPT                                           */
  /* ------------------------------------------------------------------ */

  useEffect(() => {
    if (typeof window === "undefined" || !apiKey) return;

    const w = window as any;
    if (w.google?.maps) {
      setMapsLoaded(true);
      return;
    }

    // Avoid injecting multiple scripts
    if (w.__homefixGoogleMapsPromise) {
      (w.__homefixGoogleMapsPromise as Promise<void>).then(() =>
        setMapsLoaded(true)
      );
      return;
    }

    w.__homefixGoogleMapsPromise = new Promise<void>((resolve) => {
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
      script.async = true;
      script.defer = true;

      script.onload = () => {
        setMapsLoaded(true);
        resolve();
      };

      script.onerror = () => {
        console.error("[MapPicker] Google Maps script failed to load.");
        resolve();
      };

      document.head.appendChild(script);
    });
  }, [apiKey]);

  /* ------------------------------------------------------------------ */
  /*  SAFE REVERSE GEOCODE                                              */
  /* ------------------------------------------------------------------ */

  const safeReverseGeocode = useCallback(async (coords: Coordinates) => {
    try {
      const g = (window as any).google;
      if (!g?.maps) return "";

      const geocoder = new g.maps.Geocoder();

      return await new Promise<string>((resolve) => {
        geocoder.geocode({ location: coords }, (res: any, status: any) => {
          if (status === "OK" && res?.[0]) resolve(res[0].formatted_address);
          else resolve("");
        });
      });
    } catch (e) {
      console.error("[MapPicker] Reverse geocode failed:", e);
      return "";
    }
  }, []);

  /* ------------------------------------------------------------------ */
  /*  LOAD PLACE AUTOCOMPLETE WEB COMPONENT                             */
  /* ------------------------------------------------------------------ */

  const loadWebComponent = useCallback(async (): Promise<boolean> => {
    if (typeof window === "undefined") return false;

    const w = window as any;

    if (w.customElements?.get("gmpx-place-autocomplete")) return true;

    if (w.__gmpxPlaceAutocompletePromise) {
      return w.__gmpxPlaceAutocompletePromise as Promise<boolean>;
    }

    w.__gmpxPlaceAutocompletePromise = new Promise<boolean>((resolve) => {
      const candidates = [
        "https://maps.gstatic.com/maps-api-v3/api/js/WebComponent/latest/PlaceAutocompleteElement.js",
        "https://maps.gstatic.com/maps-api-v3/api/js/WebComponent/PlaceAutocompleteElement.js",
      ];

      const tryNext = (index: number) => {
        if (index >= candidates.length) {
          resolve(false);
          return;
        }

        const script = document.createElement("script");
        script.type = "module";
        script.src = candidates[index];

        script.onload = () => {
          const ok = !!w.customElements?.get("gmpx-place-autocomplete");
          if (ok) resolve(true);
          else tryNext(index + 1);
        };

        script.onerror = () => {
          tryNext(index + 1);
        };

        document.head.appendChild(script);
      };

      tryNext(0);
    });

    return w.__gmpxPlaceAutocompletePromise as Promise<boolean>;
  }, []);

  /* ------------------------------------------------------------------ */
  /*  INIT MAP + MARKER                                                 */
  /* ------------------------------------------------------------------ */

  useEffect(() => {
    if (!mapsLoaded || !mapRootRef.current) return;

    let idleListener: google.maps.MapsEventListener | null = null;
    let dragListener: google.maps.MapsEventListener | null = null;

    (async () => {
      const g = (window as any).google;
      if (!g?.maps) return;

      const map = new g.maps.Map(mapRootRef.current!, {
        center: initialLocation,
        zoom: 16,
        disableDefaultUI: true,
        gestureHandling: editable ? "greedy" : "none",
        mapTypeId: satellite
          ? g.maps.MapTypeId.SATELLITE
          : g.maps.MapTypeId.ROADMAP,
      });

      mapRef.current = map;

      const marker = new g.maps.Marker({
        position: initialLocation,
        map,
        draggable: editable,
      });

      markerRef.current = marker;

      // Initial address
      const initAddr = await safeReverseGeocode(initialLocation);
      setAddress(initAddr);
      onLocationChange?.(initialLocation, initAddr, false);

      // When map stops moving
      idleListener = map.addListener("idle", async () => {
        const c = map.getCenter();
        if (!c) return;

        const loc = { lat: c.lat(), lng: c.lng() };
        marker.setPosition(c);

        const addr = await safeReverseGeocode(loc);
        setAddress(addr);
        onLocationChange?.(loc, addr, false);
      });

      // Marker drag
      if (editable) {
        dragListener = marker.addListener("dragend", async () => {
          const p = marker.getPosition();
          if (!p) return;

          const loc = { lat: p.lat(), lng: p.lng() };
          map.panTo(p);

          const addr = await safeReverseGeocode(loc);
          setAddress(addr);
          onLocationChange?.(loc, addr, false);
        });
      }
    })();

    return () => {
      idleListener?.remove();
      dragListener?.remove();
    };
  }, [
    mapsLoaded,
    satellite,
    editable,
    initialLocation,
    onLocationChange,
    safeReverseGeocode,
  ]);

  /* ------------------------------------------------------------------ */
  /*  ACTIONS                                                           */
  /* ------------------------------------------------------------------ */

  const locateMe = useCallback(() => {
    if (!navigator.geolocation || !mapRef.current) return;

    setLocating(true);

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const loc = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
        };

        const g = (window as any).google;

        if (g?.maps && mapRef.current) {
          const ll = new g.maps.LatLng(loc.lat, loc.lng);
          mapRef.current.panTo(ll);
          markerRef.current?.setPosition(ll);
        }

        const addr = await safeReverseGeocode(loc);
        setAddress(addr);
        onLocationChange?.(loc, addr, false);
        setLocating(false);
      },
      () => {
        console.warn("[MapPicker] Geolocation failed or was denied.");
        setLocating(false);
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  }, [onLocationChange, safeReverseGeocode]);

  const confirmLocation = useCallback(async () => {
    if (!markerRef.current) return;

    const p = markerRef.current.getPosition();
    if (!p) return;

    const loc = { lat: p.lat(), lng: p.lng() };
    const addr = await safeReverseGeocode(loc);

    setAddress(addr);
    onLocationChange?.(loc, addr, true);
  }, [onLocationChange, safeReverseGeocode]);

  const toggleSatellite = useCallback(() => {
    setSatellite((s) => !s);
  }, []);

  /* ------------------------------------------------------------------ */
  /*  ATTACH AUTOCOMPLETE                                               */
  /* ------------------------------------------------------------------ */

  const attachAutocomplete = useCallback(async () => {
    if (!mapsLoaded) return;
    if (!autocompleteElRef?.current) return;

    const webcompLoaded = await loadWebComponent();
    if (!webcompLoaded) {
      setAutocompleteReady(false);

      if (!autocompleteErrorLoggedRef.current) {
        console.warn(
          "[MapPicker] PlaceAutocompleteElement could not be loaded. " +
            "Autocomplete will be disabled; check Places API / web component URLs."
        );
        autocompleteErrorLoggedRef.current = true;
      }

      return;
    }

    const el = autocompleteElRef.current as GmpxPlaceAutocompleteElement;
    if (!el) return;

    setAutocompleteReady(true);

    const handler = async (ev: any) => {
      const wc = el as GmpxPlaceAutocompleteElement;
      const place = ev?.detail?.place ?? wc.getPlace?.() ?? null;
      if (!place) return;

      const loc =
        place?.geometry?.location != null
          ? {
              lat: place.geometry.location.lat(),
              lng: place.geometry.location.lng(),
            }
          : null;

      const addr = place?.formatted_address ?? place?.name ?? "";

      if (loc && mapRef.current) {
        const g = (window as any).google;
        const ll = new g.maps.LatLng(loc.lat, loc.lng);
        mapRef.current.panTo(ll);
        markerRef.current?.setPosition(ll);
      }

      setAddress(addr);
      onLocationChange?.(loc, addr, false);
    };

    el.addEventListener("place_changed", handler);
    el.addEventListener("gmpx-place-selected", handler);
    el.addEventListener("change", handler);

    return () => {
      el.removeEventListener("place_changed", handler);
      el.removeEventListener("gmpx-place-selected", handler);
      el.removeEventListener("change", handler);
    };
  }, [mapsLoaded, autocompleteElRef, loadWebComponent, onLocationChange]);

  useEffect(() => {
    let cleanupFn: (() => void) | void;

    (async () => {
      cleanupFn = await attachAutocomplete();
    })();

    return () => {
      cleanupFn?.();
    };
  }, [attachAutocomplete]);

  /* ------------------------------------------------------------------ */
  /*  RETURN HOOK API                                                   */
  /* ------------------------------------------------------------------ */

  // üî• Unified "is maps usable?" flag
  const mapsDead =
    !apiKey ||
    !mapsLoaded ||
    (typeof window !== "undefined" &&
      !(window as any).google?.maps?.Map);

  return {
    mapRootRef,
    mapRef,
    address,
    satellite,
    locating,
    autocompleteReady,
    mapsLoaded,
    mapsDead,
    locateMe,
    confirmLocation,
    toggleSatellite,
  };
}

--- hooks/useOtpManager.ts ---
"use client";
/**
 * ============================================================
 * üåø HomeFix ‚Äî useOtpManager (v3.0 Unified Toast Edition)
 * ------------------------------------------------------------
 * ‚úÖ Uses global useToast() (no duplicate toasts)
 * ‚úÖ Clean API endpoints: send & verify for phone/email
 * ‚úÖ Boolean returns for easy UI binding
 * ‚úÖ Haptic feedback and verbose logging retained
 * ============================================================
 */

import { useToast } from "@/hooks/use-toast";
import { useState } from "react";

interface UseOtpManager {
  sendOtp: (target: string, type: "phone" | "email") => Promise<boolean>;
  verifyOtp: (
    otp: string,
    target: string,
    type: "phone" | "email"
  ) => Promise<boolean>;
  loading: boolean;
  verifying: boolean;
}

export function useOtpManager(): UseOtpManager {
  if (typeof window === "undefined") {
    console.warn("‚ö†Ô∏è useOtpManager() called on server ‚Äî skipping hook logic.");
    return {
      sendOtp: async () => false,
      verifyOtp: async () => false,
      loading: false,
      verifying: false,
    };
  }

  const { success, error, info } = useToast();
  const [loading, setLoading] = useState(false);
  const [verifying, setVerifying] = useState(false);

  /* ------------------------------------------------------------
     üì© Send OTP
  ------------------------------------------------------------ */
  async function sendOtp(
    target: string,
    type: "phone" | "email"
  ): Promise<boolean> {
    if (!target) {
      error("Please provide a valid target before sending OTP.");
      return false;
    }

    setLoading(true);

    try {
      const endpoint =
        type === "phone" ? "/api/auth/phone-otp" : "/api/auth/send-email-otp";

      const payload =
        type === "phone"
          ? { phone: `+91${target}`, action: "send" }
          : { email: target };

      console.log(`üì® [useOtpManager] Sending ${type} OTP ‚Üí`, payload);

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      if (!res.ok || !data.success)
        throw new Error(data.message || "Failed to send OTP");

      success(
        `OTP sent successfully to ${
          type === "phone" ? `+91 ${target}` : target
        }`
      );
      navigator.vibrate?.(30);
      return true;
    } catch (err: any) {
      console.error("üí• [useOtpManager:sendOtp]", err);
      error(`Failed to send ${type.toUpperCase()} OTP. Please try again.`);
      navigator.vibrate?.([80, 40, 80]);
      return false;
    } finally {
      setLoading(false);
    }
  }

  /* ------------------------------------------------------------
     üîê Verify OTP
  ------------------------------------------------------------ */
  async function verifyOtp(
    otp: string,
    target: string,
    type: "phone" | "email"
  ): Promise<boolean> {
    if (!otp || otp.length !== 6) {
      error("Please enter a valid 6-digit OTP.");
      return false;
    }

    setVerifying(true);

    try {
      const endpoint =
        type === "phone" ? "/api/auth/phone-otp" : "/api/auth/verify-email-otp";

      const payload =
        type === "phone"
          ? { phone: `+91${target}`, otp }
          : { email: target, otp };

      console.log(`üîç [useOtpManager] Verifying ${type} OTP ‚Üí`, payload);

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      if (!res.ok || !(data.success || data.verified))
        throw new Error(data.message || "Invalid OTP");

      success(
        `${type === "phone" ? "Phone" : "Email"} verified successfully ‚úÖ`
      );
      navigator.vibrate?.([60, 40, 120]);
      return true;
    } catch (err: any) {
      console.error("üí• [useOtpManager:verifyOtp]", err);
      error("Invalid OTP. Please try again.");
      navigator.vibrate?.([120]);
      return false;
    } finally {
      setVerifying(false);
    }
  }

  return { sendOtp, verifyOtp, loading, verifying };
}

--- hooks/useSupabaseUserSafe.ts ---
"use client";

import { supabase } from "@/lib/supabaseClient";
import { useEffect, useState } from "react";

export interface SafeUser {
  id: string;
  email: string | null;
  phone: string | null;
  name: string | null;
  isGuest: boolean;
}

/**
 * useSupabaseUserSafe() ‚Äî v3 (Jagadish Edition)
 * -------------------------------------------------------
 * ‚úî Real Supabase session always wins
 * ‚úî Hydrates from user_profiles table (correct source)
 * ‚úî Never falls into guest while logged in
 * ‚úî Restores last real user after HMR/refresh
 * ‚úî Guest fallback ONLY if no session + no cache
 */
export function useSupabaseUserSafe(): SafeUser | null {
  const [safeUser, setSafeUser] = useState<SafeUser | null>(null);

  useEffect(() => {
    let ignore = false;

    async function load() {
      // 1Ô∏è‚É£ Fetch real authenticated session
      const { data: userData } = await supabase.auth.getUser();
      const sessionUser = userData?.user;

      if (sessionUser && !ignore) {
        const userId = sessionUser.id;

        // üî• Fetch actual profile from DB (important fix)
        const { data: profile } = await supabase
          .from("user_profiles")
          .select("name, phone")
          .eq("id", userId)
          .maybeSingle();

        const normalized: SafeUser = {
          id: userId,
          email: sessionUser.email ?? null,
          phone: profile?.phone ?? null,
          name: profile?.name ?? null,
          isGuest: false,
        };

        // Store real user for refresh recovery
        localStorage.setItem("hf_last_user", JSON.stringify(normalized));
        setSafeUser(normalized);
        return;
      }

      // 2Ô∏è‚É£ Last known real user (prevents guest override)
      const cachedRaw = localStorage.getItem("hf_last_user");
      if (cachedRaw && !ignore) {
        try {
          const parsed = JSON.parse(cachedRaw);
          if (parsed?.id) {
            setSafeUser({ ...parsed, isGuest: false });
            return;
          }
        } catch {}
      }

      // 3Ô∏è‚É£ TRUE guest fallback
      const guestId =
        localStorage.getItem("hf_guest_id") || `guest-${crypto.randomUUID()}`;
      localStorage.setItem("hf_guest_id", guestId);

      if (!ignore) {
        setSafeUser({
          id: guestId,
          email: null,
          phone: null,
          name: "Guest",
          isGuest: true,
        });
      }
    }

    load();

    // 4Ô∏è‚É£ Auto-refresh on auth events
    const { data: listener } = supabase.auth.onAuthStateChange(() => load());

    return () => {
      ignore = true;
      listener.subscription.unsubscribe();
    };
  }, []);

  return safeUser;
}

--- lib/assets/homefix-logo.ts ---
/**
 * HomeFix Gemini Logo ‚Äî Pure SVG Definition üíé
 * ---------------------------------------------
 * - Perfect for emails, PDFs, or metadata images.
 * - Renders sharp in both dark & light contexts.
 */

export const HomeFixLogoSVG = `
<svg xmlns="http://www.w3.org/2000/svg" width="160" height="48" viewBox="0 0 160 48">
  <defs>
    <linearGradient id="geminiGradient" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#5A5DF0"/>
      <stop offset="50%" stop-color="#9B5CF8"/>
      <stop offset="100%" stop-color="#EC6ECF"/>
    </linearGradient>
  </defs>
  <text x="4" y="34"
        font-family="Poppins, Inter, sans-serif"
        font-weight="800"
        font-size="34"
        fill="url(#geminiGradient)">
    HomeFix
  </text>
</svg>
`;

--- lib/console.ts ---
// /lib/console.js
/**
 * üß≠ HomeFix India ‚Äî Edith Integrated Logger (v3.0)
 * -------------------------------------------------
 * Unified logging system with:
 *  - Structured log levels (log, info, warn, error)
 *  - Browser event dispatch via `edith:log`
 *  - Timestamped & tagged console output
 *  - Auto-disable in production or when NEXT_PUBLIC_DEBUG_MODE=false
 */



export type LogLevel = "log" | "info" | "warn" | "error";

const isDebug =
  process.env.NEXT_PUBLIC_DEBUG_MODE === "true" ||
  process.env.NODE_ENV !== "production";

/**
 * üîä Dispatch an Edith log event to the browser window.
 * Enables live monitoring from Admin Dashboard.
 */
export function edithLog(level: LogLevel, message: string, meta: any = {}) {
  if (typeof window !== "undefined") {
    const event = new CustomEvent("edith:log", {
      detail: { level, message, meta, ts: Date.now() },
    });
    window.dispatchEvent(event);
  }
}

/**
 * üïí Timestamp + context formatter
 */
function format(tag: string | undefined, args: any[]) {
  const time = new Date().toLocaleTimeString("en-IN", { hour12: false });
  const label = tag ? `[${tag}]` : "";
  return [`üïí ${time}`, label, ...args];
}

/**
 * üü¢ Loggers ‚Äî with fallback to `edithLog()` dispatch
 */
export const log = (tag?: string, ...args: any[]) => {
  const msg = args.join(" ");
  try { edithLog("log", msg, { tag }); } catch {}
  if (isDebug) console.log("üü¢", ...format(tag, args));
};

export const info = (tag?: string, ...args: any[]) => {
  const msg = args.join(" ");
  try { edithLog("info", msg, { tag }); } catch {}
  if (isDebug) console.info("üîµ", ...format(tag, args));
};

export const warn = (tag?: string, ...args: any[]) => {
  const msg = args.join(" ");
  try { edithLog("warn", msg, { tag }); } catch {}
  if (isDebug) console.warn("üü†", ...format(tag, args));
};

export const error = (tag?: string, ...args: any[]) => {
  const msg = args.join(" ");
  try { edithLog("error", msg, { tag }); } catch {}
  if (isDebug) console.error("üî¥", ...format(tag, args));
};

/**
 * ‚ö° Force-log even in production (critical alerts)
 */
export const forceLog = (tag?: string, ...args: any[]) => {
  const msg = args.join(" ");
  try { edithLog("log", msg, { tag, force: true }); } catch {}
  console.log("‚ö°", ...format(tag, args));
};

const consoleBridge = { log, info, warn, error, forceLog, edithLog };

export default consoleBridge;

--- lib/database.types.ts ---
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.5"
  }
  public: {
    Tables: {
      admin_broadcasts: {
        Row: {
          body: string | null
          created_at: string | null
          created_by: string | null
          id: string
          subject: string | null
          title: string | null
        }
        Insert: {
          body?: string | null
          created_at?: string | null
          created_by?: string | null
          id?: string
          subject?: string | null
          title?: string | null
        }
        Update: {
          body?: string | null
          created_at?: string | null
          created_by?: string | null
          id?: string
          subject?: string | null
          title?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "admin_broadcasts_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "user_profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      booking_log: {
        Row: {
          booking_id: string | null
          created_at: string | null
          endpoint: string | null
          error_message: string | null
          id: number
          message: string | null
          response_body: Json | null
          status_code: number | null
        }
        Insert: {
          booking_id?: string | null
          created_at?: string | null
          endpoint?: string | null
          error_message?: string | null
          id?: number
          message?: string | null
          response_body?: Json | null
          status_code?: number | null
        }
        Update: {
          booking_id?: string | null
          created_at?: string | null
          endpoint?: string | null
          error_message?: string | null
          id?: number
          message?: string | null
          response_body?: Json | null
          status_code?: number | null
        }
        Relationships: []
      }
      bookings: {
        Row: {
          address: string | null
          created_at: string | null
          email: string | null
          id: number
          latitude: number | null
          longitude: number | null
          preferred_date: string | null
          preferred_slot: string | null
          price_per_unit: number | null
          professional_service: string | null
          quantity: number | null
          service_id: number | null
          services: Json
          site_location: Json | null
          status: string | null
          total: number | null
          total_price: number
          type: string | null
          updated_at: string | null
          user_id: string | null
        }
        Insert: {
          address?: string | null
          created_at?: string | null
          email?: string | null
          id?: never
          latitude?: number | null
          longitude?: number | null
          preferred_date?: string | null
          preferred_slot?: string | null
          price_per_unit?: number | null
          professional_service?: string | null
          quantity?: number | null
          service_id?: number | null
          services?: Json
          site_location?: Json | null
          status?: string | null
          total?: number | null
          total_price?: number
          type?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Update: {
          address?: string | null
          created_at?: string | null
          email?: string | null
          id?: never
          latitude?: number | null
          longitude?: number | null
          preferred_date?: string | null
          preferred_slot?: string | null
          price_per_unit?: number | null
          professional_service?: string | null
          quantity?: number | null
          service_id?: number | null
          services?: Json
          site_location?: Json | null
          status?: string | null
          total?: number | null
          total_price?: number
          type?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "bookings_service_id_fkey"
            columns: ["service_id"]
            isOneToOne: false
            referencedRelation: "services"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "bookings_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "user_profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      email_queue: {
        Row: {
          created_at: string | null
          id: number
          last_error: string | null
          payload: Json
          processed: boolean | null
          processed_at: string | null
        }
        Insert: {
          created_at?: string | null
          id?: number
          last_error?: string | null
          payload: Json
          processed?: boolean | null
          processed_at?: string | null
        }
        Update: {
          created_at?: string | null
          id?: number
          last_error?: string | null
          payload?: Json
          processed?: boolean | null
          processed_at?: string | null
        }
        Relationships: []
      }
      email_verifications: {
        Row: {
          created_at: string | null
          email: string
          id: string
          otp: string
          user_id: string | null
          verified: boolean | null
        }
        Insert: {
          created_at?: string | null
          email: string
          id?: string
          otp: string
          user_id?: string | null
          verified?: boolean | null
        }
        Update: {
          created_at?: string | null
          email?: string
          id?: string
          otp?: string
          user_id?: string | null
          verified?: boolean | null
        }
        Relationships: [
          {
            foreignKeyName: "email_verifications_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "user_profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      goods: {
        Row: {
          category: string | null
          created_at: string | null
          created_by: string | null
          description: string | null
          id: number
          images: Json | null
          is_active: boolean | null
          metadata: Json | null
          price: number | null
          sku: string | null
          stock: number | null
          title: string
          updated_at: string | null
        }
        Insert: {
          category?: string | null
          created_at?: string | null
          created_by?: string | null
          description?: string | null
          id?: never
          images?: Json | null
          is_active?: boolean | null
          metadata?: Json | null
          price?: number | null
          sku?: string | null
          stock?: number | null
          title: string
          updated_at?: string | null
        }
        Update: {
          category?: string | null
          created_at?: string | null
          created_by?: string | null
          description?: string | null
          id?: never
          images?: Json | null
          is_active?: boolean | null
          metadata?: Json | null
          price?: number | null
          sku?: string | null
          stock?: number | null
          title?: string
          updated_at?: string | null
        }
        Relationships: []
      }
      http_response_log: {
        Row: {
          created_at: string | null
          endpoint: string | null
          error_message: string | null
          id: number
          message: string | null
          request_body: Json | null
          request_url: string | null
          response_body: string | null
          status: number | null
          status_code: number | null
        }
        Insert: {
          created_at?: string | null
          endpoint?: string | null
          error_message?: string | null
          id?: never
          message?: string | null
          request_body?: Json | null
          request_url?: string | null
          response_body?: string | null
          status?: number | null
          status_code?: number | null
        }
        Update: {
          created_at?: string | null
          endpoint?: string | null
          error_message?: string | null
          id?: never
          message?: string | null
          request_body?: Json | null
          request_url?: string | null
          response_body?: string | null
          status?: number | null
          status_code?: number | null
        }
        Relationships: []
      }
      notifications: {
        Row: {
          created_at: string | null
          error: string | null
          id: number
          kind: string
          payload: Json | null
          provider_id: string | null
          status: string | null
          subject: string | null
          to_email: string | null
        }
        Insert: {
          created_at?: string | null
          error?: string | null
          id?: never
          kind: string
          payload?: Json | null
          provider_id?: string | null
          status?: string | null
          subject?: string | null
          to_email?: string | null
        }
        Update: {
          created_at?: string | null
          error?: string | null
          id?: never
          kind?: string
          payload?: Json | null
          provider_id?: string | null
          status?: string | null
          subject?: string | null
          to_email?: string | null
        }
        Relationships: []
      }
      services: {
        Row: {
          category: string | null
          created_at: string | null
          description: string | null
          gallery: Json | null
          icon: string | null
          id: number
          image_url: string | null
          is_active: boolean | null
          price: number | null
          title: string
          type: string | null
          unit: string | null
          updated_at: string | null
        }
        Insert: {
          category?: string | null
          created_at?: string | null
          description?: string | null
          gallery?: Json | null
          icon?: string | null
          id?: never
          image_url?: string | null
          is_active?: boolean | null
          price?: number | null
          title: string
          type?: string | null
          unit?: string | null
          updated_at?: string | null
        }
        Update: {
          category?: string | null
          created_at?: string | null
          description?: string | null
          gallery?: Json | null
          icon?: string | null
          id?: never
          image_url?: string | null
          is_active?: boolean | null
          price?: number | null
          title?: string
          type?: string | null
          unit?: string | null
          updated_at?: string | null
        }
        Relationships: []
      }
      trigger_log: {
        Row: {
          created_at: string | null
          error_message: string | null
          event: string | null
          id: number
          message: string | null
          payload: Json | null
          status_code: number | null
          trigger_name: string | null
        }
        Insert: {
          created_at?: string | null
          error_message?: string | null
          event?: string | null
          id?: number
          message?: string | null
          payload?: Json | null
          status_code?: number | null
          trigger_name?: string | null
        }
        Update: {
          created_at?: string | null
          error_message?: string | null
          event?: string | null
          id?: number
          message?: string | null
          payload?: Json | null
          status_code?: number | null
          trigger_name?: string | null
        }
        Relationships: []
      }
      user_profiles: {
        Row: {
          address: string | null
          created_at: string | null
          email: string | null
          email_verified: boolean | null
          id: string
          latitude: number | null
          longitude: number | null
          name: string | null
          phone: string
          phone_verified: boolean | null
          role: string | null
          updated_at: string | null
          verified_at: string | null
        }
        Insert: {
          address?: string | null
          created_at?: string | null
          email?: string | null
          email_verified?: boolean | null
          id?: string
          latitude?: number | null
          longitude?: number | null
          name?: string | null
          phone: string
          phone_verified?: boolean | null
          role?: string | null
          updated_at?: string | null
          verified_at?: string | null
        }
        Update: {
          address?: string | null
          created_at?: string | null
          email?: string | null
          email_verified?: boolean | null
          id?: string
          latitude?: number | null
          longitude?: number | null
          name?: string | null
          phone?: string
          phone_verified?: boolean | null
          role?: string | null
          updated_at?: string | null
          verified_at?: string | null
        }
        Relationships: []
      }
    }
    Views: {
      http_response_log_readable: {
        Row: {
          created_at: string | null
          error_message: string | null
          id: number | null
          message: string | null
          request_body: Json | null
          request_url: string | null
          response_body: string | null
          status: number | null
          status_text: string | null
        }
        Insert: {
          created_at?: string | null
          error_message?: string | null
          id?: number | null
          message?: string | null
          request_body?: Json | null
          request_url?: string | null
          response_body?: string | null
          status?: number | null
          status_text?: never
        }
        Update: {
          created_at?: string | null
          error_message?: string | null
          id?: number | null
          message?: string | null
          request_body?: Json | null
          request_url?: string | null
          response_body?: string | null
          status?: number | null
          status_text?: never
        }
        Relationships: []
      }
    }
    Functions: {
      _homefix_service_key: { Args: never; Returns: string }
      _http_post_json: {
        Args: { headers?: Json; payload: Json; req_url: string }
        Returns: Json
      }
      fn_get_trigger_health: {
        Args: never
        Returns: {
          function_name: string
          last_called_at: string
          last_status_code: number
          table_name: string
          trigger_name: string
        }[]
      }
      safe_http_post: {
        Args: { body?: Json; headers?: Json; url: string }
        Returns: Json
      }
      safe_insert_profile_v2: {
        Args: { name?: string; phone: string }
        Returns: Json
      }
      safe_net_http_post: {
        Args: { body?: Json; headers?: Json; url: string }
        Returns: Json
      }
      universal_http_post: {
        Args: { body: string; headers: Json; url: string }
        Returns: undefined
      }
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {},
  },
} as const

--- lib/loadGoogleMaps.ts ---
let mapsPromise: Promise<any> | null = null;

export function loadGoogleMaps(apiKey: string) {
  if (!mapsPromise) {
    mapsPromise = new Promise((resolve, reject) => {
      if (typeof window === "undefined") return;

      if ((window as any).google?.maps) {
        resolve((window as any).google.maps);
        return;
      }

      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
      script.async = true;
      script.defer = true;

      script.onload = () => {
        resolve((window as any).google.maps);
      };
      script.onerror = reject;

      document.head.appendChild(script);
    });
  }
  return mapsPromise;
}

--- lib/mockRazorpay.ts ---
/**
 * ============================================================
 * üßæ Edith Mock Razorpay v1.0
 * ------------------------------------------------------------
 * Simulates a real Razorpay checkout promise for local testing.
 * - Returns a fake payment_id and signature after 1.2 s
 * - Randomizes success / failure (90 % success)
 * ============================================================
 */

export interface MockPaymentResponse {
  payment_id: string;
  signature: string;
  status: "success" | "failed";
}

export async function simulateRazorpayPayment(
  amount: number
): Promise<MockPaymentResponse> {
  return new Promise((resolve) => {
    setTimeout(() => {
      const success = Math.random() > 0.1; // 90 % success
      resolve({
        payment_id: success ? `PAY_${Date.now().toString(36)}` : "FAILED_TXN",
        signature: success
          ? `SIG_${Math.random().toString(36).slice(2, 10)}`
          : "",
        status: success ? "success" : "failed",
      });
    }, 1200);
  });
}

--- lib/roles.ts ---
export const ROLE_CAPS = {
  admin: {
    canSeeUsers: true,
    canSeeServices: true,
    canSeeBookings: true,
    canSeeCms: true,
    canSeeSettings: true,
  },
  manager: {
    canSeeUsers: true,
    canSeeServices: true,
    canSeeBookings: true,
    canSeeCms: true,
    canSeeSettings: false,
  },
  technician: {
    canSeeUsers: false,
    canSeeServices: false,
    canSeeBookings: true,
    canSeeCms: false,
    canSeeSettings: false,
  },
  support: {
    canSeeUsers: false,
    canSeeServices: false,
    canSeeBookings: true,
    canSeeCms: true,
    canSeeSettings: false,
  },
  user: {
    canSeeUsers: false,
    canSeeServices: false,
    canSeeBookings: false,
    canSeeCms: false,
    canSeeSettings: false,
  },
} as const;

export type RoleKey = keyof typeof ROLE_CAPS;

export function getCaps(role: RoleKey) {
  return ROLE_CAPS[role] ?? ROLE_CAPS.user;
}

--- lib/supabaseQueries/admin.ts ---
/**
 * ============================================================
 * üìò FILE: /lib/supabaseQueries/admin.ts
 * üîß MODULE: HomeFix Admin Query Core v4.8 ‚Äî Unified Toast Edition
 * ------------------------------------------------------------
 * ‚úÖ Uses unified useToast() hook (no direct Sonner imports)
 * ‚úÖ Prevents duplicate toasts across Admin UI
 * ‚úÖ Type-safe with admin.types.ts
 * ‚úÖ Logs via Edith console wrappers
 * ‚úÖ Dispatches ‚Äúedith:bookingUpdate‚Äù custom event safely
 * ============================================================
 */

"use client";
import { error, info, log, warn } from "@/lib/console";
import { supabase } from "@/lib/supabaseClient";
import type {
  AdminBooking,
  AdminChartPoint,
  AdminStats,
} from "@/lib/supabaseQueries/admin.types";

/* ============================================================
   üß© Core: Fetch Admin Dashboard Data
============================================================ */
type ToastAdapter = {
  success?: (message: string) => void;
  error?: (message: string) => void;
  info?: (message: string) => void;
};

export async function fetchAdminDashboardData(
  toast?: ToastAdapter
): Promise<{
  stats: AdminStats;
  bookings: AdminBooking[];
  chartData: AdminChartPoint[];
}> {
  const toastSuccess = toast?.success;
  const toastError = toast?.error;

  try {
    // 1Ô∏è‚É£ Aggregate Counts
    const [{ count: sCount }, { count: bCount }, { count: uCount }] =
      await Promise.all([
        supabase.from("services").select("id", { count: "exact", head: true }),
        supabase.from("bookings").select("id", { count: "exact", head: true }),
        supabase.from("user_profiles").select("id", {
          count: "exact",
          head: true,
        }),
      ]);

    const stats: AdminStats = {
      services: sCount || 0,
      bookings: bCount || 0,
      users: uCount || 0,
    };

    // 2Ô∏è‚É£ Latest Bookings
    const { data: latest, error: bErr } = await supabase
      .from("bookings")
      .select(
        `
          id,
          created_at,
          address,
          status,
          preferred_date,
          preferred_slot,
          email,
          user_profiles ( name, phone, email ),
          services ( title )
        `
      )
      .order("created_at", { ascending: false })
      .limit(5);

    if (bErr) throw bErr;

    const bookings: AdminBooking[] =
      latest?.map((b: any) => ({
        id: b.id,
        created_at: b.created_at,
        address: b.address ?? null,
        status: b.status ?? null,
        preferred_date: b.preferred_date ?? null,
        preferred_slot: b.preferred_slot ?? null,
        email: b.email ?? null,
        service_title:
          Array.isArray(b.services) && b.services.length
            ? b.services[0].title
            : b.services?.title ?? null,
        client_name:
          Array.isArray(b.user_profiles) && b.user_profiles.length
            ? b.user_profiles[0].name
            : b.user_profiles?.name ?? null,
        client_email:
          Array.isArray(b.user_profiles) && b.user_profiles.length
            ? b.user_profiles[0].email
            : b.user_profiles?.email ?? null,
        client_phone:
          Array.isArray(b.user_profiles) && b.user_profiles.length
            ? b.user_profiles[0].phone
            : b.user_profiles?.phone ?? null,
      })) ?? [];

    // 3Ô∏è‚É£ Booking Trends
    const { data: all, error: cErr } = await supabase
      .from("bookings")
      .select("created_at")
      .order("created_at", { ascending: true });

    if (cErr) throw cErr;

    const grouped =
      all?.reduce<Record<string, number>>((acc, b) => {
        const month = new Date(b.created_at).toLocaleString("en", {
          month: "short",
        });
        acc[month] = (acc[month] || 0) + 1;
        return acc;
      }, {}) ?? {};

    const chartData: AdminChartPoint[] = Object.entries(grouped).map(
      ([month, count]) => ({ month, count })
    );

    log("AdminDashboard", "‚úÖ Dashboard data fetched successfully.");
    return { stats, bookings, chartData };
  } catch (err: any) {
    error("AdminDashboard", "‚ùå Fetch failed:", err);
    toastError?.(`Error loading admin data: ${err.message || "Unexpected error"}`);
    throw err;
  }
}

/* ============================================================
   üß∞ Utility: Update Booking Status (v4.8)
============================================================ */
export async function updateBookingStatus(
  id: number,
  newStatus: string,
  toast?: ToastAdapter
): Promise<boolean> {
  const toastSuccess = toast?.success;
  const toastError = toast?.error;
  const toastInfo = toast?.info;

  log("Bookings", `Attempting status update ‚Üí ${id} ‚Üí ${newStatus}`);

  try {
    const { data, error: dbError } = await supabase
      .from("bookings")
      .update({ status: newStatus })
      .eq("id", id)
      .select("id, status, updated_at")
      .maybeSingle();

    if (dbError) {
      error("Bookings", "Supabase update error:", dbError.message);
      toastError?.(`Update failed: ${dbError.message}`);
      return false;
    }

    if (!data) {
      warn("Bookings", "No rows updated for booking:", id);
      toastInfo?.(`Booking not found for ID #${id}`);
      return false;
    }

    info("Bookings", `‚úÖ Booking #${id} updated ‚Üí ${newStatus}`);
    toastSuccess?.(`Booking #${id} updated ‚Äî status: ${newStatus}`);

    // ü™∂ Dispatch a global Edith event
    try {
      window.dispatchEvent(
        new CustomEvent("edith:bookingUpdate", {
          detail: { id, status: newStatus, ts: Date.now() },
        })
      );
    } catch (evtErr) {
      warn("Edith", "Failed to dispatch bookingUpdate event:", evtErr);
    }

    return true;
  } catch (err: any) {
    error("Bookings", "Unexpected exception:", err);
    toastError?.(`Unexpected error: ${err.message || "Could not update booking"}`);
    return false;
  }
}

--- lib/supabaseQueries/admin.types.ts ---
/**
 * File: /lib/supabaseQueries/admin.types.ts
 * Version: v1.0 ‚Äî HomeFix Admin Type Library üåø
 * ------------------------------------------------------------
 * ‚úÖ Centralized shared interfaces for all admin modules
 * ‚úÖ Mirrors live Supabase schema (bookings, services, user_profiles)
 * ‚úÖ Autocomplete-friendly for components, hooks, and Edge Functions
 * ‚úÖ Keeps AdminDashboard.tsx, BookingsTable.tsx, and data hooks aligned
 *
 * Usage:
 *   import type { AdminStats, AdminBooking, AdminChartPoint } from "@/lib/supabaseQueries/admin.types";
 */

export interface AdminStats {
  /** Total number of active services */
  services: number;

  /** Total number of bookings (any status) */
  bookings: number;

  /** Total number of registered users */
  users: number;
}

/* ------------------------------------------------------------
   üìò AdminBooking ‚Äî normalized from Supabase public.bookings
------------------------------------------------------------ */
export interface AdminBooking {
  /** Unique booking ID */
  id: number;

  /** ISO timestamp when booking was created */
  created_at: string;

  /** Client site/service address */
  address?: string | null;

  /** Booking status ‚Äî upcoming, in-progress, completed, cancelled, etc. */
  status?: string | null;

  /** User-selected preferred service date */
  preferred_date?: string | null;

  /** User-selected preferred time slot (9 AM / 1 PM / 5 PM / 7 PM) */
  preferred_slot?: string | null;

  /** Booking email contact (may differ from user_profiles.email) */
  email?: string | null;

  /** Linked service title from services table */
  service_title?: string | null;

  /** Linked client name from user_profiles */
  client_name?: string | null;

  /** Linked client email from user_profiles */
  client_email?: string | null;

  /** Linked client phone number from user_profiles */
  client_phone?: string | null;
}

/* ------------------------------------------------------------
   üìà AdminChartPoint ‚Äî used in Booking Trends (Recharts)
------------------------------------------------------------ */
export interface AdminChartPoint {
  /** Month abbreviation (e.g., Jan, Feb, Mar) */
  month: string;

  /** Total bookings in that month */
  count: number;
}

/* ------------------------------------------------------------
   üß© AdminHookReturn ‚Äî unified type for hooks like useAdminDashboardData
------------------------------------------------------------ */
export interface AdminHookReturn {
  stats: AdminStats;
  bookings: AdminBooking[];
  chartData: AdminChartPoint[];
  loading: boolean;
  loadData: () => Promise<void>;
}

--- lib/supabaseQueries/bookings.ts ---
"use client";

/**
 * File: /lib/supabaseQueries/bookings.ts
 * Project: HomeFix India v3.1
 * Supabase Project ID: xnubmphixlpkyqfhghup
 * ------------------------------------------------------------
 * ‚úÖ Typed Supabase client (Database-aware)
 * ‚úÖ Flattened joins using !inner
 * ‚úÖ Safe mapping + TS-strict BookingRow interface
 * ‚úÖ Admin Dashboard ready
 */

import { supabase } from "@/lib/supabaseClient";
import type { Database } from "@/lib/database.types";

/* ------------------------------------------------------------
   ‚öôÔ∏è Initialize Typed Supabase Client
------------------------------------------------------------ */

/* ------------------------------------------------------------
   üß© Type Definition for Dashboard Consumption
------------------------------------------------------------ */
export interface BookingRow {
  id: string;
  created_at: string;
  address: string | null;
  status: string;
  preferred_date: string | null;
  preferred_slot: string | null;
  email: string | null;
  service_title: string | null;
  client_name: string | null;
  client_email: string | null;
  client_phone: string | null;
}

/* ------------------------------------------------------------
   üöÄ Fetch All Bookings (Admin Dashboard)
------------------------------------------------------------ */
export async function fetchAllBookings(): Promise<BookingRow[]> {
  try {
    const { data, error } = await supabase
      .from("bookings")
      .select(`
        id,
        created_at,
        address,
        status,
        preferred_date,
        preferred_slot,
        email,
        user_profiles!inner(name, phone, email),
        services!inner(title)
      `)
      .order("created_at", { ascending: false });

    if (error) {
      console.error("‚ùå Error fetching bookings:", error.message);
      return [];
    }

    if (!data) {
      console.warn("‚ö†Ô∏è No booking data found.");
      return [];
    }

    // Map and flatten relational data
    const normalized: BookingRow[] = data.map((b: any) => ({
      id: b.id,
      created_at: b.created_at,
      address: b.address ?? null,
      status: b.status,
      preferred_date: b.preferred_date ?? null,
      preferred_slot: b.preferred_slot ?? null,
      email: b.email ?? null,
      service_title: b.services?.title ?? null,
      client_name: b.user_profiles?.name ?? null,
      client_email: b.user_profiles?.email ?? null,
      client_phone: b.user_profiles?.phone ?? null,
    }));

    return normalized;
  } catch (err) {
    console.error("üî• Unexpected error in fetchAllBookings():", err);
    return [];
  }
}

--- lib/supabaseServerClient.ts ---
import { createClient } from '@supabase/supabase-js';

// Validate environment variables
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  throw new Error('‚ùå supabaseUrl or serviceRoleKey is missing from environment variables');
}

/**
 * Server-side Supabase client ‚Äî use only in route handlers, server components, or edge functions.
 */
export const supabaseServer = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

--- lib/useAuth.ts ---
"use client";
import { useEffect, useState } from "react";

export function useAuth() {
  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const stored = localStorage.getItem("user");
    if (stored) {
      try {
        setUser(JSON.parse(stored));
      } catch {
        setUser(null);
      }
    } else {
      setUser(null);
    }
    setLoading(false);
  }, []);

  return { user, setUser, loading };
}

--- lib/useServices.ts ---
"use client";
import { useEffect, useState } from "react";
import supabase from "@/lib/supabaseClient";

export type Service = {
  id: number;
  title: string;
  description?: string;
  price?: number;
  unit?: string;
  icon?: string;
  image_url?: string;
  gallery?: any[];
  category?: string;
  type?: string;
  is_active: boolean;
  slug?: string;
};

export type GroupedServices = Record<string, Service[]>;

export default function useServices() {
  const [services, setServices] = useState<GroupedServices>({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchServices() {
      try {
        const { data, error } = await supabase
          .from("services")
          .select("*")
          .eq("is_active", true)
          .order("category");

        if (error) throw error;

        const grouped: GroupedServices = {};
        for (const item of data) {
          const cat = item.category || "Misc";
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(item);
        }

        setServices(grouped);
        localStorage.setItem("services_cache", JSON.stringify(grouped));
      } catch (err: any) {
        console.error("[useServices] Error:", err.message);
        setError(err.message);
        const cache = localStorage.getItem("services_cache");
        if (cache) setServices(JSON.parse(cache));
      } finally {
        setLoading(false);
      }
    }

    fetchServices();
  }, []);

  return { services, loading, error };
}

--- lib/utils.ts ---
/**
 * File: /lib/utils.js
 * Purpose: (auto-added during Portable Cleanup) ‚Äî add a concise, human-readable purpose for this file.
 * Process: Part of HomeFix portable refactor; no functional changes made by header.
 * Dependencies: Review local imports; ensure single supabase client in /lib when applicable.
 * Note: This header is documentation-only and safe to remove or edit.
 */
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
